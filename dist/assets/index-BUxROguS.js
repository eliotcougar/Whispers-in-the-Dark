import{r as s,o as bo,j as a,R as yo,b as vo}from"./vendor-B8WumMjc.js";import{g as xo,o as Co,d as So,e as No,s as wt,t as wo,i as To,k as ct,l as bn,b as pe,m as et,p as Tt,q as ze,r as Io,u as jo,v as ko,w as Sa,x as Lo,y as Ft,z as Po,A as Ao,B as Do,C as Na,E as Eo,F as wa,G as Ta,H as Ia,I as yn,J as Mo,K as ja,L as Fo,M as aa,N as ka,O as La,P as $o,Q as Pa,R as Aa,S as Da,T as $t,U as Ro,V as Xt,W as Ye,h as vn,X as Vt,Y as Oo,Z as Go,_ as _o,$ as Vo,a0 as Ea,a1 as Uo,a2 as qt,a3 as zo,a4 as sa,a5 as Ue,a6 as Bo,a7 as Ho,a8 as Wo,a9 as Zt,aa as en,ab as Jo,ac as Ko,ad as Ma,ae as Yo,af as Qo,ag as Xo,ah as qo,ai as Zo,aj as er}from"./utils-B7yNI6lz.js";import{L as tr,I as nr,q as xn,r as tn,s as oa,t as on,u as Fa,v as ar,w as ra,R as Cn,P as ge,x as sr,y as or,z as rr,A as lr,B as nn,E as ir,F as $a,H as Ra,J as vt,e as Oa,f as Ga,g as Rt,h as Ot,K as fe,d as rn,C as Ve,O as _a,Q as cr,S as ur,M as an,U as dr,G as sn,X as mr,i as Et,Y as pr,Z as gr,_ as fr,$ as lt,a0 as it,a1 as la,N as hr,p as br,a2 as ia,V as yr,a3 as vr,a4 as ln,a5 as St,a6 as Mt,c as xr,b as Cr,a as Sr,D as Nr,a7 as ca}from"./corrections-D2pPkWuS.js";import{B,I as de,D as wr}from"./debug-CHtl36hp.js";import{c as Tr}from"./resources-CAQ9QWxJ.js";import"./gemini-OHsDkYxx.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const d of r)if(d.type==="childList")for(const i of d.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const d={};return r.integrity&&(d.integrity=r.integrity),r.referrerPolicy&&(d.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?d.credentials="include":r.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function o(r){if(r.ep)return;r.ep=!0;const d=n(r);fetch(r.href,d)}})();const Va=()=>{const[e,t]=s.useState(xo());return s.useEffect(()=>(Co(t),()=>{So(t)}),[]),e},cn=`You are the Dungeon Master for a text-based adventure game. Your role is to describe scenes, provide action/dialogue choices, manage inventory, player goals, track known NPCs (including their presence, general location, and precise location in scene), and track local time/environment/place.
In your thinking focus less on the specific responses you will generate, and more on the overall detailed narrative flow, player engagement, and world consistency.

Local Time, Environment & Place Guide:
${tr}

Items Guide:
${nr}

Player Input and Contextual Information:
- Very subtly and indirectly take into account Player's Character Gender, but do not focus attention on it in the text, only on its consequences.
- Current Theme Guidance gives you specific instructions about the setting, tone, and types of challenges or events to generate. Adhere to this guidance.
- If "localPlace" corresponds to a location in "Locations Nearby" list OR remained at the old location, always set "currentMapNodeId" to the name of that location.
- If "sceneDescription" or "logMessage" mentions a new significant NAMED location or feature that is NOT in 'Known Locations' list (nor by one of its aliases), describe it in "mapHint", and set "mapUpdated": true. The map service will handle adding it.
- If new distant quest-related and objective-related locations are mentioned but don't exist on the map, provide a short description of them, their surroundings, and how to reach them in "mapHint" for the Map AI.
- If "sceneDescription" or "logMessage" mentions a new NPC (i.e., not in 'Known NPCs in Current Theme' list), you MUST add it using "npcsAdded". If an existing NPC's description, aliases, or presence change significantly, use "npcsUpdated".
- Pay close attention to 'Active: true' items and their available actions.
- Compare the new Local Place of the Player to the precise locations of relevant NPCs, and update their presence state accordingly.
For example, leaving NPC's location makes them "distant", entering NPC's location makes them 'nearby' if they are still there, or 'unknown', is they moved while the player was not there.
If a Companion leaves the Player, or the Player leaves a Companion, their presence status changes to 'nearby' or, sometimes, 'distant', depending on context.
- The response MUST include "localTime", "localEnvironment", and "localPlace".
- If "mainQuest" or "currentObjective" change, they MUST be provided. Otherwise, they are optional.
- If the narrative implies any changes to the map (new details, locations, connections, status changes), set "mapUpdated": true and write about it in mapHint.
- If Player's Action is "Inspect: [item_name]": Provide details about the item in "logMessage". If new info/use is found, mention it in playerItemsHint.
- If Player's Action is "Attempt to use: [item_name]": Treat it as the most logical action. Describe the outcome in "logMessage". If specific function is revealed, mention the new knownUse in playerItemsHint.

CRITICALLY IMPORTANT: If "logMessage" or "sceneDescription" implies items were gained, lost, moved, or changed, you MUST summarize these changes using "playerItemsHint", "worldItemsHint", and "npcItemsHint" and list new items in "newItems".
CRITICALLY IMPORTANT: Names and Aliases (of items, places, NPCs, etc) cannot contain a comma.
`,un=async e=>(console.error("API Key not configured for Gemini Service."),Promise.reject(new Error("API Key not configured."))),Ir=async(e,t,n)=>(console.error("API Key not configured for Gemini Service. Cannot summarize."),null);function jr(e,t){if(!e||typeof e!="object")return console.warn("parseAIResponse: Parsed data is not a valid object.",e),t==null||t(),null;const n=e;return typeof n.sceneDescription!="string"||n.sceneDescription.trim()===""?(console.warn("parseAIResponse: sceneDescription is missing or empty.",e),t==null||t(),null):(n.mainQuest===void 0||n.mainQuest===null||typeof n.mainQuest=="string")&&(n.currentObjective===void 0||n.currentObjective===null||typeof n.currentObjective=="string")&&(n.logMessage===void 0||n.logMessage===null||typeof n.logMessage=="string")&&(n.npcsAdded===void 0||n.npcsAdded===null||Array.isArray(n.npcsAdded))&&(n.npcsUpdated===void 0||n.npcsUpdated===null||Array.isArray(n.npcsUpdated))&&(n.objectiveAchieved===void 0||n.objectiveAchieved===null||typeof n.objectiveAchieved=="boolean")&&(n.localTime===void 0||n.localTime===null||typeof n.localTime=="string")&&(n.localEnvironment===void 0||n.localEnvironment===null||typeof n.localEnvironment=="string")&&(n.localPlace===void 0||n.localPlace===null||typeof n.localPlace=="string")&&(n.dialogueSetup===void 0||n.dialogueSetup===null||typeof n.dialogueSetup=="object")&&(n.mapUpdated===void 0||n.mapUpdated===null||typeof n.mapUpdated=="boolean")&&(n.currentMapNodeId===void 0||n.currentMapNodeId===null||typeof n.currentMapNodeId=="string")&&(n.mapHint===void 0||n.mapHint===null||typeof n.mapHint=="string")&&(n.playerItemsHint===void 0||n.playerItemsHint===null||typeof n.playerItemsHint=="string")&&(n.worldItemsHint===void 0||n.worldItemsHint===null||typeof n.worldItemsHint=="string")&&(n.npcItemsHint===void 0||n.npcItemsHint===null||typeof n.npcItemsHint=="string")&&(n.newItems===void 0||n.newItems===null||Array.isArray(n.newItems))?To(n):(console.warn("parseAIResponse: Basic field validation failed (pre-dialogue specifics and array checks).",e),t==null||t(),null)}async function kr(e,t){var d;let n=e.dialogueSetup,o=Array.isArray(e.options)?e.options:[],r=!1;if(n){let i=oa(n);if(!i){console.warn("parseAIResponse: 'dialogueSetup' is present but malformed. Attempting correction.");const g=[...t.allRelevantNPCs];(e.npcsAdded??[]).forEach(p=>{on(p)&&g.push({...p,id:ct(p.name),themeName:"",presenceStatus:p.presenceStatus??"unknown",lastKnownLocation:p.lastKnownLocation??null,preciseLocation:p.preciseLocation??null})}),(e.npcsUpdated??[]).forEach(p=>{if(Fa(p)){const m=t.allRelevantNPCs.find(f=>f.name===p.name);g.push({id:ct(p.name),name:p.name,description:p.newDescription??(m==null?void 0:m.description)??"Updated NPC",aliases:p.newAliases??(m==null?void 0:m.aliases)??[],themeName:"",presenceStatus:p.newPresenceStatus??(m==null?void 0:m.presenceStatus)??"unknown",lastKnownLocation:p.newLastKnownLocation??(m==null?void 0:m.lastKnownLocation)??null,preciseLocation:p.newPreciseLocation??(m==null?void 0:m.preciseLocation)??null})}});const c=await ar(t.logMessageFromPayload??e.logMessage,t.sceneDescriptionFromPayload??e.sceneDescription);c&&oa(c)?(n=c,i=!0,console.log("parseAIResponse: Successfully corrected 'dialogueSetup'.")):(console.warn("parseAIResponse: Failed to correct 'dialogueSetup' or corrected version is still invalid. Discarding dialogue attempt."),n=void 0,i=!1)}r=i&&!!n,r&&(o=[])}return!r&&(n=void 0,!Array.isArray(o)||!o.every(i=>typeof i=="string"))?(console.warn("parseAIResponse: options are missing or invalid (must be array of strings) when not in dialogue.",e),(d=t.onParseAttemptFailed)==null||d.call(t),null):{dialogueSetup:n,options:o,isDialogueTurn:r}}async function Lr(e,t,n,o){const r=[];if(Array.isArray(e))for(const c of e){const p=typeof c=="object"&&c!==null&&"name"in c?c.name:void 0;if(on(c))r.push({...c,id:ct(c.name),presenceStatus:c.presenceStatus??"unknown",lastKnownLocation:c.lastKnownLocation??null,preciseLocation:c.preciseLocation??null,themeName:""});else{console.warn(`parseAIResponse ('npcsAdded'): Invalid NPC structure for "${p??"Unknown Name"}". Attempting correction.`);const m=await ra(p??"Newly Mentioned NPC",o.logMessageFromPayload??n.logMessage,o.sceneDescriptionFromPayload??n.sceneDescription);if(m){const f=m.description.split(" ").slice(0,2).join(" ")||"Corrected NPC",u={name:p??f,description:m.description,aliases:m.aliases,presenceStatus:m.presenceStatus,lastKnownLocation:m.lastKnownLocation,preciseLocation:m.preciseLocation};on(u)?(r.push({...u,id:ct(u.name),themeName:""}),console.log("parseAIResponse ('npcsAdded'): Successfully corrected NPC:",u.name)):console.warn(`parseAIResponse ('npcsAdded'): Corrected NPC "${p??"Unknown Name"}" still invalid. Discarding. Corrected Data:`,u)}else console.warn(`parseAIResponse ('npcsAdded'): Failed to correct NPC "${p??"Unknown Name"}". Discarding.`)}}else e!==void 0&&console.warn("parseAIResponse ('npcsAdded'): Field was present but not an array.",e);const d=Array.isArray(t)?t:[],i=[];for(const c of d)if(typeof c=="object"&&c!==null&&"name"in c&&typeof c.name=="string"&&c.name.trim()!==""){const p={...c,name:c.name},m=p.name,f=new Set([...o.allRelevantNPCs.map(u=>u.name),...r.map(u=>u.name)]);if(!f.has(p.name)){console.warn(`parseAIResponse ('npcsUpdated'): Original target name "${m}" not found. Attempting name correction.`);const u=await xn("NPC name",p.name,o.logMessageFromPayload??n.logMessage,o.sceneDescriptionFromPayload??n.sceneDescription,Array.from(f));u&&u.trim()!==""?(p.name=u,console.log(`parseAIResponse ('npcsUpdated'): Corrected target name to "${u}".`)):console.warn(`parseAIResponse ('npcsUpdated'): Failed to correct target name for "${m}". Will attempt to process as is, may convert to 'add'.`)}Fa(p)?i.push(p):console.warn(`parseAIResponse ('npcsUpdated'): Payload for "${m}" is invalid after potential name correction. Discarding. Payload:`,p)}else console.warn("parseAIResponse ('npcsUpdated'): Update missing or has invalid 'name'. Discarding.",c);const g=[];for(const c of i){const p=c.name,m=o.allRelevantNPCs.some(b=>b.name===p),f=r.findIndex(b=>b.name===p),u=f!==-1;if(m||u){if(g.push(c),u){const b=r[f];c.newDescription!==void 0&&(b.description=c.newDescription),c.newAliases!==void 0&&(b.aliases=c.newAliases),c.addAlias&&(b.aliases=Array.from(new Set([...b.aliases??[],c.addAlias]))),c.newPresenceStatus!==void 0&&(b.presenceStatus=c.newPresenceStatus),c.newLastKnownLocation!==void 0&&(b.lastKnownLocation=c.newLastKnownLocation),c.newPreciseLocation!==void 0&&(b.preciseLocation=c.newPreciseLocation),b.presenceStatus==="distant"||b.presenceStatus==="unknown"?b.preciseLocation=null:b.preciseLocation??(b.preciseLocation=b.presenceStatus==="companion"?"with you":"nearby in the scene"),r[f]=b}}else{console.warn(`parseAIResponse ('npcsUpdated'): Target NPC "${p}" for update not found. Converting to an add operation.`);const b={id:ct(p),name:p,description:c.newDescription??`Details for ${p} are emerging.`,aliases:c.newAliases??(c.addAlias?[c.addAlias]:[]),themeName:"",presenceStatus:c.newPresenceStatus??"unknown",lastKnownLocation:c.newLastKnownLocation??null,preciseLocation:c.newPreciseLocation??null};if(b.description===`Details for ${p} are emerging.`){const l=await ra(p,o.logMessageFromPayload??n.logMessage,o.sceneDescriptionFromPayload??n.sceneDescription);l&&(b.description=l.description,b.aliases=Array.from(new Set([...b.aliases??[],...l.aliases])),b.presenceStatus=l.presenceStatus,b.lastKnownLocation=l.lastKnownLocation,b.preciseLocation=l.preciseLocation)}b.presenceStatus==="distant"||b.presenceStatus==="unknown"?b.preciseLocation=null:b.preciseLocation??(b.preciseLocation=b.presenceStatus==="companion"?"with you":"nearby in the scene");const x=r.findIndex(l=>l.name===b.name);x===-1?r.push(b):r[x]={...r[x],...b}}}return{npcsAdded:r,npcsUpdated:g}}async function dn(e,t,n,o,r,d,i=[],g={nodes:[],edges:[]},c=[]){var f,u,b;const p=No(e),m=g.nodes.filter(x=>x.data.nodeType!=="feature");try{const x=wt(p);if(x===null)throw new Error("JSON parse failed");const l=jr(x,o);if(!l)return null;const S={playerGender:t,currentTheme:n,onParseAttemptFailed:o,logMessageFromPayload:r,sceneDescriptionFromPayload:d,allRelevantNPCs:i,allRelevantMainMapNodesForCorrection:m,currentInventoryForCorrection:c},y=await kr(l,S);if(!y)return null;l.dialogueSetup=y.dialogueSetup,l.options=y.options;let w=y.isDialogueTurn;l.itemChange=[];const A=await Lr(l.npcsAdded,l.npcsUpdated,l,S);if(l.npcsAdded=A.npcsAdded,l.npcsUpdated=A.npcsUpdated,w&&l.dialogueSetup){const R=new Set([...i.map(j=>j.name),...l.npcsAdded.map(j=>j.name),...l.npcsUpdated.map(j=>j.name)]),C=[];for(const j of l.dialogueSetup.participants)if(R.has(j))C.push(j);else{console.warn(`parseAIResponse: Dialogue participant "${j}" is not among known or newly added/updated NPCs. Attempting name correction against this turn's NPCs.`);const v=await xn("dialogue participant",j,r??l.logMessage,d??l.sceneDescription,Array.from(R),n);v&&R.has(v)?(C.push(v),console.log(`parseAIResponse: Corrected dialogue participant name from "${j}" to "${v}".`)):console.warn(`parseAIResponse: Dialogue participant "${j}" could not be validated/corrected against this turn's NPCs. Discarding participant.`)}C.length===0&&l.dialogueSetup.participants.length>0?(console.warn("parseAIResponse: No valid dialogue participants remain after final name validation. Discarding dialogue attempt."),l.dialogueSetup=void 0,w=!1,(!Array.isArray(l.options)||l.options.length===0||!l.options.every(j=>typeof j=="string"&&j.trim()!==""))&&(console.warn("parseAIResponse: options invalid after dialogue cancellation. Resetting to default failsafe.",l.options),l.options=["Look around.","Ponder the situation.","Check inventory.","Try to move on.","Consider your objective.","Plan your next steps."])):l.dialogueSetup.participants=C}if(w)l.options=[];else{if(!Array.isArray(l.options)||l.options.length===0||!l.options.every(R=>typeof R=="string"&&R.trim()!==""))return console.warn("parseAIResponse: options are missing, empty, or invalid when not inDialogue (final check).",l.options),o==null||o(),null;for(;l.options.length<tn;)l.options.push("...");l.options.length>tn&&(l.options=l.options.slice(0,tn))}return l.objectiveAchieved=l.objectiveAchieved??!1,l.localTime=((f=l.localTime)==null?void 0:f.trim())??"Time Unknown",l.localEnvironment=((u=l.localEnvironment)==null?void 0:u.trim())??"Environment Undetermined",l.localPlace=((b=l.localPlace)==null?void 0:b.trim())??"Undetermined Location",wo(l),delete l.placesAdded,delete l.placesUpdated,l}catch(x){return console.warn("parseAIResponse: Failed to parse JSON response from AI. This attempt will be considered a failure.",x),console.debug("parseAIResponse: Original response text (before any processing):",e),console.debug("parseAIResponse: JSON string after fence stripping (if any, input to JSON.parse):",p),o==null||o(),null}}const Pr=async(e,t,n,o,r,d,i,g,c,p,m,f,u,b,x)=>(console.error("API Key not configured for Dialogue Service."),Promise.reject(new Error("API Key not configured."))),Ar=async e=>(console.error("API Key not configured for Dialogue Summary Service."),Promise.reject(new Error("API Key not configured."))),Dr=async e=>(console.error("API Key not configured for Dialogue Memory Summary Service."),null),Er=async e=>(console.error("refineLore_Service: API not configured"),null),Ua=async e=>(console.error("collectRelevantFacts_Service: API not configured"),null),za=async e=>(console.error("distillFacts_Service: API not configured"),null),Mr=e=>{const{getCurrentGameState:t,commitGameState:n,playerGenderProp:o,setError:r,setIsLoading:d,setLoadingReason:i,initiateDialogueExit:g,isDialogueExiting:c,addDebugEntry:p}=e;return{handleDialogueOptionSelect:s.useCallback(async f=>{const u=t(),b=u.currentThemeObject;if(!b||!u.dialogueState||c)return;const x={speaker:"Player",line:f},l=[...u.dialogueState.options],S=[...u.dialogueState.history,x],y=l.length>0&&f===l[l.length-1],w={...u,dialogueState:{...u.dialogueState,history:S,options:[]},lastTurnChanges:null};if(n(w),y)await g(w);else{d(!0),i("dialogue_turn"),r(null);try{const A=w.mapData.nodes.filter(k=>k.themeName===b.name&&k.data.nodeType!=="feature"),R=w.allNPCs.filter(k=>k.themeName===b.name),C=w.gameLog.slice(-Cn),j=bn(A,R,`${w.currentScene} ${f}`,"Locations mentioned:","NPCs mentioned:"),v=[...w.themeFacts].sort((k,N)=>N.tier-k.tier||N.createdTurn-k.createdTurn).map(k=>({text:k.text,tier:k.tier}));i("loremaster_collect");const P=await Ua({themeName:b.name,facts:v,lastScene:w.currentScene,playerAction:f,recentLogEntries:C,detailedContext:j});i("dialogue_turn");const M=(P==null?void 0:P.facts)??[],{parsed:z,prompt:O,rawResponse:F,thoughts:I}=await Pr(b,w.mainQuest,w.currentObjective,w.currentScene,w.localTime,w.localEnvironment,w.localPlace,A,w.allNPCs.filter(k=>k.themeName===b.name),w.inventory.filter(k=>k.holderId===ge),o,S,f,(()=>{if(!w.dialogueState)throw new Error("Dialogue state is not defined");return w.dialogueState.participants})(),M);p({prompt:O,rawResponse:F,thoughts:I});const L=t();if(z&&L.dialogueState){const k=[...S,...z.npcResponses],N={participants:z.updatedParticipants??L.dialogueState.participants,history:k,options:z.playerOptions};z.dialogueEnds&&(N.options=[]);const T={...L,dialogueState:N,lastTurnChanges:null};n(T),z.dialogueEnds&&await g(T)}else if(L.dialogueState){r("The conversation faltered. Try choosing an option again or ending the dialogue.");const k={...L.dialogueState};k.options.length===0&&(k.options=l.length>0?l:["End Conversation."]),n({...L,dialogueState:k,lastTurnChanges:null})}}catch(A){console.error("Error during dialogue turn:",A),r("An error occurred in the conversation. You might need to end it.");const R=t();if(R.dialogueState){const C=l.length>0?l:["Try to end the conversation."];n({...R,dialogueState:{...R.dialogueState,options:C},lastTurnChanges:null})}}finally{const A=t(),{dialogueState:R}=A;!!(R&&R.options.length===0&&R.history.length>0)||c||(d(!1),i(null))}}},[t,n,o,c,r,d,i,g,p])}},Fr=e=>{const{getCurrentGameState:t,commitGameState:n,playerGenderProp:o,setError:r,setIsLoading:d,setLoadingReason:i,onDialogueConcluded:g,getDialogueDebugLogs:c,clearDialogueDebugLogs:p}=e,[m,f]=s.useState(!1),u=s.useCallback(async x=>{var M,z;const l=x.currentThemeObject;(M=x.dialogueState)==null||M.history;const S=((z=x.dialogueState)==null?void 0:z.participants)??[];if(!l||!x.dialogueState){console.error("Cannot exit dialogue: current theme is null or not in dialogue state.",x),await g(null,x,{turns:c()}),p(),f(!1),d(!1),i(null);return}d(!0),i("dialogue_summary"),f(!0),r(null);const y=pe(x);i("dialogue_memory_creation"),l.name,y.currentScene,y.localTime,y.localEnvironment,y.localPlace;const A={summaryText:await Dr()??"A conversation took place, but the details are hazy.",participants:S,timestamp:y.localTime??"Unknown Time",location:y.localPlace??"Unknown Location"};y.allNPCs=y.allNPCs.map(O=>{if(S.includes(O.name)&&O.themeName===l.name){const F=[...O.dialogueSummaries??[],A];return F.length>sr&&F.shift(),{...O,dialogueSummaries:F}}return O}),i("dialogue_conclusion_summary"),y.mapData.nodes.filter(O=>O.themeName===l.name),y.mapData.edges.filter(O=>{const F=y.mapData.nodes.find(L=>L.id===O.sourceNodeId),I=y.mapData.nodes.find(L=>L.id===O.targetNodeId);return(F==null?void 0:F.themeName)===l.name&&(I==null?void 0:I.themeName)===l.name}),y.mainQuest,y.currentObjective,y.currentScene,y.localTime,y.localEnvironment,y.localPlace,y.allNPCs.filter(O=>O.themeName===l.name),y.inventory.filter(O=>O.holderId===ge),l.name;const{parsed:R,prompt:C,rawResponse:j,thoughts:v}=await Ar();y.dialogueState=null;const P={turns:c(),summaryPrompt:C,summaryRawResponse:j,summaryThoughts:v};await g(R,y,P),p(),f(!1)},[o,r,d,i,g,c,p]),b=s.useCallback(()=>{const x=t();if(x.dialogueState&&!m){const l={speaker:"Player",line:"(Forces the conversation to end)"},S=[...x.dialogueState.history,l],y={...x,dialogueState:{...x.dialogueState,history:S,options:[]},lastTurnChanges:null};n(y),u(y)}},[t,n,m,u]);return{isDialogueExiting:m,initiateDialogueExit:u,handleForceExitDialogue:b}},$r=e=>{const{getCurrentGameState:t,commitGameState:n,playerGenderProp:o,setError:r,setIsLoading:d,setLoadingReason:i,onDialogueConcluded:g}=e,c=s.useRef([]),p=S=>{c.current.push(S)},m=()=>c.current,f=()=>{c.current=[]},{isDialogueExiting:u,initiateDialogueExit:b,handleForceExitDialogue:x}=Fr({getCurrentGameState:t,commitGameState:n,playerGenderProp:o,setError:r,setIsLoading:d,setLoadingReason:i,onDialogueConcluded:g,getDialogueDebugLogs:m,clearDialogueDebugLogs:f}),{handleDialogueOptionSelect:l}=Mr({getCurrentGameState:t,commitGameState:n,playerGenderProp:o,setError:r,setIsLoading:d,setLoadingReason:i,initiateDialogueExit:b,isDialogueExiting:u,addDebugEntry:p});return{isDialogueExiting:u,handleDialogueOptionSelect:l,handleForceExitDialogue:x}},Rr=e=>$r(e),Or=(e,t)=>`Start a new adventure in the theme "${e.name}". ${e.systemInstructionModifier}
Player's Character Gender: "${t}"
Suggested Initial Scene: "${e.initialSceneDescriptionSeed}" (adjust for variety)
Suggested Initial Main Quest: "${e.initialMainQuest}" (adjust for variety)
Suggested Initial Current Objective: "${e.initialCurrentObjective}" (adjust for variety)
Suggested Initial New Items for the player: "${e.initialItems}" (adjust names and descriptions for variety)

The player's last action was unremarkableâ€”something common anyone would do in this situation.

Creatively generate variations of the main quest and current objective based on the suggestions, but make them noticeably different.
Creatively generate the initial scene description, action options, and items (variations based on 'New Items for the player'), along with a logMessage.
Creatively add any important quest item(s), if any, based on your generated quest and objective.

ALWAYS SET "mapUpdated": true.
ALWAYS REQUIRED: "mainQuest", "currentObjective", "localTime", "localEnvironment", and "localPlace".
`,Gr=(e,t,n)=>{const o=et(t," - ",!0,!0,!1,!1,!0);return`The player is entering a NEW theme "${e.name}" after a reality shift.
Player's Character Gender: "${n}"
Initial Scene: "${e.initialSceneDescriptionSeed}" (adapt to an arrival scene describing the disorienting transition).
Main Quest: "${e.initialMainQuest}" (adjust for variety)
Current Objective: "${e.initialCurrentObjective}" (adjust for variety)

Player's Current Inventory (brought from previous reality or last visit):
${o}

Generate the scene description for a disoriented arrival, and provide appropriate initial action options for the player to orient themselves.

List anachronistic Player's Items in playerItemsHint.

ALWAYS SET "mapUpdated": true.
ALWAYS REQUIRED: "mainQuest", "currentObjective", "localTime", "localEnvironment", and "localPlace".
`},_r=(e,t,n,o,r,d)=>{const i=et(t," - ",!0,!0,!1,!1,!0),g=r.nodes.filter(S=>S.themeName===e.name&&S.data.nodeType!=="feature"&&S.data.nodeType!=="room"),c=Tt(g,!1),p=d.filter(S=>S.presenceStatus==="companion"),m=p.length>0?ze(p," - ",!1,!1,!1,!0):"None",f=d.filter(S=>S.presenceStatus==="nearby"),u=f.length>0?ze(f," - ",!1,!1,!1,!0):"None",b=d.filter(S=>S.presenceStatus==="distant"||S.presenceStatus==="unknown"),x=b.length>0?ze(b," - ",!1,!1,!1,!0):"None specifically known in this theme yet.";return`The player is CONTINUING their adventure by re-entering the theme "${e.name}" after a reality shift.
Player's Character Gender: "${n}"
The Adventure Summary: "${o.summary}"
Main Quest: "${o.mainQuest}"
Current Objective: "${o.currentObjective}"

## Player's Current Inventory (brought from previous reality or last visit):
${i}

List anachronistic Player's Items in playerItemsHint.

## Known Locations:
${c}

## Known NPCs (including presence):
${x}

## Companions traveling with the Player:
${m}

## NPCs Player can interact with (nearby):
${u}

Describe the scene as they re-enter, potentially in a state of confusion from the shift, making it feel like a continuation or a new starting point consistent with the Adventure Summary and current quest/objective.
Provide appropriate action options for the player to orient themselves.

ALWAYS SET "mapUpdated": true.
ALWAYS REQUIRED: "mainQuest", "currentObjective", "localTime", "localEnvironment", and "localPlace".
`},Vr=(e,t,n,o,r,d,i,g,c,p,m,f,u,b,x,l,S,y,w)=>{var D;const A=n.length>0?et(n," - ",!0,!0,!1,!1,!0):"There are no items in player's inventory.",R=o.length>0?`There are items at this location: 
${et(o," - ",!0,!0,!1,!1,!0)}`:"There are no visible items at this location.",C=Tt(c,!0),j=p.filter(G=>G.presenceStatus==="companion"),v=j.length>0?ze(j," - ",!1,!1,!1,!0):"None",P=p.filter(G=>G.presenceStatus==="nearby"),M=P.length>0?ze(P," - ",!1,!1,!1,!0):"None",z=p.filter(G=>G.presenceStatus==="distant"||G.presenceStatus==="unknown"),O=z.length>0?ze(z," - ",!1,!1,!1,!0):"None specifically known in this theme yet.",F=m.length>0?m.map(G=>`- ${G}`).join(`
`):"None",I=Io(g),L=y.nodes.filter(G=>G.themeName===i.name),k=y.edges.filter(G=>{const Y=L.find(_=>_.id===G.sourceNodeId),$=L.find(_=>_.id===G.targetNodeId);return Y&&$}),N=jo(y,(S==null?void 0:S.id)??null,i,L,k),T=ko(y,(S==null?void 0:S.id)??null,w);let h="";if(T)h=T;else if(w){const G=y.nodes.find(X=>X.id===w),Y=(G==null?void 0:G.placeName)??w,$=G==null?void 0:G.data.parentNodeId,_=$&&$!=="Universe"?((D=y.nodes.find(X=>X.id===$))==null?void 0:D.placeName)??$:null;h=`Player wants to reach ${_?`${Y} in ${_}`:Y}, but does not know how to get there.`}const E=bn(c,p,`${e} ${t}`,"### Details on relevant locations mentioned in current scene or action:","### Details on relevant NPCs mentioned in current scene or action:");return`Based on the Previous Scene and Player Action, and taking into account the provided context (including map context), generate the next scene description, options, item changes, log message, etc.

## Context:
Player's Character Gender: "${x}"
Previous Local Time: "${f??"Unknown"}"
Previous Local Environment: "${u??"Undetermined"}"
Previous Local Place: "${b??"Undetermined Location"}"
Main Quest: "${r??"Not set"}"
Current Objective: "${d??"Not set"}"

### Player's Inventory:
${A}

### Items at Current Location:
${R}

### Known Locations:
${C}

### Known NPCs:
${O}

### Companions traveling with the Player:
${v}

### NPCs Player can interact with (nearby):
${M}

### Current Map Context (including your location, possible exits, nearby paths, and other nearby locations):
${N}

${E}

### Relevant Facts about the world:
${F}

### Recent Events to keep in mind (for context and continuity):
${I}
 - A bit later you look around and consider your next move.
IMPORTANT: Recent events are provided only for additional context. These actions have already been processed by the game and should NEVER trigger item actions again, to avoid double counting.

---

Current Theme: "${i.name}"
Previous Scene: "${e}"
Player Action: "${t}"
${h}`},Ur=e=>{const{getCurrentGameState:t,setGameStateStack:n,loadInitialGame:o,enabledThemePacksProp:r,playerGenderProp:d,stabilityLevelProp:i,chaosLevelProp:g,setError:c,setLoadingReason:p,isLoading:m}=e,f=s.useRef({}),u=s.useCallback(async(y,w)=>{if(f.current[y.name])return;f.current[y.name]=!0;const A=await Ir(y,w.currentScene,w.gameLog),R=w.mapData.nodes.filter(v=>v.themeName===y.name&&v.data.nodeType!=="feature"&&v.data.nodeType!=="room"),C=w.allNPCs.filter(v=>v.themeName===y.name),j={summary:A??"The details of this reality are hazy...",mainQuest:w.mainQuest??"Unknown",currentObjective:w.currentObjective??"Unknown",placeNames:R.map(v=>v.placeName),npcNames:C.map(v=>v.name)};n(v=>{const P={...v[0]};return P.themeHistory={...P.themeHistory,[y.name]:j},[P,v[1]]}),f.current[y.name]=!1},[n]),b=s.useCallback((y=!1)=>{const w=t(),A=w.currentThemeObject;if(!A||m)return;u(A,w),p("reality_shift_load");const R=(()=>{if(w.pendingNewThemeNameAfterShift&&!w.isAwaitingManualShiftThemeSelection)return w.pendingNewThemeNameAfterShift;if(!w.isAwaitingManualShiftThemeSelection){const j=Sa(r);return Lo(j,A.name)}return null})();if(!R&&!w.isAwaitingManualShiftThemeSelection){c("Could not select a new theme for reality shift. Current theme remains."),p(null);return}const C=w.isCustomGameMode;n(j=>{let v={...j[0]};const P=v.inventory,M=v.score,z=v.themeHistory,O=v.mapData,F=v.allNPCs,I=v.mapLayoutConfig,L=v.globalTurnNumber,k=v.debugLore,N=v.debugGoodFacts,T=v.debugBadFacts;return v=Ft(),v.inventory=P,v.score=M,v.themeHistory=z,v.mapData=O,v.allNPCs=F,v.mapLayoutConfig=I,v.globalTurnNumber=L,v.debugLore=k,v.debugGoodFacts=N,v.debugBadFacts=T,v.pendingNewThemeNameAfterShift=R,v.currentThemeName=null,v.currentThemeObject=null,v.dialogueState=null,v.turnsSinceLastShift=0,v.isCustomGameMode=C,v.isAwaitingManualShiftThemeSelection=w.isAwaitingManualShiftThemeSelection,y&&(v.score=Math.max(0,v.score-10)),v.playerGender=d,v.enabledThemePacks=r,v.stabilityLevel=i,v.chaosLevel=g,[v,j[1]]}),!w.isAwaitingManualShiftThemeSelection&&R&&o({explicitThemeName:R,isTransitioningFromShift:!0,customGameFlag:C})},[t,r,u,o,c,p,n,d,i,g,m]),x=s.useCallback(()=>{const y=t(),w=y.currentThemeObject;!w||m||(c("MANUAL SHIFT! Reality destabilizes..."),u(w,y),y.isCustomGameMode?n(A=>[{...A[0],isAwaitingManualShiftThemeSelection:!0,lastActionLog:"You focus your will, preparing to choose a new reality..."},A[1]]):b(!1))},[t,u,b,c,n,m]),l=s.useCallback(y=>{t().isAwaitingManualShiftThemeSelection&&(p("reality_shift_load"),n(A=>[{...A[0],isAwaitingManualShiftThemeSelection:!1,pendingNewThemeNameAfterShift:y,lastActionLog:`You chose to shift reality to: ${y}. The world warps around you!`},A[1]]),o({explicitThemeName:y,isTransitioningFromShift:!0,customGameFlag:!0}))},[t,n,o,p]),S=s.useCallback(()=>{n(y=>[{...y[0],isAwaitingManualShiftThemeSelection:!1,lastActionLog:"You decide against manually shifting reality for now."},y[1]]),c(null),p(null)},[n,c,p]);return{triggerRealityShift:b,executeManualRealityShift:x,completeManualShiftWithSelectedTheme:l,cancelManualShiftThemeSelection:S}},zr=({loadingReasonRef:e,setLoadingReason:t,setError:n})=>({processMapUpdates:s.useCallback(async(r,d,i,g,c)=>{try{await Po(r,d,i,g,e.current,t,c)}catch(p){throw n(p instanceof Error?p.message:String(p)),p}},[e,t,n])}),Br=(e,t,n,o,r,d,i,g,c,p,m)=>{const f=r.length>0?JSON.stringify(r,null,2):"[]";return`- Player's Last Action: ${e}
- Player Items Hint: "${t}";
- World Items Hint: "${n}";
- NPC Items Hint: "${o}".

${f?`New Items from Storyteller AI or Dialogue AI:
${f}
`:""}
${d?`Current Player's Inventory:
${d}
`:""}
${i?`Current Location Inventory - ID: ${g??"unknown"}
${i}
`:""}
${c?`Companions Inventory:
${c}
`:""}
${p?`Nearby NPCs Inventory:
${p}
`:""}
${m?`Nearby Map Context where you can put Items:
${m}
`:""}

Provide the inventory update as JSON as described in the SYSTEM_INSTRUCTION.`},Hr=async e=>(console.error("API Key not configured for Inventory Service."),Promise.reject(new Error("API Key not configured."))),Wr=(e,t)=>{for(const n of t){const o=n.chapters;if(!o||o.length===0)continue;const r=e.find(d=>d.action==="create"&&d.item.name===n.name);if(r&&r.action==="create"){const d=r.item;(!d.chapters||d.chapters.length!==o.length)&&(d.chapters=o)}}},Jr=async(e,t,n,o,r,d,i,g,c,p,m,f,u,b)=>{var v;const x=(e==null?void 0:e.trim())??"",l=(t==null?void 0:t.trim())??"",S=(n==null?void 0:n.trim())??"";if(!x&&!l&&!S&&o.length===0)return{itemChanges:[],debugInfo:null};Br(r,x,l,S,o,d,i,g,c,p,b);const{response:y,thoughts:w,systemInstructionUsed:A,jsonSchemaUsed:R,promptUsed:C}=await Hr();let j=or(y.text??"");if(!j||j.itemChanges.length===0&&(((v=y.text)==null?void 0:v.trim())??"")!=="[]"){const P=await rr(y.text??"");P&&(j={itemChanges:P})}if(j){Wr(j.itemChanges,o);for(const P of j.itemChanges){if(P.action==="addDetails"&&P.invalidPayload){const M=await lr(JSON.stringify(P.invalidPayload));M&&(P.item=M,delete P.invalidPayload)}if(P.action==="create"&&P.item.type==="book"){const M=P.item.chapters??[];if(M.length<nn){const z=await ir(P.item.name,P.item.description,M.map(O=>O.heading),nn-M.length);z&&z.length>0&&(P.item.chapters=M.concat(z).slice(0,nn))}}}}return{itemChanges:j?j.itemChanges:[],debugInfo:{prompt:C,systemInstruction:A,jsonSchema:R,rawResponse:y.text??"",parsedItemChanges:j?j.itemChanges:void 0,observations:j==null?void 0:j.observations,rationale:j==null?void 0:j.rationale,thoughts:w}}},Gt=async(e,t,n,o,r,d,i,g,c,p,m="",f)=>(console.error("generatePageText: API key not configured."),null),Kr=async({aiItemChanges:e,aiData:t,theme:n,baseState:o,playerActionText:r,loadingReason:d,setLoadingReason:i})=>{if(!n)return[...e];const g=[];for(const c of e){let p={...c};if("item"in p&&p.item.type==="immovable"){if(p.action==="create"){const m=p.item;m.holderId.startsWith("node_")||(m.holderId=o.currentMapNodeId??"unknown")}else if(p.action==="move"){const m=p.item;m.newHolderId.startsWith("node_")||(m.newHolderId=o.currentMapNodeId??"unknown")}}if(p.action==="destroy"){const m=p.item,f=m.name;if(!o.inventory.filter(l=>l.holderId===ge).find(l=>{const S=m.id!==void 0&&l.id===m.id,y=m.name!==void 0&&l.name===m.name;return S||y})){const l=d;i("correction");const S=await xn("item",f??"",t.logMessage,"sceneDescription"in t?t.sceneDescription:o.currentScene,o.inventory.filter(y=>y.holderId===ge).map(y=>y.name));S&&(p.item={id:S,name:S}),i(l)}const b=`${t.logMessage??""} ${"sceneDescription"in t?t.sceneDescription:""} ${r??""}`.toLowerCase();if(["drop","dropped","leave","left","put down","set down","place","placed"].some(l=>b.includes(l))){const l=o.inventory.find(S=>S.holderId===ge&&(m.id!=null&&S.id===m.id||m.name!=null&&S.name.toLowerCase()===m.name.toLowerCase()));l&&(p={action:"create",item:{...l,holderId:o.currentMapNodeId??"unknown"}})}}g.push(p)}return g},Yr=async({aiData:e,theme:t,draftState:n,baseState:o,turnChanges:r,processMapUpdates:d})=>{t&&await d(e,n,o,t,r)},Qr=async({aiData:e,theme:t,draftState:n,baseState:o,correctedItemChanges:r,playerActionText:d,loadingReason:i,setLoadingReason:g})=>{const c=o.inventory.filter(x=>x.holderId===ge),p=o.inventory.filter(x=>x.holderId===o.currentMapNodeId),m=o.allNPCs.filter(x=>x.presenceStatus==="companion"),f=o.allNPCs.filter(x=>x.presenceStatus==="nearby"),u=x=>x.length===0?"None.":x.map(l=>{const S=o.inventory.filter(y=>y.holderId===l.id);return`ID: ${l.id} - ${l.name}: ${et(S," - ",!0,!0,!1,!0)}`}).join(`
`);let b=[...r];if(t){const x=i;g("inventory");const l=Mo(n.mapData,n.currentMapNodeId,o.inventory),S=await Jr("playerItemsHint"in e?e.playerItemsHint:void 0,"worldItemsHint"in e?e.worldItemsHint:void 0,"npcItemsHint"in e?e.npcItemsHint:void 0,"newItems"in e&&Array.isArray(e.newItems)?e.newItems:[],d??"",et(c," - ",!0,!0,!1,!0),et(p," - ",!0,!0,!1,!0),o.currentMapNodeId??null,u(m),u(f),"sceneDescription"in e?e.sceneDescription:o.currentScene,e.logMessage,t,l);g(x),S&&(b=b.concat(S.itemChanges),n.lastDebugPacket&&(n.lastDebugPacket.inventoryDebugInfo=S.debugInfo))}return{combinedItemChanges:b,baseInventoryForPlayer:c}},Xr=(e,t,n)=>{"dialogueSetup"in t&&t.dialogueSetup?(e.actionOptions=[],e.dialogueState={participants:t.dialogueSetup.participants,history:t.dialogueSetup.initialNpcResponses,options:t.dialogueSetup.initialPlayerOptions}):n&&(e.dialogueState=null)},qr=({loadingReasonRef:e,setLoadingReason:t,setError:n,setGameStateStack:o,debugLore:r,openDebugLoreModal:d})=>{const{processMapUpdates:i}=zr({loadingReasonRef:e,setLoadingReason:t,setError:n}),g=s.useRef(null),c=s.useCallback(()=>{g.current&&(clearTimeout(g.current),g.current=null)},[]);return{processAiResponse:s.useCallback(async(m,f,u,b)=>{var M,z,O,F,I,L,k,N,T,h;const{baseStateSnapshot:x,isFromDialogueSummary:l=!1,scoreChangeFromAction:S=0,playerActionText:y}=b,w={itemChanges:[],npcChanges:[],objectiveAchieved:!1,objectiveTextChanged:!1,mainQuestTextChanged:!1,localTimeChanged:!1,localEnvironmentChanged:!1,localPlaceChanged:!1,currentMapNodeIdChanged:!1,scoreChangedBy:S,mapDataChanged:!1};if(!m){n("The Dungeon Master's connection is unstable... (Invalid AI response after retries)"),!l&&"actionOptions"in u&&(u.actionOptions=["Try to wait for the connection to improve.","Consult the ancient network spirits.","Check your own connection.","Sigh dramatically."]),u.lastActionLog="The Dungeon Master seems to be having trouble communicating the outcome of your last action.",u.localTime=u.localTime??"Time Unknown",u.localEnvironment=u.localEnvironment??"Environment Undetermined",u.localPlace=u.localPlace??"Undetermined Location",u.lastTurnChanges=w,u.dialogueState=null;return}u.lastDebugPacket={...u.lastDebugPacket??{},prompt:((M=u.lastDebugPacket)==null?void 0:M.prompt)??"Prompt not captured for this state transition",rawResponseText:((z=u.lastDebugPacket)==null?void 0:z.rawResponseText)??"Raw text not captured",parsedResponse:m,timestamp:new Date().toISOString(),mapUpdateDebugInfo:null,inventoryDebugInfo:null,loremasterDebugInfo:((O=u.lastDebugPacket)==null?void 0:O.loremasterDebugInfo)??{collect:null,extract:null,integrate:null,distill:null,journal:null}},m.localTime!==void 0&&(u.localTime!==m.localTime&&(w.localTimeChanged=!0),u.localTime=m.localTime),m.localEnvironment!==void 0&&(u.localEnvironment!==m.localEnvironment&&(w.localEnvironmentChanged=!0),u.localEnvironment=m.localEnvironment),m.localPlace!==void 0&&(u.localPlace!==m.localPlace&&(w.localPlaceChanged=!0),u.localPlace=m.localPlace),m.mainQuest!==void 0&&(u.mainQuest!==m.mainQuest&&(w.mainQuestTextChanged=!0),u.mainQuest=m.mainQuest);const A=u.currentObjective;m.currentObjective!==void 0&&(u.currentObjective!==m.currentObjective&&(w.objectiveTextChanged=!0),u.currentObjective=m.currentObjective),c();let R=null;m.currentObjective!==void 0&&m.currentObjective!==A?R=m.objectiveAchieved?"success":"neutral":m.objectiveAchieved&&A!==null&&(R="success"),R?(u.objectiveAnimationType=R,g.current=window.setTimeout(()=>{o(E=>[{...E[0],objectiveAnimationType:null},E[1]]),g.current=null},5e3)):u.objectiveAnimationType=null,w.objectiveAchieved=m.objectiveAchieved??!1,m.objectiveAchieved&&(u.score=u.score+1,w.scoreChangedBy+=1),"sceneDescription"in m&&m.sceneDescription&&(u.currentScene=m.sceneDescription),m.options.length>0&&!m.dialogueSetup?u.actionOptions=m.options:!l&&!m.dialogueSetup&&(u.actionOptions=["Look around.","Ponder your situation.","Check your inventory.","Wait for something to happen.","Consider your objective.","Plan your next steps."]);const C=m.itemChange,j=await Kr({aiItemChanges:C,aiData:m,theme:f,baseState:x,playerActionText:y,loadingReason:e.current,setLoadingReason:t});await Yr({aiData:m,theme:f,draftState:u,baseState:x,turnChanges:w,processMapUpdates:i});const{combinedItemChanges:v,baseInventoryForPlayer:P}=await Qr({aiData:m,theme:f,draftState:u,baseState:x,correctedItemChanges:j,playerActionText:y,loadingReason:e.current,setLoadingReason:t});if(w.itemChanges=Ao(v,P),u.inventory=Do(v,b.forceEmptyInventory?[]:x.inventory),m.logMessage?(u.gameLog=Na(u.gameLog,m.logMessage,$a),u.lastActionLog=m.logMessage):l||(u.lastActionLog="The Dungeon Master remains silent on the outcome of your last action."),f){for(const E of v)if(E.action==="addDetails"){const V=Eo([E.item.id,E.item.name],u.inventory,!1,!0);if(!V)continue;const D=(F=E.item.chapters)==null?void 0:F[0];if(!D)continue;const{name:G,systemInstructionModifier:Y}=f,$=u.mapData.nodes.filter(q=>q.themeName===G&&q.data.nodeType!=="feature"&&q.data.nodeType!=="room"),_=Tt($,!0),K=u.allNPCs.filter(q=>q.themeName===G),X=K.length>0?ze(K," - ",!1,!1,!1,!0):"None specifically known in this theme yet.";(L=(I=V.chapters)==null?void 0:I[V.chapters.length-1])==null||L.actualContent;const ae=((k=u.lastDebugPacket.storytellerThoughts)==null?void 0:k.slice(-1)[0])??"",le=await Gt(D.heading,D.description,D.contentLength,G,Y,u.currentScene,ae,_,X,u.mainQuest,`Take into account: ${u.lastActionLog??""}`);if(le){const q=V.tags??[];let ie=le;q.includes("foreign")?ie=await Gt(D.heading,D.description,D.contentLength,G,Y,u.currentScene,ae,_,X,u.mainQuest,`Translate the following text into an artificial nonexistent language that fits the theme and context:
"""${le}"""`)??le:q.includes("encrypted")?ie=wa(le):q.includes("runic")&&(ie=Ta(le)),q.includes("torn")&&!q.includes("recovered")&&(ie=Ia(ie));const xe={...D,actualContent:le,visibleContent:ie},ee=u.inventory.findIndex(Ie=>Ie.id===V.id),me={...V,chapters:[...V.chapters??[],xe],lastInspectTurn:void 0};u.inventory[ee]=me}}}if(f){const E=((N=u.lastDebugPacket.storytellerThoughts)==null?void 0:N.join(`
`))??"";l?[b.dialogueTranscript??"",E?`
  ## Storyteller's Thoughts:
${E}
------`:""].filter(Boolean).join(`
`):[y?`Action: ${y}`:"",m.sceneDescription,m.logMessage??"",E?`
  ## Storyteller's Thoughts:

${E}
------`:""].filter(Boolean).join(`
`);const V=u.mapData.nodes.filter(_=>_.themeName===f.name&&_.data.nodeType!=="feature"&&_.data.nodeType!=="room"),D=u.allNPCs.filter(_=>_.themeName===f.name),G=u.inventory.filter(_=>_.holderId===ge||V.some(K=>K.id===_.holderId)||D.some(K=>K.id===_.holderId));[`Node IDs: ${V.map(_=>_.id).join(", ")}`,`NPC IDs: ${D.map(_=>_.id).join(", ")}`,`Item IDs: ${G.map(_=>_.id).join(", ")}`].join(`
`);const Y=e.current,$=await Er({themeName:f.name,existingFacts:u.themeFacts});u.lastDebugPacket.loremasterDebugInfo&&(u.lastDebugPacket.loremasterDebugInfo.extract=((T=$==null?void 0:$.debugInfo)==null?void 0:T.extract)??null,u.lastDebugPacket.loremasterDebugInfo.integrate=((h=$==null?void 0:$.debugInfo)==null?void 0:h.integrate)??null),$!=null&&$.refinementResult&&yn(u,$.refinementResult.factsChange,u.globalTurnNumber,f.name),t(Y)}Xr(u,m,l),u.lastTurnChanges=w},[e,t,n,o,i,c,r,d]),clearObjectiveAnimationTimer:c}},Zr=({getCurrentGameState:e,commitGameState:t,isLoading:n})=>{const o=s.useRef(e);s.useEffect(()=>{o.current=e},[e]);const r=s.useCallback((x,l)=>{var v;const S=e();if(n||S.dialogueState)return;const y=S.inventory.find(P=>P.name===x&&P.holderId===ge);if(!y)return;const w=pe(S),A=S.currentMapNodeId??"unknown";w.inventory=w.inventory.map(P=>{if(P.name!==x||P.holderId!==ge)return P;const M=P.type==="page"||P.type==="book"||P.type==="picture"||P.type==="map";return{...P,holderId:A,...M?{stashed:!1}:{}}});const C={itemChanges:[{type:"loss",lostItem:{...y}}],npcChanges:[],objectiveAchieved:!1,objectiveTextChanged:!1,mainQuestTextChanged:!1,localTimeChanged:!1,localEnvironmentChanged:!1,localPlaceChanged:!1,currentMapNodeIdChanged:!1,scoreChangedBy:0,mapDataChanged:!1};w.lastTurnChanges=C;let j=l;if(!j){const P=((v=S.mapData.nodes.find(M=>M.id===A))==null?void 0:v.placeName)??S.localPlace??"Unknown Place";y.type==="vehicle"&&!y.isActive?j=`You left your ${x} parked at ${P}.`:j=`You left your ${x} at ${P}.`}j&&(w.gameLog=Na(w.gameLog,j,$a),w.lastActionLog=j),t(w)},[e,t,n]),d=s.useCallback(x=>{var j;const l=e();if(n||l.dialogueState)return;const S=l.currentMapNodeId;if(!S)return;const y=ja(l.mapData,S),w=l.inventory.find(v=>v.name!==x?!1:v.holderId===S?!0:y.includes(v.holderId));if(!w)return;const A=pe(l);A.inventory=A.inventory.map(v=>v.name===x&&v.holderId===w.holderId?{...v,holderId:ge}:v);const C={itemChanges:[{type:"acquire",acquiredItem:{...w,holderId:ge}}],npcChanges:[],objectiveAchieved:!1,objectiveTextChanged:!1,mainQuestTextChanged:!1,localTimeChanged:!1,localEnvironmentChanged:!1,localPlaceChanged:!1,currentMapNodeIdChanged:!1,scoreChangedBy:0,mapDataChanged:!1};A.lastTurnChanges=C,A.gameLog=Fo(A.gameLog,x),(j=A.lastActionLog)!=null&&j.startsWith(`You left your ${x}`)&&(A.lastActionLog=null),t(A)},[e,t,n]),i=s.useCallback((x,l,S,y,w)=>{const A=o.current(),R=pe(A);R.inventory=R.inventory.map(C=>{if(C.id!==x)return C;if(C.chapters){const j=typeof y=="number"?y:0,v=C.chapters.map((P,M)=>{if(M!==j)return P;const z={...P};return l!==void 0&&(z.actualContent=l),S!==void 0&&(z.visibleContent=S),w!==void 0&&(z.imageData=w),z});return{...C,chapters:v}}return C}),t(R)},[t]),g=s.useCallback((x,l)=>{const S=o.current(),y=pe(S);y.inventory=y.inventory.map(w=>{if(w.id!==x)return w;const A={...l,heading:aa(l.heading,w.chapters??[])};return{...w,chapters:[...w.chapters??[],A],lastWriteTurn:S.globalTurnNumber}}),t(y)},[t]),c=s.useCallback((x,l)=>{const S=o.current(),y=pe(S),w={...x,heading:aa(x.heading,y.playerJournal)};y.playerJournal=[...y.playerJournal,w],y.lastJournalWriteTurn=S.globalTurnNumber,l&&(y.lastDebugPacket??(y.lastDebugPacket={prompt:"",rawResponseText:null,parsedResponse:null,timestamp:new Date().toISOString(),storytellerThoughts:null,mapUpdateDebugInfo:null,inventoryDebugInfo:null,loremasterDebugInfo:{collect:null,extract:null,integrate:null,distill:null,journal:null},dialogueDebugInfo:null}),y.lastDebugPacket.loremasterDebugInfo&&(y.lastDebugPacket.loremasterDebugInfo.journal=l)),t(y)},[t]),p=s.useCallback((x,l)=>{const S=o.current(),y=typeof l=="number"?l:0;if(y<0||y>=S.playerJournal.length)return;const w=pe(S);w.playerJournal=w.playerJournal.map((A,R)=>R===y?{...A,actualContent:x}:A),t(w)},[t]),m=s.useCallback(()=>{const x=o.current(),l=pe(x);return l.lastJournalInspectTurn=x.globalTurnNumber,t(l),l},[t]),f=s.useCallback((x,l)=>{const S=o.current(),y=pe(S),w=y.inventory.map(A=>{if(A.id!==x)return A;const R=A.tags??[];return R.includes(l)?A:{...A,tags:[...R,l]}});y.inventory=w,t(y)},[t]),u=s.useCallback(x=>{const l=e();if(n||l.dialogueState)return;const S=pe(l);S.inventory=S.inventory.map(y=>y.name===x&&y.holderId===ge?{...y,stashed:!y.stashed}:y),S.lastTurnChanges=l.lastTurnChanges,t(S)},[e,t,n]),b=s.useCallback((x,l)=>{const S=l??o.current(),y=pe(S);return y.inventory=y.inventory.map(w=>w.id===x?{...w,lastInspectTurn:S.globalTurnNumber}:w),t(y),y},[t]);return{handleDropItem:r,handleTakeLocationItem:d,updateItemContent:i,addJournalEntry:g,addPlayerJournalEntry:c,updatePlayerJournalContent:p,addTag:f,recordInspect:b,recordPlayerJournalInspect:m,handleStashToggle:u}},el=e=>{const{getCurrentGameState:t,commitGameState:n,setGameStateStack:o,playerGenderProp:r,stabilityLevelProp:d,chaosLevelProp:i,setIsLoading:g,setLoadingReason:c,setError:p,setParseErrorCounter:m,triggerRealityShift:f,executeManualRealityShift:u,freeFormActionText:b,setFreeFormActionText:x,isLoading:l,hasGameBeenInitialized:S,loadingReasonRef:y,debugLore:w,openDebugLoreModal:A}=e,{processAiResponse:R,clearObjectiveAnimationTimer:C}=qr({loadingReasonRef:y,setLoadingReason:c,setError:p,setGameStateStack:o,debugLore:w,openDebugLoreModal:A}),{handleDropItem:j,handleTakeLocationItem:v,updateItemContent:P,addJournalEntry:M,addPlayerJournalEntry:z,updatePlayerJournalContent:O,recordPlayerJournalInspect:F,recordInspect:I,handleStashToggle:L}=Zr({getCurrentGameState:t,commitGameState:n,isLoading:l}),k=s.useCallback(async D=>{const G=D.currentThemeObject;if(G&&D.globalTurnNumber>0&&D.globalTurnNumber%Ra===0&&D.lastLoreDistillTurn!==D.globalTurnNumber){const Y=D.mapData.nodes.filter(_=>_.themeName===G.name);Array.from(new Set(D.inventory.filter(_=>_.holderId===ge||Y.some(X=>X.id===_.holderId)?!0:!!D.allNPCs.find(X=>X.id===_.holderId&&X.themeName===G.name)).map(_=>_.name))),Y.map(_=>_.placeName),c("loremaster_refine");const $=await za({themeName:G.name,facts:D.themeFacts,currentQuest:D.mainQuest,currentObjective:D.currentObjective});D.lastLoreDistillTurn=D.globalTurnNumber,D.lastDebugPacket??(D.lastDebugPacket={prompt:"",rawResponseText:null,parsedResponse:null,timestamp:new Date().toISOString(),storytellerThoughts:null,mapUpdateDebugInfo:null,inventoryDebugInfo:null,loremasterDebugInfo:{collect:null,extract:null,integrate:null,distill:null,journal:null},dialogueDebugInfo:null}),D.lastDebugPacket.loremasterDebugInfo&&(D.lastDebugPacket.loremasterDebugInfo.distill=($==null?void 0:$.debugInfo)??null),$!=null&&$.refinementResult&&yn(D,$.refinementResult.factsChange,D.globalTurnNumber,G.name)}},[c]),N=s.useCallback(async(D,G=!1,Y)=>{const $=Y??t();if(l||$.dialogueState)return;g(!0),p(null),m(0),x("");const _=pe($),K=G?-vt:0,X=$.currentThemeObject;if(!X){p("Critical error: Current theme object not found. Cannot proceed."),g(!1),c(null);return}const ae=$.gameLog.slice(-Cn),le=$.mapData.nodes.filter(J=>J.themeName===X.name&&J.data.nodeType!=="feature"&&J.data.nodeType!=="room"),q=$.allNPCs.filter(J=>J.themeName===X.name),ie=$.currentMapNodeId?$.mapData.nodes.find(J=>J.id===$.currentMapNodeId)??null:null,xe=$.inventory.filter(J=>J.holderId!==ge&&J.holderId===$.currentMapNodeId);bn(le,q,`${$.currentScene} ${D}`,"Locations mentioned:","NPCs mentioned:"),[...$.themeFacts].sort((J,ne)=>ne.tier-J.tier||ne.createdTurn-J.createdTurn).map(J=>({text:J.text,tier:J.tier})),c("loremaster_collect");const ee=await Ua({themeName:X.name,lastScene:$.currentScene}),me=(ee==null?void 0:ee.facts)??[],Ie=Vr($.currentScene,D,$.inventory.filter(J=>J.holderId===ge),xe,$.mainQuest,$.currentObjective,X,ae,le,q,me,$.localTime,$.localEnvironment,$.localPlace,r,$.themeHistory,ie,$.mapData,$.destinationNodeId);let se=pe($);const U={prompt:Ie,systemInstruction:cn,jsonSchema:void 0,rawResponseText:null,parsedResponse:null,timestamp:new Date().toISOString(),storytellerThoughts:null,mapUpdateDebugInfo:null,inventoryDebugInfo:null,loremasterDebugInfo:{collect:(ee==null?void 0:ee.debugInfo)??null,extract:null,integrate:null,distill:null,journal:null},dialogueDebugInfo:null};se.lastDebugPacket=U,G&&(se.score-=vt);let H=!1;try{c("storyteller");const{response:J,thoughts:ne,systemInstructionUsed:Se,jsonSchemaUsed:he,promptUsed:je}=await un(Ie);se.lastDebugPacket={...se.lastDebugPacket,rawResponseText:J.text??null,storytellerThoughts:ne,systemInstruction:Se,jsonSchema:he,prompt:je};const $e={nodes:se.mapData.nodes.filter(Ne=>Ne.themeName===X.name),edges:se.mapData.edges.filter(Ne=>{const De=se.mapData.nodes.find(Ee=>Ee.id===Ne.sourceNodeId),Pe=se.mapData.nodes.find(Ee=>Ee.id===Ne.targetNodeId);return(De==null?void 0:De.themeName)===X.name&&(Pe==null?void 0:Pe.themeName)===X.name})},Ae=await dn(J.text??"",r,X,()=>{m(1)},$.lastActionLog??void 0,$.currentScene,q,$e,$.inventory.filter(Ne=>Ne.holderId===ge));await R(Ae,X,se,{baseStateSnapshot:_,scoreChangeFromAction:K,playerActionText:D})}catch(J){if(H=!0,console.error("Error executing player action:",J),ka(J)){const ne=La(J);p(`AI service error (${String(ne??"unknown")}). Please retry.`)}else{const ne=J instanceof Error?J.message:String(J);p(`The Dungeon Master's connection seems unstable. Error: (${ne}). Please try again or consult the game log.`)}se=pe(_),se.lastActionLog=`Your action ("${D}") caused a ripple in reality, but the outcome is obscured.`,se.actionOptions=["Look around.","Ponder the situation.","Check your inventory.","Try to move on.","Consider your objective.","Plan your next steps."],se.dialogueState=null,se.lastDebugPacket={...U,error:J instanceof Error?J.message:String(J)}}finally{if(H||(se.turnsSinceLastShift+=1,se.globalTurnNumber+=1,await k(se)),n(se),g(!1),c(null),!se.isCustomGameMode&&!se.dialogueState){const J=X.name===se.pendingNewThemeNameAfterShift?0:d;se.turnsSinceLastShift>J&&Math.random()*100<i&&(p("CHAOS SHIFT! Reality fractures without warning!"),f(!0))}}},[t,n,l,r,d,i,f,g,c,p,m,x,R,k]),T=s.useCallback(D=>{var _;const G=t();let Y=D;const $=$o(G.inventory.map(K=>({name:K.name,type:"item",description:K.description,item:K})));if($){const{regex:K,lookup:X}=$,ae=new Set;let le;for(;(le=K.exec(D))!==null;){const q=X.get(le[0].toLowerCase()),ie=q==null?void 0:q.entityData.item;ie&&(ie.type==="book"||ie.type==="page")&&ae.add(ie)}for(const q of ae){const ie=(_=q.tags)==null?void 0:_.includes("recovered"),xe=(q.chapters??[]).map(ee=>`${ee.heading}
${ie?ee.actualContent??"":ee.visibleContent??""}`).join(`

`);Y+=`
The contents of the ${q.name} follow:
${xe}`}}if(D==="Try to force your way back to the previous reality."){const K=Object.keys(G.themeHistory).pop();if(K){const X={...G,pendingNewThemeNameAfterShift:K};o(ae=>[X,ae[1]]),G.isCustomGameMode?u():f()}else p("No previous reality to return to.")}else N(Y)},[t,N,f,p,o,u]),h=s.useCallback((D,G,Y,$)=>{var _;if(G==="inspect"){const K=I(D.id,$);if(D.type==="book"||D.type==="page"){const X=(_=D.tags)==null?void 0:_.includes("recovered"),ae=(D.chapters??[]).map(le=>`${le.heading}
${X?le.actualContent??"":le.visibleContent??""}

`).join("");N(`Player reads the ${D.name} - ${D.description}. Here's what the player reads:
${ae}`,!1,K)}else N(`Player investigates the ${D.name} - ${D.description}.`,!1,K)}else G==="specific"&&Y?N(Y.promptEffect):G==="generic"&&N(`Attempt to use: ${D.name}`)},[N,I]),E=s.useCallback(()=>{const D=t();b.trim()&&D.score>=vt&&!l&&S&&!D.dialogueState&&N(b.trim(),!0)},[b,t,l,S,N]),V=s.useCallback(()=>{o(D=>{const[G,Y]=D;return Y&&G.globalTurnNumber>0?(C(),[Y,G]):D})},[o,C]);return{processAiResponse:R,executePlayerAction:N,handleActionSelect:T,handleItemInteraction:h,handleDropItem:j,handleTakeLocationItem:v,updateItemContent:P,addJournalEntry:M,addPlayerJournalEntry:z,updatePlayerJournalContent:O,handleStashToggle:L,recordPlayerJournalInspect:F,handleFreeFormActionSubmit:E,handleUndoTurn:V}},xt=()=>({IDEAL_EDGE_LENGTH:Da,NESTED_PADDING:Aa,NESTED_ANGLE_PADDING:Pa,LABEL_MARGIN_PX:Ot,LABEL_LINE_HEIGHT_EM:Rt,LABEL_OVERLAP_MARGIN_PX:Ga,ITEM_ICON_SCALE:Oa}),tl=e=>{const{setGameStateStack:t}=e,n=s.useCallback(i=>{t(g=>{const c=g[0].mapLayoutConfig;return c.IDEAL_EDGE_LENGTH===i.IDEAL_EDGE_LENGTH&&c.NESTED_PADDING===i.NESTED_PADDING&&c.NESTED_ANGLE_PADDING===i.NESTED_ANGLE_PADDING&&c.LABEL_OVERLAP_MARGIN_PX===i.LABEL_OVERLAP_MARGIN_PX&&c.ITEM_ICON_SCALE===i.ITEM_ICON_SCALE?g:[{...g[0],mapLayoutConfig:i},g[1]]})},[t]),o=s.useCallback(i=>{t(g=>[{...g[0],mapViewBox:i},g[1]])},[t]),r=s.useCallback(i=>{t(g=>{const c=g[0];let p=!1;const m=new Map(c.mapData.nodes.map(b=>[b.id,{...b}]));for(const b of i){const x=m.get(b.id);if(x){const l=x.position.x!==b.position.x||x.position.y!==b.position.y,S=b.data.visualRadius!==void 0&&x.data.visualRadius!==b.data.visualRadius;(l||S)&&(x.position={...b.position},b.data.visualRadius!==void 0&&(x.data.visualRadius=b.data.visualRadius),p=!0)}}const f={...c.mapData,nodes:Array.from(m.values())},u={...c,mapData:f};return p?[u,g[1]]:g})},[t]),d=s.useCallback(i=>{t(g=>[{...g[0],destinationNodeId:i},g[1]])},[t]);return{handleMapLayoutConfigChange:n,handleMapViewBoxChange:o,handleMapNodesPositionChange:r,handleSelectDestinationNode:d}},nl=e=>{const{setGameStateStack:t}=e,n=tl({setGameStateStack:t});return{...el(e),...n}},al=e=>{const{theme:t,inventory:n,playerGender:o,isTransitioningFromShift:r,themeMemory:d,mapDataForTheme:i,npcsForTheme:g}=e,c=n.filter(m=>m.holderId===ge);let p="";return r&&d&&i&&g?p=_r(t,c,o,d,i,g):r?p=Gr(t,c,o):p=Or(t,o),p},Ba="idb:",nt=(e,t)=>`${e}_${String(t)}`,Be=(e,t)=>`${Ba}${nt(e,t)}`,Nt=e=>typeof e=="string"&&e.startsWith(Ba),Sn=bo("whispers-images",1,{upgrade(e){e.createObjectStore("chapterImages")}}),Ha=async()=>{const t=(await Sn).transaction("chapterImages","readwrite");await t.store.clear(),await t.done},ut=async(e,t,n)=>{const o=await Sn,r=nt(e,t);await o.put("chapterImages",n,r)},dt=async(e,t)=>{const n=await Sn,o=nt(e,t);return await n.get("chapterImages",o)??null},sl=async e=>{const t=pe(e);return await Promise.all(t.inventory.map(async n=>{var o;await Promise.all(((o=n.chapters)==null?void 0:o.map(async(r,d)=>{r.imageData&&!Nt(r.imageData)&&(await ut(n.id,d,r.imageData),r.imageData=Be(n.id,d))}))??[])})),await Promise.all(t.playerJournal.map(async(n,o)=>{n.imageData&&!Nt(n.imageData)&&(await ut(fe,o,n.imageData),n.imageData=Be(fe,o))})),t},ua=async e=>{const t=pe(e);return await Promise.all(t.inventory.map(async n=>{var o;await Promise.all(((o=n.chapters)==null?void 0:o.map(async(r,d)=>{if(Nt(r.imageData)){const i=await dt(n.id,d);r.imageData=i??void 0}}))??[])})),await Promise.all(t.playerJournal.map(async(n,o)=>{if(Nt(n.imageData)){const r=await dt(fe,o);n.imageData=r??void 0}})),t},da=async e=>{const t=pe(e);return await Promise.all(t.inventory.map(async n=>{var o;await Promise.all(((o=n.chapters)==null?void 0:o.map(async(r,d)=>{r.imageData||await dt(n.id,d)&&(r.imageData=Be(n.id,d))}))??[])})),await Promise.all(t.playerJournal.map(async(n,o)=>{n.imageData||await dt(fe,o)&&(n.imageData=Be(fe,o))})),t},ol=e=>{const{playerGenderProp:t,enabledThemePacksProp:n,stabilityLevelProp:o,chaosLevelProp:r,setIsLoading:d,setLoadingReason:i,setError:g,setParseErrorCounter:c,setHasGameBeenInitialized:p,onSettingsUpdateFromLoad:m,getCurrentGameState:f,commitGameState:u,resetGameStateStack:b,setGameStateStack:x,processAiResponse:l}=e,S=s.useCallback(async(C={})=>{const{isRestart:j=!1,explicitThemeName:v=null,isTransitioningFromShift:P=!1,customGameFlag:M=!1,savedStateToLoad:z=null,clearImages:O=!1}=C;if(d(!0),i(P?"reality_shift_load":"initial_load"),g(null),c(0),(j||O)&&await Ha(),z){const[h,E]=z;let V=h.currentThemeObject;!V&&h.currentThemeName&&(V=$t(h.currentThemeName)),h.currentThemeName&&!V&&g(`Failed to apply loaded state: Theme "${h.currentThemeName}" not found. Game state may be unstable.`);let D=h.mapData;V&&(D=await Ro(D,V));const G=h.currentMapNodeId,Y=h.destinationNodeId,$=h.mapLayoutConfig;typeof $.NESTED_PADDING!="number"&&($.NESTED_PADDING=xt().NESTED_PADDING),typeof $.NESTED_ANGLE_PADDING!="number"&&($.NESTED_ANGLE_PADDING=xt().NESTED_ANGLE_PADDING);const _={...h,currentThemeObject:V,mapData:D,currentMapNodeId:G,destinationNodeId:Y,mapLayoutConfig:$,mapViewBox:h.mapViewBox,isCustomGameMode:h.isCustomGameMode,isAwaitingManualShiftThemeSelection:h.isAwaitingManualShiftThemeSelection,globalTurnNumber:h.globalTurnNumber};x([_,E??_]),m({stabilityLevel:_.stabilityLevel,chaosLevel:_.chaosLevel,enabledThemePacks:_.enabledThemePacks,playerGender:_.playerGender}),p(!0),d(!1),i(null);return}let F=v;if(!F){const h=Sa(n);if(h.length===0){g("No adventure themes are enabled or available. Please check settings."),d(!1),i(null);return}F=h[Math.floor(Math.random()*h.length)].name}const I=$t(F);if(!I){g(`Theme "${F}" not found. Cannot start game.`),d(!1),i(null);return}let L=Ft();if(L.playerGender=t,L.enabledThemePacks=n,L.stabilityLevel=o,L.chaosLevel=r,L.mapLayoutConfig=xt(),L.mapViewBox=rn,L.globalTurnNumber=0,L.isCustomGameMode=M,L.currentThemeName=I.name,L.currentThemeObject=I,L.turnsSinceLastShift=0,P){const h=f();L.inventory=h.inventory,L.score=h.score,L.themeHistory=h.themeHistory,L.mapLayoutConfig=h.mapLayoutConfig,L.mapViewBox=h.mapViewBox,L.globalTurnNumber=h.globalTurnNumber,L.mapData.nodes=h.mapData.nodes.filter(E=>E.themeName!==I.name),L.mapData.edges=h.mapData.edges.filter(E=>{const V=h.mapData.nodes.find(G=>G.id===E.sourceNodeId),D=h.mapData.nodes.find(G=>G.id===E.targetNodeId);return(V==null?void 0:V.themeName)!==I.name||(D==null?void 0:D.themeName)!==I.name}),L.allNPCs=h.allNPCs.filter(E=>E.themeName!==I.name)}else L.mapData={nodes:[],edges:[]},L.allNPCs=[],L.themeHistory={},L.score=0,L.inventory=[],L.mapViewBox=rn;const k=pe(L),N=Object.prototype.hasOwnProperty.call(L.themeHistory,I.name),T=al({theme:I,inventory:L.inventory,playerGender:t,isTransitioningFromShift:P,themeMemory:N?L.themeHistory[I.name]:void 0,mapDataForTheme:L.mapData,npcsForTheme:L.allNPCs.filter(h=>h.themeName===I.name)});L.lastDebugPacket={prompt:T,systemInstruction:cn,jsonSchema:void 0,rawResponseText:null,parsedResponse:null,timestamp:new Date().toISOString(),storytellerThoughts:null,mapUpdateDebugInfo:null,inventoryDebugInfo:null,loremasterDebugInfo:{collect:null,extract:null,integrate:null,distill:null,journal:null},dialogueDebugInfo:null};try{const{response:h,thoughts:E,systemInstructionUsed:V,jsonSchemaUsed:D,promptUsed:G}=await un(T);L.lastDebugPacket.rawResponseText=h.text??null,L.lastDebugPacket.storytellerThoughts=E,L.lastDebugPacket.systemInstruction=V,L.lastDebugPacket.jsonSchema=D,L.lastDebugPacket.prompt=G;const Y={nodes:L.mapData.nodes.filter(_=>_.themeName===I.name),edges:L.mapData.edges.filter(_=>{const K=L.mapData.nodes.find(ae=>ae.id===_.sourceNodeId),X=L.mapData.nodes.find(ae=>ae.id===_.targetNodeId);return(K==null?void 0:K.themeName)===I.name&&(X==null?void 0:X.themeName)===I.name})},$=await dn(h.text??"",t,I,()=>{c(1)},void 0,void 0,L.allNPCs.filter(_=>_.themeName===I.name),Y,L.inventory.filter(_=>_.holderId===ge));await l($,I,L,{baseStateSnapshot:k,forceEmptyInventory:!P&&j,playerActionText:void 0}),p(!0),L.pendingNewThemeNameAfterShift=null,(!P||L.globalTurnNumber===0)&&(L.globalTurnNumber=1)}catch(h){if(console.error("Error loading initial game:",h),ka(h)){L=pe(k);const E=La(h);g(`AI service error (${String(E??"unknown")}). Please retry.`)}else{const E=h instanceof Error?h.message:String(h);g(`Failed to initialize the adventure in "${I.name}": ${E}`)}L.lastDebugPacket&&(L.lastDebugPacket.error=h instanceof Error?h.message:String(h))}finally{u(L),d(!1),i(null)}},[t,n,o,r,d,i,g,c,p,m,f,u,l,x]),y=s.useCallback(()=>{const C=Xt(t,n,o,r);b(C),p(!1),S({isRestart:!0,customGameFlag:!1})},[S,p,b,t,n,o,r]),w=s.useCallback(C=>{const j=Xt(t,n,o,r);b(j),p(!1),S({explicitThemeName:C,isRestart:!0,customGameFlag:!0})},[S,p,b,t,n,o,r]),A=s.useCallback(()=>{g(null);const C=Xt(t,n,o,r);b(C),p(!1),S({isRestart:!0,customGameFlag:!1})},[S,g,p,b,t,n,o,r]),R=s.useCallback(async()=>{var O;g(null);const C=f();if(!C.currentThemeName){await S({isRestart:!0,customGameFlag:C.isCustomGameMode});return}const j=(O=C.lastDebugPacket)==null?void 0:O.prompt,v=C.currentThemeObject;if(!j||!v){const F={...C,actionOptions:["Look around.","Ponder the situation.","Try to move on.","Check your inventory.","Consider your objective.","Plan your next steps."],lastActionLog:"Attempting to re-establish connection with the narrative flow...",dialogueState:null};u(F),d(!1),i(null);return}d(!0),i("storyteller"),c(0);const P=pe(C);let M=pe(C);const z={prompt:j,systemInstruction:cn,jsonSchema:void 0,rawResponseText:null,parsedResponse:null,timestamp:new Date().toISOString(),storytellerThoughts:null,mapUpdateDebugInfo:null,inventoryDebugInfo:null,loremasterDebugInfo:{collect:null,extract:null,integrate:null,distill:null,journal:null},dialogueDebugInfo:null};M.lastDebugPacket=z;try{const{response:F,thoughts:I,systemInstructionUsed:L,jsonSchemaUsed:k,promptUsed:N}=await un(j);M.lastDebugPacket.rawResponseText=F.text??null,M.lastDebugPacket.storytellerThoughts=I,M.lastDebugPacket.systemInstruction=L,M.lastDebugPacket.jsonSchema=k,M.lastDebugPacket.prompt=N;const T=M.allNPCs.filter(V=>V.themeName===v.name),h={nodes:M.mapData.nodes.filter(V=>V.themeName===v.name),edges:M.mapData.edges.filter(V=>{const D=M.mapData.nodes.find(Y=>Y.id===V.sourceNodeId),G=M.mapData.nodes.find(Y=>Y.id===V.targetNodeId);return(D==null?void 0:D.themeName)===v.name&&(G==null?void 0:G.themeName)===v.name})},E=await dn(F.text??"",t,v,()=>{c(1)},C.lastActionLog??void 0,C.currentScene,T,h,C.inventory.filter(V=>V.holderId===ge));await l(E,v,M,{baseStateSnapshot:P,scoreChangeFromAction:0,playerActionText:void 0}),M.turnsSinceLastShift+=1,M.globalTurnNumber+=1}catch(F){console.error("Error retrying last main AI request:",F);const I=F instanceof Error?F.message:String(F);g(`Retry failed: ${I}.`),M=pe(P),M.lastActionLog="Retry failed. The outcome remains uncertain.",M.actionOptions=["Look around.","Ponder the situation.","Check your inventory.","Try to move on.","Consider your objective.","Plan your next steps."],M.dialogueState=null,M.lastDebugPacket&&(M.lastDebugPacket.error=I)}finally{u(M),d(!1),i(null)}},[f,S,u,g,d,i,c,l,t]);return{loadInitialGame:S,handleStartNewGameFromButton:y,startCustomGame:w,executeRestartGame:A,handleRetry:R}},ma=e=>{const{currentState:t,playerGender:n,enabledThemePacks:o,stabilityLevel:r,chaosLevel:d}=e;return{...t,saveGameVersion:Ve,playerGender:n,enabledThemePacks:o,stabilityLevel:r,chaosLevel:d,mapData:t.mapData,currentMapNodeId:t.currentMapNodeId,destinationNodeId:t.destinationNodeId,mapLayoutConfig:t.mapLayoutConfig,mapViewBox:t.mapViewBox,isCustomGameMode:t.isCustomGameMode,isAwaitingManualShiftThemeSelection:t.isAwaitingManualShiftThemeSelection,globalTurnNumber:t.globalTurnNumber,currentThemeObject:t.currentThemeObject}},rl=e=>{const{playerGenderProp:t,enabledThemePacksProp:n,stabilityLevelProp:o,chaosLevelProp:r,onSettingsUpdateFromLoad:d,initialSavedStateFromApp:i,initialDebugStackFromApp:g,isAppReady:c,openDebugLoreModal:p}=e,[m,f]=s.useState(()=>[Ft(),Ft()]),[u,b]=s.useState(()=>g??[null,null]),[x,l]=s.useState(!1),S=Va(),y=s.useRef(S),w=s.useCallback(Q=>{y.current=Q,Ye(Q)},[]),[A,R]=s.useState(null),[C,j]=s.useState(0),[v,P]=s.useState(""),[M,z]=s.useState(!1),O=s.useRef(!1),F=s.useRef(!1),I=s.useRef(()=>{}),L=s.useRef(()=>{}),k=s.useRef(()=>Promise.resolve()),N=s.useCallback(()=>m[0],[m]),T=s.useCallback(Q=>{f(oe=>[Q,oe[0]]),b(oe=>[Q.lastDebugPacket??null,oe[0]])},[]),h=s.useCallback(Q=>{f([Q,Q]),b([Q.lastDebugPacket??null,Q.lastDebugPacket??null])},[]),E=s.useCallback(()=>{const[Q,oe]=m;return[ma({currentState:Q,playerGender:t,enabledThemePacks:n,stabilityLevel:o,chaosLevel:r}),oe?ma({currentState:oe,playerGender:t,enabledThemePacks:n,stabilityLevel:o,chaosLevel:r}):void 0]},[m,t,n,o,r]),V=s.useCallback(()=>u,[u]),{triggerRealityShift:D,executeManualRealityShift:G,completeManualShiftWithSelectedTheme:Y,cancelManualShiftThemeSelection:$}=Ur({getCurrentGameState:N,setGameStateStack:f,loadInitialGame:Q=>{k.current(Q)},enabledThemePacksProp:n,playerGenderProp:t,stabilityLevelProp:o,chaosLevelProp:r,setError:R,setLoadingReason:w,isLoading:x});I.current=D,L.current=G;const _=N(),K=s.useCallback(()=>{f(Q=>[{...Q[0],debugLore:!Q[0].debugLore},Q[1]])},[]),X=s.useCallback(()=>{f(Q=>[{...Q[0],debugGoodFacts:[],debugBadFacts:[]},Q[1]])},[]),{handleMapLayoutConfigChange:ae,handleMapViewBoxChange:le,handleMapNodesPositionChange:q,handleSelectDestinationNode:ie,processAiResponse:xe,handleActionSelect:ee,handleItemInteraction:me,handleDropItem:Ie,handleTakeLocationItem:se,handleStashToggle:U,updateItemContent:H,addJournalEntry:J,addPlayerJournalEntry:ne,updatePlayerJournalContent:Se,recordPlayerJournalInspect:he,handleFreeFormActionSubmit:je,handleUndoTurn:$e}=nl({getCurrentGameState:N,commitGameState:T,setGameStateStack:f,playerGenderProp:t,stabilityLevelProp:o,chaosLevelProp:r,setIsLoading:l,setLoadingReason:w,setError:R,setParseErrorCounter:j,triggerRealityShift:D,executeManualRealityShift:G,freeFormActionText:v,setFreeFormActionText:P,isLoading:x,hasGameBeenInitialized:M,loadingReasonRef:y,debugLore:_.debugLore,openDebugLoreModal:p}),{loadInitialGame:Ae,handleStartNewGameFromButton:Ne,startCustomGame:De,executeRestartGame:Pe,handleRetry:Ee}=ol({playerGenderProp:t,enabledThemePacksProp:n,stabilityLevelProp:o,chaosLevelProp:r,setIsLoading:l,setLoadingReason:w,setError:R,setParseErrorCounter:j,setHasGameBeenInitialized:z,onSettingsUpdateFromLoad:d,getCurrentGameState:N,commitGameState:T,resetGameStateStack:h,setGameStateStack:f,processAiResponse:xe});k.current=Ae;const{isDialogueExiting:Oe,handleDialogueOptionSelect:mt,handleForceExitDialogue:pt}=Rr({getCurrentGameState:N,commitGameState:T,playerGenderProp:t,setError:R,setIsLoading:l,setLoadingReason:w,onDialogueConcluded:(Q,oe,be)=>{const re=pe(oe);return xe(Q,oe.currentThemeObject,re,{baseStateSnapshot:pe(oe),isFromDialogueSummary:!0,playerActionText:void 0,dialogueTranscript:oe.gameLog[oe.gameLog.length-1]??""}).then(()=>{re.lastDebugPacket??(re.lastDebugPacket={prompt:"",rawResponseText:null,parsedResponse:null,timestamp:new Date().toISOString(),storytellerThoughts:null,mapUpdateDebugInfo:null,inventoryDebugInfo:null,loremasterDebugInfo:{collect:null,extract:null,integrate:null,distill:null},dialogueDebugInfo:null}),re.lastDebugPacket.prompt=`[Dialogue Outcome]
${be.summaryPrompt??re.lastDebugPacket.prompt}`,re.lastDebugPacket.rawResponseText=be.summaryRawResponse??null,re.lastDebugPacket.storytellerThoughts=be.summaryThoughts??null,re.lastDebugPacket.parsedResponse=Q,re.lastDebugPacket.dialogueDebugInfo=be,T(re),l(!1),w(null)}).catch(ce=>{console.error("Error in post-dialogue processAiResponse:",ce),R("Failed to fully process dialogue conclusion. Game state might be inconsistent."),T(oe),l(!1),w(null)})}});s.useEffect(()=>{c&&!M&&i&&!O.current&&(Ae({savedStateToLoad:i}),O.current=!0)},[c,M,i,Ae]),s.useEffect(()=>{c&&g&&!F.current&&(b(g),F.current=!0)},[c,g]);const W=N();s.useEffect(()=>{M&&f(Q=>{const oe=Q[0],be=oe.enabledThemePacks.length===n.length&&oe.enabledThemePacks.every((ce,ue)=>ce===n[ue]);return oe.playerGender===t&&be&&oe.stabilityLevel===o&&oe.chaosLevel===r?Q:[{...oe,playerGender:t,enabledThemePacks:[...n],stabilityLevel:o,chaosLevel:r},Q[1]]})},[t,n,o,r,M]);const Ge=s.useMemo(()=>{const Q={},oe=new Set(W.mapData.nodes.map(be=>be.id));return W.inventory.forEach(be=>{var re;if(oe.has(be.holderId)){const ce=Q[be.holderId]??{hasUseful:!1,hasVehicle:!1};(re=be.tags)!=null&&re.includes("junk")||(ce.hasUseful=!0),be.type==="vehicle"&&(ce.hasVehicle=!0),Q[be.holderId]=ce}}),Q},[W.inventory,W.mapData.nodes]),Qe=s.useCallback(async()=>{const Q=N(),oe=Q.currentThemeObject;if(!oe)return;l(!0),R(null);const be=Q.mapData.nodes.filter(ue=>ue.themeName===oe.name);Array.from(new Set(Q.inventory.filter(ue=>ue.holderId===ge||be.some(we=>we.id===ue.holderId)?!0:!!Q.allNPCs.find(we=>we.id===ue.holderId&&we.themeName===oe.name)).map(ue=>ue.name))),be.map(ue=>ue.placeName),w("loremaster_refine");const re=await za({themeName:oe.name,facts:Q.themeFacts,currentQuest:Q.mainQuest,currentObjective:Q.currentObjective}),ce=pe(Q);ce.lastLoreDistillTurn=Q.globalTurnNumber,ce.lastDebugPacket??(ce.lastDebugPacket={prompt:"",rawResponseText:null,parsedResponse:null,timestamp:new Date().toISOString(),storytellerThoughts:null,mapUpdateDebugInfo:null,inventoryDebugInfo:null,loremasterDebugInfo:{collect:null,extract:null,integrate:null,distill:null},dialogueDebugInfo:null}),ce.lastDebugPacket.loremasterDebugInfo&&(ce.lastDebugPacket.loremasterDebugInfo.distill=(re==null?void 0:re.debugInfo)??null),re!=null&&re.refinementResult&&yn(ce,re.refinementResult.factsChange,ce.globalTurnNumber,oe.name),T(ce),l(!1),w(null)},[T,N,R,l,w]);return s.useEffect(()=>{!M||x||W.dialogueState!==null||W.globalTurnNumber>0&&W.globalTurnNumber%Ra===0&&W.lastLoreDistillTurn!==W.globalTurnNumber&&Qe()},[W.globalTurnNumber,W.lastLoreDistillTurn,Qe,M,x,W.dialogueState]),{currentTheme:W.currentThemeObject,currentScene:W.currentScene,actionOptions:W.actionOptions,mainQuest:W.mainQuest,currentObjective:W.currentObjective,inventory:W.inventory.filter(Q=>Q.holderId===ge),playerJournal:W.playerJournal,lastJournalWriteTurn:W.lastJournalWriteTurn,lastJournalInspectTurn:W.lastJournalInspectTurn,lastLoreDistillTurn:W.lastLoreDistillTurn,itemsHere:s.useMemo(()=>{if(!W.currentMapNodeId)return[];const Q=W.inventory.filter(ce=>ce.holderId===W.currentMapNodeId),oe=ja(W.mapData,W.currentMapNodeId),be=W.inventory.filter(ce=>oe.includes(ce.holderId)),re=[...Q];return be.forEach(ce=>{re.includes(ce)||re.push(ce)}),re},[W.currentMapNodeId,W.inventory,W.mapData]),itemPresenceByNode:Ge,gameLog:W.gameLog,lastActionLog:W.lastActionLog,isLoading:x||W.dialogueState!==null&&Oe,loadingReason:S,error:A,themeHistory:W.themeHistory,allNPCs:W.allNPCs,mapData:W.mapData,currentMapNodeId:W.currentMapNodeId,destinationNodeId:W.destinationNodeId,mapLayoutConfig:W.mapLayoutConfig,mapViewBox:W.mapViewBox,score:W.score,freeFormActionText:v,setFreeFormActionText:P,handleFreeFormActionSubmit:je,objectiveAnimationType:W.objectiveAnimationType,localTime:W.localTime,localEnvironment:W.localEnvironment,localPlace:W.localPlace,turnsSinceLastShift:W.turnsSinceLastShift,globalTurnNumber:W.globalTurnNumber,isCustomGameMode:W.isCustomGameMode,isAwaitingManualShiftThemeSelection:W.isAwaitingManualShiftThemeSelection,dialogueState:W.dialogueState,isDialogueExiting:Oe,handleDialogueOptionSelect:mt,handleForceExitDialogue:pt,lastDebugPacket:u[0],lastTurnChanges:W.lastTurnChanges,gameStateStack:m,debugPacketStack:u,handleActionSelect:ee,handleItemInteraction:me,handleDropItem:Ie,handleTakeLocationItem:se,updateItemContent:H,handleRetry:Ee,executeRestartGame:Pe,executeManualRealityShift:G,completeManualShiftWithSelectedTheme:Y,cancelManualShiftThemeSelection:$,startCustomGame:De,gatherCurrentGameState:E,gatherDebugPacketStack:V,applyLoadedGameState:Ae,setError:R,setIsLoading:l,hasGameBeenInitialized:M,handleStartNewGameFromButton:Ne,handleMapLayoutConfigChange:ae,handleMapViewBoxChange:le,handleMapNodesPositionChange:q,handleSelectDestinationNode:ie,handleUndoTurn:$e,handleStashToggle:U,addJournalEntry:J,addPlayerJournalEntry:ne,updatePlayerJournalContent:Se,recordPlayerJournalInspect:he,commitGameState:T,handleDistillFacts:Qe,toggleDebugLore:K,clearDebugFacts:X,debugLore:W.debugLore,debugGoodFacts:W.debugGoodFacts,debugBadFacts:W.debugBadFacts}};function Wa({tag:e="h2",children:t,icon:n,preset:o="amber",font:r="2xl"}){const d=e,i={slate:"text-slate-300",gray:"text-gray-400",zinc:"text-zinc-400",neutral:"text-neutral-400",stone:"text-stone-400",red:"text-red-400",orange:"text-orange-400",amber:"text-amber-400",yellow:"text-yellow-400",lime:"text-lime-400",green:"text-green-400",emerald:"text-emerald-400",teal:"text-teal-400",cyan:"text-cyan-400",sky:"text-sky-400",blue:"text-blue-400",indigo:"text-indigo-400",violet:"text-violet-400",purple:"text-purple-400",fuchsia:"text-fuchsia-400",pink:"text-pink-400",rose:"text-rose-400"},g={sm:"text-sm font-semibold",base:"text-base font-semibold",lg:"text-lg font-semibold",xl:"text-xl font-semibold","2xl":"text-2xl font-semibold","3xl":"text-3xl font-semibold","4xl":"text-4xl font-semibold"},c=n?a.jsx("span",{className:"mr-2 inline-flex",children:n}):null;return s.createElement(d,{className:`${g[r]} ${i[o]}`},c,t)}Wa.defaultProps={children:void 0,font:"2xl",icon:void 0,preset:"amber",tag:"h2"};function Fe({header:e,headerIcon:t,children:n,text:o,highlightEntities:r,enableMobileTap:d=!1,containerClassName:i="p-3",headerTag:g="h2",borderColorClass:c="border-amber-700",backgroundColorClass:p="",borderWidthClass:m="border-b",headerFont:f="2xl",headerPreset:u="amber",headerWrapperClassName:b="",contentFontClass:x="",contentColorClass:l="text-slate-200"}){const S=o?o.split(`
`).map(y=>a.jsx("p",{className:"mb-3 last:mb-0",children:r?vn(y,r,d):y},y)):n;return a.jsxs("section",{className:`${i} ${p} ${m} ${c}`,children:[e?a.jsx("div",{className:` ${b} `,children:a.jsx(Wa,{font:f,icon:t,preset:u,tag:g,children:e})}):null,a.jsx("div",{className:`${x} ${l}`,children:S})]})}Fe.defaultProps={backgroundColorClass:"",borderColorClass:"border-amber-700",borderWidthClass:"border-b",children:void 0,containerClassName:"p-3",contentColorClass:"text-slate-200",contentFontClass:"",enableMobileTap:!1,header:void 0,headerFont:"2xl",headerIcon:void 0,headerPreset:"amber",headerTag:"h2",headerWrapperClassName:"",highlightEntities:void 0,text:void 0};function Ja({description:e,lastActionLog:t,inventory:n,mapData:o,allNPCs:r,currentThemeName:d,localTime:i,localEnvironment:g,localPlace:c}){const p=s.useMemo(()=>Vt(n,o,r,d),[n,o,r,d]),m=typeof window<"u"&&window.matchMedia("(hover: none)").matches,f=a.jsx(Fe,{backgroundColorClass:"bg-slate-800",borderColorClass:"border-slate-600",borderWidthClass:"rounded-lg border",contentFontClass:"leading-relaxed text-lg",enableMobileTap:m,highlightEntities:p,text:e||void 0}),u=t?a.jsx(Fe,{backgroundColorClass:"bg-slate-800",borderColorClass:"border-slate-600",borderWidthClass:"rounded-lg border",contentColorClass:"text-yellow-200",contentFontClass:"leading-relaxed text-lg",enableMobileTap:m,highlightEntities:p,text:t||void 0}):null,b=i||g||c?a.jsx(Fe,{borderColorClass:"border-slate-600",borderWidthClass:"border-t",contentColorClass:"text-slate-300",contentFontClass:"text-lg",text:`Time: ${i??"Unknown"}. Environment: ${g??"Unknown"} Location: ${c??"Unknown"}`}):null;return a.jsxs("div",{className:"space-y-3",children:[u,f,b]})}Ja.defaultProps={lastActionLog:null,localEnvironment:null,localPlace:null,localTime:null};function ll({options:e,onActionSelect:t,disabled:n,inventory:o,mapData:r,allNPCs:d,currentThemeName:i}){const g=s.useMemo(()=>Vt(o,r,d,i),[o,r,d,i]),c=s.useCallback(p=>m=>{t(p),m.currentTarget.blur()},[t]);return a.jsx("div",{className:"mt-6",children:a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:e.map(p=>a.jsx(B,{ariaLabel:p,disabled:n||p==="...",label:a.jsx(a.Fragment,{children:vn(p,g)}),onClick:c(p),preset:"sky",size:"lg",variant:"standard"},p))})})}function Nn({type:e}){const n={"single-use":"text-red-400","multi-use":"text-yellow-400",equipment:"text-sky-400",container:"text-orange-400",key:"text-lime-400",weapon:"text-amber-400",ammunition:"text-cyan-400",vehicle:"text-indigo-400",immovable:"text-purple-400","status effect":"text-pink-400",page:"text-green-400",book:"text-green-400",picture:"text-fuchsia-400",map:"text-teal-400"}[e];return a.jsx("span",{className:`text-xs italic ${n}`,children:e})}function il({items:e,onTakeItem:t,onItemInteract:n,disabled:o,currentNodeId:r,mapNodes:d}){const i=s.useCallback(f=>{const u=f.currentTarget.dataset.itemName;u&&(t(u),f.currentTarget.blur())},[t]),g=s.useCallback(f=>{const u=f.currentTarget.dataset.itemName;if(!u)return;const b=e.find(x=>x.name===u);b&&(n(b,"inspect"),f.currentTarget.blur())},[e,n]),c=s.useCallback(f=>{const u=f.currentTarget.dataset.itemName;if(!u)return;const b=e.find(x=>x.name===u);b&&(n(b,"generic"),f.currentTarget.blur())},[e,n]),p=s.useCallback(f=>{const{itemName:u,actionName:b,promptEffect:x}=f.currentTarget.dataset;if(!u||!b||!x)return;const l=e.find(y=>y.name===u);if(!l)return;n(l,"specific",{actionName:b,promptEffect:x,description:b}),f.currentTarget.blur()},[e,n]),m=s.useCallback(f=>f.knownUses?f.knownUses.filter(u=>{const b=!!f.isActive;return u.appliesWhenActive!==void 0&&u.appliesWhenInactive!==void 0?u.appliesWhenActive&&b||u.appliesWhenInactive&&!b||!u.appliesWhenActive&&!u.appliesWhenInactive:u.appliesWhenActive!==void 0?u.appliesWhenActive===b:u.appliesWhenInactive!==void 0?u.appliesWhenInactive===!b:!0}):[],[]);return e.length===0?null:a.jsxs("div",{className:"bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700",children:[a.jsxs("h3",{className:"text-xl font-bold text-amber-400 mb-2 border-b-2 border-amber-700 pb-2 flex items-center",children:[a.jsx(de,{color:"amber",inline:!0,marginRight:8,name:"inventory",size:20})," ","Items Here"]}),a.jsx("ul",{className:"flex flex-wrap justify-center gap-4 list-none p-0",children:e.map(f=>{var l;const u=f.isActive&&f.activeDescription?f.activeDescription:f.description,b=f.holderId===r,x=b?null:(l=d.find(S=>S.id===f.holderId))==null?void 0:l.placeName;return a.jsxs("li",{className:"w-[270px] text-slate-300 bg-slate-700/60 p-4 rounded-md shadow border border-slate-600 flex flex-col",children:[a.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[a.jsx(Nn,{type:f.type}),f.isActive?a.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),a.jsx("div",{className:"mb-1",children:a.jsx("span",{className:"font-semibold text-lg text-slate-100",children:f.name})}),a.jsx("p",{className:"text-sm text-slate-300 mb-1 italic leading-tight flex-grow",children:u}),!b&&x?a.jsxs("p",{className:"text-xs text-slate-300 mb-2",children:["Reachable at ",x]}):null,a.jsx("div",{className:"mt-auto space-y-2",children:f.type==="immovable"?a.jsxs(a.Fragment,{children:[m(f).map(S=>a.jsx(B,{ariaLabel:`${S.actionName}${S.description?": "+S.description:""}`,"data-action-name":S.actionName,"data-item-name":f.name,"data-prompt-effect":S.promptEffect,disabled:o,label:S.actionName,onClick:p,preset:"teal",size:"sm",title:S.description},`${f.name}-ku-${S.actionName}`)),a.jsx(B,{ariaLabel:`Inspect ${f.name}`,"data-item-name":f.name,disabled:o,label:"Inspect",onClick:g,preset:"indigo",size:"sm"}),a.jsx(B,{ariaLabel:`Attempt to use ${f.name}`,"data-item-name":f.name,disabled:o,label:"Attempt to Use (Generic)",onClick:c,preset:"sky",size:"sm"})]}):a.jsx("button",{"aria-label":f.type==="vehicle"?`Enter ${f.name}`:`Take ${f.name}`,className:"w-full text-sm bg-green-700 hover:bg-green-600 text-white font-medium py-1.5 px-3 rounded shadow disabled:bg-slate-600 disabled:text-slate-300 disabled:cursor-not-allowed transition-colors duration-150 ease-in-out","data-item-name":f.name,disabled:o,onClick:i,type:"button",children:f.type==="vehicle"?"Enter Vehicle":"Take"})})]},f.name)})})]})}function Ka({item:e,isNew:t,isStashing:n,isConfirmingDiscard:o,applicableUses:r,disabled:d,currentTurn:i,onSpecificUse:g,onInspect:c,onGenericUse:p,onVehicleToggle:m,onStartConfirmDiscard:f,onConfirmDrop:u,onCancelDiscard:b,onRead:x,onStashToggle:l,filterMode:S,registerRef:y}){var O,F,I,L,k,N,T,h,E;const w=e.isActive&&e.activeDescription?e.activeDescription:e.description,A=e.type==="page"||e.type==="book"||e.type==="picture"||e.type==="map",R=e.type==="picture"||e.type==="map",C=e.type!=="status effect"&&e.type!=="vehicle",j=!((O=e.tags)!=null&&O.includes("junk"))&&e.type!=="vehicle"&&e.type!=="status effect",v=S==="stashed"&&(!!e.stashed||n),P=j&&!o&&(!A||v),M=[];r.forEach(V=>{M.push(a.jsx(B,{ariaLabel:`${V.actionName}${V.description?": "+V.description:""}`,"data-action-name":V.actionName,"data-item-name":e.name,"data-prompt-effect":V.promptEffect,disabled:d||o,label:V.actionName,onClick:g,preset:"teal",size:"sm",title:V.description},`${e.name}-knownuse-${V.actionName}`))});const z=d||o||(A?e.id===fe?(((F=e.chapters)==null?void 0:F.length)??0)===0:((I=e.chapters)==null?void 0:I.some(V=>!V.actualContent))??!0:R?((L=e.chapters)==null?void 0:L.some(V=>!V.imageData))??!0:!1)||e.lastInspectTurn!==void 0&&i-e.lastInspectTurn<_a;return M.push(a.jsx(B,{ariaLabel:`Inspect ${e.name}`,"data-item-name":e.name,disabled:z,label:"Inspect",onClick:c,preset:"indigo",size:"sm"},`${e.name}-inspect`)),(e.type==="page"||e.type==="book"||e.type==="picture"||e.type==="map")&&M.push(a.jsx(B,{ariaLabel:`Read ${e.name}`,"data-item-name":e.name,disabled:d||o||e.id===fe&&(((k=e.chapters)==null?void 0:k.length)??0)===0,label:"Read",onClick:x,preset:"teal",size:"sm"},`${e.name}-read`)),C&&M.push(a.jsx(B,{ariaLabel:`Attempt to use ${e.name} (generic action)`,"data-item-name":e.name,disabled:d||o,label:"Attempt to Use (Generic)",onClick:p,preset:"sky",size:"sm"},`${e.name}-generic-use`)),e.type==="vehicle"&&M.push(a.jsx(B,{ariaLabel:e.isActive?`Exit ${e.name}`:`Enter ${e.name}`,"data-item-name":e.name,disabled:d||o,label:e.isActive?`Exit ${e.name}`:`Enter ${e.name}`,onClick:m,preset:"sky",size:"sm"},`${e.name}-vehicle-action`)),(N=e.tags)!=null&&N.includes("junk")&&!o&&M.push(a.jsx(B,{ariaLabel:`Discard ${e.name}`,"data-item-name":e.name,disabled:d,icon:a.jsx(de,{color:"white",inline:!0,marginRight:4,name:"trash",size:16}),label:"Discard",onClick:f,preset:"orange",size:"sm"},`${e.name}-discard`)),(e.type==="page"||e.type==="book"||e.type==="picture"||e.type==="map")&&!o&&M.push(a.jsx(B,{ariaLabel:S==="stashed"?`Retrieve ${e.name}`:`Stash ${e.name}`,"data-item-name":e.name,disabled:d,label:S==="stashed"?"Retrieve":"Stash",onClick:l,preset:"sky",size:"sm"},`${e.name}-stash`)),j&&A&&P&&M.push(a.jsx(B,{ariaLabel:`Drop ${e.name}`,"data-item-name":e.name,disabled:d,label:"Drop",onClick:f,preset:"sky",size:"sm"},`${e.name}-drop`)),j&&!A&&P&&M.push(a.jsx(B,{ariaLabel:`Drop ${e.name}`,"data-item-name":e.name,disabled:d,label:"Drop",onClick:f,preset:"sky",size:"sm"},`${e.name}-drop`)),!((T=e.tags)!=null&&T.includes("junk"))&&!o&&e.type==="vehicle"&&!e.isActive&&M.push(a.jsx(B,{ariaLabel:`Park ${e.name} here`,"data-item-name":e.name,disabled:d,label:"Park Here",onClick:f,preset:"sky",size:"sm"},`${e.name}-drop`)),o&&M.push(a.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[a.jsx(B,{ariaLabel:`Confirm drop of ${e.name}`,"data-item-name":e.name,disabled:d,label:e.type==="vehicle"&&!e.isActive?"Confirm Park":(h=e.tags)!=null&&h.includes("junk")?"Confirm Discard":"Confirm Drop",onClick:u,preset:"red",size:"sm"},`${e.name}-confirm-drop`),a.jsx(B,{ariaLabel:"Cancel discard",disabled:d,label:"Cancel",onClick:b,preset:"slate",size:"sm"},`${e.name}-cancel-discard`)]},`${e.name}-confirm-group`)),a.jsxs("li",{className:`w-[270px] text-slate-300 bg-slate-700/60 p-4 rounded-md shadow border border-slate-600 ${t?"animate-new-item-pulse":""} ${n?"animate-archive-fade-out":""} flex flex-col`,"data-item-name":e.name,ref:y,children:[a.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[a.jsx(Nn,{type:e.type}),e.isActive?a.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),a.jsx("div",{className:"mb-1",children:a.jsx("span",{className:"font-semibold text-lg text-slate-100",children:e.name})}),a.jsx("p",{className:"text-sm text-slate-300 mb-3 italic leading-tight flex-grow",children:w}),(E=e.tags)!=null&&E.includes("junk")?a.jsx("p",{className:"text-xs text-orange-400 mb-1 italic",children:"(Marked as junk)"}):null,a.jsx("div",{className:"space-y-2 mt-auto",children:M})]},e.name)}Ka.defaultProps={registerRef:void 0};function cl({sortOrder:e,disabled:t,onSortByName:n,onSortByType:o}){return a.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[a.jsx(B,{ariaLabel:"Sort by Name",disabled:t,label:"Sort by Name",onClick:n,preset:e==="name"?"sky":"slate",pressed:e==="name",size:"sm",variant:"toggle"}),a.jsx(B,{ariaLabel:"Sort by Type",disabled:t,label:"Sort by Type",onClick:o,preset:e==="type"?"sky":"slate",pressed:e==="type",size:"sm",variant:"toggle"})]})}function ul({filterMode:e,disabled:t,onFilterAll:n,onFilterStashed:o}){return a.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[a.jsx(B,{ariaLabel:"Show All",disabled:t,label:"All",onClick:n,preset:e==="all"?"sky":"slate",pressed:e==="all",size:"sm",variant:"toggle"}),a.jsx(B,{ariaLabel:"Show Stashed",disabled:t,label:"Stashed",onClick:o,preset:e==="stashed"?"sky":"slate",pressed:e==="stashed",size:"sm",variant:"toggle"})]})}const dl=({items:e,onItemInteract:t,onDropItem:n,onStashToggle:o,onReadPage:r})=>{const[d,i]=s.useState(new Set),g=s.useRef(e),[c,p]=s.useState(null),[m,f]=s.useState("default"),[u,b]=s.useState("all"),[x,l]=s.useState(new Set),S=s.useCallback(k=>{f(N=>N==="name"?"default":"name"),k.currentTarget.blur()},[]),y=s.useCallback(k=>{f(N=>N==="type"?"default":"type"),k.currentTarget.blur()},[]),w=s.useCallback(k=>{b("all"),k.currentTarget.blur()},[]),A=s.useCallback(k=>{b(N=>N==="stashed"?"all":"stashed"),k.currentTarget.blur()},[]),R=s.useCallback(k=>{const N=k.currentTarget.dataset.itemName;N&&(p(N),k.currentTarget.blur())},[]),C=s.useCallback(k=>{const N=k.currentTarget.dataset.itemName;!N||!e.find(h=>h.name===N)||(n(N),p(null),k.currentTarget.blur())},[e,n]),j=s.useCallback(k=>{const N=k.currentTarget.dataset.itemName;if(N){const T=e.find(h=>h.name===N);o(N),T!=null&&T.stashed?u==="stashed"?(l(h=>new Set(h).add(N)),setTimeout(()=>{l(h=>{const E=new Set(h);return E.delete(N),E})},1e3)):(i(h=>new Set(h).add(N)),setTimeout(()=>{i(h=>{const E=new Set(h);return E.delete(N),E})},1500)):(l(h=>new Set(h).add(N)),setTimeout(()=>{l(h=>{const E=new Set(h);return E.delete(N),E})},1e3)),k.currentTarget.blur()}},[u,e,o]),v=s.useCallback(k=>{p(null),k.currentTarget.blur()},[]),P=s.useCallback(k=>{const{itemName:N,actionName:T,promptEffect:h}=k.currentTarget.dataset;if(!N||!T||!h)return;const E=e.find(D=>D.name===N);if(!E)return;t(E,"specific",{actionName:T,promptEffect:h,description:T}),k.currentTarget.blur()},[e,t]),M=s.useCallback(k=>{const N=k.currentTarget.dataset.itemName;if(!N)return;const T=e.find(h=>h.name===N);T&&(t(T,"inspect"),k.currentTarget.blur())},[e,t]),z=s.useCallback(k=>{const N=k.currentTarget.dataset.itemName;if(!N)return;const T=e.find(h=>h.name===N);T&&(t(T,"generic"),k.currentTarget.blur())},[e,t]),O=s.useCallback(k=>{const N=k.currentTarget.dataset.itemName;if(!N)return;const T=e.find(V=>V.name===N);if(!T)return;const h=T.isActive?`Exit ${T.name}`:`Enter ${T.name}`;t(T,"specific",{actionName:h,promptEffect:h,description:h}),k.currentTarget.blur()},[e,t]),F=s.useCallback(k=>{const N=k.currentTarget.dataset.itemName;if(!N)return;const T=e.find(h=>h.name===N);T&&(r(T),k.currentTarget.blur())},[e,r]);s.useEffect(()=>{const k=new Set(e.map(h=>h.name)),N=new Set(g.current.map(h=>h.name)),T=[];k.forEach(h=>{N.has(h)||T.push(h)}),T.length>0&&(i(h=>{const E=new Set(h);return T.forEach(V=>E.add(V)),E}),T.forEach(h=>{setTimeout(()=>{i(E=>{const V=new Set(E);return V.delete(h),V})},1500)})),g.current=e},[e]);const I=s.useMemo(()=>{const N=[...e.filter(T=>{if(x.has(T.name))return!0;const h=["page","book","picture","map"].includes(T.type);return u==="stashed"?T.stashed&&h:!(T.stashed&&h)})];return m==="name"?N.sort((T,h)=>T.name.localeCompare(h.name)):m==="type"?N.sort((T,h)=>{const E=T.type.localeCompare(h.type);return E!==0?E:T.name.localeCompare(h.name)}):N.reverse(),N},[e,m,u,x]),L=s.useCallback(k=>k.knownUses?k.knownUses.filter(N=>{const T=!!k.isActive;return N.appliesWhenActive!==void 0&&N.appliesWhenInactive!==void 0?N.appliesWhenActive&&T||N.appliesWhenInactive&&!T||!N.appliesWhenActive&&!N.appliesWhenInactive:N.appliesWhenActive!==void 0?N.appliesWhenActive===T:N.appliesWhenInactive!==void 0?N.appliesWhenInactive===!T:!0}):[],[]);return{displayedItems:I,newlyAddedItemNames:d,stashingItemNames:x,confirmingDiscardItemName:c,sortOrder:m,filterMode:u,handleSortByName:S,handleSortByType:y,handleFilterAll:w,handleFilterStashed:A,handleStartConfirmDiscard:R,handleConfirmDrop:C,handleCancelDiscard:v,handleSpecificUse:P,handleInspect:M,handleGenericUse:z,handleVehicleToggle:O,handleStashToggleInternal:j,handleRead:F,getApplicableKnownUses:L}};function ml({items:e,onItemInteract:t,onDropItem:n,onStashToggle:o,onReadPage:r,currentTurn:d,disabled:i}){const{displayedItems:g,newlyAddedItemNames:c,stashingItemNames:p,confirmingDiscardItemName:m,sortOrder:f,handleSortByName:u,handleSortByType:b,filterMode:x,handleFilterAll:l,handleFilterStashed:S,handleStartConfirmDiscard:y,handleConfirmDrop:w,handleCancelDiscard:A,handleSpecificUse:R,handleInspect:C,handleGenericUse:j,handleVehicleToggle:v,handleStashToggleInternal:P,handleRead:M,getApplicableKnownUses:z}=dl({items:e,onItemInteract:t,onDropItem:n,onStashToggle:o,onReadPage:r}),O=s.useRef(new Map),F=s.useRef(new Map),I=s.useRef(i),L=s.useCallback(k=>{if(!k)return;const N=k.dataset.itemName;N&&O.current.set(N,k)},[]);return s.useLayoutEffect(()=>{const k=new Map;if(O.current.forEach((N,T)=>{if(!N.isConnected){O.current.delete(T),F.current.delete(T);return}k.set(T,N.getBoundingClientRect())}),I.current!==i){I.current=i,F.current=k;return}i||F.current.forEach((N,T)=>{const h=k.get(T),E=O.current.get(T);if(!h||!E)return;const V=Math.round(N.left-h.left),D=Math.round(N.top-h.top);(V!==0||D!==0)&&(E.style.transition="none",E.style.transform=`translate(${String(V)}px, ${String(D)}px)`,requestAnimationFrame(()=>{E.style.transition="transform 0.2s",E.style.transform=""}),setTimeout(()=>{E.style.transition=""},200))}),F.current=k},[g,i]),a.jsxs("div",{className:"bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700 h-full",children:[a.jsxs("h3",{className:"text-xl font-bold text-amber-400 mb-2 border-b-2 border-amber-700 pb-2 flex items-center",children:[a.jsx(de,{color:"amber",inline:!0,marginRight:8,name:"inventory",size:20})," ","Inventory"]}),a.jsx(cl,{disabled:i,onSortByName:u,onSortByType:b,sortOrder:f}),a.jsx(ul,{disabled:i,filterMode:x,onFilterAll:l,onFilterStashed:S}),g.length===0?a.jsx("p",{className:"text-slate-300 italic",children:"Your pockets are empty."}):a.jsx("ul",{className:"flex flex-wrap justify-center gap-4 list-none p-0",children:g.map(k=>{const N=z(k),T=c.has(k.name),h=p.has(k.name),E=m===k.name;return a.jsx(Ka,{applicableUses:N,currentTurn:d,disabled:i,filterMode:x,isConfirmingDiscard:E,isNew:T,isStashing:h,item:k,onCancelDiscard:A,onConfirmDrop:w,onGenericUse:j,onInspect:C,onRead:M,onSpecificUse:R,onStartConfirmDiscard:y,onStashToggle:P,onVehicleToggle:v,registerRef:L},k.name)})})]})}function pl({allNPCs:e,currentMapNodeId:t,currentObjective:n,currentThemeName:o,enableMobileTap:r,inventory:d,itemsHere:i,mainQuest:g,mapNodes:c,objectiveAnimationType:p,onDropItem:m,onStashToggle:f,onItemInteract:u,onReadPage:b,onReadPlayerJournal:x,onTakeItem:l,globalTurnNumber:S,disabled:y}){const w=s.useMemo(()=>Vt(d,c,e,o),[d,c,e,o]);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"flex justify-start gap-4 mb-2",children:a.jsx(B,{ariaLabel:"Open journal",disabled:y,icon:a.jsx(de,{name:"journalPen",size:24}),onClick:x,preset:"blue",size:"lg",title:"Open Journal",variant:"toolbarLarge"})}),g?a.jsx(Fe,{backgroundColorClass:"bg-purple-800/50",borderColorClass:"border-purple-600",borderWidthClass:"border rounded-lg",containerClassName:"p-3",contentColorClass:"text-purple-200",contentFontClass:"text-lg",enableMobileTap:r,header:"Main Quest",headerFont:"lg",headerPreset:"purple",highlightEntities:w,text:g}):null,n?a.jsx(Fe,{backgroundColorClass:"bg-amber-800/50",borderColorClass:"border-amber-600",borderWidthClass:"border rounded-lg",containerClassName:`p-3 ${p==="success"?"animate-objective-success":p==="neutral"?"animate-objective-neutral":""}`,contentColorClass:"text-amber-200",contentFontClass:"text-lg",enableMobileTap:r,header:"Current Objective",headerFont:"lg",headerPreset:"amber",highlightEntities:w,text:n}):null,a.jsx(il,{currentNodeId:t,disabled:y,items:i,mapNodes:c,onItemInteract:u,onTakeItem:l}),a.jsx(ml,{currentTurn:S,disabled:y,items:d,onDropItem:m,onItemInteract:u,onReadPage:b,onStashToggle:f})]})}const Ya=()=>{const[e,t]=s.useState(Oo()),[n,o]=s.useState(Go());s.useEffect(()=>(_o(t),Vo(o),()=>{Uo(t)}),[]);const r=s.useCallback(()=>{Ea()},[]);return{progress:e,retryCount:n,clearProgress:r}};function tt(){const e=Va(),{progress:t,retryCount:n}=Ya(),r="rounded-full h-16 w-16 border-t-4 border-b-4 animate-spin border-sky-600",d="text-sky-400",i=e?cr[e]:void 0,g=(i==null?void 0:i.text)??"Loading...",c=t?t+t.split("").reverse().join(""):"",p=n>0?`Retry ${String(n)}`:"";return a.jsxs("div",{"aria-live":"polite",className:"flex flex-col items-center my-8",role:"status",children:[a.jsx("div",{"aria-hidden":"true",className:r}),a.jsx("p",{className:`mt-2 text-xl ${d} text-shadow-md`,children:g}),p?a.jsx("p",{className:`text-sm ${d} text-shadow-md mt-1`,children:p}):null,c?a.jsx("div",{className:"mt-2 text-2xl text-sky-300 font-mono text-shadow-md",children:c}):null]})}function mn({message:e,onRetry:t}){return a.jsxs("div",{className:"bg-red-800 border border-red-600 text-red-100 p-6 rounded-lg shadow-xl my-4 animate-pulse",children:[a.jsxs("div",{className:"flex items-center mb-2",children:[a.jsx(de,{color:"red",inline:!0,marginRight:12,name:"error",size:32}),a.jsx("h3",{className:"font-bold text-2xl text-red-200",children:"A Shadow Falls!"})]}),a.jsx("p",{className:"text-red-200 mb-4",children:e}),t?a.jsx(B,{ariaLabel:"Try again after error",label:"Try Again",onClick:t,preset:"red",size:"md",variant:"compact"}):null]})}mn.defaultProps={onRetry:void 0};function gl({score:e,isLoading:t,currentThemeName:n,currentSceneExists:o,onOpenVisualizer:r,onOpenKnowledgeBase:d,onOpenHistory:i,onOpenMap:g,onOpenTitleMenu:c,onManualRealityShift:p,turnsSinceLastShift:m}){return a.jsxs("div",{className:"flex justify-between items-center w-full",children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsxs("div",{"aria-label":`Current score: ${String(e)} points`,className:"flex items-center p-2 border border-amber-500 rounded-md shadow-md",title:`Score: ${String(e)} points`,children:[a.jsx(de,{color:"amber",inline:!0,marginRight:8,name:"coin",size:20}),a.jsx("span",{className:"text-amber-400 font-semibold text-lg",children:e})]}),n?a.jsxs("div",{"aria-label":`Turns since last reality shift: ${String(m)}`,className:"flex items-center p-2 border border-indigo-500 rounded-md shadow-md",title:`Turns since last reality shift: ${String(m)}`,children:[a.jsx(de,{color:"indigo",inline:!0,marginRight:8,name:"clock",size:20}),a.jsx("span",{className:"text-indigo-400 font-semibold text-lg",children:m})]}):null]}),a.jsxs("div",{className:"flex space-x-2",children:[a.jsx(B,{ariaLabel:"Visualize Scene",disabled:t||!n||!o,icon:a.jsx(de,{inline:!0,name:"visualize",size:20}),onClick:r,preset:"blue",size:"md",title:"Visualize Scene",variant:"toolbar"}),a.jsx(B,{ariaLabel:"Open Knowledge Base",disabled:t||!n,icon:a.jsx(de,{inline:!0,name:"bookOpen",size:20}),onClick:d,preset:"blue",size:"md",title:"Open Knowledge Base",variant:"toolbar"}),a.jsx(B,{ariaLabel:"Open History",disabled:t||!n,icon:a.jsx(de,{inline:!0,name:"scroll",size:20}),onClick:i,preset:"blue",size:"md",title:"Open History",variant:"toolbar"}),a.jsx(B,{ariaLabel:"Open Map",disabled:t||!n,icon:a.jsx(de,{inline:!0,name:"map",size:20}),onClick:g,preset:"blue",size:"md",title:"Open Map",variant:"toolbar"}),a.jsx(B,{ariaLabel:"Force Reality Shift",disabled:t||!n,icon:a.jsx(de,{inline:!0,name:"realityShift",size:20}),onClick:p,preset:"purple",size:"md",title:"Force Reality Shift",variant:"toolbar"}),a.jsx(B,{ariaLabel:"Open Title Menu",disabled:t,icon:a.jsx(de,{inline:!0,name:"menu",size:20}),onClick:c,preset:"gray",size:"md",title:"Open Title Menu",variant:"toolbar"})]})]})}const pa=()=>({[Et]:{model:Et,count:qt(Et),limit:mr},[sn]:{model:sn,count:qt(sn),limit:dr},[an]:{model:an,count:qt(an),limit:ur}}),fl=()=>{const[e,t]=s.useState(()=>pa());return s.useEffect(()=>{const n=()=>{t(pa())},o=zo(n),r=setInterval(n,1e3);return()=>{o(),clearInterval(r)}},[]),e},hl="w-4 h-4 rounded",bl=e=>e<.1?"bg-green-500":e<.2?"bg-lime-500":e<.3?"bg-yellow-500":e<.4?"bg-orange-500":e<.5?"bg-amber-500":"bg-red-500";function Qa(){const e=fl();return a.jsxs("div",{"aria-label":"Model usage last minute",className:"flex space-x-1 items-center my-2",children:[Object.values(e).map(t=>{const n=t.count/t.limit,o=`${t.model}: ${String(t.count)}/${String(t.limit)} calls last minute`;return a.jsx("div",{"aria-label":o,className:`${hl} ${bl(n)}`,title:o},t.model)}),a.jsx("div",{className:"flex-grow border-t border-slate-600 ml-2"})]})}function Xa({hasGameBeenInitialized:e,isCustomGameMode:t,currentTheme:n}){return a.jsxs("header",{className:"w-full max-w-screen-xl mb-6 text-center",children:[a.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-sky-400 tracking-wider title-font",children:"Whispers in the Dark"}),a.jsx("p",{className:"text-slate-300 text-lg",children:"An Adventure in Shifting Realities"}),e?a.jsxs("p",{children:[t?a.jsx("span",{className:"block text-xs text-orange-400",children:"(Custom Game - Random Shifts Disabled)"}):null,n?a.jsx("span",{className:"block text-xs text-purple-400",children:n.name}):null]}):null]})}function qa({version:e}){return a.jsx("span",{className:"text-sm text-slate-300 absolute bottom-4 right-4",children:"Version: "+e})}qa.defaultProps={};function Za({isVisible:e,onClose:t,onNewGame:n,onCustomGame:o,onSaveGame:r,onLoadGame:d,onOpenSettings:i,onOpenInfo:g,isGameActive:c}){const p=s.useCallback(()=>{r&&r()},[r]);return a.jsx("div",{"aria-labelledby":"title-menu-heading","aria-modal":"true",className:`animated-frame ${e?"open":""}`,role:"dialog",children:a.jsxs("div",{className:"animated-frame-content relative",children:[" ",c?a.jsx(B,{ariaLabel:"Close Title Menu",icon:a.jsx(de,{name:"x",size:20}),onClick:t,size:"sm",variant:"close"}):null,a.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full p-4 text-center",children:[a.jsx(Xa,{currentTheme:null,hasGameBeenInitialized:c,isCustomGameMode:!1}),a.jsxs("div",{className:"space-y-3 sm:space-y-3 w-full max-w-xs sm:max-w-sm",children:[a.jsx(B,{ariaLabel:c?"Start a New Game (Random Shifts, Progress will be lost)":"Start a New Game (Random Shifts)",label:"New Game",onClick:n,preset:"red",size:"lg"}),a.jsx(B,{ariaLabel:c?"Start a Custom Game (Choose Theme, No Random Shifts, Progress will be lost)":"Start a Custom Game (Choose Theme, No Random Shifts)",label:"Custom Game",onClick:o,preset:"orange",size:"lg"}),c&&r?a.jsx(B,{ariaLabel:"Save Current Game to File",label:"Save Game",onClick:p,preset:"green",size:"lg"}):null,a.jsx(B,{ariaLabel:c?"Load Game from File (Current progress will be lost)":"Load Game from File",label:"Load Game",onClick:d,preset:"blue",size:"lg"}),a.jsx(B,{ariaLabel:"Open Settings",label:"Settings",onClick:i,preset:"gray",size:"lg"}),a.jsx(B,{ariaLabel:"About & Game Guide",label:"About",onClick:g,preset:"cyan",size:"lg"}),c?a.jsx(B,{ariaLabel:"Return to Game",label:"Return to Game",onClick:t,preset:"sky",size:"lg"}):null]})]}),a.jsx(qa,{version:pr})]})})}Za.defaultProps={onSaveGame:void 0};function es({isVisible:e,onClose:t,history:n,options:o,onOptionSelect:r,participants:d,isLoading:i,isDialogueExiting:g,inventory:c,mapData:p,allNPCs:m,currentThemeName:f}){const u=s.useRef(null),b=s.useRef(null);s.useEffect(()=>{e&&b.current&&b.current.scrollIntoView({behavior:"smooth",block:"end"})},[n,e]),s.useEffect(()=>{if(!e)return;const A=u.current;A&&i&&(g||o.length===0)&&A.scrollTo({top:A.scrollHeight,behavior:"smooth"})},[i,g,o.length,e,n.length]);const x=s.useMemo(()=>Vt(c,p,m,f),[c,p,m,f]),l=d.join(", "),S=i||g,y=s.useCallback(A=>{const R=A.currentTarget.dataset.option;R&&(r(R),A.currentTarget.blur())},[r]);if(!e)return null;const w=()=>{if(g||i)return a.jsx(tt,{});if(o.length>0)return a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:o.map(A=>a.jsx(B,{ariaLabel:A,"data-option":A,disabled:S,enableHighlightTap:!0,highlightEntities:x,label:A,onClick:y,preset:"sky",size:"md",variant:"standard"},A))})};return a.jsx("div",{"aria-labelledby":"dialogue-title","aria-modal":"true",className:"dialogue-frame open",ref:u,role:"dialog",children:a.jsxs("div",{className:"dialogue-frame-content",children:[a.jsx(B,{ariaLabel:"End Conversation",disabled:i||g,icon:a.jsx(de,{name:"x",size:20}),onClick:t,size:"sm",variant:"close"}),a.jsxs("h1",{className:"text-2xl font-bold text-sky-300 mb-4 text-center",id:"dialogue-title",children:["Conversation with:"," ",l]}),a.jsx("div",{className:"dialogue-log-area flex-grow mb-4 pr-2 min-h-[200px] overflow-y-auto",children:n.map((A,R)=>{const C=A.speaker.toLowerCase()==="player";return a.jsxs("div",{className:`mb-3 p-3 rounded-lg animate-dialogue-new-entry ${C?"bg-slate-700 ml-auto w-11/12 text-right":"bg-slate-600 mr-auto w-11/12"}`,ref:R===n.length-1?b:null,children:[a.jsxs("strong",{className:C?"text-amber-400":"text-emerald-400",children:[A.speaker,":"]}),a.jsx("span",{className:"text-slate-100 ml-2",children:vn(A.line,x)})]},A.line)})}),a.jsxs("div",{className:"dialogue-options-area mt-auto pt-4",children:[a.jsxs("div",{className:"flex items-center mb-2",children:[a.jsx(Qa,{}),a.jsx("div",{className:"flex-grow border-t border-slate-600 ml-2"})]}),w()]})]})})}es.defaultProps={isDialogueExiting:!1};const ga=600,yl=2e3,vl=(e,t)=>{const n=e??[],o=t??[];if(n.length!==o.length)return!1;if(n.length===0)return!0;const r=g=>{const c={};return Object.keys(g).sort().forEach(p=>{c[p]=g[p]}),JSON.stringify(c)},d=n.map(r).sort(),i=o.map(r).sort();for(let g=0;g<d.length;g++)if(d[g]!==i[g])return!1;return!0},xl=(e,t)=>!e||!t?e===t:e.name!==t.name||e.type!==t.type||e.description!==t.description||(e.activeDescription??"")!==(t.activeDescription??"")||(e.isActive??!1)!==(t.isActive??!1)||JSON.stringify(e.tags??[])!==JSON.stringify(t.tags??[])?!1:vl(e.knownUses,t.knownUses),Cl=({lastTurnChanges:e,isGameBusy:t})=>{const[n,o]=s.useState([]),[r,d]=s.useState(null),[i,g]=s.useState("idle"),[c,p]=s.useState(null),[m,f]=s.useState(!1),[u,b]=s.useState(null),[x,l]=s.useState(null),[S,y]=s.useState(!1),[w,A]=s.useState(null),[R,C]=s.useState(null),j=s.useRef(null),v=s.useCallback(()=>{j.current&&(clearTimeout(j.current),j.current=null)},[]),P=s.useCallback(()=>{v(),o([]),d(null),g("idle"),y(!1),f(!1),b(null),l(null),p(null)},[v]);s.useEffect(()=>{t&&(R?(A(R),C(null)):e&&e!==w&&A(e),P())},[t,P,R,w,e]),s.useEffect(()=>{if(t||!e){!t&&n.length>0&&o([]);return}if(e===w||e===R||R&&r)return;C(e);const F=[];for(const I of e.itemChanges)I.type==="acquire"&&I.acquiredItem?F.push({type:"acquire",item:I.acquiredItem}):I.type==="loss"&&I.lostItem?F.push({type:"loss",item:I.lostItem}):I.type==="update"&&I.oldItem&&I.newItem&&(xl(I.oldItem,I.newItem)||F.push({type:"change",oldItem:I.oldItem,newItem:I.newItem}));F.sort((I,L)=>{const k={loss:0,acquire:1,change:2};return k[I.type]-k[L.type]}),F.length>0?o(F):(o([]),A(e),C(null),y(!1))},[e,t,w,R,r,n]);const M=s.useCallback(()=>{if(v(),n.length>0&&!t){const F=n[0];d(F),o(I=>I.slice(1)),y(!0),F.type==="change"&&F.oldItem&&F.newItem?p({oldItem:F.oldItem,newItem:F.newItem}):F.item?p({item:F.item}):p(null),g("appearing")}else d(null),g("idle"),p(null)},[n,t,v]);s.useEffect(()=>{i==="idle"&&!r&&!t&&(n.length>0?M():(y(!1),R&&R!==w&&A(R),C(null)))},[i,n,r,M,t,R,w]),s.useEffect(()=>{if(!(t||!r||i==="idle")){switch(v(),i){case"appearing":{b(null),l(null),f(!0);const F=r;j.current=window.setTimeout(()=>{r===F&&g("visible")},ga);break}case"visible":{r.type==="acquire"?l("acquire"):r.type==="loss"?l("loss"):l("change-new");const F=r;j.current=window.setTimeout(()=>{r===F&&g("disappearing")},yl);break}case"disappearing":l(null),r.type==="loss"?b("disappear-to-large"):b("disappear-to-small"),f(!1),j.current=window.setTimeout(()=>{d(null),g("idle"),b(null)},ga);break}return()=>{v()}}},[r,i,t,v]);const z=s.useCallback(()=>{t||(P(),R?(A(R),C(null)):e&&e!==w&&A(e))},[t,P,e,w,R]),O=s.useCallback(F=>{(F.key==="Enter"||F.key===" ")&&z()},[z]);return{itemForCardDisplay:c,currentAnimatingItem:r,isVisibleOverlay:S,isCardVisibleClass:m,explicitDisappearClass:u,activeGlowType:x,handleSkipAnimations:z,handleKeyDown:O}},At=()=>{};function Sl({lastTurnChanges:e,isGameBusy:t}){const{itemForCardDisplay:n,currentAnimatingItem:o,isVisibleOverlay:r,isCardVisibleClass:d,explicitDisappearClass:i,activeGlowType:g,handleSkipAnimations:c,handleKeyDown:p}=Cl({lastTurnChanges:e,isGameBusy:t}),m=l=>{var S,y;return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[a.jsx(Nn,{type:l.type}),l.isActive?a.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),a.jsx("div",{className:"mb-1",children:a.jsx("span",{className:"font-semibold text-lg text-slate-100",children:l.name})}),a.jsx("p",{className:"text-sm text-slate-300 mb-3 italic leading-tight flex-grow",children:l.isActive&&l.activeDescription?l.activeDescription:l.description}),(S=l.tags)!=null&&S.includes("junk")?a.jsx("p",{className:"text-xs text-orange-400 mb-1 italic",children:"(Marked as junk)"}):null,a.jsxs("div",{className:"space-y-1 mt-auto",children:[(y=l.knownUses)==null?void 0:y.map(w=>a.jsx(B,{"aria-hidden":"true",ariaLabel:w.actionName,disabled:!0,label:w.actionName,onClick:At,preset:"slate",size:"sm",title:w.description},`${l.name}-anim-ku-${w.actionName}`)),a.jsx(B,{"aria-hidden":"true",ariaLabel:"Inspect",disabled:!0,label:"Inspect",onClick:At,preset:"slate",size:"sm"}),l.type!=="status effect"&&l.type!=="vehicle"&&a.jsx(B,{"aria-hidden":"true",ariaLabel:"Attempt to Use (Generic)",disabled:!0,label:"Attempt to Use (Generic)",onClick:At,preset:"slate",size:"sm"}),l.type==="vehicle"&&a.jsx(B,{"aria-hidden":"true",ariaLabel:l.isActive?`Exit ${l.name}`:`Enter ${l.name}`,disabled:!0,label:l.isActive?`Exit ${l.name}`:`Enter ${l.name}`,onClick:At,preset:"slate",size:"sm"})]})]})};if(!r||!n)return null;const f=l=>g?g==="acquire"&&l==="single"?"apply-green-glow-effect":g==="loss"&&l==="single"?"apply-red-glow-effect":g==="change-new"&&l==="new"?"apply-neutral-glow-effect":"":"",u="animating-item-card",b=d?"visible":"",x=i&&!d?i:"";return a.jsx("div",{"aria-label":"Skip item animations",className:"item-change-overlay active",onClick:c,onKeyDown:p,role:"button",tabIndex:0,children:(o==null?void 0:o.type)==="change"&&n.oldItem&&n.newItem?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:`${u} ${b} ${x} ${f("old")}`,children:m(n.oldItem)}),a.jsx("div",{className:`${u} ${b} ${x} ${f("new")}`,children:m(n.newItem)})]}):n.item?a.jsx("div",{className:`${u} ${b} ${x} ${f("single")}`,children:m(n.item)}):null})}function ts({theme:e,onSelect:t,disabled:n=!1}){const o=s.useCallback(()=>{t()},[t]);return a.jsx(B,{ariaLabel:`Start a new game in the theme: ${e.name}${n?" (Current theme, cannot select)":""}`,disabled:n,label:a.jsxs("div",{className:"flex flex-col items-start text-left w-full",style:{minHeight:"180px"},children:[a.jsx("h3",{className:"text-xl font-semibold text-amber-400 mb-2",children:e.name}),a.jsx("p",{className:"text-sm text-slate-300 leading-snug line-clamp-8",children:e.initialSceneDescriptionSeed}),n?a.jsx("p",{className:"text-xs text-orange-300 mt-1 italic",children:"(Currently active theme)"}):null]}),onClick:o,preset:"slate",variant:"standard"})}ts.defaultProps={disabled:!1};function pn({isVisible:e,onClose:t,onThemeSelected:n,disabledThemeName:o=null,titleText:r=void 0,descriptionText:d=void 0}){const i=s.useCallback(m=>()=>{n(m)},[n]);if(!e)return null;const g=Object.keys(sa).reduce((m,f)=>{const u=f;return m[u]=sa[u],m},{}),c=r??"Choose Your Adventure Theme",p=d??"Select a theme to start your custom game. In this mode, random reality shifts are disabled, allowing for a focused, single-theme experience. You can still manually trigger a reality shift if you wish to change themes later.";return a.jsx("div",{"aria-labelledby":"custom-game-setup-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:a.jsxs("div",{className:"animated-frame-content",children:[a.jsx(B,{ariaLabel:"Close theme selection",icon:a.jsx(de,{name:"x",size:20}),onClick:t,size:"sm",variant:"close"}),a.jsxs("div",{className:"flex flex-col items-center w-full h-full p-2",children:[a.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-4 text-center",id:"custom-game-setup-title",children:c}),a.jsx("p",{className:"text-slate-300 mb-6 text-center text-sm max-w-2xl",children:p}),Object.keys(g).length===0?a.jsx("p",{className:"text-slate-300 italic",children:"No themes available. Please check configuration."}):a.jsx("div",{className:"overflow-y-auto flex-grow w-full max-w-5xl px-6",children:Object.entries(g).map(([m,f])=>f.length>0&&a.jsxs("section",{className:"mb-8",children:[a.jsx("h2",{className:"text-2xl font-semibold text-purple-400 mb-3 pb-1 border-b border-purple-600",children:m}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4",children:f.map(u=>{const b=u.name===o;return a.jsx(ts,{disabled:b,onSelect:i(u.name),theme:u},u.name)})})]},m))})]})]})})}pn.defaultProps={descriptionText:void 0,disabledThemeName:null,titleText:void 0};function gn({id:e,label:t,value:n,onChange:o,min:r=0,max:d=100,explanation:i,disabled:g=!1,faded:c=!1,suffix:p=""}){const m=s.useCallback(u=>{o(parseInt(u.target.value,10))},[o]),f=c||g?"opacity-50":"";return a.jsxs("div",{className:"settings-slider-container",children:[a.jsxs("label",{className:`settings-slider-label ${f}`,htmlFor:e,children:[t,":",a.jsxs("span",{children:[n,p]})]}),a.jsx("input",{"aria-labelledby":`${e}-label`,"aria-valuemax":d,"aria-valuemin":r,"aria-valuenow":n,className:`settings-slider ${f}`,disabled:g,id:e,max:d,min:r,onChange:m,type:"range",value:n}),i?a.jsx("p",{className:`settings-explanation ${f}`,id:`${e}-label`,children:i}):null]})}gn.defaultProps={disabled:!1,explanation:void 0,faded:!1,max:100,min:0,suffix:""};function ns({name:e,options:t,value:n,onChange:o,addCustom:r=!1,placeholder:d=""}){const i=t.includes(n),g=i||!r||n==="Not Specified"?"":n,[c,p]=s.useState(g);s.useEffect(()=>{const l=t.includes(n);p(l||!r||n==="Not Specified"?"":n)},[n,t,r]);const m=s.useCallback(l=>{o(l==="Custom"?c.trim()||"Not Specified":l)},[c,o]),f=s.useCallback(l=>{m(l.currentTarget.value)},[m]),u=s.useCallback(l=>{const S=l.target.value;p(S),t.includes(n)||o(S.trim()||"Not Specified")},[o,t,n]),b=i?n:"Custom",x=r?[...t,"Custom"]:t;return a.jsxs("div",{className:"space-y-3",children:[x.map(l=>a.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-2 bg-slate-700/50 rounded-md hover:bg-slate-600/50 transition-colors",children:[a.jsx("input",{"aria-labelledby":`${e}-${l}`,checked:b===l,className:"form-radio h-5 w-5 text-sky-500 bg-slate-600 border-slate-500 focus:ring-sky-400 focus:ring-offset-slate-800",name:e,onChange:f,type:"radio",value:l}),a.jsx("span",{className:"text-slate-200 text-lg",id:`${e}-${l}`,children:l})]},l)),r&&b==="Custom"?a.jsx("input",{"aria-label":"Custom input",className:"w-full p-2 mt-2 bg-slate-600 text-slate-100 border border-slate-500 rounded-md focus:ring-sky-500 focus:border-sky-500",onChange:u,placeholder:d,type:"text",value:c}):null]})}ns.defaultProps={addCustom:!1,placeholder:""};function as({options:e,selected:t,onToggle:n,errorText:o}){const r=s.useCallback(d=>{n(d.currentTarget.value)},[n]);return a.jsxs("div",{className:"space-y-3",children:[e.map(d=>a.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-2 bg-slate-700/50 rounded-md hover:bg-slate-600/50 transition-colors",children:[a.jsx("input",{"aria-labelledby":`${d}-label`,checked:t.includes(d),className:"form-checkbox h-5 w-5 text-sky-500 bg-slate-600 border-slate-500 rounded focus:ring-sky-400 focus:ring-offset-slate-800",onChange:r,type:"checkbox",value:d}),a.jsx("span",{className:"text-slate-200 text-lg",id:`${d}-label`,children:d})]},d)),o?a.jsx("p",{className:"text-red-400 mt-2 text-sm",children:o}):null]})}as.defaultProps={errorText:void 0};function Nl({isVisible:e,onClose:t,stabilityLevel:n,chaosLevel:o,onStabilityChange:r,onChaosChange:d,enabledThemePacks:i,onToggleThemePack:g,playerGender:c,onPlayerGenderChange:p,isCustomGameMode:m}){const f=s.useCallback(b=>{g(b)},[g]),u=s.useCallback(b=>{f(b)},[f]);return a.jsx("div",{"aria-labelledby":"settings-title","aria-modal":"true",className:`animated-frame ${e?"open":""}`,role:"dialog",children:a.jsxs("div",{className:"animated-frame-content",children:[a.jsx(B,{ariaLabel:"Close settings",icon:a.jsx(de,{name:"x",size:20}),onClick:t,size:"sm",variant:"close"}),a.jsxs("div",{className:"settings-content-area",children:[a.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-8 text-center",id:"settings-title",children:"Game Settings"}),a.jsxs("div",{className:"mb-8",id:"reality-shift-controls",children:[" ",a.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Reality Shift Controls"}),m?a.jsxs("div",{className:"p-3 mb-3 bg-indigo-800/70 border border-indigo-600 rounded-md text-indigo-200 text-sm",children:[a.jsx("p",{children:"Random Reality Shifts are disabled in Custom Game mode."}),a.jsx("p",{children:'You can still change these settings, and they will apply if you start a regular "New Game" from the Main Menu.'})]}):null,a.jsx(gn,{explanation:"Number of turns after any reality shift before random chaos shifts can occur again. Higher values mean longer periods of stability (e.g., 0 = chaos can happen immediately, 10 = 10 turns of safety). Max 100.",faded:m,id:"stabilitySlider",label:"Stability",onChange:r,value:n}),a.jsx(gn,{explanation:"Percentage chance (0-100%) of a random reality shift occurring each turn, *after* the 'Stability' period has passed. Higher values mean more frequent shifts.",faded:m,id:"chaosSlider",label:"Chaos",onChange:d,suffix:"%",value:o}),a.jsx("p",{className:"settings-disclaimer",children:"In the Beta, manual reality shift can be triggered at any time regardless of these settings."})]}),a.jsxs("div",{className:"mb-8",children:[a.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Player Character Gender"}),a.jsx("p",{className:"settings-explanation mb-3",children:"Choose your character's gender. This may subtly influence descriptions and interactions in the game. Changing it in the middle of the game can have unexpected effects."}),a.jsx(ns,{addCustom:!0,name:"playerGender",onChange:p,options:["Male","Female"],placeholder:"Enter custom gender (or leave blank for 'Not Specified')",value:c})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Theme Pack Preferences"}),a.jsx("p",{className:"settings-explanation mb-3",children:"Select which genre packs to include in the pool for random reality shifts. At least one pack must be enabled. Can be safely changed at any time."}),a.jsx(as,{errorText:i.length===0?"At least one theme pack must be enabled. Please select a pack to continue.":void 0,onToggle:u,options:gr,selected:i})]})]})]})})}function wl({title:e,items:t}){return a.jsxs("div",{children:[a.jsx("h3",{className:"text-xl font-medium text-sky-400 mb-2",children:e}),a.jsx("ul",{className:"list-disc list-inside ml-4 space-y-1",children:t.map(n=>a.jsx("li",{children:n},n))})]})}const _t=Tr;function Tl(e){return e.replace(/\{\{CURRENT_SAVE_GAME_VERSION\}\}/g,Ve).replace(/\{\{GEMINI_MODEL_NAME\}\}/g,Et)}const Il=_t.sections.map(e=>a.jsx(Fe,{contentFontClass:"leading-relaxed space-y-3",header:e.header,text:e.text.map(t=>Tl(t)).join(`
`)},e.header)),jl=_t.changelog.map(e=>a.jsx(wl,{items:e.items,title:e.title},e.title));function kl({isVisible:e,onClose:t}){return a.jsx("div",{"aria-labelledby":"info-title","aria-modal":"true",className:`animated-frame ${e?"open":""}`,role:"dialog",children:a.jsxs("div",{className:"animated-frame-content",children:[a.jsx(B,{ariaLabel:"Close game information",icon:a.jsx(de,{name:"x",size:20}),onClick:t,size:"sm",variant:"close"}),a.jsxs("div",{className:"info-content-area",children:[a.jsx(Fe,{borderColorClass:"border-sky-700",borderWidthClass:"border-b-2",containerClassName:"mb-6",header:_t.title,headerFont:"3xl",headerPreset:"sky",headerTag:"h1",headerWrapperClassName:"text-center"}),Il,a.jsx(Fe,{contentFontClass:"leading-relaxed space-y-4",header:"Changelog",children:jl}),a.jsx(Fe,{containerClassName:"mt-8",contentColorClass:"text-slate-500",contentFontClass:"text-sm text-center",text:_t.footer})]})]})})}const Ll=yo.memo(kl);function Pl({isVisible:e,facts:t,onSubmit:n,onClose:o}){const[r,d]=s.useState({});s.useEffect(()=>{e&&d({})},[t,e]);const i=s.useCallback((b,x)=>{d(l=>({...l,[b]:l[b]===x?void 0:x}))},[]),g=s.useCallback(()=>{const b=[],x=[];t.forEach((l,S)=>{r[S]==="good"&&b.push(l),r[S]==="bad"&&x.push(l)}),n(b,x,!0)},[t,r,n]),c=s.useCallback(()=>{n([],[],!1)},[n]),p=s.useCallback(b=>{i(b,"good")},[i]),m=s.useCallback(b=>{i(b,"bad")},[i]),f=s.useMemo(()=>t.map((b,x)=>()=>{p(x)}),[t,p]),u=s.useMemo(()=>t.map((b,x)=>()=>{m(x)}),[t,m]);return a.jsx("div",{"aria-labelledby":"debug-lore-title","aria-modal":"true",className:`animated-frame debug-lore-frame ${e?"open":""}`,role:"dialog",children:a.jsxs("div",{className:"animated-frame-content",children:[a.jsx(B,{ariaLabel:"Close debug lore",icon:a.jsx(de,{name:"x",size:20}),onClick:o,size:"sm",variant:"close"}),a.jsx("h1",{className:"text-2xl font-bold text-amber-400 mb-3 text-center",id:"debug-lore-title",children:"Evaluate Extracted Facts"}),a.jsx("ul",{className:"mb-4 space-y-2",children:t.map((b,x)=>a.jsxs("li",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"flex-grow text-slate-300",children:b}),a.jsx(B,{ariaLabel:"Mark good",label:"Good",onClick:f[x],preset:"green",pressed:r[x]==="good",size:"sm",variant:"toggle"}),a.jsx(B,{ariaLabel:"Mark bad",label:"Bad",onClick:u[x],preset:"red",pressed:r[x]==="bad",size:"sm",variant:"toggle"})]},b))}),a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx(B,{ariaLabel:"Skip",label:"Skip",onClick:c,preset:"stone",size:"sm"}),a.jsx(B,{ariaLabel:"OK",label:"OK",onClick:g,preset:"sky",size:"sm"})]})]})})}function Al({isBlurred:e,isDebugViewVisible:t,setIsDebugViewVisible:n}){const o=s.useCallback(()=>{n(r=>!r)},[n]);return a.jsx("footer",{className:`w-full max-w-screen-xl mt-12 text-center text-slate-500 text-sm ${e?"filter blur-sm pointer-events-none":""}`,children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("p",{className:"text-left",children:["Â©"," ",new Date().getFullYear(),". Developed by"," ",fr,", Codex, and Gemini."," ",a.jsx("br",{}),"Powered by Gemini."]}),a.jsx("button",{"aria-label":t?"Hide Debug View":"Open Debug View",className:"px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs rounded shadow-md transition-colors",onClick:o,type:"button",children:"Debug"})]})})}function Dl({allNPCs:e,currentTheme:t,isVisible:n,onClose:o}){const r=s.useMemo(()=>{const i={};return e.forEach(g=>{let c=i[g.themeName];c||(c=[],i[g.themeName]=c),c.push(g)}),i},[e]),d=s.useMemo(()=>Object.keys(r).sort((i,g)=>t&&i===t.name?-1:t&&g===t.name?1:i.localeCompare(g)),[r,t]);return a.jsx("div",{"aria-labelledby":"knowledge-base-title","aria-modal":"true",className:`animated-frame ${n?"open":""}`,role:"dialog",children:a.jsxs("div",{className:"animated-frame-content",children:[a.jsx(B,{ariaLabel:"Close knowledge base",icon:a.jsx(de,{name:"x",size:20}),onClick:o,size:"sm",variant:"close"}),a.jsxs("div",{className:"knowledge-base-content-area",children:[a.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-6 text-center",id:"knowledge-base-title",children:"Knowledge Base"}),d.length===0&&n?a.jsx("p",{className:"text-slate-300 italic text-center",children:"No knowledge has been recorded yet."}):null,n?d.map(i=>{const g=r[i]??[];return g.length===0?null:a.jsxs("section",{className:"mb-8",children:[a.jsxs("h2",{className:"kb-theme-group-title",children:["Theme:"," ",i,t&&i===t.name?a.jsx("span",{className:"text-sm text-purple-400 ml-2",children:"(Current Active Theme)"}):null]}),g.length>0&&a.jsxs(a.Fragment,{children:[a.jsx("h3",{className:"text-xl font-semibold text-emerald-400 mt-4 mb-2",children:"NPCs"}),a.jsx("div",{className:"kb-card-grid",children:g.map(c=>{let p;if(t&&i===t.name&&(c.presenceStatus==="companion"||c.presenceStatus==="nearby")){const f=c.presenceStatus==="companion"?"companion":"nearbyNpc",u=c.presenceStatus==="companion"?"(Companion)":"(Nearby)",b=c.presenceStatus==="companion"?"text-green-300":"text-sky-300";p=a.jsxs("p",{className:"text-sm text-slate-300 flex items-center",children:[a.jsx(de,{color:f==="companion"?"green":"sky",inline:!0,marginRight:4,name:f,size:16}),a.jsxs("span",{className:`ml-1 ${b} italic`,children:[c.preciseLocation??""," ",u]})]})}else c.lastKnownLocation&&c.lastKnownLocation!=="Unknown"?p=a.jsx("p",{className:"text-sm text-slate-300 flex items-center",children:a.jsxs("span",{className:"ml-1 italic",children:[c.lastKnownLocation," ","(",c.presenceStatus,")"]})}):p=a.jsx("p",{className:"text-sm text-slate-500 flex items-center",children:a.jsxs("span",{className:"ml-1 italic",children:["(",c.presenceStatus,", Location Unknown)"]})});return a.jsxs("div",{className:"kb-card",children:[a.jsx("div",{className:"kb-card-name-header",children:c.name}),c.aliases&&c.aliases.length>0?a.jsxs("p",{className:"kb-card-aliases",children:["Aliases:",c.aliases.join(", ")]}):null,a.jsx("p",{className:"kb-card-description",children:c.description}),a.jsx("div",{className:"mt-2 pt-2 border-t border-slate-600",children:p})]},`${i}-npc-${c.name}`)})})]})]},i)}):null]})]})})}const El=(e=`${String(-lt/2)} ${String(-it/2)} ${String(lt)} ${String(it)}`,t)=>{const[n,o]=s.useState(e),r=C=>{o(C),t&&t(C)},d=s.useRef(null),[i,g]=s.useState(!1),[c,p]=s.useState(null),[m,f]=s.useState(null);s.useEffect(()=>{o(C=>C===e?C:e)},[e]);const u=C=>{C.target.closest(".map-node")||(g(!0),p({x:C.clientX,y:C.clientY}),d.current&&(d.current.style.cursor="grabbing"))},b=C=>{if(!i||!c||!d.current)return;const j=d.current,v=Ue(j,c.x,c.y),P=Ue(j,C.clientX,C.clientY),M=v.x-P.x,z=v.y-P.y,[O,F,I,L]=n.split(" ").map(parseFloat);r(`${String(O+M)} ${String(F+z)} ${String(I)} ${String(L)}`),p({x:C.clientX,y:C.clientY})},x=()=>{g(!1),p(null),d.current&&(d.current.style.cursor="grab")},l=()=>{i&&x()},S=C=>{if(C.cancelable&&C.preventDefault(),!d.current)return;const[j,v,P,M]=n.split(" ").map(parseFloat),z=1.1,O=C.deltaY<0?P/z:P*z,F=C.deltaY<0?M/z:M*z,I=Math.min(lt,it)*.1,L=Math.min(lt,it)*10;if(O<I||O>L||F<I||F>L)return;const k=d.current,N=Ue(k,C.clientX,C.clientY),T=N.x-(N.x-j)*(O/P),h=N.y-(N.y-v)*(F/M);r(`${String(T)} ${String(h)} ${String(O)} ${String(F)}`)},y=(C,j)=>Math.sqrt(Math.pow(C.clientX-j.clientX,2)+Math.pow(C.clientY-j.clientY,2));return{viewBox:n,svgRef:d,handleMouseDown:u,handleMouseMove:b,handleMouseUp:x,handleMouseLeave:l,handleWheel:S,handleTouchStart:C=>{if(d.current)if(C.cancelable&&C.preventDefault(),C.touches.length===1){if(C.target.closest(".map-node"))return;g(!0),p({x:C.touches[0].clientX,y:C.touches[0].clientY}),f(null),d.current.style.cursor="grabbing"}else C.touches.length===2&&(g(!1),f(y(C.touches[0],C.touches[1])),p(null))},handleTouchMove:C=>{if(d.current){if(C.cancelable&&C.preventDefault(),C.touches.length===1&&i&&c){const j=C.touches[0],v=d.current,P=Ue(v,c.x,c.y),M=Ue(v,j.clientX,j.clientY),z=P.x-M.x,O=P.y-M.y,[F,I,L,k]=n.split(" ").map(parseFloat);r(`${String(F+z)} ${String(I+O)} ${String(L)} ${String(k)}`),p({x:j.clientX,y:j.clientY})}else if(C.touches.length===2&&m!==null){const j=y(C.touches[0],C.touches[1]);if(j===0||m===0)return;const v=j/m,[P,M,z,O]=n.split(" ").map(parseFloat);let F=z/v,I=O/v;const L=Math.min(lt,it)*.1,k=Math.min(lt,it)*10;(F<L||F>k||I<L||I>k)&&(F<L&&(I*=L/F,F=L),I<L&&(F*=L/I,I=L),F>k&&(I*=k/F,F=k),I>k&&(F*=k/I,I=k));const N=(C.touches[0].clientX+C.touches[1].clientX)/2,T=(C.touches[0].clientY+C.touches[1].clientY)/2,h=d.current,E=Ue(h,N,T),V=E.x-(E.x-P)*(F/z),D=E.y-(E.y-M)*(I/O);r(`${String(V)} ${String(D)} ${String(F)} ${String(I)}`),f(j)}}},handleTouchEnd:C=>{d.current&&(d.current.style.cursor="grab"),C.touches.length<2&&f(null),C.touches.length<1&&(g(!1),p(null))}}},Ml=({nodes:e,edges:t,svgRef:n,viewBox:o,destinationNodeId:r,onSelectDestination:d})=>{const[i,g]=s.useState(null),[c,p]=s.useState(!1),m=s.useRef(null),f=250,[u,b]=s.useState(null);s.useLayoutEffect(()=>{if(!i||!n.current){b(null);return}const{x:C,y:j}=Bo(n.current,i.svgX,i.svgY),v=n.current.getBoundingClientRect();b({x:C-v.left,y:j-v.top})},[i,o,n]);const x=s.useCallback((C,j,v)=>{const P=C>v.width/2?"right":"left";return`${j>v.height*.75?"bottom":"top"}-${P}`},[]),l=s.useCallback(()=>{m.current&&(clearTimeout(m.current),m.current=null),c||g(null)},[c]),S=s.useCallback(C=>{const j=C.target;!j.closest(".map-node")&&!j.closest(".map-edge-group")&&(p(!1),g(null))},[]),y=s.useCallback(C=>{var N;if(c)return;const j=C.currentTarget.dataset.edgeId;if(!j)return;const v=t.find(T=>T.id===j);if(!v)return;const P=(N=n.current)==null?void 0:N.getBoundingClientRect();if(!P)return;const M=C.clientX-P.left,z=C.clientY-P.top,O=n.current?Ue(n.current,C.clientX,C.clientY):{x:0,y:0},F=e.find(T=>T.id===v.sourceNodeId),I=e.find(T=>T.id===v.targetNodeId);let L=v.data.description??`Path between ${(F==null?void 0:F.placeName)??"Unknown"} and ${(I==null?void 0:I.placeName)??"Unknown"}`;v.data.travelTime&&(L+=`
${v.data.travelTime}`),v.data.status&&(L+=`
Status: ${v.data.status}`);const k=x(M,z,P);m.current&&clearTimeout(m.current),m.current=window.setTimeout(()=>{g({content:L,svgX:O.x,svgY:O.y,anchor:k})},f)},[x,t,c,e,n]),w=s.useCallback(C=>{var L;if(c)return;const j=C.currentTarget.getAttribute("data-node-id");if(!j)return;const v=e.find(k=>k.id===j);if(!v)return;const P=(L=n.current)==null?void 0:L.getBoundingClientRect();if(!P)return;const M=C.clientX-P.left,z=C.clientY-P.top,O=n.current?Ue(n.current,C.clientX,C.clientY):{x:0,y:0};let F=v.placeName;v.data.aliases&&v.data.aliases.length>0&&(F+=` (aka ${v.data.aliases.join(", ")})`),v.data.description&&(F+=`
${v.data.description}`),F+=`
Status: ${v.data.status}`;const I=x(M,z,P);m.current&&clearTimeout(m.current),m.current=window.setTimeout(()=>{g({content:F,svgX:O.x,svgY:O.y,anchor:I,nodeId:j})},f)},[x,c,e,n]),A=s.useCallback(C=>{var L;C.stopPropagation();const j=C.currentTarget.getAttribute("data-node-id");if(!j)return;const v=e.find(k=>k.id===j);if(!v)return;m.current&&(clearTimeout(m.current),m.current=null);const P=(L=n.current)==null?void 0:L.getBoundingClientRect();if(!P)return;const M=C.clientX-P.left,z=C.clientY-P.top,O=n.current?Ue(n.current,C.clientX,C.clientY):{x:0,y:0};let F=v.placeName;v.data.aliases&&v.data.aliases.length>0&&(F+=` (aka ${v.data.aliases.join(", ")})`),v.data.description&&(F+=`
${v.data.description}`),F+=`
Status: ${v.data.status}`,p(!0);const I=x(M,z,P);g({content:F,svgX:O.x,svgY:O.y,anchor:I,nodeId:j})},[x,e,n]),R=s.useCallback(C=>{const j=C.currentTarget.dataset.nodeId;j&&(d(j===r?null:j),p(!1),g(null))},[r,d]);return{tooltip:i,tooltipScreenPosition:u,isTooltipLocked:c,handleMouseLeaveGeneral:l,handleSvgClick:S,handleEdgeMouseEnterById:y,handleNodeMouseEnterById:w,handleNodeClickById:A,handleDestinationClick:R,setIsTooltipLocked:p}},fa=(e,t)=>{const n=e.position.x,o=e.position.y,r=t.position.x,d=t.position.y,i=r-n,g=d-o,c=Math.sqrt(i*i+g*g)||1,p=(n+r)/2,m=(o+d)/2,f=c*.3,u=-g/c,b=i/c,x=p+u*f,l=m+b*f;return`M ${String(n)} ${String(o)} Q ${String(x)} ${String(l)} ${String(r)} ${String(d)}`},Fl={};function $l({nodes:e,edges:t,currentMapNodeId:n,destinationNodeId:o,itemPresenceByNode:r=Fl,onSelectDestination:d,labelOverlapMarginPx:i,itemIconScale:g,initialViewBox:c,onViewBoxChange:p}){const m=El(c,p),{svgRef:f,viewBox:u,handleMouseDown:b,handleMouseMove:x,handleMouseUp:l,handleMouseLeave:S,handleWheel:y,handleTouchStart:w,handleTouchMove:A,handleTouchEnd:R}=m,{tooltip:C,tooltipScreenPosition:j,isTooltipLocked:v,handleMouseLeaveGeneral:P,handleSvgClick:M,handleEdgeMouseEnterById:z,handleNodeMouseEnterById:O,handleNodeClickById:F,handleDestinationClick:I}=Ml({nodes:e,edges:t,svgRef:f,viewBox:u,destinationNodeId:o,onSelectDestination:d}),L=s.useMemo(()=>Ho(e,i),[e,i]),k=s.useMemo(()=>{const h=new Map(e.map(D=>[D.id,D])),E=new Map,V=D=>{if(!D)return 0;const G=E.get(D.id);if(G!==void 0)return G;const Y=D.data.parentNodeId?h.get(D.data.parentNodeId):void 0,$=Y?V(Y)+1:0;return E.set(D.id,$),$};return e.forEach(D=>V(D)),E},[e]),N=s.useMemo(()=>[...e].sort((h,E)=>(k.get(h.id)??0)-(k.get(E.id)??0)),[e,k]),T=s.useMemo(()=>{if(!o)return null;const h=e.find(D=>D.id===o),E=n?e.find(D=>D.id===n):null;if(!h)return null;const V=new Map(e.map(D=>[D.id,D]));return E&&(E.id===h.id||Wo(E,h,V))?null:a.jsx("polygon",{className:"map-destination-marker",pointerEvents:"none",points:"0,-14 10,0 0,14 -10,0",transform:`translate(${String(h.position.x)}, ${String(h.position.y)})`})},[o,e,n]);return e.length===0?a.jsx("div",{className:"map-content-area",children:a.jsx("p",{className:"text-slate-500 italic",children:"No map data available for this theme yet."})}):a.jsxs("div",{className:"map-content-area",children:[a.jsx("svg",{className:"map-svg-container",onClick:M,onMouseDown:b,onMouseLeave:S,onMouseMove:x,onMouseUp:l,onTouchEnd:R,onTouchMove:A,onTouchStart:w,onWheel:y,preserveAspectRatio:"xMidYMid meet",ref:f,viewBox:u,children:a.jsxs("g",{children:[t.map(h=>{const E=e.find(G=>G.id===h.sourceNodeId),V=e.find(G=>G.id===h.targetNodeId);if(!E||!V)return null;let D="map-edge";return h.data.type&&(D+=` ${h.data.type.replace(/\s+/g,"_").toLowerCase()}`),h.data.status&&(D+=` ${h.data.status.replace(/\s+/g,"_").toLowerCase()}`),a.jsx("g",{className:"map-edge-group","data-edge-id":h.id,onMouseEnter:z,onMouseLeave:P,children:h.data.type==="shortcut"?a.jsxs(a.Fragment,{children:[a.jsx("path",{d:fa(E,V),fill:"none",stroke:"transparent",strokeWidth:la}),a.jsx("path",{className:D,d:fa(E,V)})]}):a.jsxs(a.Fragment,{children:[a.jsx("line",{stroke:"transparent",strokeWidth:la,x1:E.position.x,x2:V.position.x,y1:E.position.y,y2:V.position.y}),a.jsx("line",{className:D,x1:E.position.x,x2:V.position.x,y1:E.position.y,y2:V.position.y})]})},h.id)}),N.map(h=>{let E="map-node-circle";E+=` ${h.data.nodeType}`,h.id===n&&(E+=" current");const V=h.data.status.replace(/\s+/g,"_").toLowerCase();E+=` ${V}`;const D=Zt(h);return a.jsxs("g",{className:"map-node","data-node-id":h.id,onClick:F,onMouseLeave:P,transform:`translate(${String(h.position.x)}, ${String(h.position.y)})`,children:[a.jsx("circle",{className:E,"data-node-id":h.id,onMouseEnter:h.data.nodeType==="feature"?O:void 0,onMouseLeave:h.data.nodeType==="feature"?P:void 0,pointerEvents:h.data.nodeType==="feature"?"visible":"none",r:D}),a.jsx("circle",{className:"map-node-hover-ring","data-node-id":h.id,fill:"none",onMouseEnter:O,onMouseLeave:P,pointerEvents:"stroke",r:D,stroke:"transparent",strokeWidth:8})]},h.id)}),T,N.map(h=>{const E=r[h.id]??{hasUseful:!1,hasVehicle:!1};if(!E.hasUseful&&!E.hasVehicle)return null;const D=Zt(h)+Ot*1.5,G=hr*2*g,Y=h.position.x+D*Math.sin(20*Math.PI/180)-G/2,$=h.position.y-D*Math.cos(20*Math.PI/180)-G/2,_=h.position.x+D*Math.sin(340*Math.PI/180)-G/2,K=h.position.y-D*Math.cos(340*Math.PI/180)-G/2;return a.jsxs("g",{children:[E.hasUseful?a.jsx("g",{pointerEvents:"none",transform:`translate(${String(Y)}, ${String($)})`,children:a.jsx(de,{color:"green",name:"mapItemBox",size:G,wrapper:"g"})}):null,E.hasVehicle?a.jsx("g",{pointerEvents:"none",transform:`translate(${String(_)}, ${String(K)})`,children:a.jsx(de,{color:"green",name:"mapWheel",size:G,wrapper:"g"})}):null]},`${h.id}-icons`)}),N.map(h=>{const E=en(h.data.nodeType)?20:25,V=Jo(h.placeName,E,br),D=Zt(h),G=en(h.data.nodeType)?7:12,Y=D+Ot+(L[h.id]??0),$=Ko(h.data.nodeType)?-(V.length-1)*.5*Rt+.3:Y/G;return a.jsx("text",{className:`map-node-label${en(h.data.nodeType)?h.data.nodeType==="feature"?" feature-label":h.data.nodeType==="room"?" room-label":" interior-label":""}`,"data-node-id":h.id,onMouseEnter:O,onMouseLeave:P,pointerEvents:"visible",transform:`translate(${String(h.position.x)}, ${String(h.position.y)})`,children:V.map((_,K)=>a.jsx("tspan",{dy:K===0?`${String($)}em`:`${String(Rt)}em`,x:"0",children:_},`${h.id}-${_}`))},`label-${h.id}`)})]})}),C&&j?a.jsxs("div",{className:`map-tooltip anchor-${C.anchor}`,style:{top:j.y,left:j.x,pointerEvents:v?"auto":"none"},children:[v&&C.nodeId?a.jsx("div",{className:"mb-1",children:a.jsx(B,{ariaLabel:C.nodeId===o?"Remove Destination":"Set Destination","data-node-id":C.nodeId,label:C.nodeId===o?"Remove Destination":"Set Destination",onClick:I,preset:"amber",size:"sm",variant:"standard"})}):null,C.content.split(`
`).map((h,E)=>a.jsxs(s.Fragment,{children:[E===0?a.jsx("strong",{children:h}):h,E<C.content.split(`
`).length-1&&a.jsx("br",{})]},`${String(C.nodeId)}-${String(h)}`))]}):null]})}function Dt({label:e,id:t,value:n,onChange:o,min:r,max:d,step:i,explanation:g=""}){const c=s.useCallback(p=>{o(parseFloat(p.target.value))},[o]);return a.jsxs("div",{className:"map-control-group",children:[a.jsxs("label",{className:"map-control-label",htmlFor:t,children:[e,": ",n.toFixed(i<1?2:0)]}),a.jsx("input",{className:"map-control-input",id:t,max:d,min:r,onChange:c,step:i,type:"range",value:n}),g?a.jsx("p",{className:"map-control-explanation",children:g}):null]})}function Rl(e){const[t,n]=s.useState(!1),o=s.useCallback(()=>{n(x=>!x)},[]),{padding:r,setPadding:d,anglePadding:i,setAnglePadding:g,overlapMargin:c,setOverlapMargin:p,itemIconScale:m,setItemIconScale:f,onReset:u,onRefreshLayout:b}=e;return a.jsxs("div",{className:`map-controls-container ${t?"controls-expanded":""}`,children:[t?a.jsxs("div",{className:"map-layout-sliders-wrapper",children:[a.jsx(Dt,{explanation:"Distance between parent and child levels",id:"layoutPadding",label:"Padding",max:60,min:5,onChange:d,step:1,value:r}),a.jsx(Dt,{explanation:"Extra spacing between siblings",id:"layoutAnglePadding",label:"Angle Padding",max:.5,min:0,onChange:g,step:.01,value:i}),a.jsx(Dt,{explanation:"Extra spacing when labels overlap",id:"overlapMargin",label:"Overlap Margin",max:10,min:0,onChange:p,step:1,value:c}),a.jsx(Dt,{explanation:"Relative size of item markers",id:"itemIconScale",label:"Icon Size",max:1,min:.2,onChange:f,step:.1,value:m}),a.jsx("div",{className:"mt-2",children:a.jsx(B,{ariaLabel:"Reset to Defaults",label:"Reset to Defaults",onClick:u,preset:"orange",variant:"standard"})})]}):null,a.jsxs("div",{className:"map-action-buttons-row",children:[a.jsx(B,{ariaLabel:"Toggle Layout Controls",label:`${t?"Hide":"Show"} Layout Controls`,onClick:o,preset:"blue",size:"sm",variant:"compact"}),a.jsx(B,{ariaLabel:"Refresh Layout",label:"Refresh Layout",onClick:b,preset:"blue",size:"sm",variant:"compact"})]})]})}function Ol({mapData:e,currentThemeName:t,currentMapNodeId:n,destinationNodeId:o,itemPresenceByNode:r,onSelectDestination:d,initialLayoutConfig:i,initialViewBox:g,onViewBoxChange:c,onNodesPositioned:p,onLayoutConfigChange:m,isVisible:f,onClose:u}){const[b,x]=s.useState([]),[l,S]=s.useState(i.IDEAL_EDGE_LENGTH),[y,w]=s.useState(i.NESTED_PADDING),[A,R]=s.useState(i.NESTED_ANGLE_PADDING),C=Ot,j=Rt,[v,P]=s.useState(i.LABEL_OVERLAP_MARGIN_PX),[M,z]=s.useState(i.ITEM_ICON_SCALE);s.useEffect(()=>{const T=i.IDEAL_EDGE_LENGTH,h=i.NESTED_PADDING,E=i.NESTED_ANGLE_PADDING,V=i.LABEL_OVERLAP_MARGIN_PX,D=i.ITEM_ICON_SCALE;S(G=>G===T?G:T),w(G=>G===h?G:h),R(G=>G===E?G:E),P(G=>G===V?G:V),z(G=>G===D?G:D)},[i]);const O=s.useMemo(()=>({IDEAL_EDGE_LENGTH:l,NESTED_PADDING:y,NESTED_ANGLE_PADDING:A,LABEL_MARGIN_PX:C,LABEL_LINE_HEIGHT_EM:j,LABEL_OVERLAP_MARGIN_PX:v,ITEM_ICON_SCALE:M}),[l,y,A,C,j,v,M]);s.useEffect(()=>{const T=setTimeout(()=>{m(O)},500);return()=>{clearTimeout(T)}},[O,m]);const F=s.useMemo(()=>t?e.nodes.filter(T=>T.themeName===t):[],[e.nodes,t]),I=s.useMemo(()=>{if(!t)return[];const T=new Set(F.map(h=>h.id));return e.edges.filter(h=>T.has(h.sourceNodeId)&&T.has(h.targetNodeId))},[e.edges,F,t]),L=s.useCallback(()=>{const T=[...F],h=Ma(T,{padding:y,anglePadding:A});x(h),p(h)},[F,y,A,p]);s.useEffect(()=>{f?L():x([])},[f,L]);const k=s.useCallback(()=>{L()},[L]),N=s.useCallback(()=>{S(Da),w(Aa),R(Pa),P(Ga),z(Oa)},[]);return f?a.jsx("div",{"aria-labelledby":"map-display-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:a.jsxs("div",{className:"animated-frame-content",children:[a.jsx(B,{ariaLabel:"Close map view",icon:a.jsx(de,{name:"x",size:20}),onClick:u,size:"sm",variant:"close"}),a.jsx("h1",{className:"text-xl font-bold text-teal-400 mb-2 text-center",id:"map-display-title",children:t?`Map: ${t}`:"Map"}),a.jsx("p",{className:"text-center text-xs text-slate-300 mb-1",children:"Pan by dragging, zoom with the mouse wheel or pinch. Hover for details."}),a.jsx($l,{currentMapNodeId:n,destinationNodeId:o,edges:I,initialViewBox:g,itemIconScale:M,itemPresenceByNode:r,labelOverlapMarginPx:v,nodes:b,onSelectDestination:d,onViewBoxChange:c}),a.jsx(Rl,{anglePadding:A,itemIconScale:M,onRefreshLayout:k,onReset:N,overlapMargin:v,padding:y,setAnglePadding:R,setItemIconScale:z,setOverlapMargin:P,setPadding:w})]})}):null}function yt({isOpen:e,title:t,message:n,onConfirm:o,onCancel:r,confirmText:d="Confirm",cancelText:i="Cancel",confirmPreset:g="sky",isCustomModeShift:c=!1}){const p=s.useCallback(f=>{f.stopPropagation()},[]);if(!e)return null;let m=n;return t==="Confirm Reality Shift"&&c&&(m=a.jsx(a.Fragment,{children:"This will allow you to choose a new theme to shift to. The current adventure will be summarized. Are you sure you wish to proceed?"})),a.jsxs("div",{"aria-labelledby":"confirmation-dialog-title","aria-modal":"true",className:"fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center z-[100] p-4 backdrop-blur-sm",onClick:r,role:"dialog",children:[a.jsxs("div",{className:"bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-lg transform transition-all duration-300 ease-out scale-95 opacity-0 animate-dialog-enter",onClick:p,style:{animationFillMode:"forwards"},children:[a.jsx("h2",{className:"text-2xl font-bold text-sky-300 mb-5",id:"confirmation-dialog-title",children:t}),a.jsx("div",{className:"text-slate-300 mb-8 text-base leading-relaxed",children:m}),a.jsxs("div",{className:"flex justify-end space-x-4",children:[a.jsx(B,{ariaLabel:i,label:i,onClick:r,preset:"slate",size:"md",variant:"compact"}),a.jsx(B,{ariaLabel:d,label:d,onClick:o,preset:g,size:"md",variant:"compact"})]})]}),a.jsx("style",{children:`
        @keyframes dialog-enter {
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        .animate-dialog-enter {
          animation: dialog-enter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
      `})]})}yt.defaultProps={cancelText:"Cancel",confirmPreset:"sky",confirmText:"Confirm",isCustomModeShift:!1};function Gl({messages:e}){const t=s.useRef(null),n="Game Log",o=a.jsx(de,{color:"emerald",inline:!0,marginRight:8,name:"log",size:20}),r=(()=>{const d=new Map;return e.map(i=>{const g=d.get(i)??0;return d.set(i,g+1),a.jsxs("li",{className:"text-slate-200 leading-snug",children:[a.jsx("span",{className:"mr-1 text-emerald-500",children:"Â»"}),i]},`${i}-${String(g)}`)})})();return a.jsx(Fe,{borderColorClass:"border-emerald-700",borderWidthClass:"border-b-2",containerClassName:"mt-6 bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700 max-h-80 overflow-y-auto",contentColorClass:"",contentFontClass:"",header:n,headerFont:"xl",headerIcon:o,headerPreset:"emerald",headerTag:"h3",headerWrapperClassName:"flex items-center",children:a.jsxs("ul",{className:"space-y-2 text-sm",children:[r,a.jsx("div",{ref:t})]})})}function _l({themeHistory:e,gameLog:t,isVisible:n,onClose:o}){const r=Object.entries(e);return a.jsx("div",{"aria-labelledby":"history-title","aria-modal":"true",className:`animated-frame ${n?"open":""}`,role:"dialog",children:a.jsxs("div",{className:"animated-frame-content",children:[a.jsx(B,{ariaLabel:"Close history",icon:a.jsx(de,{name:"x",size:20}),onClick:o,size:"sm",variant:"close"}),a.jsxs("div",{className:"theme-memory-content-area",children:[a.jsx(Fe,{borderColorClass:"border-purple-700",borderWidthClass:"border-b-2",containerClassName:"mt-4 mb-4",header:"History",headerFont:"2xl",headerPreset:"purple",headerTag:"h2",headerWrapperClassName:"text-center"}),a.jsx(Gl,{messages:t}),a.jsx(Fe,{borderColorClass:"border-purple-700",borderWidthClass:"border-b-2",containerClassName:"mt-4 mb-4",header:"Echoes of Past Realities",headerFont:"2xl",headerPreset:"purple",headerTag:"h2",headerWrapperClassName:"text-center"}),r.length===0&&a.jsx("p",{className:"text-slate-300 italic text-center",children:"No alternate timelines have been chronicled yet."}),r.length>0&&a.jsx("ul",{className:"space-y-4",children:r.map(([d,i])=>a.jsxs("li",{className:"text-slate-300 bg-slate-700/80 p-4 rounded-lg shadow-lg border border-slate-600 transition-all hover:shadow-purple-500/40 hover:border-purple-500",children:[a.jsx("h4",{className:"font-semibold text-xl text-purple-300 mb-2",children:d}),i.summary&&i.summary!=="The details of this reality are hazy..."?a.jsxs("p",{className:"text-sm text-slate-300 mb-2 italic leading-relaxed",children:["â€œ",i.summary,"â€"]}):a.jsx("p",{className:"text-sm text-slate-300 mb-2 italic",children:"The memories of this reality are too fragmented to recall clearly."})]},d))})]})]})})}console.error("GEMINI_API_KEY for GoogleGenAI is not set. Image visualization will not work.");function Vl({currentSceneDescription:e,currentTheme:t,mapData:n,allNPCs:o,localTime:r,localEnvironment:d,localPlace:i,isVisible:g,onClose:c,setGeneratedImage:p,cachedImageUrl:m,cachedImageScene:f}){const[u,b]=s.useState(null),[x,l]=s.useState(!1),[S,y]=s.useState(null),[w,A]=s.useState(1),[R,C]=s.useState({x:0,y:0}),[j,v]=s.useState(!1),[P,M]=s.useState(null),[z,O]=s.useState(null),F=s.useRef(null),I=($,_,K)=>Math.min(K,Math.max(_,$)),L=s.useCallback($=>{$.cancelable&&$.preventDefault();const _=$.deltaY<0?1.1:.9;A(K=>I(K*_,1,4))},[]),k=s.useCallback($=>{v(!0),M({x:$.clientX,y:$.clientY})},[]),N=s.useCallback($=>{if(!j||!P)return;const _=$.clientX-P.x,K=$.clientY-P.y;C(X=>({x:X.x+_,y:X.y+K})),M({x:$.clientX,y:$.clientY})},[j,P]),T=s.useCallback(()=>{v(!1),M(null)},[]),h=($,_)=>Math.sqrt(($.clientX-_.clientX)**2+($.clientY-_.clientY)**2),E=s.useCallback($=>{$.cancelable&&$.preventDefault(),$.touches.length===1?(v(!0),M({x:$.touches[0].clientX,y:$.touches[0].clientY}),O(null)):$.touches.length===2&&(v(!1),M(null),O(h($.touches[0],$.touches[1])))},[]),V=s.useCallback($=>{if($.cancelable&&$.preventDefault(),$.touches.length===1&&j&&P){const _=$.touches[0],K=_.clientX-P.x,X=_.clientY-P.y;C(ae=>({x:ae.x+K,y:ae.y+X})),M({x:_.clientX,y:_.clientY})}else if($.touches.length===2&&z!==null){const _=h($.touches[0],$.touches[1]);if(_===0)return;A(K=>I(K*(_/z),1,4)),O(_)}},[j,P,z]),D=s.useCallback($=>{$.touches.length<2&&O(null),$.touches.length<1&&(v(!1),M(null))},[]);s.useEffect(()=>{A(1),C({x:0,y:0})},[u]);const G=s.useCallback(async()=>{{y("Image generation service or theme is not available."),l(!1),Ye(null);return}},[e,t,n,o,r,d,i,p]),Y=s.useCallback(()=>{G()},[G]);return s.useEffect(()=>{g&&(m&&f===e?(b(m),l(!1),y(null)):G())},[g,m,f,e,G]),a.jsx("div",{"aria-labelledby":"visualizer-title","aria-modal":"true",className:`animated-frame ${g?"open":""}`,role:"dialog",children:a.jsxs("div",{className:"animated-frame-content visualizer-content-area",children:[a.jsx(B,{ariaLabel:"Close visualizer",icon:a.jsx(de,{name:"x",size:20}),onClick:c,size:"sm",variant:"close"}),x?a.jsx("div",{className:"visualizer-spinner-container",children:a.jsx(tt,{})}):null,!x&&S?a.jsxs("div",{className:"visualizer-error-container",children:[a.jsx("h2",{className:"text-xl font-semibold text-red-400 mb-2",id:"visualizer-title",children:"Vision Failed"}),a.jsx("p",{children:S}),a.jsx("button",{className:"mt-4 px-6 py-2 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-md shadow transition-colors",onClick:Y,type:"button",children:"Retry Visualization"})]}):null,!x&&!S&&u?a.jsxs("div",{className:"visualizer-image-container",onMouseDown:k,onMouseLeave:T,onMouseMove:N,onMouseUp:T,onTouchEnd:D,onTouchMove:V,onTouchStart:E,onWheel:L,role:"presentation",children:[a.jsx("img",{alt:"Scene visualization",className:"visualizer-image",ref:F,src:u,style:{transform:`translate(${String(R.x)}px, ${String(R.y)}px) scale(${String(w)})`}}),a.jsx("h2",{className:"sr-only",id:"visualizer-title",children:"Scene Visualization"})]}):null,!x&&!S&&!u&&g?a.jsx("div",{className:"visualizer-spinner-container",children:a.jsx("p",{className:"mt-2 text-lg text-slate-300",id:"visualizer-title",children:"Preparing to visualize..."})}):null]})})}const Ul={},zl=async(e,t,n)=>{const o=`${e.id}-${String(n)}`,r=Ul[o];return r||(console.error("generateChapterImage: API key not configured."),"")};function ss({item:e,currentTheme:t,currentScene:n,storytellerThoughts:o,mapData:r,allNPCs:d,currentQuest:i,isVisible:g,startIndex:c=0,onClose:p,updateItemContent:m,onInspect:f,onWriteJournal:u,canWriteJournal:b=!0,canInspectJournal:x=!0,isWritingJournal:l=!1}){var se;const[S,y]=s.useState(null),[w,A]=s.useState(!1),[R,C]=s.useState(!1),j=w||R,[v,P]=s.useState(!1),[M,z]=s.useState(null),[O,F]=s.useState(c),I=s.useRef(!1),L=(e==null?void 0:e.type)==="book",k=(e==null?void 0:e.type)==="page",N=(e==null?void 0:e.id)===fe,T=s.useMemo(()=>{if(!e)return[];if(e.id===fe)return e.chapters??[];if(e.chapters&&e.chapters.length>0)return e.chapters;const U=e;return[{heading:e.name,description:e.description,contentLength:U.contentLength??30,actualContent:U.actualContent,visibleContent:U.visibleContent}]},[e]),h=s.useMemo(()=>{if(!e||e.type!=="book")return T.length;let U=0;for(;U<T.length&&T[U].actualContent;U+=1);return Math.min(T.length,U+1)},[T,e]),E=s.useMemo(()=>T.every(U=>!!U.actualContent),[T]),V=s.useCallback(()=>{F(U=>Math.max(0,U-1))},[]),D=s.useCallback(()=>{F(U=>Math.min(N?T.length-1:h,U+1))},[N,T.length,h]),G=s.useCallback(()=>{f==null||f()},[f]),Y=s.useCallback(()=>{u==null||u()},[u]),$=s.useCallback(U=>{const H=Number(U.target.value);L&&!N?H<=h&&F(H):H<h&&F(H)},[h,L,N]),{name:_,systemInstructionModifier:K}=t,X=s.useCallback(()=>{P(U=>!U)},[]);s.useEffect(()=>{P(!1),F(c)},[e==null?void 0:e.id,g,c]);const ae=s.useCallback(U=>{U.target===U.currentTarget&&p()},[p]),le=s.useMemo(()=>{const U=(e==null?void 0:e.tags)??[],H=[],J=(e==null?void 0:e.type)==="book"&&!N?O-1:O,Se=J>=0&&J<T.length?T[J]:void 0,he=v&&!!(Se!=null&&Se.actualContent),je=!he&&U.includes("foreign");return U.includes("handwritten")?H.push(je?"tag-handwritten-foreign":"tag-handwritten"):U.includes("printed")?H.push(je?"tag-printed-foreign":"tag-printed"):U.includes("typed")?H.push(je?"tag-typed-foreign":"tag-typed"):U.includes("digital")&&H.push(je?"tag-digital-foreign":"tag-digital"),U.includes("faded")&&H.push("tag-faded"),U.includes("smudged")&&H.push("tag-smudged"),U.includes("torn")&&H.push("tag-torn"),he||(U.includes("glitching")&&H.push("tag-glitching"),U.includes("encrypted")&&H.push("tag-encrypted"),U.includes("foreign")&&H.push("tag-foreign")),U.includes("gothic")&&H.push("tag-gothic"),U.includes("runic")&&H.push("tag-runic"),U.includes("recovered")&&v&&H.push("tag-recovered"),H.join(" ")},[e,v,O,T,N]),q=s.useMemo(()=>{const U=r.nodes.filter(H=>H.themeName===_&&H.data.nodeType!=="feature"&&H.data.nodeType!=="room");return Tt(U,!0)},[r,_]),ie=s.useMemo(()=>{const U=d.filter(H=>H.themeName===_);return U.length>0?ze(U," - ",!1,!1,!1,!0):"None specifically known in this theme yet."},[d,_]);s.useEffect(()=>{if(!g||!e){y(null),z(null),A(!1);return}if(e.type==="book"&&!N&&O===0){y(null),A(!1);return}const U=e.type==="book"&&!N?O-1:O;if(U<0||U>=T.length){y(null),A(!1);return}const H=T[U];if(H.visibleContent){y(H.visibleContent),A(!1);return}if(e.id===fe&&H.actualContent){y(H.actualContent),A(!1);return}A(!0),Ye(e.type==="book"?"book":"page"),(async()=>{const J=H.contentLength,ne=await Gt(H.heading,H.description,J,_,K,n,o,q,ie,i,"Write it exclusively in English without any foreign, encrypted, or gibberish text.",e.type==="book"&&!N&&U>0?T[U-1].actualContent??"":void 0);if(ne){const Se=e.tags??[];let he=ne;Se.includes("foreign")?he=await Gt(H.heading,H.description,J,_,K,n,o,q,ie,i,`Translate the following text into an artificial nonexistent language that fits the theme and context:
"""${ne}"""`)??ne:Se.includes("encrypted")?he=wa(ne):Se.includes("runic")&&(he=Ta(ne)),Se.includes("torn")&&!Se.includes("recovered")&&(he=Ia(he)),m(e.id,ne,he,U),y(he)}A(!1),Ye(null)})()},[g,e,O,T,_,K,n,o,q,ie,i,m,N]),s.useEffect(()=>{if(C(!1),!g||!e||e.type!=="picture"&&e.type!=="map"){z(null),C(!1);return}const U=O;if(U<0||U>=T.length){z(null),C(!1);return}const H=T[U];(async()=>{if(Nt(H.imageData)){const ne=await dt(e.id,U);if(ne){z(`data:image/jpeg;base64,${ne}`),C(!1);return}}else if(H.imageData){await ut(e.id,U,H.imageData),m(e.id,void 0,void 0,U,Be(e.id,U)),z(`data:image/jpeg;base64,${H.imageData}`),C(!1);return}else{const ne=await dt(e.id,U);if(ne){m(e.id,void 0,void 0,U,Be(e.id,U)),z(`data:image/jpeg;base64,${ne}`),C(!1);return}}if(I.current)return;I.current=!0,C(!0),Ye(e.type==="book"?"book":"page");const J=await zl(e,t,U);J&&(await ut(e.id,U,J),m(e.id,void 0,void 0,U,Be(e.id,U)),z(`data:image/jpeg;base64,${J}`)),C(!1),Ye(null),I.current=!1})()},[g,e,O,T,t,m]);const xe=s.useMemo(()=>{if(!e)return S;const U=e.type==="book"&&!N?O-1:O;if(!(U>=0&&U<T.length))return S;const J=T[U];return v&&J.actualContent?J.actualContent:S},[v,e,S,O,T,N]),ee=s.useMemo(()=>N&&l,[N,l]);s.useEffect(()=>{if(ee)return Ye("journal"),()=>{Ye(null)}},[ee]);const me=s.useMemo(()=>{var H;if(!e||!((H=e.tags)!=null&&H.includes("torn"))||e.tags.includes("recovered")||!xe)return null;const U=xe.trim();return U.startsWith("--- torn ---")?"top":U.endsWith("--- torn ---")?"bottom":null},[xe,e]),Ie=s.useMemo(()=>e?N?x:L||k?E:!0:!1,[e,N,L,k,x,E]);return a.jsx("div",{"aria-labelledby":"page-view-title","aria-modal":"true",className:`animated-frame ${g?"open":""}`,onClick:ae,role:"dialog",children:a.jsxs("div",{className:"animated-frame-content page-view-content-area",children:[a.jsx(B,{ariaLabel:"Close page",icon:a.jsx(de,{name:"x",size:20}),onClick:p,size:"sm",variant:"close"}),e!=null&&e.name?a.jsx("h2",{className:"text-2xl font-bold text-amber-400 mb-4 text-center",id:"page-view-title",children:e.name}):null,L||N?a.jsxs("div",{className:"flex justify-center items-center gap-2 mb-2",children:[N&&f?a.jsx(B,{ariaLabel:"Inspect",disabled:!Ie,label:"Inspect",onClick:G,preset:"indigo",size:"sm",variant:"compact"}):null,a.jsx(B,{ariaLabel:"Previous chapter",disabled:O===0,label:"â—„",onClick:V,preset:"slate",size:"lg",variant:"toolbar"}),a.jsx("select",{"aria-label":"Select chapter",className:"bg-slate-800 text-white text-md h-9 p-2",onChange:$,value:O,children:L&&!N?a.jsxs(a.Fragment,{children:[a.jsx("option",{value:0,children:"ToC"}),T.slice(0,h).map((U,H)=>a.jsx("option",{value:H+1,children:U.heading},U.heading))]}):T.map((U,H)=>a.jsx("option",{value:H,children:U.heading},U.heading))}),a.jsx(B,{ariaLabel:"Next chapter",disabled:j||(L&&!N?O>=h||O===T.length:O>=T.length-1),label:"â–º",onClick:D,preset:"slate",size:"lg",variant:"toolbar"}),N&&u?a.jsx(B,{ariaLabel:"Write entry",disabled:!b||l,label:"Write",onClick:Y,preset:"blue",size:"sm",title:"Write a new journal entry",variant:"compact"}):null]}):null,(se=e==null?void 0:e.tags)!=null&&se.includes("recovered")?a.jsx("div",{className:"flex justify-center",children:a.jsx(B,{ariaLabel:v?"Show encoded text":"Show decoded text",label:v?"Hide":"Reveal",onClick:X,preset:v?"sky":"slate",pressed:v,size:"sm",variant:"toggle"})}):null,ee?a.jsx(tt,{}):j?a.jsx(tt,{}):(e==null?void 0:e.type)==="book"&&!N&&O===0?a.jsx("ul",{className:`p-5 mt-4 list-disc list-inside overflow-y-auto text-left ${le}`,children:T.map((U,H)=>a.jsx("p",{children:`${String(H+1)}. ${U.heading}`},U.heading))}):xe||((e==null?void 0:e.type)==="picture"||(e==null?void 0:e.type)==="map")&&M?a.jsxs("div",{className:`whitespace-pre-wrap text-lg overflow-y-auto p-5 mt-4 ${le} ${me?`torn-${me}`:""}`,children:[((e==null?void 0:e.type)==="picture"||(e==null?void 0:e.type)==="map")&&M?a.jsx("div",{className:"mb-4 flex justify-center",children:a.jsx("img",{alt:e.name,className:"max-h-[24rem] object-contain mask-gradient-edges",src:M})}):null,xe?Yo(xe):null]}):N&&T.length===0?a.jsx("div",{className:`whitespace-pre-wrap text-lg overflow-y-auto p-5 mt-4 min-h-[20rem] tag-${t.playerJournalStyle}`}):null]})})}ss.defaultProps={canInspectJournal:!0,canWriteJournal:!0,isWritingJournal:!1,onInspect:void 0,onWriteJournal:void 0,startIndex:0};function Bl({isVisualizerVisible:e,onCloseVisualizer:t,visualizerImageUrl:n,visualizerImageScene:o,setGeneratedImage:r,currentScene:d,currentTheme:i,mapData:g,allNPCs:c,localTime:p,localEnvironment:m,localPlace:f,isKnowledgeBaseVisible:u,onCloseKnowledgeBase:b,isHistoryVisible:x,onCloseHistory:l,themeHistory:S,gameLog:y,isMapVisible:w,onCloseMap:A,currentThemeName:R,currentMapNodeId:C,destinationNodeId:j,itemPresenceByNode:v,onSelectDestination:P,initialLayoutConfig:M,initialViewBox:z,onViewBoxChange:O,onNodesPositioned:F,onLayoutConfigChange:I,newGameFromMenuConfirmOpen:L,handleConfirmNewGameFromMenu:k,handleCancelNewGameFromMenu:N,newCustomGameConfirmOpen:T,handleConfirmNewCustomGame:h,handleCancelNewCustomGame:E,loadGameFromMenuConfirmOpen:V,handleConfirmLoadGameFromMenu:D,handleCancelLoadGameFromMenu:G,shiftConfirmOpen:Y,handleConfirmShift:$,handleCancelShift:_,isCustomGameModeShift:K,inventory:X,playerJournal:ae,lastJournalWriteTurn:le,pageItemId:q,pageStartChapterIndex:ie,isPageVisible:xe,onClosePage:ee,storytellerThoughts:me,currentQuest:Ie,updateItemContent:se,updatePlayerJournalContent:U,onItemInspect:H,canInspectJournal:J,onWriteJournal:ne,canWriteJournal:Se,isWritingJournal:he}){const je=s.useCallback((Ne,De,Pe,Ee,Oe)=>{q===fe?U(De??"",Ee):se(Ne,De,Pe,Ee,Oe)},[q,se,U]),$e=s.useCallback(()=>{q&&(H(q),ee())},[q,H,ee]),Ae=s.useCallback(()=>{q===fe&&ne()},[q,ne]);return a.jsxs(a.Fragment,{children:[a.jsx(Vl,{allNPCs:c,cachedImageScene:o,cachedImageUrl:n,currentSceneDescription:d,currentTheme:i,isVisible:e,localEnvironment:m,localPlace:f,localTime:p,mapData:g.nodes,onClose:t,setGeneratedImage:r}),a.jsx(Dl,{allNPCs:c,currentTheme:i,isVisible:u,onClose:b}),a.jsx(_l,{gameLog:y,isVisible:x,onClose:l,themeHistory:S}),a.jsx(ss,{allNPCs:c,canInspectJournal:J,canWriteJournal:Se,currentQuest:Ie,currentScene:d,currentTheme:i,isVisible:xe,isWritingJournal:he,item:q===fe?{id:fe,name:"Personal Journal",type:"book",description:"Your own journal",holderId:ge,chapters:ae,lastWriteTurn:le,tags:[i.playerJournalStyle]}:X.find(Ne=>Ne.id===q)??null,mapData:g,onClose:ee,onInspect:q?$e:void 0,onWriteJournal:q?Ae:void 0,startIndex:ie,storytellerThoughts:me,updateItemContent:je}),a.jsx(Ol,{currentMapNodeId:C,currentThemeName:R,destinationNodeId:j,initialLayoutConfig:M,initialViewBox:z,isVisible:w,itemPresenceByNode:v,mapData:g,onClose:A,onLayoutConfigChange:I,onNodesPositioned:F,onSelectDestination:P,onViewBoxChange:O}),a.jsx(yt,{confirmPreset:"red",confirmText:"Start New Game",isOpen:L,message:"Are you sure you want to start a new game? Your current progress will be lost.",onCancel:N,onConfirm:k,title:"Confirm New Game"}),a.jsx(yt,{confirmPreset:"orange",confirmText:"Start Custom Game",isOpen:T,message:"Are you sure you want to start a new custom game? Your current progress will be lost.",onCancel:E,onConfirm:h,title:"Confirm Custom Game"}),a.jsx(yt,{confirmPreset:"blue",confirmText:"Load Game",isOpen:V,message:"Are you sure you want to load a game? Your current progress will be overwritten if you load a new game.",onCancel:G,onConfirm:D,title:"Confirm Load Game"}),a.jsx(yt,{confirmPreset:"purple",confirmText:"Shift Reality",isCustomModeShift:K,isOpen:Y,message:a.jsxs(a.Fragment,{children:["This will destabilize the current reality, leading to an"," ",a.jsx("strong",{className:"text-purple-400",children:"immediate and unpredictable shift"})," ","to a new theme. Are you sure you wish to proceed?"]}),onCancel:_,onConfirm:$,title:"Confirm Reality Shift"})]})}function Hl({freeFormActionText:e,canPerformFreeAction:t,onChange:n,onSubmit:o}){const r=s.useCallback(()=>{o()},[o]);return a.jsxs("div",{className:"mt-4 p-4 bg-slate-800 border border-slate-700 rounded-lg shadow",children:[a.jsxs("label",{className:"block text-sm font-medium text-amber-300 mb-1",htmlFor:"freeFormAction",children:["Perform Custom Action (Cost:"," ",vt," ","Score Points)"]}),a.jsxs("div",{className:"flex space-x-2",children:[a.jsx("input",{"aria-label":"Custom action input",className:"flex-grow p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 disabled:bg-slate-600 disabled:text-slate-300",disabled:!t,id:"freeFormAction",maxLength:ia,onChange:n,placeholder:"Type your custom action here...",type:"text",value:e}),a.jsx(B,{ariaLabel:"Submit custom action",disabled:!t||e.trim()==="",label:"Submit",onClick:r,preset:"green",type:"button",variant:"compact"})]}),!t&&a.jsx("p",{className:"text-xs text-red-400 mt-1",children:"Not enough score points."}),t?a.jsxs("p",{className:"text-xs text-slate-300 mt-1",children:["Max",ia," ","characters."]}):null]})}const Wl=async(e,t,n,o,r,d,i,g,c,p,m,f)=>(console.error("generateJournalEntry: API key not configured."),null);function Jl(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.summaryText=="string"&&Array.isArray(t.participants)&&t.participants.every(n=>typeof n=="string")&&typeof t.timestamp=="string"&&typeof t.location=="string"}function os(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.heading=="string"&&typeof t.description=="string"&&typeof t.contentLength=="number"&&(t.actualContent===void 0||typeof t.actualContent=="string")&&(t.visibleContent===void 0||typeof t.visibleContent=="string")&&(t.imageData===void 0||typeof t.imageData=="string")}function Kl(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.id=="string"&&typeof t.name=="string"&&typeof t.type=="string"&&yr.includes(t.type)&&typeof t.description=="string"&&typeof t.holderId=="string"&&(t.activeDescription===void 0||typeof t.activeDescription=="string")&&(t.isActive===void 0||typeof t.isActive=="boolean")&&(t.stashed===void 0||typeof t.stashed=="boolean")&&(t.tags===void 0||Array.isArray(t.tags)&&t.tags.every(n=>typeof n=="string"))&&(t.lastWriteTurn===void 0||typeof t.lastWriteTurn=="number")&&(t.lastInspectTurn===void 0||typeof t.lastInspectTurn=="number")&&(t.contentLength===void 0||typeof t.contentLength=="number")&&(t.actualContent===void 0||typeof t.actualContent=="string")&&(t.visibleContent===void 0||typeof t.visibleContent=="string")&&(t.imageData===void 0||typeof t.imageData=="string")&&(t.chapters===void 0||Array.isArray(t.chapters)&&t.chapters.every(os))&&(t.knownUses===void 0||Array.isArray(t.knownUses)&&t.knownUses.every(n=>typeof n.actionName=="string"&&typeof n.promptEffect=="string"&&(n.description===void 0||typeof n.description=="string")&&(n.appliesWhenActive===void 0||typeof n.appliesWhenActive=="boolean")&&(n.appliesWhenInactive===void 0||typeof n.appliesWhenInactive=="boolean")))}function Yl(e){if(typeof e!="object"||e===null)return!1;const t=e;for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const o=t[n];if(!o||typeof o.summary!="string"||typeof o.mainQuest!="string"||typeof o.currentObjective!="string"||!Array.isArray(o.placeNames)||!o.placeNames.every(r=>typeof r=="string")||!Array.isArray(o.npcNames)||!o.npcNames.every(r=>typeof r=="string"))return!1}return!0}function Ql(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.id=="number"&&typeof t.text=="string"&&Array.isArray(t.entities)&&t.entities.every(n=>typeof n=="string")&&typeof t.themeName=="string"&&typeof t.createdTurn=="number"&&typeof t.tier=="number"}function Xl(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.id=="string"&&t.id.trim()!==""&&typeof t.themeName=="string"&&typeof t.name=="string"&&t.name.trim()!==""&&typeof t.description=="string"&&t.description.trim()!==""&&(t.aliases===void 0||Array.isArray(t.aliases)&&t.aliases.every(n=>typeof n=="string"))&&(t.presenceStatus===void 0||vr.includes(t.presenceStatus))&&(t.lastKnownLocation===void 0||t.lastKnownLocation===null||typeof t.lastKnownLocation=="string")&&(t.preciseLocation===void 0||t.preciseLocation===null||typeof t.preciseLocation=="string")&&(t.dialogueSummaries===void 0||Array.isArray(t.dialogueSummaries)&&t.dialogueSummaries.every(Jl))}function ql(e){return Array.isArray(e)&&e.every(t=>typeof t=="string"&&Xo.includes(t))}function Zl(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.description=="string"&&(t.aliases===void 0||Array.isArray(t.aliases)&&t.aliases.every(n=>typeof n=="string"))&&(t.status===void 0||["undiscovered","discovered","rumored","quest_target","blocked"].includes(t.status))&&(t.visited===void 0||typeof t.visited=="boolean")&&(t.isFeature===void 0||typeof t.isFeature=="boolean")&&(t.parentNodeId===void 0||typeof t.parentNodeId=="string")}function ei(e){if(!e||typeof e!="object")return!1;const t=e,n=t.position;return typeof t.id=="string"&&t.id.trim()!==""&&typeof t.themeName=="string"&&typeof t.placeName=="string"&&t.placeName.trim()!==""&&n!==void 0&&typeof n.x=="number"&&typeof n.y=="number"&&Zl(t.data)}function ti(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.id=="string"&&t.id.trim()!==""&&typeof t.sourceNodeId=="string"&&t.sourceNodeId.trim()!==""&&typeof t.targetNodeId=="string"&&t.targetNodeId.trim()!==""&&typeof t.data=="object"}function ni(e){if(!e||typeof e!="object")return!1;const t=e;return Array.isArray(t.nodes)&&t.nodes.every(ei)&&Array.isArray(t.edges)&&t.edges.every(ti)}function ai(e){if(!e||typeof e!="object")return!1;const t=e,n=Object.keys(xt());for(const o of n){const r=t[o];if(typeof r!="number")return console.warn(`isValidMapLayoutConfig: Key '${o}' is missing or not a number. Value: ${String(r)}`),!1}return!0}function si(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.name=="string"&&t.name.trim()!==""&&typeof t.systemInstructionModifier=="string"&&typeof t.initialMainQuest=="string"&&typeof t.initialCurrentObjective=="string"&&typeof t.initialSceneDescriptionSeed=="string"&&typeof t.initialItems=="string"}function oi(e){if(!e||typeof e!="object")return console.warn("Invalid save data: Not an object."),!1;const t=e;if(t.saveGameVersion!==Ve){const r=e.saveGameVersion;console.warn(`Save data version mismatch. Expected ${Ve}, got ${String(r)}. Attempting to load anyway if structure is V3-compatible.`)}const n=["currentThemeName","currentThemeObject","currentScene","actionOptions","mainQuest","currentObjective","inventory","playerJournal","lastJournalWriteTurn","lastJournalInspectTurn","lastLoreDistillTurn","gameLog","lastActionLog","themeHistory","themeFacts","pendingNewThemeNameAfterShift","allNPCs","mapData","currentMapNodeId","destinationNodeId","mapLayoutConfig","mapViewBox","score","stabilityLevel","chaosLevel","localTime","localEnvironment","localPlace","enabledThemePacks","playerGender","turnsSinceLastShift","globalTurnNumber","isCustomGameMode"];for(const r of n)if(!(r in t)&&!(["currentThemeName","currentThemeObject","mainQuest","currentObjective","lastActionLog","pendingNewThemeNameAfterShift","localTime","localEnvironment","localPlace","currentMapNodeId","destinationNodeId","themeFacts"].includes(r)&&t[r]===null)&&r!=="isCustomGameMode"&&r!=="globalTurnNumber"&&r!=="themeFacts")return console.warn(`Invalid save data (V3): Missing field '${r}'.`),!1;if(t.currentThemeName!==null&&typeof t.currentThemeName!="string")return console.warn("Invalid save data (V3): currentThemeName type."),!1;if(t.currentThemeObject!==null&&!si(t.currentThemeObject))return console.warn("Invalid save data (V3): currentThemeObject type or structure."),!1;if(typeof t.currentScene!="string")return console.warn("Invalid save data (V3): currentScene type."),!1;if(!Array.isArray(t.actionOptions)||!t.actionOptions.every(r=>typeof r=="string"))return console.warn("Invalid save data (V3): actionOptions."),!1;if(t.mainQuest!==null&&typeof t.mainQuest!="string")return console.warn("Invalid save data (V3): mainQuest type."),!1;if(t.currentObjective!==null&&typeof t.currentObjective!="string")return console.warn("Invalid save data (V3): currentObjective type."),!1;if(!Array.isArray(t.inventory)||!t.inventory.every(Kl))return console.warn("Invalid save data (V3): inventory."),!1;if(!Array.isArray(t.playerJournal)||!t.playerJournal.every(os))return console.warn("Invalid save data (V3): playerJournal type."),!1;if(typeof t.lastJournalWriteTurn!="number")return console.warn("Invalid save data (V3): lastJournalWriteTurn type."),!1;if(typeof t.lastJournalInspectTurn!="number")return console.warn("Invalid save data (V3): lastJournalInspectTurn type."),!1;if(typeof t.lastLoreDistillTurn!="number")return console.warn("Invalid save data (V3): lastLoreDistillTurn type."),!1;if(!Array.isArray(t.gameLog)||!t.gameLog.every(r=>typeof r=="string"))return console.warn("Invalid save data (V3): gameLog."),!1;if(t.lastActionLog!==null&&typeof t.lastActionLog!="string")return console.warn("Invalid save data (V3): lastActionLog type."),!1;if(!Yl(t.themeHistory))return console.warn("Invalid save data (V3): themeHistory."),!1;if(t.themeFacts!==void 0&&!Array.isArray(t.themeFacts))return console.warn("Invalid save data (V5): themeFacts type."),!1;if(Array.isArray(t.themeFacts)&&!t.themeFacts.every(Ql))return console.warn("Invalid save data (V5): themeFacts structure."),!1;if(t.pendingNewThemeNameAfterShift!==null&&typeof t.pendingNewThemeNameAfterShift!="string")return console.warn("Invalid save data (V3): pendingNewThemeNameAfterShift type."),!1;if(!Array.isArray(t.allNPCs)||!t.allNPCs.every(Xl))return console.warn("Invalid save data (V3): allNPCs."),!1;if(!ni(t.mapData))return console.warn("Invalid save data (V3): mapData."),!1;if(t.currentMapNodeId!==null&&typeof t.currentMapNodeId!="string")return console.warn("Invalid save data (V3): currentMapNodeId type."),!1;if(t.destinationNodeId!==null&&typeof t.destinationNodeId!="string")return console.warn("Invalid save data (V3): destinationNodeId type."),!1;if(!ai(t.mapLayoutConfig))return console.warn("Invalid save data (V3): mapLayoutConfig."),!1;if(typeof t.mapViewBox!="string")return console.warn("Invalid save data (V3): mapViewBox type."),!1;if(typeof t.score!="number")return console.warn("Invalid save data (V3): score type."),!1;if(typeof t.stabilityLevel!="number")return console.warn("Invalid save data (V3): stabilityLevel type."),!1;if(typeof t.chaosLevel!="number")return console.warn("Invalid save data (V3): chaosLevel type."),!1;if(t.localTime!==null&&typeof t.localTime!="string")return console.warn("Invalid save data (V3): localTime type."),!1;if(t.localEnvironment!==null&&typeof t.localEnvironment!="string")return console.warn("Invalid save data (V3): localEnvironment type."),!1;if(t.localPlace!==null&&typeof t.localPlace!="string")return console.warn("Invalid save data (V3): localPlace type."),!1;if(!ql(t.enabledThemePacks))return console.warn("Invalid save data (V3): enabledThemePacks."),!1;if(typeof t.playerGender!="string")return console.warn("Invalid save data (V3): playerGender type."),!1;if(typeof t.turnsSinceLastShift!="number")return console.warn("Invalid save data(V3): turnsSinceLastShift type."),!1;if(typeof t.globalTurnNumber!="number")return console.warn("Invalid save data(V3): globalTurnNumber type."),!1;if(t.isCustomGameMode!==void 0&&typeof t.isCustomGameMode!="boolean")return console.warn("Invalid save data (V3): isCustomGameMode type."),!1;const o=["dialogueState"];for(const r of o)if(r in t&&t[r]!==null&&t[r]!==void 0)return console.warn(`Invalid save data (V3): Unexpected dialogue field '${r}' found in SavedGameDataShape. It should be null/undefined here.`),!1;return!0}function ha(e){const t=xt();if(e.mapLayoutConfig&&typeof e.mapLayoutConfig=="object"){const n=e.mapLayoutConfig,o={};for(const r of Object.keys(t)){const d=n[r];Object.prototype.hasOwnProperty.call(n,r)&&typeof d=="number"?o[r]=d:o[r]=t[r]}e.mapLayoutConfig=o}else e.mapLayoutConfig=t}function ba(e){!e||!Array.isArray(e.nodes)||e.nodes.forEach(t=>{t.data||(t.data={}),typeof t.data.description!="string"&&(t.data.description="No description provided."),Array.isArray(t.data.aliases)?t.data.aliases=t.data.aliases.filter(o=>typeof o=="string"):t.data.aliases=[],["undiscovered","discovered","rumored","quest_target","blocked"].includes(t.data.status)||(t.data.status="discovered"),typeof t.data.visited!="boolean"&&(t.data.visited=!1),typeof t.data.isFeature!="boolean"&&(t.data.isFeature=!1)})}function ri(e){return e.inventory=e.inventory.map(t=>({...t,id:t.id||Qo(t.name),tags:t.tags??[],stashed:t.stashed??!1,holderId:t.holderId||ge})),e.allNPCs=e.allNPCs.map(t=>{const n=t;return{...n,id:n.id??ct(n.name??""),aliases:n.aliases??[],presenceStatus:n.presenceStatus??"unknown",lastKnownLocation:n.lastKnownLocation??null,preciseLocation:n.preciseLocation??null,dialogueSummaries:n.dialogueSummaries??[]}}),e.mapViewBox=typeof e.mapViewBox=="string"?e.mapViewBox:rn,Array.isArray(e.themeFacts)||(e.themeFacts=[]),Array.isArray(e.playerJournal)||(e.playerJournal=[]),typeof e.lastJournalInspectTurn!="number"&&(e.lastJournalInspectTurn=0),typeof e.lastLoreDistillTurn!="number"&&(e.lastLoreDistillTurn=0),e}function ya(e,t){let n=null;e.saveGameVersion===Ve||typeof e.saveGameVersion=="string"&&e.saveGameVersion.startsWith(Ve.split(".")[0])?(e.saveGameVersion!==Ve&&console.warn(`Potentially compatible future V${Ve.split(".")[0]}.x save version '${String(e.saveGameVersion)}' from ${t}. Attempting to treat as current version (V3) for validation.`),n=e,ha(n),ba(n.mapData)):(console.warn(`Unknown save version '${String(e.saveGameVersion)}' from ${t}. This might fail validation.`),n=e,ha(n),ba(n.mapData)),!n.currentThemeObject&&n.currentThemeName&&(n.currentThemeObject=$t(n.currentThemeName),n.currentThemeObject||console.warn(`Failed to find theme "${n.currentThemeName}" during ${t} load. Game state might be incomplete.`));const o=e.globalTurnNumber;if(typeof o=="string"){const r=parseInt(o,10);n.globalTurnNumber=isNaN(r)?0:r}else o==null&&(n.globalTurnNumber=0);return n.destinationNodeId=n.destinationNodeId??null,oi(n)?ri(n):null}const li=e=>{const{dialogueState:t,objectiveAnimationType:n,lastDebugPacket:o,lastTurnChanges:r,debugLore:d,debugGoodFacts:i,debugBadFacts:g,isAwaitingManualShiftThemeSelection:c,...p}=e,m={nodes:e.mapData.nodes.map(u=>({...u,data:{description:u.data.description||"Description missing in save prep",aliases:u.data.aliases??[],status:u.data.status,isFeature:u.data.isFeature,visited:u.data.visited,parentNodeId:u.data.parentNodeId,nodeType:u.data.nodeType,...Object.fromEntries(Object.entries(u.data).filter(([b])=>!["description","aliases"].includes(b)))}})),edges:e.mapData.edges};return{...p,saveGameVersion:Ve,currentThemeObject:e.currentThemeObject,inventory:e.inventory.map(u=>({...u,tags:u.tags??[],stashed:u.stashed??!1,holderId:u.holderId||ge})),allNPCs:e.allNPCs.map(u=>({...u,aliases:u.aliases??[],presenceStatus:u.presenceStatus,lastKnownLocation:u.lastKnownLocation,preciseLocation:u.preciseLocation,dialogueSummaries:u.dialogueSummaries??[]})),mapData:m,currentMapNodeId:e.currentMapNodeId,destinationNodeId:e.destinationNodeId,mapLayoutConfig:e.mapLayoutConfig,mapViewBox:e.mapViewBox,score:e.score,stabilityLevel:e.stabilityLevel,chaosLevel:e.chaosLevel,localTime:e.localTime,localEnvironment:e.localEnvironment,localPlace:e.localPlace,enabledThemePacks:e.enabledThemePacks,playerGender:e.playerGender,turnsSinceLastShift:e.turnsSinceLastShift,globalTurnNumber:e.globalTurnNumber,isCustomGameMode:e.isCustomGameMode,themeFacts:e.themeFacts}},va=e=>{const t={nodes:e.mapData.nodes.map(o=>({...o,data:{...o.data,description:o.data.description||"Description missing on load",aliases:o.data.aliases??[]}})),edges:e.mapData.edges};let n=e.currentThemeObject;return!n&&e.currentThemeName&&(n=$t(e.currentThemeName),n||console.warn(`expandSavedDataToFullState: Theme "${e.currentThemeName}" not found in current definitions. Game may be unstable.`)),{...e,currentThemeObject:n,allNPCs:e.allNPCs.map(o=>({...o,dialogueSummaries:o.dialogueSummaries??[]})),mapData:t,currentMapNodeId:e.currentMapNodeId,destinationNodeId:e.destinationNodeId,mapLayoutConfig:e.mapLayoutConfig,mapViewBox:e.mapViewBox,isCustomGameMode:e.isCustomGameMode,globalTurnNumber:e.globalTurnNumber,themeFacts:e.themeFacts,debugLore:!1,debugGoodFacts:[],debugBadFacts:[],isAwaitingManualShiftThemeSelection:!1,dialogueState:null,objectiveAnimationType:null,lastDebugPacket:null,lastTurnChanges:null}},xa=e=>{const t=li(e);return t.inventory=t.inventory.map(n=>{var o;return{...n,chapters:(o=n.chapters)==null?void 0:o.map(r=>({...r,imageData:void 0}))}}),t.playerJournal=t.playerJournal.map(n=>({...n,imageData:void 0})),t},rs=e=>({current:xa(e[0]),previous:e[1]?xa(e[1]):null}),ls=e=>[va(e.current),e.previous?va(e.previous):void 0];function is(e,t){const n=e.current;if(!n||typeof n!="object")return null;const o=ya(n,t);if(!o)return null;const r=e.previous;let d=null;if(r&&typeof r=="object"){const i=ya(r,t);i&&(d=i)}return{current:o,previous:d}}const ii=(e,t,n)=>{const o=new Blob([e],{type:n}),r=URL.createObjectURL(o),d=document.createElement("a");d.href=r,d.download=t,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(r)},ci=async(e,t,n)=>{try{const o=await ua(e[0]),r=e[1]?await ua(e[1]):void 0,d={},i=p=>{p.inventory.forEach(m=>{var f;(f=m.chapters)==null||f.forEach((u,b)=>{u.imageData&&(d[nt(m.id,b)]=u.imageData)})}),p.playerJournal.forEach((m,f)=>{m.imageData&&(d[nt(fe,f)]=m.imageData)})};i(o),r&&i(r);const g=rs(e),c=JSON.stringify({game:g,debug:t,images:d},null,2);return ii(c,`WhispersInTheDark_Save_V${Ve}_${new Date().toISOString().slice(0,10)}.json`,"application/json"),!0}catch(o){return console.error("Error saving game state to file:",o),n&&n("An error occurred while preparing your game data for download."),!1}},ui=async e=>new Promise(t=>{const n=new FileReader;n.onload=o=>{try{if(o.target&&typeof o.target.result=="string"){const r=wt(o.target.result);if(r===null){t(null);return}const{game:d=r,debug:i,images:g}=r,c=is(d,"file");if(c){(async()=>{try{const p=ls(c),m=async x=>{const l=pe(x);return g&&(await Promise.all(l.inventory.map(async S=>{var y;await Promise.all(((y=S.chapters)==null?void 0:y.map(async(w,A)=>{const R=nt(S.id,A),C=g[R];C&&(await ut(S.id,A,C),w.imageData=Be(S.id,A))}))??[])})),await Promise.all(l.playerJournal.map(async(S,y)=>{const w=nt(fe,y),A=g[w];A&&(await ut(fe,y,A),S.imageData=Be(fe,y))}))),sl(l)},f=await m(p[0]),u=p[1]?await m(p[1]):void 0,b=Array.isArray(i)?[i[0]??null,i[1]??null]:[i??null,null];t({gameStateStack:[f,u],debugPacketStack:b})}catch{t(null)}})();return}}console.warn("File save data is invalid or version mismatch for V3. Not loading."),t(null)}catch(r){console.error("Error loading game state from file:",r),t(null)}},n.onerror=()=>{console.error("Error reading file."),t(null)},n.readAsText(e)}),fn=(e,t)=>{try{const n=rs(e);return localStorage.setItem(Mt,JSON.stringify(n)),!0}catch(n){console.error("Error saving game state to localStorage:",n);const o=n instanceof DOMException&&(n.name==="QuotaExceededError"||n.code===22)?"Could not save game: Browser storage is full. Please clear some space or try saving to a file.":"An unexpected error occurred while trying to automatically save your game.";return t&&t(o),!1}},di=()=>{try{const e=localStorage.getItem(Mt);if(!e)return null;const t=wt(e);if(t===null)return console.warn("Saved data found in localStorage could not be parsed as JSON."),null;if(typeof t!="object")return console.warn("Saved data found in localStorage is not an object."),null;const n=is(t,"localStorage");return n?ls(n):(console.warn("Local save data is invalid or version mismatch for V3. Starting new game."),localStorage.removeItem(Mt),localStorage.removeItem(St),null)}catch(e){return console.error("Error loading game state from localStorage:",e),localStorage.removeItem(Mt),localStorage.removeItem(St),null}},mi=async()=>{const e=di();if(!e)return null;const[t,n]=e,o=await da(t),r=n?await da(n):void 0;return[o,r]},hn=e=>{try{localStorage.setItem(St,JSON.stringify(e))}catch(t){console.error("Error saving debug packet stack to localStorage:",t)}},pi=()=>{try{const e=localStorage.getItem(St);if(!e)return null;const t=wt(e);if(Array.isArray(t)){const[n,o]=t;return[n??null,o??null]}return t&&typeof t=="object"?[t,null]:(console.warn("Saved debug stack found in localStorage could not be parsed."),null)}catch(e){return console.error("Error loading debug packet stack from localStorage:",e),localStorage.removeItem(St),null}},Ct=e=>{try{localStorage.setItem(ln,JSON.stringify(e))}catch(t){console.error("Error saving debug lore state to localStorage:",t)}},Ca=()=>{try{const e=localStorage.getItem(ln);if(!e)return null;const t=wt(e);if(!t||typeof t!="object"||typeof t.debugLore!="boolean")return console.warn("Saved debug lore data found in localStorage could not be parsed."),null;const n=Array.isArray(t.debugGoodFacts)?[...t.debugGoodFacts]:[],o=Array.isArray(t.debugBadFacts)?[...t.debugBadFacts]:[];return{debugLore:t.debugLore,debugGoodFacts:n,debugBadFacts:o}}catch(e){return console.error("Error loading debug lore state from localStorage:",e),localStorage.removeItem(ln),null}},gi=1500,fi=({gatherGameStateStack:e,gatherDebugPacketStack:t,applyLoadedGameState:n,setError:o,setIsLoading:r,isLoading:d=!1,dialogueState:i=null,hasGameBeenInitialized:g=!1})=>{const[c,p]=s.useState(xr),[m,f]=s.useState([...Cr]),[u,b]=s.useState(Sr),[x,l]=s.useState(Nr),[S,y]=s.useState(null),[w,A]=s.useState(null),[R,C]=s.useState(!1);s.useEffect(()=>{(async()=>{const I=await mi(),L=pi(),k=Ca();if(I){L&&A(L),k&&(I[0].debugLore=k.debugLore,I[0].debugGoodFacts=k.debugGoodFacts,I[0].debugBadFacts=k.debugBadFacts);const N=I[0];p(N.playerGender),f(N.enabledThemePacks),b(N.stabilityLevel),l(N.chaosLevel),y(I)}else y(null);C(!0)})()},[]);const j=s.useCallback(I=>{I.playerGender!==void 0&&p(I.playerGender),I.enabledThemePacks!==void 0&&f(I.enabledThemePacks),I.stabilityLevel!==void 0&&b(I.stabilityLevel),I.chaosLevel!==void 0&&l(I.chaosLevel)},[]),v=s.useRef(null),P=s.useRef(null);s.useEffect(()=>{if(!(d||!g||!R||i))return P.current&&clearTimeout(P.current),P.current=window.setTimeout(()=>{if(e&&t){const I=e(),L=t();fn(I,o?k=>{o(k)}:void 0),hn(L),Ct({debugLore:I[0].debugLore,debugGoodFacts:I[0].debugGoodFacts,debugBadFacts:I[0].debugBadFacts})}},gi),()=>{P.current&&clearTimeout(P.current)}},[e,t,d,g,R,i,o]);const M=s.useCallback(async()=>{if(d||i){o==null||o("Cannot save to file while loading or in dialogue.");return}if(e&&t){const I=e(),L=t();await ci(I,L,o?k=>{o(k)}:void 0)}},[e,t,d,i,o]),z=()=>{var I;if(d||i){o==null||o("Cannot load from file while another operation is in progress or while in dialogue.");return}(I=v.current)==null||I.click()},O=async I=>{var k;if(d||i){o==null||o("Cannot load from file while another operation is in progress or while in dialogue."),I.target.value="";return}const L=(k=I.target.files)==null?void 0:k[0];if(L){r==null||r(!0),o==null||o(null),await Ha();const N=await ui(L);if(N){const{gameStateStack:T,debugPacketStack:h}=N,E=Ca();E&&(T[0].debugLore=E.debugLore,T[0].debugGoodFacts=E.debugGoodFacts,T[0].debugBadFacts=E.debugBadFacts),n&&await n({savedStateToLoad:T}),fn(T,o?V=>{o(V)}:void 0),hn(h),Ct(E||{debugLore:T[0].debugLore,debugGoodFacts:T[0].debugGoodFacts,debugBadFacts:T[0].debugBadFacts})}else o==null||o("Failed to load game from file. The file might be corrupted, an incompatible version, or not a valid save file.");r==null||r(!1)}I.target.value=""};return{playerGender:c,setPlayerGender:p,enabledThemePacks:m,setEnabledThemePacks:f,stabilityLevel:u,setStabilityLevel:b,chaosLevel:x,setChaosLevel:l,initialSavedState:S,initialDebugStack:w,appReady:R,fileInputRef:v,handleSaveToFile:M,handleLoadFromFileClick:z,handleFileInputChange:I=>{O(I)},updateSettingsFromLoad:j}},hi=()=>{const[e,t]=s.useState(!1),[n,o]=s.useState(null),[r,d]=s.useState(null),[i,g]=s.useState(!1),[c,p]=s.useState(!1),[m,f]=s.useState(!1),[u,b]=s.useState(!1),[x,l]=s.useState(!1),[S,y]=s.useState(!1),[w,A]=s.useState(!1),[R,C]=s.useState(!1),[j,v]=s.useState(!1),[P,M]=s.useState(!1),[z,O]=s.useState(!1),[F,I]=s.useState(!1),[L,k]=s.useState(!1),[N,T]=s.useState(!1),[h,E]=s.useState(null),[V,D]=s.useState(0),[G,Y]=s.useState(!1),[$,_]=s.useState(!1),[K,X]=s.useState([]),ae=s.useRef(null),le=s.useCallback(()=>{t(!0)},[]),q=s.useCallback(()=>{t(!1)},[]),ie=s.useCallback(()=>{g(!0)},[]),xe=s.useCallback(()=>{g(!1)},[]),ee=s.useCallback(()=>{b(!0)},[]),me=s.useCallback(()=>{b(!1)},[]),Ie=s.useCallback(()=>{p(!0)},[]),se=s.useCallback(()=>{p(!1)},[]),U=s.useCallback(()=>{f(!0)},[]),H=s.useCallback(()=>{f(!1)},[]),J=s.useCallback(()=>{l(!0)},[]),ne=s.useCallback(()=>{l(!1)},[]),Se=s.useCallback(()=>{A(!0)},[]),he=s.useCallback(()=>{A(!1)},[]),je=s.useCallback(()=>{C(!1)},[]),$e=s.useCallback(()=>{v(!0)},[]),Ae=s.useCallback(()=>{v(!1)},[]),Ne=s.useCallback(()=>{M(!0)},[]),De=s.useCallback(()=>{M(!1)},[]),Pe=s.useCallback(()=>{O(!0)},[]),Ee=s.useCallback(()=>{O(!1)},[]),Oe=s.useCallback(()=>{I(!0)},[]),mt=s.useCallback(()=>{I(!1)},[]),pt=s.useCallback(()=>{k(!0)},[]),W=s.useCallback(()=>{k(!1)},[]),Ge=s.useCallback(()=>{T(!0)},[]),Qe=s.useCallback(()=>{T(!1)},[]),Q=s.useCallback((ue,te=0)=>{E(ue),D(te),Y(!0)},[]),oe=s.useCallback(()=>{Y(!1),E(null),D(0),Ea()},[]),be=s.useCallback((ue,te)=>{X(ue),ae.current=te,_(!0)},[]),re=s.useCallback((ue,te,we)=>{var Xe;(Xe=ae.current)==null||Xe.call(ae,ue,te,we),_(!1)},[]),ce=s.useCallback(()=>{var ue;(ue=ae.current)==null||ue.call(ae,[],[],!1),_(!1)},[]);return{isVisualizerVisible:e,visualizerImageUrl:n,visualizerImageScene:r,isKnowledgeBaseVisible:i,isSettingsVisible:c,isInfoVisible:m,isMapVisible:u,userRequestedTitleMenuOpen:x,shouldReturnToTitleMenu:S,isHistoryVisible:w,isDebugViewVisible:R,isCustomGameSetupVisible:j,isManualShiftThemeSelectionVisible:P,shiftConfirmOpen:z,newGameFromMenuConfirmOpen:F,loadGameFromMenuConfirmOpen:L,newCustomGameConfirmOpen:N,pageItemId:h,pageStartChapterIndex:V,isPageVisible:G,setVisualizerImageUrl:o,setVisualizerImageScene:d,setShouldReturnToTitleMenu:y,setIsDebugViewVisible:C,openVisualizer:le,closeVisualizer:q,openKnowledgeBase:ie,closeKnowledgeBase:xe,openMap:ee,closeMap:me,openSettings:Ie,closeSettings:se,openInfo:U,closeInfo:H,openTitleMenu:J,closeTitleMenu:ne,openHistory:Se,closeHistory:he,closeDebugView:je,openCustomGameSetup:$e,closeCustomGameSetup:Ae,openManualShiftThemeSelection:Ne,closeManualShiftThemeSelection:De,openShiftConfirm:Pe,closeShiftConfirm:Ee,openNewGameFromMenuConfirm:Oe,closeNewGameFromMenuConfirm:mt,openLoadGameFromMenuConfirm:pt,closeLoadGameFromMenuConfirm:W,openNewCustomGameConfirm:Ge,closeNewCustomGameConfirm:Qe,openPageView:Q,closePageView:oe,isDebugLoreVisible:$,debugLoreFacts:K,openDebugLoreModal:be,submitDebugLoreModal:re,closeDebugLoreModal:ce}},bi=1500;function yi({gatherGameStateStack:e,gatherDebugPacketStack:t,isLoading:n,hasGameBeenInitialized:o,appReady:r,dialogueState:d,dependencies:i,setError:g}){const c=s.useRef(null),p=JSON.stringify(i);s.useEffect(()=>{if(!(n||!o||!r||d))return c.current&&clearTimeout(c.current),c.current=window.setTimeout(()=>{const m=e(),f=t();fn(m,g?u=>{g(u)}:void 0),hn(f),Ct({debugLore:m[0].debugLore,debugGoodFacts:m[0].debugGoodFacts,debugBadFacts:m[0].debugBadFacts})},bi),()=>{c.current&&clearTimeout(c.current)}},[e,t,n,o,r,d,p,g])}function vi(){var Qn,Xn,qn,Zn;const{clearProgress:e}=Ya(),t=s.useRef(null),n=()=>{if(!t.current)throw new Error("Game logic is not initialized");return t.current},{playerGender:o,setPlayerGender:r,enabledThemePacks:d,setEnabledThemePacks:i,stabilityLevel:g,setStabilityLevel:c,chaosLevel:p,setChaosLevel:m,initialSavedState:f,initialDebugStack:u,appReady:b,fileInputRef:x,handleSaveToFile:l,handleLoadFromFileClick:S,handleFileInputChange:y,updateSettingsFromLoad:w}=fi({gatherGameStateStack:()=>n().gatherCurrentGameState(),gatherDebugPacketStack:()=>n().gatherDebugPacketStack(),applyLoadedGameState:Z=>n().applyLoadedGameState(Z),setError:Z=>{n().setError(Z)},setIsLoading:Z=>{n().setIsLoading(Z)},isLoading:(Qn=t.current)==null?void 0:Qn.isLoading,dialogueState:(Xn=t.current)==null?void 0:Xn.dialogueState,hasGameBeenInitialized:(qn=t.current)==null?void 0:qn.hasGameBeenInitialized}),{isVisualizerVisible:A,visualizerImageUrl:R,setVisualizerImageUrl:C,visualizerImageScene:j,setVisualizerImageScene:v,isKnowledgeBaseVisible:P,isSettingsVisible:M,isInfoVisible:z,isMapVisible:O,userRequestedTitleMenuOpen:F,setShouldReturnToTitleMenu:I,shouldReturnToTitleMenu:L,isHistoryVisible:k,isDebugViewVisible:N,isCustomGameSetupVisible:T,isManualShiftThemeSelectionVisible:h,shiftConfirmOpen:E,newGameFromMenuConfirmOpen:V,loadGameFromMenuConfirmOpen:D,newCustomGameConfirmOpen:G,openVisualizer:Y,closeVisualizer:$,openKnowledgeBase:_,closeKnowledgeBase:K,openMap:X,closeMap:ae,openSettings:le,closeSettings:q,openInfo:ie,closeInfo:xe,openTitleMenu:ee,closeTitleMenu:me,openHistory:Ie,closeHistory:se,closeDebugView:U,setIsDebugViewVisible:H,openCustomGameSetup:J,closeCustomGameSetup:ne,openManualShiftThemeSelection:Se,closeManualShiftThemeSelection:he,openShiftConfirm:je,closeShiftConfirm:$e,openNewGameFromMenuConfirm:Ae,closeNewGameFromMenuConfirm:Ne,openLoadGameFromMenuConfirm:De,closeLoadGameFromMenuConfirm:Pe,openNewCustomGameConfirm:Ee,closeNewCustomGameConfirm:Oe,pageItemId:mt,pageStartChapterIndex:pt,isPageVisible:W,openPageView:Ge,closePageView:Qe,isDebugLoreVisible:Q,debugLoreFacts:oe,openDebugLoreModal:be,submitDebugLoreModal:re,closeDebugLoreModal:ce}=hi(),ue=rl({playerGenderProp:o,enabledThemePacksProp:d,stabilityLevelProp:g,chaosLevelProp:p,onSettingsUpdateFromLoad:w,initialSavedStateFromApp:f,initialDebugStackFromApp:u,isAppReady:b,openDebugLoreModal:be});t.current=ue;const{currentTheme:te,currentScene:we,mainQuest:Xe,currentObjective:wn,actionOptions:Tn,inventory:He,itemsHere:us,itemPresenceByNode:ds,gameLog:We,isLoading:Me,error:gt,lastActionLog:In,themeHistory:jn,mapData:ke,currentMapNodeId:_e,mapLayoutConfig:ft,allNPCs:Je,score:Ut,freeFormActionText:ms,setFreeFormActionText:kn,handleFreeFormActionSubmit:ps,objectiveAnimationType:gs,handleActionSelect:fs,handleItemInteraction:It,handleTakeLocationItem:hs,handleRetry:Ln,executeManualRealityShift:Pn,completeManualShiftWithSelectedTheme:An,cancelManualShiftThemeSelection:Dn,isAwaitingManualShiftThemeSelection:zt,startCustomGame:En,gatherCurrentGameState:bs,gatherDebugPacketStack:ys,hasGameBeenInitialized:ye,handleStartNewGameFromButton:jt,localTime:Bt,localEnvironment:Ht,localPlace:Wt,dialogueState:Te,handleDialogueOptionSelect:Mn,handleForceExitDialogue:vs,isDialogueExiting:Fn,lastDebugPacket:qe,lastTurnChanges:xs,turnsSinceLastShift:$n,globalTurnNumber:at,isCustomGameMode:kt,gameStateStack:Cs,debugPacketStack:Ss,handleMapLayoutConfigChange:Ns,handleUndoTurn:ws,destinationNodeId:st,handleSelectDestinationNode:Ts,mapViewBox:ht,handleMapViewBoxChange:Is,handleMapNodesPositionChange:Jt,commitGameState:Rn,updateItemContent:js,addPlayerJournalEntry:On,updatePlayerJournalContent:ks,recordPlayerJournalInspect:Gn,playerJournal:Re,lastJournalWriteTurn:Ke,lastJournalInspectTurn:_n,handleDistillFacts:Vn,toggleDebugLore:Ls,debugLore:Un,debugGoodFacts:zn,debugBadFacts:Bn}=ue,Ps=s.useCallback(Z=>{Rn(Z)},[Rn]),As=s.useCallback(Z=>{const ve=new Blob([Z],{type:"application/json"}),Ce=URL.createObjectURL(ve),Le=document.createElement("a");Le.href=Ce,Le.download="DebugLoreFacts.json",document.body.appendChild(Le),Le.click(),document.body.removeChild(Le),URL.revokeObjectURL(Ce)},[]),Ds=s.useCallback(()=>{ue.clearDebugFacts(),Ct({debugLore:ue.debugLore,debugGoodFacts:[],debugBadFacts:[]})},[ue]);s.useEffect(()=>{Me||e()},[Me,e]);const Hn=s.useRef(We.length),Wn=s.useRef(we),Jn=F||b&&!ye&&!Me&&!T&&!h,ot=A||P||M||z||O||k||N||W||Q||!!Te||Jn||E||V||D||T||G||h;s.useEffect(()=>{const Z=document.body;if(ot){const ve=window.innerWidth-document.documentElement.clientWidth;Z.style.overflow="hidden",ve>0&&(Z.style.paddingRight=`${String(ve)}px`)}else Z.style.overflow="",Z.style.paddingRight="";return()=>{Z.style.overflow="",Z.style.paddingRight=""}},[ot]),s.useEffect(()=>{(we!==Wn.current||We.length>Hn.current)&&window.scrollTo({top:0,behavior:"smooth"}),Wn.current=we,Hn.current=We.length},[we,We.length]),s.useEffect(()=>{C(null),v(null)},[we,C,v]),yi({gatherGameStateStack:bs,gatherDebugPacketStack:ys,isLoading:Me,hasGameBeenInitialized:ye,appReady:b,dialogueState:Te,setError:Z=>{n().setError(Z)},dependencies:[te,we,Tn,Xe,wn,He,We,In,jn,ke,_e,ft,Je,Ut,Bt,Ht,Wt,o,d,g,p,$n,kt,zt,Un,zn,Bn]});const Es=Ut>=vt&&!Me&&ye&&!Te,Ms=typeof window<"u"&&window.matchMedia("(hover: none)").matches,Fs=s.useCallback((Z,ve)=>{C(Z),v(ve)},[C,v]),$s=s.useCallback(()=>{Pn(),$e()},[Pn,$e]),Kn=s.useCallback(()=>{Ln()},[Ln]),Rs=s.useCallback(()=>{Vn()},[Vn]),Os=s.useCallback(Z=>{var Ce;const ve=Z.id===fe?Math.max(0,(((Ce=Z.chapters)==null?void 0:Ce.length)??0)-1):0;Ge(Z.id,ve)},[Ge]),[Lt,Kt]=s.useState(!1),Gs=(Ke===0||at-Ke>=ca)&&!Lt,_s=Re.length>0&&(_n===0||at-_n>=_a),Vs=s.useCallback(()=>{const Z=Re.length>0?Re.length-1:0;Ge(fe,Z)},[Ge,Re.length]),Us=s.useCallback(()=>{!(Ke===0||at-Ke>=ca)||Lt||(Kt(!0),Ge(fe,Re.length),(async()=>{var ta,na;if(!te){Kt(!1);return}const{name:ve,systemInstructionModifier:Ce}=te,Le=ke.nodes.filter(Ze=>Ze.themeName===ve&&Ze.data.nodeType!=="feature"&&Ze.data.nodeType!=="room"),bt=Tt(Le,!0),Pt=Je.filter(Ze=>Ze.themeName===ve),fo=Pt.length>0?ze(Pt," - ",!1,!1,!1,!0):"None specifically known in this theme yet.",ho=((ta=Re[Re.length-1])==null?void 0:ta.actualContent)??"",ea=Math.floor(Math.random()*50)+100,rt=await Wl(ea,"Personal Journal","Your own journal",ho,ve,Ce,we,((na=qe==null?void 0:qe.storytellerThoughts)==null?void 0:na.slice(-1)[0])??"",bt,fo,We.slice(-Cn));if(rt!=null&&rt.entry){const Ze={heading:rt.entry.heading,description:"",contentLength:ea,actualContent:rt.entry.text};On(Ze,rt.debugInfo??void 0),Ge(fe,Re.length)}Kt(!1)})())},[Je,te,we,On,ke.nodes,Xe,Ge,Re,qe,We,at,Ke,Lt]),zs=s.useCallback(Z=>{if(Z===fe){const Ce={id:fe,name:"Personal Journal",type:"book",description:"Your own journal",holderId:ge,chapters:Re,lastWriteTurn:Ke,tags:[(te==null?void 0:te.playerJournalStyle)??"handwritten"]},Le=Gn();It(Ce,"inspect",void 0,Le);return}const ve=He.find(Ce=>Ce.id===Z);ve&&It(ve,"inspect")},[He,It,Re,Ke,Gn,te]),Bs=s.useCallback(Z=>{kn(Z.target.value)},[kn]),Hs=s.useCallback(()=>{Pe(),ee()},[Pe,ee]),Ws=s.useCallback(()=>{$e()},[$e]),Js=s.useCallback(()=>{Oe(),ee()},[Oe,ee]),Ks=s.useCallback(()=>{Ne(),ee()},[Ne,ee]),Ys=s.useCallback(Z=>{i(ve=>{const Ce=ve.includes(Z)?ve.filter(Le=>Le!==Z):[...ve,Z];return Ce.length===0?(n().setError("At least one theme pack must be enabled."),ve):Ce})},[i]);s.useEffect(()=>{zt&&!h&&Se()},[zt,h,Se]);const Qs=s.useCallback(Z=>{he(),An(Z)},[he,An]),Xs=s.useCallback(()=>{he(),Dn()},[he,Dn]),qs=s.useCallback(Z=>{Mn(Z)},[Mn]),Zs=s.useCallback(()=>{me(),ye?Ae():jt()},[me,ye,jt,Ae]),eo=s.useCallback(()=>{Ne(),jt()},[Ne,jt]),to=s.useCallback(()=>{me(),ye?De():S()},[me,ye,S,De]),no=s.useCallback(()=>{Pe(),S()},[Pe,S]),ao=s.useCallback(async()=>{me(),await l()},[me,l]),so=s.useCallback(()=>{me(),I(!0),le()},[me,I,le]),oo=s.useCallback(()=>{q(),(L||!ye)&&ee(),I(!1)},[q,L,ye,ee,I]),ro=s.useCallback(()=>{me(),I(!0),ie()},[me,I,ie]),lo=s.useCallback(()=>{xe(),(L||!ye)&&ee(),I(!1)},[xe,L,ye,ee,I]),io=s.useCallback(()=>{me(),ye?Ee():J()},[me,ye,J,Ee]),co=s.useCallback(()=>{Oe(),J()},[Oe,J]),uo=s.useCallback(()=>{ne(),ee()},[ne,ee]),mo=s.useCallback(Z=>{ne(),En(Z)},[ne,En]),[po,Yt]=s.useState(ht),Yn=s.useMemo(()=>qo(ke),[ke]),go=s.useMemo(()=>!st||!_e||_e===st||Zo(ke,_e,st)?null:er(ke,_e,st,Yn),[st,_e,ke,Yn,at]),Qt=s.useRef(!1);return s.useEffect(()=>{if(O&&!Qt.current){const Z=Ma(ke.nodes.filter(Ce=>Ce.themeName===(te==null?void 0:te.name)).map(Ce=>({...Ce})),{padding:ft.NESTED_PADDING,anglePadding:ft.NESTED_ANGLE_PADDING});Jt(Z);const ve=ht.split(" ").map(parseFloat);if(ve.length===4){const[,,Ce,Le]=ve,bt=Z.find(Pt=>Pt.id===_e);bt&&!isNaN(Ce)&&!isNaN(Le)?Yt(`${String(bt.position.x-Ce/2)} ${String(bt.position.y-Le/2)} ${String(Ce)} ${String(Le)}`):Yt(ht)}else Yt(ht)}O?Qt.current=!0:Qt.current=!1},[O,ht,_e,ke.nodes,te==null?void 0:te.name,ft,Jt]),b?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 p-4 md:p-8 flex flex-col items-center",children:[a.jsx(Xa,{currentTheme:te,hasGameBeenInitialized:ye,isCustomGameMode:kt}),gt&&!Me&&!Te&&ye?a.jsx("div",{className:"w-full max-w-3xl my-4",children:a.jsx(mn,{message:gt,onRetry:Kn})}):null,gt&&!ye?a.jsx("div",{className:"w-full max-w-3xl my-4",children:a.jsx(mn,{message:gt,onRetry:Kn})}):null,a.jsxs("main",{className:`w-full max-w-screen-xl grid grid-cols-1 lg:grid-cols-4 gap-3 flex-grow ${ot?"filter blur-sm pointer-events-none":""}`,children:[a.jsxs("div",{className:"lg:col-span-2 space-y-3 flex flex-col",children:[a.jsx(gl,{currentSceneExists:!!we,currentThemeName:te?te.name:null,isLoading:Me||!!Te,onManualRealityShift:je,onOpenHistory:Ie,onOpenKnowledgeBase:_,onOpenMap:X,onOpenTitleMenu:ee,onOpenVisualizer:Y,score:Ut,turnsSinceLastShift:$n}),a.jsx(Qa,{}),Me&&!ye?!gt&&a.jsx(tt,{}):null,ye?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"relative",children:[a.jsx(Ja,{allNPCs:Je,currentThemeName:te?te.name:null,description:we,inventory:He,lastActionLog:In,localEnvironment:Ht,localPlace:Wt,localTime:Bt,mapData:ke.nodes}),Me&&!Te&&!Fn&&ye?a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-900/75 rounded-lg",children:a.jsx(tt,{})}):null]}),a.jsx(ll,{allNPCs:Je,currentThemeName:te?te.name:null,disabled:Me||!!Te,inventory:He,mapData:ke.nodes,onActionSelect:fs,options:Tn}),a.jsx(Hl,{canPerformFreeAction:Es,freeFormActionText:ms,onChange:Bs,onSubmit:ps})]}):a.jsx("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg flex-grow min-h-48"})]}),a.jsx("div",{className:"lg:col-span-2 space-y-2 flex flex-col",children:ye?a.jsx(pl,{allNPCs:Je,currentMapNodeId:_e,currentObjective:wn,currentThemeName:te?te.name:null,disabled:Me||ot,enableMobileTap:Ms,globalTurnNumber:at,inventory:He,itemsHere:us,mainQuest:Xe,mapNodes:ke.nodes,objectiveAnimationType:gs,onDropItem:ue.handleDropItem,onItemInteract:It,onReadPage:Os,onReadPlayerJournal:Vs,onStashToggle:ue.handleStashToggle,onTakeItem:hs}):a.jsx("div",{className:"hidden lg:block bg-slate-800/50 border border-slate-700 rounded-lg flex-grow min-h-48"})})]}),a.jsx(Sl,{isGameBusy:ot||Me,lastTurnChanges:xs}),a.jsx(Al,{isBlurred:ot,isDebugViewVisible:N,setIsDebugViewVisible:H})]}),a.jsx("input",{accept:".json,application/json","aria-hidden":"true",className:"hidden",onChange:y,ref:x,type:"file"}),a.jsx(es,{allNPCs:Je,currentThemeName:te?te.name:null,history:(Te==null?void 0:Te.history)??[],inventory:He,isDialogueExiting:Fn,isLoading:Me,isVisible:!!Te,mapData:ke.nodes,onClose:vs,onOptionSelect:qs,options:(Te==null?void 0:Te.options)??[],participants:(Te==null?void 0:Te.participants)??[]}),a.jsx(wr,{badFacts:Bn,debugLore:Un,debugPacket:Ss[0],gameStateStack:Cs,goodFacts:zn,isVisible:N,onApplyGameState:Ps,onClearFacts:Ds,onClose:U,onDistillFacts:Rs,onSaveFacts:As,onToggleDebugLore:Ls,onUndoTurn:ws,travelPath:go}),a.jsx(Za,{isGameActive:ye,isVisible:Jn,onClose:me,onCustomGame:io,onLoadGame:to,onNewGame:Zs,onOpenInfo:ro,onOpenSettings:so,onSaveGame:ye?ao:void 0}),a.jsx(pn,{isVisible:T,onClose:uo,onThemeSelected:mo}),a.jsx(pn,{descriptionText:"Choose the theme you wish to manually shift your reality to. The current theme is disabled.",disabledThemeName:te?te.name:null,isVisible:h,onClose:Xs,onThemeSelected:Qs,titleText:"Select Destination Theme"}),a.jsx(Nl,{chaosLevel:p,enabledThemePacks:d,isCustomGameMode:kt,isVisible:M,onChaosChange:m,onClose:oo,onPlayerGenderChange:r,onStabilityChange:c,onToggleThemePack:Ys,playerGender:o,stabilityLevel:g}),a.jsx(Ll,{isVisible:z,onClose:lo}),a.jsx(Pl,{facts:oe,isVisible:Q,onClose:ce,onSubmit:re}),ye&&te?a.jsx(Bl,{allNPCs:Je,canInspectJournal:_s,canWriteJournal:Gs,currentMapNodeId:_e,currentQuest:Xe,currentScene:we,currentTheme:te,currentThemeName:te.name,destinationNodeId:st,gameLog:We,handleCancelLoadGameFromMenu:Hs,handleCancelNewCustomGame:Js,handleCancelNewGameFromMenu:Ks,handleCancelShift:Ws,handleConfirmLoadGameFromMenu:no,handleConfirmNewCustomGame:co,handleConfirmNewGameFromMenu:eo,handleConfirmShift:$s,initialLayoutConfig:ft,initialViewBox:po,inventory:He,isCustomGameModeShift:kt,isHistoryVisible:k,isKnowledgeBaseVisible:P,isMapVisible:O,isPageVisible:W,isVisualizerVisible:A,isWritingJournal:Lt,itemPresenceByNode:ds,lastJournalWriteTurn:Ke,loadGameFromMenuConfirmOpen:D,localEnvironment:Ht,localPlace:Wt,localTime:Bt,mapData:ke,newCustomGameConfirmOpen:G,newGameFromMenuConfirmOpen:V,onCloseHistory:se,onCloseKnowledgeBase:K,onCloseMap:ae,onClosePage:Qe,onCloseVisualizer:$,onItemInspect:zs,onLayoutConfigChange:Ns,onNodesPositioned:Jt,onSelectDestination:Ts,onViewBoxChange:Is,onWriteJournal:Us,pageItemId:mt,pageStartChapterIndex:pt,playerJournal:Re,setGeneratedImage:Fs,shiftConfirmOpen:E,storytellerThoughts:((Zn=qe==null?void 0:qe.storytellerThoughts)==null?void 0:Zn.slice(-1)[0])??"",themeHistory:jn,updateItemContent:js,updatePlayerJournalContent:ks,visualizerImageScene:j,visualizerImageUrl:R}):null]}):a.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 flex flex-col items-center justify-center p-4",children:[a.jsx(tt,{}),a.jsx("p",{className:"mt-4 text-xl text-sky-400",children:"Initializing application..."})]})}const cs=document.getElementById("root");if(!cs)throw new Error("Could not find root element to mount to");const xi=vo.createRoot(cs);xi.render(a.jsx(s.StrictMode,{children:a.jsx(vi,{})}));
