import{r as s,j as e,R as Tt,a as xn}from"./vendor-BcNuLXi4.js";import{u as fn,a as bn,b as ka,c as yn,i as Pe,d as jn,e as vn,T as ha,g as Cn,s as Nn,f as kn,h as wa,j as wn,k as Sn,l as Sa,D as En,m as Mn,n as Ln,o as Ue,p as Se,q as $t,r as Ea,t as Ma,v as La,w as Ta,x as $a,y as ga,z as Tn,A as $n,B as In,C as An,E as xa,F as fa,G as wt,H as Pn,I as Dn,J as Rn,K as zn,L as Gn,M as Fn,N as On,O as _n,P as Bn,Q as Vn}from"./hooks-D0y08Pj6.js";import{as as at,at as ct,au as k,av as Y,aj as st,al as nt,ak as lt,ah as ce,aw as Ia,q as It,ax as Wn,ay as Un,C as Hn,i as Aa,az as Kn,N as Ce,e as rt,d as it,aA as Pa,aB as ba,c as Yn,b as Jn,h as At,G as Pt,P as Da,ae as Ra,aC as ya,B as Xn,z as Qn,aD as qn,aE as ja,a4 as Zn}from"./debug-D6S6VXZ8.js";import{c as el}from"./resources-CXWwAOhL.js";import"./gemini-C8vQU6I3.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&l(c)}).observe(document,{childList:!0,subtree:!0});function a(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function l(r){if(r.ep)return;r.ep=!0;const o=a(r);fetch(r.href,o)}})();function za({tag:t="h2",children:n,icon:a,preset:l="amber",font:r="2xl"}){const o=t,c={slate:"text-slate-300",gray:"text-gray-400",zinc:"text-zinc-400",neutral:"text-neutral-400",stone:"text-stone-400",red:"text-red-400",orange:"text-orange-400",amber:"text-amber-400",yellow:"text-yellow-400",lime:"text-lime-400",green:"text-green-400",emerald:"text-emerald-400",teal:"text-teal-400",cyan:"text-cyan-400",sky:"text-sky-400",blue:"text-blue-400",indigo:"text-indigo-400",violet:"text-violet-400",purple:"text-purple-400",fuchsia:"text-fuchsia-400",pink:"text-pink-400",rose:"text-rose-400"},p={sm:"text-sm font-semibold",base:"text-base font-semibold",lg:"text-lg font-semibold",xl:"text-xl font-semibold","2xl":"text-2xl font-semibold","3xl":"text-3xl font-semibold","4xl":"text-4xl font-semibold"},b=a?e.jsx("span",{className:"mr-2 inline-flex",children:a}):null;return s.createElement(o,{className:`${p[r]} ${c[l]}`},b,n)}za.defaultProps={children:void 0,font:"2xl",icon:void 0,preset:"amber",tag:"h2"};function Ne({header:t,headerIcon:n,children:a,text:l,highlightEntities:r,enableMobileTap:o=!1,containerClassName:c="p-3",headerTag:p="h2",borderColorClass:b="border-amber-700",backgroundColorClass:v="",borderWidthClass:g="border-b",headerFont:C="2xl",headerPreset:d="amber",headerWrapperClassName:u="",contentFontClass:m="",contentColorClass:i="text-slate-200"}){const f=l?l.split(`
`).map(h=>e.jsx("p",{className:"mb-3 last:mb-0",children:r?at(h,r,o):h},h)):a;return e.jsxs("section",{className:`${c} ${v} ${g} ${b}`,children:[t?e.jsx("div",{className:` ${u} `,children:e.jsx(za,{font:C,icon:n,preset:d,tag:p,children:t})}):null,e.jsx("div",{className:`${m} ${i}`,children:f})]})}Ne.defaultProps={backgroundColorClass:"",borderColorClass:"border-amber-700",borderWidthClass:"border-b",children:void 0,containerClassName:"p-3",contentColorClass:"text-slate-200",contentFontClass:"",enableMobileTap:!1,header:void 0,headerFont:"2xl",headerIcon:void 0,headerPreset:"amber",headerTag:"h2",headerWrapperClassName:"",highlightEntities:void 0,text:void 0};function Ga({description:t,lastActionLog:n,inventory:a,mapData:l,allNPCs:r,localTime:o,localEnvironment:c,localPlace:p}){const b=s.useMemo(()=>ct(a,l,r),[a,l,r]),v=typeof window<"u"&&window.matchMedia("(hover: none)").matches,g=e.jsx(Ne,{backgroundColorClass:"bg-slate-800",borderColorClass:"border-slate-600",borderWidthClass:"rounded-lg border",contentFontClass:"leading-relaxed text-lg",enableMobileTap:v,highlightEntities:b,text:t||void 0}),C=n?e.jsx(Ne,{backgroundColorClass:"bg-slate-800",borderColorClass:"border-slate-600",borderWidthClass:"rounded-lg border",contentColorClass:"text-yellow-200",contentFontClass:"leading-relaxed text-lg",enableMobileTap:v,highlightEntities:b,text:n||void 0}):null,d=o||c||p?e.jsx(Ne,{borderColorClass:"border-slate-600",borderWidthClass:"border-t",contentColorClass:"text-slate-300",contentFontClass:"text-lg",text:`Time: ${o??"Unknown"}. Environment: ${c??"Unknown"} Location: ${p??"Unknown"}`}):null;return e.jsxs("div",{className:"space-y-3",children:[C,g,d]})}Ga.defaultProps={lastActionLog:null,localEnvironment:null,localPlace:null,localTime:null};function tl({options:t,onActionSelect:n,disabled:a,inventory:l,mapData:r,allNPCs:o,queuedActions:c,onClearQueuedActions:p}){const b=s.useMemo(()=>ct(l,r,o),[l,r,o]),v=c.map(u=>u.displayText).join(", "),g=c.map(u=>`  - ${u.promptText}`).join(`
`),C=s.useCallback(u=>{c.forEach(m=>{var i;return(i=m.effect)==null?void 0:i.call(m)}),n(g),p(),u.currentTarget.blur()},[c,n,p,g]),d=s.useCallback(u=>m=>{const i=g?`${g}
  - ${u}`:`  - ${u}`;c.forEach(f=>{var h;return(h=f.effect)==null?void 0:h.call(f)}),n(i),p(),m.currentTarget.blur()},[c,n,p,g]);return e.jsxs("div",{className:"mt-6",children:[c.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-3",children:e.jsx(k,{ariaLabel:v,disabled:a,label:e.jsx(e.Fragment,{children:at(v,b)}),onClick:C,preset:"teal",size:"lg",variant:"standard"})}),e.jsxs("div",{className:"mb-3 flex items-center",role:"separator",children:[e.jsx("span",{className:"flex-grow border-b border-slate-500"}),e.jsx("span",{className:"px-2 text-slate-300",children:"AND"}),e.jsx("span",{className:"flex-grow border-b border-slate-500"})]})]}):null,e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:t.map(u=>e.jsx(k,{ariaLabel:u,disabled:a||u==="...",label:e.jsx(e.Fragment,{children:at(u,b)}),onClick:d(u),preset:"sky",size:"lg",variant:"standard"},u))})]})}function Dt({type:t}){const a={"single-use":"text-red-400","multi-use":"text-yellow-400",equipment:"text-sky-400",container:"text-orange-400",key:"text-lime-400",weapon:"text-amber-400",ammunition:"text-cyan-400",vehicle:"text-indigo-400",immovable:"text-purple-400","status effect":"text-pink-400",page:"text-green-400",book:"text-green-400",picture:"text-fuchsia-400",map:"text-teal-400"}[t];return e.jsx("span",{className:`text-xs italic ${a}`,children:t})}function al({items:t,onItemInteract:n,disabled:a,currentNodeId:l,mapNodes:r,queuedActionIds:o,remainingActionPoints:c}){const p=s.useCallback(d=>{const u=d.currentTarget.dataset.itemId;if(!u)return;const m=t.find(i=>i.id===u);m&&(n(m,"take"),d.currentTarget.blur())},[t,n]),b=s.useCallback(d=>{const u=d.currentTarget.dataset.itemId;if(!u)return;const m=t.find(i=>i.id===u);m&&(n(m,"inspect"),d.currentTarget.blur())},[t,n]),v=s.useCallback(d=>{const u=d.currentTarget.dataset.itemId;if(!u)return;const m=t.find(i=>i.id===u);m&&(n(m,"generic"),d.currentTarget.blur())},[t,n]),g=s.useCallback(d=>{const{itemId:u,actionName:m,promptEffect:i}=d.currentTarget.dataset;if(!u||!m||!i)return;const f=t.find(N=>N.id===u);if(!f)return;n(f,"specific",{actionName:m,promptEffect:i,description:m}),d.currentTarget.blur()},[t,n]),C=s.useCallback(d=>d.knownUses?d.knownUses.filter(u=>{const m=!!d.isActive;return u.appliesWhenActive!==void 0&&u.appliesWhenInactive!==void 0?u.appliesWhenActive&&m||u.appliesWhenInactive&&!m||!u.appliesWhenActive&&!u.appliesWhenInactive:u.appliesWhenActive!==void 0?u.appliesWhenActive===m:u.appliesWhenInactive!==void 0?u.appliesWhenInactive===!m:!0}):[],[]);return t.length===0?null:e.jsxs("div",{className:"bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-amber-400 mb-2 border-b-2 border-amber-700 pb-2 flex items-center",children:[e.jsx(Y,{color:"amber",inline:!0,marginRight:8,name:"inventory",size:20})," ","Items Here"]}),e.jsx("ul",{className:"flex flex-wrap justify-center gap-4 list-none p-0",children:t.map(d=>{var f;const u=d.isActive&&d.activeDescription?d.activeDescription:d.description,m=d.holderId===l,i=m?null:(f=r.find(h=>h.id===d.holderId))==null?void 0:f.placeName;return e.jsxs("li",{className:"w-[270px] text-slate-300 bg-slate-700/60 p-4 rounded-md shadow border border-slate-600 flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(Dt,{type:d.type}),d.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:d.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-1 italic leading-tight flex-grow",children:u}),!m&&i?e.jsxs("p",{className:"text-xs text-slate-300 mb-2",children:["Reachable at ",i]}):null,e.jsx("div",{className:"mt-auto space-y-2",children:d.type==="immovable"?e.jsxs(e.Fragment,{children:[C(d).map(h=>{const N=o.has(`${d.id}-specific-${h.actionName}`);return e.jsx(k,{ariaLabel:`${h.actionName}${h.description?": "+h.description:""}`,cost:st,"data-action-name":h.actionName,"data-item-id":d.id,"data-prompt-effect":h.promptEffect,disabled:a||!N&&st>c,label:h.actionName,onClick:g,preset:"teal",pressed:N,size:"sm",title:h.description,variant:"toggleFull"},`${d.id}-ku-${h.actionName}`)}),(()=>{const h=o.has(`${d.id}-inspect`);return e.jsx(k,{ariaLabel:`Inspect ${d.name}`,cost:nt,"data-item-id":d.id,disabled:a||!h&&nt>c,label:"Inspect",onClick:b,preset:"indigo",pressed:h,size:"sm",variant:"toggleFull"})})(),(()=>{const h=o.has(`${d.id}-generic`);return e.jsx(k,{ariaLabel:`Attempt to use ${d.name}`,cost:lt,"data-item-id":d.id,disabled:a||!h&&lt>c,label:"Attempt to Use (Generic)",onClick:v,preset:"sky",pressed:h,size:"sm",variant:"toggleFull"})})()]}):e.jsx(k,{ariaLabel:d.type==="vehicle"?`Enter ${d.name}`:`Take ${d.name}`,"data-item-id":d.id,disabled:a,label:d.type==="vehicle"?"Enter Vehicle":"Take",onClick:p,preset:"green",size:"sm"})})]},d.id)})})]})}function Fa({item:t,isNew:n,isStashing:a,applicableUses:l,disabled:r,currentTurn:o,onSpecificUse:c,onInspect:p,onGenericUse:b,onVehicleToggle:v,onDrop:g,onDiscard:C,onRead:d,onStashToggle:u,filterMode:m,registerRef:i,queuedActionIds:f,remainingActionPoints:h}){var E,y,S,B,A,R,q,H;const N=t.isActive&&t.activeDescription?t.activeDescription:t.description,w=t.type==="page"||t.type==="book"||t.type==="picture"||t.type==="map",$=t.type==="picture"||t.type==="map",M=t.type!=="status effect"&&t.type!=="vehicle",z=!((E=t.tags)!=null&&E.includes("junk"))&&t.type!=="vehicle"&&t.type!=="status effect",_=m==="stashed"&&(t.stashed===!0||a),G=z&&(!w||_),D=[],[V,P]=s.useState(!1),J=s.useCallback(j=>{P(!0),j.currentTarget.blur()},[]),X=s.useCallback(j=>{C(j),P(!1)},[C]),O=s.useCallback(j=>{P(!1),j.currentTarget.blur()},[]);l.forEach(j=>{const F=f.has(`${t.id}-specific-${j.actionName}`);D.push(e.jsx(k,{ariaLabel:`${j.actionName}${j.description?": "+j.description:""}`,cost:st,"data-action-name":j.actionName,"data-item-id":t.id,"data-prompt-effect":j.promptEffect,disabled:r||!F&&st>h,label:j.actionName,onClick:c,preset:"teal",pressed:F,size:"sm",title:j.description,variant:"toggleFull"},`${t.id}-knownuse-${j.actionName}`))});const U=r||(w?t.id===ce?(((y=t.chapters)==null?void 0:y.length)??0)===0:((S=t.chapters)==null?void 0:S.some(j=>!j.actualContent))??!0:$?((B=t.chapters)==null?void 0:B.some(j=>!j.imageData))??!0:!1)||t.lastInspectTurn!==void 0&&o-t.lastInspectTurn<Ia,I=f.has(`${t.id}-inspect`);if(D.push(e.jsx(k,{ariaLabel:`Inspect ${t.name}`,cost:nt,"data-item-id":t.id,disabled:U||!I&&nt>h,label:"Inspect",onClick:p,preset:"indigo",pressed:I,size:"sm",variant:"toggleFull"},`${t.id}-inspect`)),(t.type==="page"||t.type==="book"||t.type==="picture"||t.type==="map")&&D.push(e.jsx(k,{ariaLabel:`Read ${t.name}`,"data-item-id":t.id,disabled:r||t.id===ce&&(((A=t.chapters)==null?void 0:A.length)??0)===0,label:"Read",onClick:d,preset:"teal",size:"sm"},`${t.id}-read`)),M){const j=f.has(`${t.id}-generic`);D.push(e.jsx(k,{ariaLabel:`Attempt to use ${t.name} (generic action)`,cost:lt,"data-item-id":t.id,disabled:r||!j&&lt>h,label:"Attempt to Use (Generic)",onClick:b,preset:"sky",pressed:j,size:"sm",variant:"toggleFull"},`${t.id}-generic-use`))}return t.type==="vehicle"&&D.push(e.jsx(k,{ariaLabel:t.isActive?`Exit ${t.name}`:`Enter ${t.name}`,"data-item-id":t.id,disabled:r,label:t.isActive?`Exit ${t.name}`:`Enter ${t.name}`,onClick:v,preset:"sky",pressed:f.has(`${t.id}-specific-${t.isActive?`Exit ${t.name}`:`Enter ${t.name}`}`),size:"sm",variant:"toggleFull"},`${t.id}-vehicle-action`)),(R=t.tags)!=null&&R.includes("junk")&&(V?D.push(e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[e.jsx(k,{ariaLabel:`Confirm discard of ${t.name}`,"data-item-id":t.id,disabled:r,label:t.type==="vehicle"&&!t.isActive?"Confirm Park":"Confirm Discard",onClick:X,preset:"red",size:"sm"},`${t.id}-confirm-discard`),e.jsx(k,{ariaLabel:"Cancel discard",disabled:r,label:"Cancel",onClick:O,preset:"slate",size:"sm"},`${t.id}-cancel-discard`)]},`${t.id}-confirm-group`)):D.push(e.jsx(k,{ariaLabel:`Discard ${t.name}`,"data-item-id":t.id,disabled:r,icon:e.jsx(Y,{color:"white",inline:!0,marginRight:4,name:"trash",size:16}),label:"Discard",onClick:J,preset:"orange",size:"sm"},`${t.id}-discard`))),(t.type==="page"||t.type==="book"||t.type==="picture"||t.type==="map")&&D.push(e.jsx(k,{ariaLabel:m==="stashed"?`Retrieve ${t.name}`:`Stash ${t.name}`,"data-item-id":t.id,disabled:r,label:m==="stashed"?"Retrieve":"Stash",onClick:u,preset:"sky",size:"sm"},`${t.id}-stash`)),z&&w&&G&&D.push(e.jsx(k,{ariaLabel:`Drop ${t.name}`,"data-item-id":t.id,disabled:r,label:"Drop",onClick:g,preset:"sky",size:"sm"},`${t.id}-drop`)),z&&!w&&G&&D.push(e.jsx(k,{ariaLabel:`Drop ${t.name}`,"data-item-id":t.id,disabled:r,label:"Drop",onClick:g,preset:"sky",size:"sm"},`${t.id}-drop`)),!((q=t.tags)!=null&&q.includes("junk"))&&t.type==="vehicle"&&!t.isActive&&D.push(e.jsx(k,{ariaLabel:`Park ${t.name} here`,"data-item-id":t.id,disabled:r,label:"Park Here",onClick:g,preset:"sky",size:"sm"},`${t.id}-drop`)),e.jsxs("li",{className:`w-[270px] text-slate-300 bg-slate-700/60 p-4 rounded-md shadow border border-slate-600 ${n?"animate-new-item-pulse":""} ${a?"animate-archive-fade-out":""} flex flex-col`,"data-item-id":t.id,ref:i,children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(Dt,{type:t.type}),t.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:t.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-3 italic leading-tight flex-grow",children:N}),(H=t.tags)!=null&&H.includes("junk")?e.jsx("p",{className:"text-xs text-orange-400 mb-1 italic",children:"(Marked as junk)"}):null,e.jsx("div",{className:"space-y-2 mt-auto",children:D})]},t.id)}Fa.defaultProps={registerRef:void 0};function sl({sortOrder:t,disabled:n,onSortByName:a,onSortByType:l}){return e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[e.jsx(k,{ariaLabel:"Sort by Name",disabled:n,label:"Sort by Name",onClick:a,preset:t==="name"?"sky":"slate",pressed:t==="name",size:"sm",variant:"toggle"}),e.jsx(k,{ariaLabel:"Sort by Type",disabled:n,label:"Sort by Type",onClick:l,preset:t==="type"?"sky":"slate",pressed:t==="type",size:"sm",variant:"toggle"})]})}function nl({filterMode:t,disabled:n,onFilterAll:a,onFilterStashed:l}){return e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[e.jsx(k,{ariaLabel:"Show All",disabled:n,label:"All",onClick:a,preset:t==="all"?"sky":"slate",pressed:t==="all",size:"sm",variant:"toggle"}),e.jsx(k,{ariaLabel:"Show Stashed",disabled:n,label:"Stashed",onClick:l,preset:t==="stashed"?"sky":"slate",pressed:t==="stashed",size:"sm",variant:"toggle"})]})}function ll({items:t,onItemInteract:n,onStashToggle:a,onReadPage:l,currentTurn:r,disabled:o,queuedActionIds:c,remainingActionPoints:p}){const{displayedItems:b,newlyAddedItemIds:v,stashingItemIds:g,sortOrder:C,handleSortByName:d,handleSortByType:u,filterMode:m,handleFilterAll:i,handleFilterStashed:f,handleSpecificUse:h,handleInspect:N,handleGenericUse:w,handleDrop:$,handleDiscard:M,handleVehicleToggle:z,handleStashToggleInternal:_,handleRead:G,getApplicableKnownUses:D}=fn({items:t,onItemInteract:n,onStashToggle:a,onReadPage:l}),V=s.useRef(new Map),P=s.useRef(new Map),J=s.useRef(o),X=s.useCallback(O=>{if(!O)return;const U=O.dataset.itemId;U&&V.current.set(U,O)},[]);return s.useLayoutEffect(()=>{const O=new Map;if(V.current.forEach((U,I)=>{if(!U.isConnected){V.current.delete(I),P.current.delete(I);return}const E=U.getBoundingClientRect();O.set(I,new DOMRect(E.left+window.scrollX,E.top+window.scrollY,E.width,E.height))}),J.current!==o){J.current=o,P.current=O;return}o||P.current.forEach((U,I)=>{const E=O.get(I),y=V.current.get(I);if(!E||!y)return;const S=Math.round(U.left-E.left),B=Math.round(U.top-E.top);(S!==0||B!==0)&&(y.style.transition="none",y.style.transform=`translate(${String(S)}px, ${String(B)}px)`,requestAnimationFrame(()=>{y.style.transition="transform 0.2s",y.style.transform=""}),setTimeout(()=>{y.style.transition=""},200))}),P.current=O},[b,o]),e.jsxs("div",{className:"bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700 h-full",children:[e.jsxs("h3",{className:"text-xl font-bold text-amber-400 mb-2 border-b-2 border-amber-700 pb-2 flex items-center",children:[e.jsx(Y,{color:"amber",inline:!0,marginRight:8,name:"inventory",size:20})," ","Inventory"]}),e.jsx(sl,{disabled:o,onSortByName:d,onSortByType:u,sortOrder:C}),e.jsx(nl,{disabled:o,filterMode:m,onFilterAll:i,onFilterStashed:f}),b.length===0?e.jsx("p",{className:"text-slate-300 italic",children:"Your pockets are empty."}):e.jsx("ul",{className:"flex flex-wrap justify-center gap-4 list-none p-0",children:b.map(O=>{const U=D(O),I=v.has(O.id),E=g.has(O.id);return e.jsx(Fa,{applicableUses:U,currentTurn:r,disabled:o,filterMode:m,isNew:I,isStashing:E,item:O,onDiscard:M,onDrop:$,onGenericUse:w,onInspect:N,onRead:G,onSpecificUse:h,onStashToggle:_,onVehicleToggle:z,queuedActionIds:c,registerRef:X,remainingActionPoints:p},O.id)})})]})}function rl({allNPCs:t,currentMapNodeId:n,currentObjective:a,enableMobileTap:l,inventory:r,itemsHere:o,storyArc:c,mapNodes:p,objectiveAnimationType:b,onStashToggle:v,onItemInteract:g,onReadPage:C,onReadPlayerJournal:d,globalTurnNumber:u,disabled:m,queuedActionIds:i,remainingActionPoints:f}){const h=s.useMemo(()=>ct(r,p,t),[r,p,t]),N=c==null?void 0:c.acts[c.currentAct-1],w=(N==null?void 0:N.mainObjective)??null,$=N?`Act ${String(c.currentAct)}: ${N.title}`:"";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-start gap-4 mb-2",children:e.jsx(k,{ariaLabel:"Open journal",disabled:m,icon:e.jsx(Y,{name:"journalPen",size:24}),onClick:d,preset:"blue",size:"lg",title:"Open Journal",variant:"toolbarLarge"})}),w?e.jsx(Ne,{backgroundColorClass:"bg-purple-800/50",borderColorClass:"border-purple-600",borderWidthClass:"border rounded-lg",containerClassName:"p-3",contentColorClass:"text-purple-200",contentFontClass:"text-lg",enableMobileTap:l,header:$,headerFont:"lg",headerPreset:"purple",highlightEntities:h,text:w}):null,a?e.jsx(Ne,{backgroundColorClass:"bg-amber-800/50",borderColorClass:"border-amber-600",borderWidthClass:"border rounded-lg",containerClassName:`p-3 ${b==="success"?"animate-objective-success":b==="neutral"?"animate-objective-neutral":""}`,contentColorClass:"text-amber-200",contentFontClass:"text-lg",enableMobileTap:l,header:"Current Objective",headerFont:"lg",headerPreset:"amber",highlightEntities:h,text:a}):null,e.jsx(al,{currentNodeId:n,disabled:m,items:o,mapNodes:p,onItemInteract:g,queuedActionIds:i,remainingActionPoints:f}),e.jsx(ll,{currentTurn:u,disabled:m,items:r,onItemInteract:g,onReadPage:C,onStashToggle:v,queuedActionIds:i,remainingActionPoints:f})]})}function xe({className:t="",showText:n=!0,size:a="lg"}){const l=bn(),{progress:r,retryCount:o}=ka(),p=`${a==="sm"?"rounded-full h-6 w-6 border-t-2 border-b-2":"rounded-full h-16 w-16 border-t-4 border-b-4"} animate-spin border-sky-600`,b="text-sky-400",v=l?It[l]:void 0,g=(v==null?void 0:v.text)??"Loading...",C=r?r+r.split("").reverse().join(""):"",d=o>0?`Retry ${String(o)}`:"",u=n?"flex flex-col items-center my-8":"";return e.jsxs("div",{"aria-live":"polite",className:`${u} ${t}`,role:"status",children:[e.jsx("div",{"aria-hidden":"true",className:p}),n?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:`mt-2 text-xl ${b} text-shadow-md`,children:g}),d?e.jsx("p",{className:`mt-1 text-sm ${b} text-shadow-md`,children:d}):null,C?e.jsx("div",{className:"mt-2 text-2xl text-sky-300 font-mono text-shadow-md",children:C}):null]}):null]})}xe.defaultProps={className:"",showText:!0,size:"lg"};function Mt({message:t,onRetry:n}){return e.jsxs("div",{className:"bg-red-800 border border-red-600 text-red-100 p-6 rounded-lg shadow-xl my-4 animate-pulse",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(Y,{color:"red",inline:!0,marginRight:12,name:"error",size:32}),e.jsx("h3",{className:"font-bold text-2xl text-red-200",children:"A Shadow Falls!"})]}),e.jsx("p",{className:"text-red-200 mb-4",children:t}),n?e.jsx(k,{ariaLabel:"Try again after error",label:"Try Again",onClick:n,preset:"red",size:"md",variant:"compact"}):null]})}Mt.defaultProps={onRetry:void 0};function il({score:t,isLoading:n,isTurnProcessing:a,currentThemeName:l,currentSceneExists:r,onOpenVisualizer:o,onOpenKnowledgeBase:c,onOpenMap:p,onOpenTitleMenu:b}){return e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{"aria-label":`Current score: ${String(t)} points`,className:"flex items-center p-2 border border-amber-500 rounded-md shadow-md",title:`Score: ${String(t)} points`,children:[e.jsx(Y,{color:"amber",inline:!0,marginRight:8,name:"coin",size:20}),e.jsx("span",{className:"text-amber-400 font-semibold text-lg",children:t})]}),a?e.jsx(xe,{showText:!1,size:"sm"}):null]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(k,{ariaLabel:"Visualize Scene",disabled:n||a||!l||!r,icon:e.jsx(Y,{inline:!0,name:"visualize",size:20}),onClick:o,preset:"blue",size:"md",title:"Visualize Scene",variant:"toolbar"}),e.jsx(k,{ariaLabel:"Open Knowledge Base",disabled:n||a||!l,icon:e.jsx(Y,{inline:!0,name:"bookOpen",size:20}),onClick:c,preset:"blue",size:"md",title:"Open Knowledge Base",variant:"toolbar"}),e.jsx(k,{ariaLabel:"Open Map",disabled:n||a||!l,icon:e.jsx(Y,{inline:!0,name:"map",size:20}),onClick:p,preset:"blue",size:"md",title:"Open Map",variant:"toolbar"}),e.jsx(k,{ariaLabel:"Open Title Menu",disabled:n||a,icon:e.jsx(Y,{inline:!0,name:"menu",size:20}),onClick:b,preset:"gray",size:"md",title:"Open Title Menu",variant:"toolbar"})]})]})}const ol="w-4 h-4 rounded",cl=t=>t<.1?"bg-green-500":t<.2?"bg-lime-500":t<.3?"bg-yellow-500":t<.4?"bg-orange-500":t<.5?"bg-amber-500":"bg-red-500";function Oa(){const t=yn();return e.jsxs("div",{"aria-label":"Model usage last minute",className:"flex space-x-1 items-center my-2",children:[Object.values(t).map(n=>{const a=n.count/n.limit,l=`${n.model}: ${String(n.count)}/${String(n.limit)} calls last minute`;return e.jsx("div",{"aria-label":l,className:`${ol} ${cl(a)}`,title:l},n.model)}),e.jsx("div",{className:"flex-grow border-t border-slate-600 ml-2"})]})}function _a({hasGameBeenInitialized:t,currentTheme:n}){return e.jsxs("header",{className:"w-full max-w-screen-xl mb-6 text-center",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-sky-400 tracking-wider title-font",children:"Whispers in the Dark"}),e.jsx("p",{className:"text-slate-300 text-lg",children:"An AI-Powered Adventure"}),t?e.jsx("p",{children:n?e.jsx("span",{className:"block text-xs text-purple-400",children:n.name}):null}):null]})}function Ba({version:t,sourceInfo:n}){return e.jsxs("p",{className:"text-sm text-slate-300 absolute bottom-4 right-4",children:[e.jsx("span",{children:"Version: "+t}),e.jsx("br",{}),e.jsx("span",{children:n??null})]})}Ba.defaultProps={sourceInfo:void 0};function Va({isVisible:t,onClose:n,onNewGame:a,onSaveGame:l,onLoadGame:r,onOpenSettings:o,onOpenInfo:c,onOpenGeminiKeyModal:p,isGameActive:b}){const v=s.useCallback(()=>{l&&l()},[l]);return e.jsx("div",{"aria-labelledby":"title-menu-heading","aria-modal":"true",className:`animated-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content relative",children:[" ",b?e.jsx(k,{ariaLabel:"Close Title Menu",icon:e.jsx(Y,{name:"x",size:20}),onClick:n,size:"sm",variant:"close"}):null,e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full p-4 text-center",children:[e.jsx(_a,{currentTheme:null,hasGameBeenInitialized:b}),e.jsxs("div",{className:"space-y-3 sm:space-y-3 w-full max-w-xs sm:max-w-sm",children:[!Pe()&&p?e.jsx(k,{ariaLabel:"Set Gemini API key",label:"Set Gemini Key",onClick:p,preset:"indigo",size:"lg"}):null,e.jsx(k,{ariaLabel:b?"Start a New Game (Progress will be lost)":"Start a New Game",disabled:!Pe(),label:"New Game",onClick:a,preset:"red",size:"lg"}),b&&l?e.jsx(k,{ariaLabel:"Save Current Game to File",label:"Save Game",onClick:v,preset:"green",size:"lg"}):null,e.jsx(k,{ariaLabel:b?"Load Game from File (Current progress will be lost)":"Load Game from File",disabled:!Pe(),label:"Load Game",onClick:r,preset:"blue",size:"lg"}),e.jsx(k,{ariaLabel:"Open Settings",label:"Settings",onClick:o,preset:"gray",size:"lg"}),e.jsx(k,{ariaLabel:"About & Game Guide",label:"About",onClick:c,preset:"cyan",size:"lg"}),b?e.jsx(k,{ariaLabel:"Return to Game",label:"Return to Game",onClick:n,preset:"sky",size:"lg"}):null]})]}),e.jsx(Ba,{sourceInfo:jn()?"Using System Gemini Key":void 0,version:Wn})]})})}Va.defaultProps={onOpenGeminiKeyModal:void 0,onSaveGame:void 0};function Wa({isVisible:t,onClose:n,history:a,options:l,onOptionSelect:r,participants:o,isLoading:c,isDialogueExiting:p,inventory:b,mapData:v,allNPCs:g}){const C=s.useRef(null),d=s.useRef(null);s.useEffect(()=>{t&&d.current&&d.current.scrollIntoView({behavior:"smooth",block:"end"})},[a,t]),s.useEffect(()=>{if(!t)return;const N=C.current;N&&c&&(p===!0||l.length===0)&&N.scrollTo({top:N.scrollHeight,behavior:"smooth"})},[c,p,l.length,t,a.length]);const u=s.useMemo(()=>ct(b,v,g),[b,v,g]),m=o.join(", "),i=c||p,f=s.useCallback(N=>{const w=N.currentTarget.dataset.option;w&&(r(w),N.currentTarget.blur())},[r]);if(!t)return null;const h=()=>{if(p||c)return e.jsx(xe,{});if(l.length>0)return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:l.map(N=>e.jsx(k,{ariaLabel:N,"data-option":N,disabled:i,enableHighlightTap:!0,highlightEntities:u,label:N,onClick:f,preset:"sky",size:"md",variant:"standard"},N))})};return e.jsx("div",{"aria-labelledby":"dialogue-title","aria-modal":"true",className:"dialogue-frame open",ref:C,role:"dialog",children:e.jsxs("div",{className:"dialogue-frame-content",children:[e.jsx(k,{ariaLabel:"End Conversation",disabled:c||p,icon:e.jsx(Y,{name:"x",size:20}),onClick:n,size:"sm",variant:"close"}),e.jsxs("h1",{className:"text-2xl font-bold text-sky-300 mb-4 text-center",id:"dialogue-title",children:["Conversation with:"," ",m]}),e.jsx("div",{className:"dialogue-log-area flex-grow mb-4 pr-2 min-h-[200px] overflow-y-auto",children:a.map((N,w)=>{const $=N.speaker.toLowerCase()==="player";return e.jsxs("div",{className:`mb-3 p-3 rounded-lg animate-dialogue-new-entry ${$?"bg-slate-700 ml-auto w-11/12 text-right":"bg-slate-600 mr-auto w-11/12"}`,ref:w===a.length-1?d:null,children:[e.jsxs("strong",{className:$?"text-amber-400":"text-emerald-400",children:[N.speaker,":"]}),e.jsx("span",{className:"text-slate-100 ml-2",children:at(N.line,u)})]},N.line)})}),e.jsxs("div",{className:"dialogue-options-area mt-auto pt-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(Oa,{}),e.jsx("div",{className:"flex-grow border-t border-slate-600 ml-2"})]}),h()]})]})})}Wa.defaultProps={isDialogueExiting:!1};const Ze=()=>{};function dl({lastTurnChanges:t,isGameBusy:n}){const{itemForCardDisplay:a,currentAnimatingItem:l,isVisibleOverlay:r,isCardVisibleClass:o,explicitDisappearClass:c,activeGlowType:p,handleSkipAnimations:b,handleKeyDown:v}=vn({lastTurnChanges:t,isGameBusy:n}),g=i=>{var f,h;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(Dt,{type:i.type}),i.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:i.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-3 italic leading-tight flex-grow",children:i.isActive&&i.activeDescription?i.activeDescription:i.description}),(f=i.tags)!=null&&f.includes("junk")?e.jsx("p",{className:"text-xs text-orange-400 mb-1 italic",children:"(Marked as junk)"}):null,e.jsxs("div",{className:"space-y-1 mt-auto",children:[(h=i.knownUses)==null?void 0:h.map(N=>e.jsx(k,{"aria-hidden":"true",ariaLabel:N.actionName,disabled:!0,label:N.actionName,onClick:Ze,preset:"slate",size:"sm",title:N.description},`${i.name}-anim-ku-${N.actionName}`)),e.jsx(k,{"aria-hidden":"true",ariaLabel:"Inspect",disabled:!0,label:"Inspect",onClick:Ze,preset:"slate",size:"sm"}),i.type!=="status effect"&&i.type!=="vehicle"&&e.jsx(k,{"aria-hidden":"true",ariaLabel:"Attempt to Use (Generic)",disabled:!0,label:"Attempt to Use (Generic)",onClick:Ze,preset:"slate",size:"sm"}),i.type==="vehicle"&&e.jsx(k,{"aria-hidden":"true",ariaLabel:i.isActive?`Exit ${i.name}`:`Enter ${i.name}`,disabled:!0,label:i.isActive?`Exit ${i.name}`:`Enter ${i.name}`,onClick:Ze,preset:"slate",size:"sm"})]})]})};if(!r||!a)return null;const C=i=>p?p==="acquire"&&i==="single"?"apply-green-glow-effect":p==="loss"&&i==="single"?"apply-red-glow-effect":p==="change-new"&&i==="new"?"apply-neutral-glow-effect":"":"",d="animating-item-card",u=o?"visible":"",m=c&&!o?c:"";return e.jsx("div",{"aria-label":"Skip item animations",className:"item-change-overlay active",onClick:b,onKeyDown:v,role:"button",tabIndex:0,children:(l==null?void 0:l.type)==="change"&&a.oldItem&&a.newItem?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`${d} ${u} ${m} ${C("old")}`,children:g(a.oldItem)}),e.jsx("div",{className:`${d} ${u} ${m} ${C("new")}`,children:g(a.newItem)})]}):a.item?e.jsx("div",{className:`${d} ${u} ${m} ${C("single")}`,children:g(a.item)}):null})}function Ua({theme:t,onSelect:n,disabled:a=!1}){const l=s.useCallback(()=>{n()},[n]);return e.jsx(k,{ariaLabel:`Start a new game in the theme: ${t.name}${a?" (Current theme, cannot select)":""}`,disabled:a,label:e.jsxs("div",{className:"flex flex-col items-start text-left w-full",style:{minHeight:"180px"},children:[e.jsx("h3",{className:"text-xl font-semibold text-amber-400 mb-2",children:t.name}),e.jsx("p",{className:"text-sm text-slate-300 leading-snug line-clamp-8",children:t.storyGuidance}),a?e.jsx("p",{className:"text-xs text-orange-300 mt-1 italic",children:"(Currently active theme)"}):null]}),onClick:l,preset:"slate",variant:"standard"})}Ua.defaultProps={disabled:!1};function Ha({isVisible:t,onClose:n,onThemeSelected:a,disabledThemeName:l=null,titleText:r=void 0,descriptionText:o=void 0}){const c=s.useCallback(g=>()=>{a(g)},[a]);if(!t)return null;const p=Object.keys(ha).reduce((g,C)=>{const d=C;return g[d]=ha[d],g},{}),b=r??"Choose Your Adventure Theme",v=o??"Select a theme to start your adventure. The story will remain in this setting until you begin a new game.";return e.jsx("div",{"aria-labelledby":"custom-game-setup-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(k,{ariaLabel:"Close theme selection",icon:e.jsx(Y,{name:"x",size:20}),onClick:n,size:"sm",variant:"close"}),e.jsxs("div",{className:"flex flex-col items-center w-full h-full p-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-4 text-center",id:"custom-game-setup-title",children:b}),e.jsx("p",{className:"text-slate-300 mb-6 text-center text-sm max-w-2xl",children:v}),Object.keys(p).length===0?e.jsx("p",{className:"text-slate-300 italic",children:"No themes available. Please check configuration."}):e.jsx("div",{className:"overflow-y-auto flex-grow w-full max-w-5xl px-6",children:Object.entries(p).map(([g,C])=>C.length>0&&e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-purple-400 mb-3 pb-1 border-b border-purple-600",children:g}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4",children:C.map(d=>{const u=d.name===l;return e.jsx(Ua,{disabled:u,onSelect:c(d.name),theme:d},d.name)})})]},g))})]})]})})}Ha.defaultProps={descriptionText:void 0,disabledThemeName:null,titleText:void 0};function Ka({options:t,selected:n,onToggle:a,errorText:l}){const r=s.useCallback(o=>{a(o.currentTarget.value)},[a]);return e.jsxs("div",{className:"space-y-3",children:[t.map(o=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-2 bg-slate-700/50 rounded-md hover:bg-slate-600/50 transition-colors",children:[e.jsx("input",{"aria-labelledby":`${o}-label`,checked:n.includes(o),className:"form-checkbox h-5 w-5 text-sky-500 bg-slate-600 border-slate-500 rounded focus:ring-sky-400 focus:ring-offset-slate-800",onChange:r,type:"checkbox",value:o}),e.jsx("span",{className:"text-slate-200 text-lg",id:`${o}-label`,children:o})]},o)),l?e.jsx("p",{className:"text-red-400 mt-2 text-sm",children:l}):null]})}Ka.defaultProps={errorText:void 0};function Rt({name:t,options:n,value:a,onChange:l,addCustom:r=!1,placeholder:o=""}){const c=n.includes(a),p=c||!r||a==="Not Specified"?"":a,[b,v]=s.useState(p);s.useEffect(()=>{const i=n.includes(a);v(i||!r||a==="Not Specified"?"":a)},[a,n,r]);const g=s.useCallback(i=>{l(i==="Custom"?b.trim()||"Not Specified":i)},[b,l]),C=s.useCallback(i=>{g(i.currentTarget.value)},[g]),d=s.useCallback(i=>{const f=i.target.value;v(f),n.includes(a)||l(f.trim()||"Not Specified")},[l,n,a]),u=c?a:"Custom",m=r?[...n,"Custom"]:n;return e.jsxs("div",{className:"space-y-3",children:[m.map(i=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-2 bg-slate-700/50 rounded-md hover:bg-slate-600/50 transition-colors",children:[e.jsx("input",{"aria-labelledby":`${t}-${i}`,checked:u===i,className:"form-radio h-5 w-5 text-sky-500 bg-slate-600 border-slate-500 focus:ring-sky-400 focus:ring-offset-slate-800",name:t,onChange:C,type:"radio",value:i}),e.jsx("span",{className:"text-slate-200 text-lg",id:`${t}-${i}`,children:i})]},i)),r&&u==="Custom"?e.jsx("input",{"aria-label":"Custom input",className:"w-full p-2 mt-2 bg-slate-600 text-slate-100 border border-slate-500 rounded-md focus:ring-sky-500 focus:border-sky-500",onChange:d,placeholder:o,type:"text",value:b}):null]})}Rt.defaultProps={addCustom:!1,placeholder:""};function ul({enabledThemePacks:t,isVisible:n,onChangeThinkingEffort:a,onClose:l,onToggleThemePack:r,thinkingEffort:o}){const c=s.useCallback(v=>{r(v)},[r]),p=s.useCallback(v=>{c(v)},[c]),b=s.useCallback(v=>{a(v)},[a]);return e.jsx("div",{"aria-labelledby":"settings-title","aria-modal":"true",className:`animated-frame ${n?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(k,{ariaLabel:"Close settings",icon:e.jsx(Y,{name:"x",size:20}),onClick:l,size:"sm",variant:"close"}),e.jsxs("div",{className:"settings-content-area",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-8 text-center",id:"settings-title",children:"Game Settings"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Thinking Effort"}),e.jsx("p",{className:"settings-explanation mb-3",children:"Select how much reasoning the AI uses. Higher levels may improve quality at the cost of time, but will not affect API usage quotas."}),e.jsx(Rt,{name:"thinking-effort",onChange:b,options:["Low","Medium","High"],value:o})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Theme Pack Preferences"}),e.jsx("p",{className:"settings-explanation mb-3",children:"Select which genre packs to include when choosing a starting theme. At least one pack must be enabled. You can change this setting at any time."}),e.jsx(Ka,{errorText:t.length===0?"At least one theme pack must be enabled. Please select a pack to continue.":void 0,onToggle:p,options:Un,selected:t})]})]})]})})}function ml({title:t,items:n}){return e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-medium text-sky-400 mb-2",children:t}),e.jsx("ul",{className:"list-disc list-inside ml-4 space-y-1",children:n.map(a=>e.jsx("li",{children:a},a))})]})}const ot=el;function pl(t){return t.replace(/\{\{CURRENT_SAVE_GAME_VERSION\}\}/g,Hn).replace(/\{\{GEMINI_MODEL_NAME\}\}/g,Aa)}const hl=ot.sections.map(t=>e.jsx(Ne,{contentFontClass:"leading-relaxed space-y-3",header:t.header,text:t.text.map(n=>pl(n)).join(`
`)},t.header)),gl=ot.changelog.map(t=>e.jsx(ml,{items:t.items,title:t.title},t.title));function xl({isVisible:t,onClose:n}){return e.jsx("div",{"aria-labelledby":"info-title","aria-modal":"true",className:`animated-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(k,{ariaLabel:"Close game information",icon:e.jsx(Y,{name:"x",size:20}),onClick:n,size:"sm",variant:"close"}),e.jsxs("div",{className:"info-content-area",children:[e.jsx(Ne,{borderColorClass:"border-sky-700",borderWidthClass:"border-b-2",containerClassName:"mb-6",header:ot.title,headerFont:"3xl",headerPreset:"sky",headerTag:"h1",headerWrapperClassName:"text-center"}),hl,e.jsx(Ne,{contentFontClass:"leading-relaxed space-y-4",header:"Changelog",children:gl}),e.jsx(Ne,{containerClassName:"mt-8",contentColorClass:"text-slate-500",contentFontClass:"text-sm text-center",text:ot.footer})]})]})})}const fl=Tt.memo(xl);function bl({isVisible:t,facts:n,onSubmit:a,onClose:l}){const[r,o]=s.useState({});s.useEffect(()=>{t&&o({})},[n,t]);const c=s.useCallback((u,m)=>{o(i=>({...i,[u]:i[u]===m?void 0:m}))},[]),p=s.useCallback(()=>{const u=[],m=[];n.forEach((i,f)=>{r[f]==="good"&&u.push(i),r[f]==="bad"&&m.push(i)}),a(u,m,!0)},[n,r,a]),b=s.useCallback(()=>{a([],[],!1)},[a]),v=s.useCallback(u=>{c(u,"good")},[c]),g=s.useCallback(u=>{c(u,"bad")},[c]),C=s.useMemo(()=>n.map((u,m)=>()=>{v(m)}),[n,v]),d=s.useMemo(()=>n.map((u,m)=>()=>{g(m)}),[n,g]);return e.jsx("div",{"aria-labelledby":"debug-lore-title","aria-modal":"true",className:`animated-frame debug-lore-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(k,{ariaLabel:"Close debug lore",icon:e.jsx(Y,{name:"x",size:20}),onClick:l,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-2xl font-bold text-amber-400 mb-3 text-center",id:"debug-lore-title",children:"Evaluate Extracted Facts"}),e.jsx("ul",{className:"mb-4 space-y-2",children:n.map((u,m)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"flex-grow text-slate-300",children:u}),e.jsx(k,{ariaLabel:"Mark good",label:"Good",onClick:C[m],preset:"green",pressed:r[m]==="good",size:"sm",variant:"toggle"}),e.jsx(k,{ariaLabel:"Mark bad",label:"Bad",onClick:d[m],preset:"red",pressed:r[m]==="bad",size:"sm",variant:"toggle"})]},u))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(k,{ariaLabel:"Skip",label:"Skip",onClick:b,preset:"stone",size:"sm"}),e.jsx(k,{ariaLabel:"OK",label:"OK",onClick:p,preset:"sky",size:"sm"})]})]})})}function yl({isVisible:t,onClose:n}){const[a,l]=s.useState("");s.useEffect(()=>{t&&l(Cn()??"")},[t]);const r=s.useCallback(c=>{l(c.target.value)},[]),o=s.useCallback(()=>{Nn(a.trim()),n()},[a,n]);return t?e.jsx("div",{"aria-labelledby":"gemini-key-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex flex-col items-center",children:[e.jsx(k,{ariaLabel:"Close Gemini key setup",icon:e.jsx(Y,{name:"x",size:20}),onClick:n,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-2xl font-bold text-sky-300 mb-4",id:"gemini-key-title",children:"Configure Gemini API Key"}),e.jsxs("div",{className:"mb-4 text-slate-200 text-center",children:["Visit"," ",e.jsx("a",{className:"text-sky-400 underline hover:text-sky-300",href:"https://aistudio.google.com",rel:"noopener noreferrer",target:"_blank",children:"https://aistudio.google.com"})," ","to generate a free API key. Paste it below."]}),e.jsxs("div",{className:"flex w-full max-w-md space-x-2",children:[e.jsx("input",{"aria-label":"Gemini API key",className:"flex-grow p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500",onChange:r,placeholder:"Enter API key",type:"password",value:a}),e.jsx(k,{ariaLabel:"Save API key",disabled:a.trim()==="",label:"Save",onClick:o,preset:"green",variant:"compact"})]}),e.jsx("div",{className:"mb-4 text-amber-400 text-center",children:"The game runs entirely in your browser. The key never leaves your device and will be stored in the Browser's Local Storage."})]})}):null}function jl({label:t,text:n}){return e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:t}),": ",n]})}function Ya({option:t,onSelect:n,disabled:a=!1}){const l=s.useCallback(()=>{n(t)},[n,t]);return e.jsx(k,{ariaLabel:`Select character ${t.name}${a?" (selected)":""}`,disabled:a,label:e.jsxs("div",{className:"flex flex-col items-start text-left w-full",style:{minHeight:"120px"},children:[e.jsx("h3",{className:"text-xl font-semibold text-amber-400 mb-2",children:t.name}),e.jsx("p",{className:"text-sm text-slate-300 leading-snug line-clamp-8",children:t.description}),a?e.jsx("p",{className:"text-xs text-orange-300 mt-1 italic",children:"(Selected)"}):null]}),onClick:l,preset:"slate",variant:"standard"})}Ya.defaultProps={disabled:!1};function vl({isVisible:t,theme:n,heroGender:a,worldFacts:l,options:r,onHeroData:o,onComplete:c}){const[p,b]=s.useState(null),[v,g]=s.useState(null),[C,d]=s.useState(null),[u,m]=s.useState(!1),[i,f]=s.useState(!1),h=s.useCallback($=>{b($.name),m(!0),(async()=>{const M=await kn(n,a,l,$.name,$.description),z={name:$.name,heroSheet:(M==null?void 0:M.heroSheet)??null,heroBackstory:(M==null?void 0:M.heroBackstory)??null,storyArc:(M==null?void 0:M.storyArc)??null};g(z.heroSheet),d(z.heroBackstory),m(!1),f(!0),o(z).finally(()=>{f(!1)})})()},[n,a,l,o]),N=s.useCallback(()=>{p&&c()},[p,c]),w=s.useCallback($=>e.jsx(Ya,{disabled:p===$.name,onSelect:h,option:$},$.name),[p,h]);return t?e.jsx("div",{"aria-labelledby":"character-select-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content character-select-content-area flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h1",{className:"mb-4 text-center text-3xl font-bold text-sky-300",id:"character-select-title",children:"Choose Your Character"}),e.jsxs("p",{className:"mb-6 max-w-2xl text-center text-sm text-slate-300",children:["Explore the world of"," ",e.jsx("span",{className:"font-semibold",children:n.name}),". ","Select a character to begin your adventure."]}),u?e.jsx(xe,{}):v&&C?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-4 w-4/5 flex-1 max-h-[60vh] overflow-y-auto rounded p-4 text-left text-slate-300 space-y-8",children:[e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h2",{className:"text-center font-semibold text-amber-400",children:v.name}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Occupation:"})," ",v.occupation]}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Traits:"})," ",v.traits.join(", ")]}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Starting Items:"})," ",v.startingItems.join(", ")]})]}),e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h3",{className:"text-center font-semibold text-sky-300",children:"Backstory"}),e.jsx("div",{className:"space-y-2 whitespace-pre-line",children:[{label:"5 years ago",text:C.fiveYearsAgo},{label:"1 year ago",text:C.oneYearAgo},{label:"6 months ago",text:C.sixMonthsAgo},{label:"1 month ago",text:C.oneMonthAgo},{label:"1 week ago",text:C.oneWeekAgo},{label:"Yesterday",text:C.yesterday},{label:"Now",text:C.now}].map(({label:$,text:M})=>e.jsx(jl,{label:$,text:M},$))})]}),e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h3",{className:"text-center font-semibold text-sky-300",children:"World Information"}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Geography:"})," ",l.geography]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Climate:"})," ",l.climate]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Technology Level:"})," ",l.technologyLevel]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Supernatural Elements:"})," ",l.supernaturalElements]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Major Factions:"})," ",l.majorFactions.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Key Resources:"})," ",l.keyResources.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Cultural Notes:"})," ",l.culturalNotes.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Notable Locations:"})," ",l.notableLocations.join(`
`)]})]})]}),e.jsxs("div",{className:"mt-8 flex items-center justify-center space-x-4",children:[e.jsx(k,{ariaLabel:"Begin the adventure",icon:e.jsx(Y,{name:"bookOpen",size:20}),label:"Begin the Journey",onClick:N,preset:"green",size:"lg"}),i?e.jsx(xe,{showText:!1,size:"sm"}):null]})]}):e.jsx("div",{className:"mt-4 w-4/5 flex-1 grid grid-cols-1 gap-4 overflow-y-auto p-4 md:grid-cols-2",children:r.map(w)})]})}):null}function Cl({isVisible:t,defaultGender:n,onSubmit:a}){const[l,r]=s.useState(n),o=s.useCallback(()=>{a(l.trim()||"Not Specified")},[l,a]);return t?e.jsx("div",{"aria-labelledby":"gender-select-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex flex-col items-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-sky-300 mb-4",id:"gender-select-title",children:"Choose Your Character's Gender"}),e.jsx("div",{className:"mb-6 w-full max-w-xs",children:e.jsx(Rt,{addCustom:!0,name:"heroGender",onChange:r,options:["Male","Female"],placeholder:"Enter custom gender",value:l})}),e.jsx(k,{ariaLabel:"Confirm gender",icon:e.jsx(Y,{name:"bookOpen",size:20}),label:"Continue",onClick:o,preset:"green",size:"lg"})]})}):null}function Nl({act:t,isTurnGenerating:n,onContinue:a}){return e.jsx("div",{"aria-labelledby":"act-intro-heading","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h2",{className:"mb-4 text-center text-3xl font-bold text-amber-400",id:"act-intro-heading",children:`Act ${String(t.actNumber)}: ${t.title}`}),e.jsx("div",{className:"mt-4 w-4/5 flex-1 max-h-[60vh] overflow-y-auto rounded p-4 text-left text-slate-300 space-y-6",children:e.jsx("section",{className:"space-y-2 text-lg",children:e.jsx("p",{className:"whitespace-pre-line text-center",children:t.description})})}),e.jsxs("div",{className:"mt-8 flex items-center space-x-4 self-center",children:[e.jsx(k,{ariaLabel:"Continue",label:"Continue",onClick:a,preset:"blue",size:"lg"}),n?e.jsx(xe,{showText:!1,size:"sm"}):null]})]})})}function kl({heroSheet:t,storyArc:n,onClose:a}){return e.jsx("div",{"aria-labelledby":"victory-heading","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold",id:"victory-heading",children:"Victory!"}),e.jsx("p",{className:"mt-4",children:`You guided ${t.name}, ${t.occupation}, through ${n.title}.`}),e.jsx("div",{className:"mt-8 w-4/5 max-h-[60vh] flex-1 overflow-y-auto rounded p-4 text-left",children:e.jsx("ul",{className:"space-y-6",children:n.acts.map(l=>e.jsxs("li",{children:[e.jsx("p",{className:"font-semibold text-center",children:`Act ${String(l.actNumber)}: ${l.title}`}),e.jsx("p",{className:"mt-2",children:l.description})]},l.actNumber))})}),e.jsx("div",{className:"mt-8 self-center",children:e.jsx(k,{ariaLabel:"Return to Title Menu",label:"Return to Title",onClick:a,preset:"blue",size:"lg"})})]})})}function wl({isBlurred:t,isDebugViewVisible:n,setIsDebugViewVisible:a}){const l=s.useCallback(()=>{a(r=>!r)},[a]);return e.jsx("footer",{className:`w-full max-w-screen-xl mt-12 text-center text-slate-500 text-sm ${t?"filter blur-sm pointer-events-none":""}`,children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-left",children:["Â©"," ",new Date().getFullYear(),". Developed by"," ",Kn,", Codex, and Gemini."," ",e.jsx("br",{}),"Powered by Gemini."]}),e.jsx("button",{"aria-label":n?"Hide Debug View":"Open Debug View",className:"px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs rounded shadow-md transition-colors",onClick:l,type:"button",children:"Debug"})]})})}function Sl({allNPCs:t,currentTheme:n,isVisible:a,onClose:l}){const r=s.useMemo(()=>[...t].sort((o,c)=>o.name.localeCompare(c.name)),[t]);return e.jsx("div",{"aria-labelledby":"knowledge-base-title","aria-modal":"true",className:`animated-frame ${a?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(k,{ariaLabel:"Close knowledge base",icon:e.jsx(Y,{name:"x",size:20}),onClick:l,size:"sm",variant:"close"}),e.jsxs("div",{className:"knowledge-base-content-area",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-6 text-center",id:"knowledge-base-title",children:"Knowledge Base"}),r.length===0&&a?e.jsx("p",{className:"text-slate-300 italic text-center",children:"No knowledge has been recorded yet."}):null,a?e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"kb-theme-group-title",children:"NPCs"}),r.length>0&&e.jsx("div",{className:"kb-card-grid",children:r.map(o=>{let c;if(!!n&&(o.presenceStatus==="companion"||o.presenceStatus==="nearby")){const b=o.presenceStatus==="companion"?"companion":"nearbyNpc",v=o.presenceStatus==="companion"?"(Companion)":"(Nearby)",g=o.presenceStatus==="companion"?"text-green-300":"text-sky-300";c=e.jsxs("p",{className:"text-sm text-slate-300 flex items-center",children:[e.jsx(Y,{color:b==="companion"?"green":"sky",inline:!0,marginRight:4,name:b,size:16}),e.jsxs("span",{className:`ml-1 ${g} italic`,children:[o.preciseLocation??""," ",v]})]})}else o.lastKnownLocation&&o.lastKnownLocation!=="Unknown"?c=e.jsx("p",{className:"text-sm text-slate-300 flex items-center",children:e.jsxs("span",{className:"ml-1 italic",children:[o.lastKnownLocation," ","(",o.presenceStatus,")"]})}):c=e.jsx("p",{className:"text-sm text-slate-500 flex items-center",children:e.jsxs("span",{className:"ml-1 italic",children:["(",o.presenceStatus,", Location Unknown)"]})});return e.jsxs("div",{className:"kb-card",children:[e.jsx("div",{className:"kb-card-name-header",children:o.name}),o.aliases&&o.aliases.length>0?e.jsxs("p",{className:"kb-card-aliases",children:["Aliases:",o.aliases.join(", ")]}):null,e.jsx("p",{className:"kb-card-description",children:o.description}),e.jsx("div",{className:"mt-2 pt-2 border-t border-slate-600",children:c})]},o.name)})})]}):null]})]})})}const tt=t=>{if(t.data.visualRadius)return t.data.visualRadius;switch(t.data.nodeType){case"region":return Ce*2.4;case"location":return Ce*2;case"settlement":return Ce*1.8;case"district":return Ce*1.6;case"exterior":return Ce*1.4;case"interior":return Ce*1.2;case"room":return Ce*.8;case"feature":return Ce*.6;default:return Ce*.6}},Ja=(t,n,a)=>{if(!t)return[];const l=t.split(" "),r=[];let o="";for(const c of l){if(r.length===a)break;if(o.length===0)o=c;else if(o.length+c.length+1<=n)o+=` ${c}`;else{if(r.push(o),r.length===a){if(c){const p=r[a-1];p.length>3?r[a-1]=p.slice(0,-3)+"...":r[a-1]=".."}o="";break}o=c}}if(o&&r.length<a?r.push(o):o&&r.length===a&&r[a-1]&&!r[a-1].endsWith("...")&&(r[a-1].length>3?r[a-1]=r[a-1].slice(0,-3)+"...":r[a-1]=".."),r.length===a&&t.split(" ").length>l.indexOf(o.split(" ")[0])+o.split(" ").length){const c=r[a-1];c&&c.length>3&&!c.endsWith("...")?r[a-1]=c.slice(0,Math.max(0,c.length-3))+"...":c&&!c.endsWith("...")&&(r[a-1]="..")}return r},He=t=>t==="feature"||t==="room"||t==="interior",Xa=t=>t==="feature",El=(t,n)=>{const a=new Map(t.map(i=>[i.id,i])),l=new Map;t.forEach(i=>{if(i.data.parentNodeId){const f=l.get(i.data.parentNodeId)??[];f.push(i),l.set(i.data.parentNodeId,f)}});const r=new Map,o=i=>{if(!i)return 0;const f=r.get(i.id);if(f!==void 0)return f;const h=i.data.parentNodeId?a.get(i.data.parentNodeId):void 0,N=h?o(h)+1:0;return r.set(i.id,N),N};t.forEach(i=>o(i));const c=i=>l.has(i.id),p=i=>He(i.data.nodeType)?7:12,b={},v=i=>{const f=b[i.id];if(f)return f;const h=He(i.data.nodeType)||!c(i)?20:25,N=Ja(i.placeName,h,Pa);return b[i.id]=N,N},g=i=>v(i).length*p(i)*it,C=i=>Math.max(...v(i).map(f=>f.length*p(i)*.6)),d=(i,f)=>{const h=C(i),N=g(i);if(Xa(i.data.nodeType))return{x:i.position.x-h/2,y:i.position.y-N/2,width:h,height:N*2};const w=tt(i)+rt+f;return{x:i.position.x-h/2,y:i.position.y+w,width:h,height:N}},u={};t.forEach(i=>{u[i.id]=0});const m=(i,f)=>i.x<f.x+f.width&&i.x+i.width>f.x&&i.y<f.y+f.height&&i.y+i.height>f.y;return l.forEach(i=>{const f=[...i].sort((h,N)=>h.position.x-N.position.x);for(let h=1;h<f.length;h++){const N=f[h-1],w=f[h];let $=d(N,u[N.id]),M=d(w,u[w.id]);if(m($,M)){const z=$.y+$.height-M.y+n;w.data.nodeType!=="feature"?(u[w.id]+=z,M=d(w,u[w.id])):N.data.nodeType!=="feature"&&(u[N.id]+=z,$=d(N,u[N.id]))}}}),t.forEach(i=>{if(i.data.nodeType==="feature")return;const f=t.filter(h=>h.data.nodeType==="feature"&&wa(h,i,a));for(const h of f){const N=d(i,u[i.id]),w=d(h,u[h.id]);if(m(N,w)){const $=w.y+w.height-N.y+n;u[i.id]+=$}}}),u},va=(t,n)=>{const a=t.position.x,l=t.position.y,r=n.position.x,o=n.position.y,c=r-a,p=o-l,b=Math.sqrt(c*c+p*p)||1,v=(a+r)/2,g=(l+o)/2,C=b*.3,d=-p/b,u=c/b,m=v+d*C,i=g+u*C;return`M ${String(a)} ${String(l)} Q ${String(m)} ${String(i)} ${String(r)} ${String(o)}`},Ml={};function Ll({nodes:t,edges:n,currentMapNodeId:a,destinationNodeId:l,itemPresenceByNode:r=Ml,onSelectDestination:o,labelOverlapMarginPx:c,itemIconScale:p,initialViewBox:b,onViewBoxChange:v}){const g=wn(b,v),{svgRef:C,viewBox:d,handleMouseDown:u,handleMouseMove:m,handleMouseUp:i,handleMouseLeave:f,handleWheel:h,handleTouchStart:N,handleTouchMove:w,handleTouchEnd:$}=g,{tooltip:M,tooltipScreenPosition:z,isTooltipLocked:_,handleMouseLeaveGeneral:G,handleSvgClick:D,handleEdgeMouseEnterById:V,handleNodeMouseEnterById:P,handleNodeClickById:J,handleDestinationClick:X}=Sn({nodes:t,edges:n,svgRef:C,viewBox:d,destinationNodeId:l,onSelectDestination:o}),O=s.useMemo(()=>El(t,c),[t,c]),U=s.useMemo(()=>{const y=new Map(t.map(A=>[A.id,A])),S=new Map,B=A=>{if(!A)return 0;const R=S.get(A.id);if(R!==void 0)return R;const q=A.data.parentNodeId?y.get(A.data.parentNodeId):void 0,H=q?B(q)+1:0;return S.set(A.id,H),H};return t.forEach(A=>B(A)),S},[t]),I=s.useMemo(()=>[...t].sort((y,S)=>(U.get(y.id)??0)-(U.get(S.id)??0)),[t,U]),E=s.useMemo(()=>{if(!l)return null;const y=t.find(A=>A.id===l),S=a?t.find(A=>A.id===a):null;if(!y)return null;const B=new Map(t.map(A=>[A.id,A]));return S&&(S.id===y.id||wa(S,y,B))?null:e.jsx("polygon",{className:"map-destination-marker",pointerEvents:"none",points:"0,-14 10,0 0,14 -10,0",transform:`translate(${String(y.position.x)}, ${String(y.position.y)})`})},[l,t,a]);return t.length===0?e.jsx("div",{className:"map-content-area",children:e.jsx("p",{className:"text-slate-500 italic",children:"No map data available for this theme yet."})}):e.jsxs("div",{className:"map-content-area",children:[e.jsx("svg",{className:"map-svg-container",onClick:D,onMouseDown:u,onMouseLeave:f,onMouseMove:m,onMouseUp:i,onTouchEnd:$,onTouchMove:w,onTouchStart:N,onWheel:h,preserveAspectRatio:"xMidYMid meet",ref:C,viewBox:d,children:e.jsxs("g",{children:[n.map(y=>{const S=t.find(R=>R.id===y.sourceNodeId),B=t.find(R=>R.id===y.targetNodeId);if(!S||!B)return null;let A="map-edge";return y.data.type&&(A+=` ${y.data.type.replace(/\s+/g,"_").toLowerCase()}`),y.data.status&&(A+=` ${y.data.status.replace(/\s+/g,"_").toLowerCase()}`),e.jsx("g",{className:"map-edge-group","data-edge-id":y.id,onMouseEnter:V,onMouseLeave:G,children:y.data.type==="shortcut"?e.jsxs(e.Fragment,{children:[e.jsx("path",{d:va(S,B),fill:"none",stroke:"transparent",strokeWidth:ba}),e.jsx("path",{className:A,d:va(S,B)})]}):e.jsxs(e.Fragment,{children:[e.jsx("line",{stroke:"transparent",strokeWidth:ba,x1:S.position.x,x2:B.position.x,y1:S.position.y,y2:B.position.y}),e.jsx("line",{className:A,x1:S.position.x,x2:B.position.x,y1:S.position.y,y2:B.position.y})]})},y.id)}),I.map(y=>{let S="map-node-circle";S+=` ${y.data.nodeType}`,y.id===a&&(S+=" current");const B=y.data.status.replace(/\s+/g,"_").toLowerCase();S+=` ${B}`;const A=tt(y);return e.jsxs("g",{className:"map-node","data-node-id":y.id,onClick:J,onMouseLeave:G,transform:`translate(${String(y.position.x)}, ${String(y.position.y)})`,children:[e.jsx("circle",{className:S,"data-node-id":y.id,onMouseEnter:y.data.nodeType==="feature"?P:void 0,onMouseLeave:y.data.nodeType==="feature"?G:void 0,pointerEvents:y.data.nodeType==="feature"?"visible":"none",r:A}),e.jsx("circle",{className:"map-node-hover-ring","data-node-id":y.id,fill:"none",onMouseEnter:P,onMouseLeave:G,pointerEvents:"stroke",r:A,stroke:"transparent",strokeWidth:8})]},y.id)}),E,I.map(y=>{const S=r[y.id]??{hasUseful:!1,hasVehicle:!1};if(!S.hasUseful&&!S.hasVehicle)return null;const A=tt(y)+rt*1.5,R=Ce*2*p,q=y.position.x+A*Math.sin(20*Math.PI/180)-R/2,H=y.position.y-A*Math.cos(20*Math.PI/180)-R/2,j=y.position.x+A*Math.sin(340*Math.PI/180)-R/2,F=y.position.y-A*Math.cos(340*Math.PI/180)-R/2;return e.jsxs("g",{children:[S.hasUseful?e.jsx("g",{pointerEvents:"none",transform:`translate(${String(q)}, ${String(H)})`,children:e.jsx(Y,{color:"green",name:"mapItemBox",size:R,wrapper:"g"})}):null,S.hasVehicle?e.jsx("g",{pointerEvents:"none",transform:`translate(${String(j)}, ${String(F)})`,children:e.jsx(Y,{color:"green",name:"mapWheel",size:R,wrapper:"g"})}):null]},`${y.id}-icons`)}),I.map(y=>{const S=He(y.data.nodeType)?20:25,B=Ja(y.placeName,S,Pa),A=tt(y),R=He(y.data.nodeType)?7:12,q=A+rt+(O[y.id]??0),H=Xa(y.data.nodeType)?-(B.length-1)*.5*it+.3:q/R;return e.jsx("text",{className:`map-node-label${He(y.data.nodeType)?y.data.nodeType==="feature"?" feature-label":y.data.nodeType==="room"?" room-label":" interior-label":""}`,"data-node-id":y.id,onMouseEnter:P,onMouseLeave:G,pointerEvents:"visible",transform:`translate(${String(y.position.x)}, ${String(y.position.y)})`,children:B.map((j,F)=>e.jsx("tspan",{dy:F===0?`${String(H)}em`:`${String(it)}em`,x:"0",children:j},`${y.id}-${j}`))},`label-${y.id}`)})]})}),M&&z?e.jsxs("div",{className:`map-tooltip anchor-${M.anchor}`,style:{top:z.y,left:z.x,pointerEvents:_?"auto":"none"},children:[_&&M.nodeId?e.jsx("div",{className:"mb-1",children:e.jsx(k,{ariaLabel:M.nodeId===l?"Remove Destination":"Set Destination","data-node-id":M.nodeId,label:M.nodeId===l?"Remove Destination":"Set Destination",onClick:X,preset:"amber",size:"sm",variant:"standard"})}):null,M.content.split(`
`).map((y,S)=>e.jsxs(s.Fragment,{children:[S===0?e.jsx("strong",{children:y}):y,S<M.content.split(`
`).length-1&&e.jsx("br",{})]},`${String(M.nodeId)}-${y}`))]}):null]})}function et({label:t,id:n,value:a,onChange:l,min:r,max:o,step:c,explanation:p=""}){const b=s.useCallback(v=>{l(parseFloat(v.target.value))},[l]);return e.jsxs("div",{className:"map-control-group",children:[e.jsxs("label",{className:"map-control-label",htmlFor:n,children:[t,": ",a.toFixed(c<1?2:0)]}),e.jsx("input",{className:"map-control-input",id:n,max:o,min:r,onChange:b,step:c,type:"range",value:a}),p?e.jsx("p",{className:"map-control-explanation",children:p}):null]})}function Tl(t){const[n,a]=s.useState(!1),l=s.useCallback(()=>{a(m=>!m)},[]),{padding:r,setPadding:o,anglePadding:c,setAnglePadding:p,overlapMargin:b,setOverlapMargin:v,itemIconScale:g,setItemIconScale:C,onReset:d,onRefreshLayout:u}=t;return e.jsxs("div",{className:`map-controls-container ${n?"controls-expanded":""}`,children:[n?e.jsxs("div",{className:"map-layout-sliders-wrapper",children:[e.jsx(et,{explanation:"Distance between parent and child levels",id:"layoutPadding",label:"Padding",max:60,min:5,onChange:o,step:1,value:r}),e.jsx(et,{explanation:"Extra spacing between siblings",id:"layoutAnglePadding",label:"Angle Padding",max:.5,min:0,onChange:p,step:.01,value:c}),e.jsx(et,{explanation:"Extra spacing when labels overlap",id:"overlapMargin",label:"Overlap Margin",max:10,min:0,onChange:v,step:1,value:b}),e.jsx(et,{explanation:"Relative size of item markers",id:"itemIconScale",label:"Icon Size",max:1,min:.2,onChange:C,step:.1,value:g}),e.jsx("div",{className:"mt-2",children:e.jsx(k,{ariaLabel:"Reset to Defaults",label:"Reset to Defaults",onClick:d,preset:"orange",variant:"standard"})})]}):null,e.jsxs("div",{className:"map-action-buttons-row",children:[e.jsx(k,{ariaLabel:"Toggle Layout Controls",label:`${n?"Hide":"Show"} Layout Controls`,onClick:l,preset:"blue",size:"sm",variant:"compact"}),e.jsx(k,{ariaLabel:"Refresh Layout",label:"Refresh Layout",onClick:u,preset:"blue",size:"sm",variant:"compact"})]})]})}function $l({mapData:t,currentThemeName:n,currentMapNodeId:a,destinationNodeId:l,itemPresenceByNode:r,onSelectDestination:o,initialLayoutConfig:c,initialViewBox:p,onViewBoxChange:b,onNodesPositioned:v,onLayoutConfigChange:g,isVisible:C,onClose:d}){const[u,m]=s.useState([]),[i,f]=s.useState(c.IDEAL_EDGE_LENGTH),[h,N]=s.useState(c.NESTED_PADDING),[w,$]=s.useState(c.NESTED_ANGLE_PADDING),M=rt,z=it,[_,G]=s.useState(c.LABEL_OVERLAP_MARGIN_PX),[D,V]=s.useState(c.ITEM_ICON_SCALE);s.useEffect(()=>{const E=c.IDEAL_EDGE_LENGTH,y=c.NESTED_PADDING,S=c.NESTED_ANGLE_PADDING,B=c.LABEL_OVERLAP_MARGIN_PX,A=c.ITEM_ICON_SCALE;f(R=>R===E?R:E),N(R=>R===y?R:y),$(R=>R===S?R:S),G(R=>R===B?R:B),V(R=>R===A?R:A)},[c]);const P=s.useMemo(()=>({IDEAL_EDGE_LENGTH:i,NESTED_PADDING:h,NESTED_ANGLE_PADDING:w,LABEL_MARGIN_PX:M,LABEL_LINE_HEIGHT_EM:z,LABEL_OVERLAP_MARGIN_PX:_,ITEM_ICON_SCALE:D}),[i,h,w,M,z,_,D]);s.useEffect(()=>{const E=setTimeout(()=>{g(P)},500);return()=>{clearTimeout(E)}},[P,g]);const J=s.useMemo(()=>t.nodes,[t.nodes]),X=s.useMemo(()=>t.edges,[t.edges]),O=s.useCallback(()=>{const E=[...J],y=Sa(E,{padding:h,anglePadding:w});m(y),v(y)},[J,h,w,v]);s.useEffect(()=>{C?O():m([])},[C,O]);const U=s.useCallback(()=>{O()},[O]),I=s.useCallback(()=>{f(En),N(Mn),$(Ln),G(Yn),V(Jn)},[]);return C?e.jsx("div",{"aria-labelledby":"map-display-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(k,{ariaLabel:"Close map view",icon:e.jsx(Y,{name:"x",size:20}),onClick:d,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-xl font-bold text-teal-400 mb-2 text-center",id:"map-display-title",children:n?`Map: ${n}`:"Map"}),e.jsx("p",{className:"text-center text-xs text-slate-300 mb-1",children:"Pan by dragging, zoom with the mouse wheel or pinch. Hover for details."}),e.jsx(Ll,{currentMapNodeId:a,destinationNodeId:l,edges:X,initialViewBox:p,itemIconScale:D,itemPresenceByNode:r,labelOverlapMarginPx:_,nodes:u,onSelectDestination:o,onViewBoxChange:b}),e.jsx(Tl,{anglePadding:w,itemIconScale:D,onRefreshLayout:U,onReset:I,overlapMargin:_,padding:h,setAnglePadding:$,setItemIconScale:V,setOverlapMargin:G,setPadding:N})]})}):null}function Lt({isOpen:t,title:n,message:a,onConfirm:l,onCancel:r,confirmText:o="Confirm",cancelText:c="Cancel",confirmPreset:p="sky"}){const b=s.useCallback(g=>{g.stopPropagation()},[]);if(!t)return null;const v=a;return e.jsxs("div",{"aria-labelledby":"confirmation-dialog-title","aria-modal":"true",className:"fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center z-[100] p-4 backdrop-blur-sm",onClick:r,role:"dialog",children:[e.jsxs("div",{className:"bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-lg transform transition-all duration-300 ease-out scale-95 opacity-0 animate-dialog-enter",onClick:b,style:{animationFillMode:"forwards"},children:[e.jsx("h2",{className:"text-2xl font-bold text-sky-300 mb-5",id:"confirmation-dialog-title",children:n}),e.jsx("div",{className:"text-slate-300 mb-8 text-base leading-relaxed",children:v}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(k,{ariaLabel:c,label:c,onClick:r,preset:"slate",size:"md",variant:"compact"}),e.jsx(k,{ariaLabel:o,label:o,onClick:l,preset:p,size:"md",variant:"compact"})]})]}),e.jsx("style",{children:`
        @keyframes dialog-enter {
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        .animate-dialog-enter {
          animation: dialog-enter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
      `})]})}Lt.defaultProps={cancelText:"Cancel",confirmPreset:"sky",confirmText:"Confirm"};const Ca={dungeon:"a dark, gritty medieval fantasy style, dungeons and dragons concept art",cyberpunk:"a neon-drenched, futuristic cyberpunk cityscape style, Blade Runner aesthetic",eldritch:"a Lovecraftian horror style, cosmic dread, 1920s period","post-apocalyptic":"a desolate, rusty post-apocalyptic wasteland style, Mad Max aesthetic",steampunk:"a steampunk style with clockwork machines and airships, Victorian era","victorian mansion":"a haunted Victorian mansion style, gothic horror, moody and atmospheric","deep space":"a deep space sci-fi style, cosmic anomaly, advanced technology","lost world":"a prehistoric lost world style, lush jungles, dinosaurs, ancient ruins","greek hero":"a mythic Greek hero style, classical art, epic battles","wild west":"a Wild West outlaw style, dusty frontier, cinematic western"};Pe()||console.error("Gemini API key is not set. Image visualization will not work.");function Il({currentSceneDescription:t,currentTheme:n,mapData:a,allNPCs:l,localTime:r,localEnvironment:o,localPlace:c,isVisible:p,onClose:b,setGeneratedImage:v,cachedImageUrl:g,cachedImageScene:C}){const[d,u]=s.useState(null),[m,i]=s.useState(!1),[f,h]=s.useState(null),[N,w]=s.useState(1),[$,M]=s.useState({x:0,y:0}),[z,_]=s.useState(!1),[G,D]=s.useState(null),[V,P]=s.useState(null),J=s.useRef(null),X=(j,F,Z)=>Math.min(Z,Math.max(F,j)),O=s.useCallback(j=>{j.cancelable&&j.preventDefault();const F=j.deltaY<0?1.1:.9;w(Z=>X(Z*F,1,4))},[]),U=s.useCallback(j=>{_(!0),D({x:j.clientX,y:j.clientY})},[]),I=s.useCallback(j=>{if(!z||!G)return;const F=j.clientX-G.x,Z=j.clientY-G.y;M(re=>({x:re.x+F,y:re.y+Z})),D({x:j.clientX,y:j.clientY})},[z,G]),E=s.useCallback(()=>{_(!1),D(null)},[]),y=(j,F)=>Math.sqrt((j.clientX-F.clientX)**2+(j.clientY-F.clientY)**2),S=s.useCallback(j=>{j.cancelable&&j.preventDefault(),j.touches.length===1?(_(!0),D({x:j.touches[0].clientX,y:j.touches[0].clientY}),P(null)):j.touches.length===2&&(_(!1),D(null),P(y(j.touches[0],j.touches[1])))},[]),B=s.useCallback(j=>{if(j.cancelable&&j.preventDefault(),j.touches.length===1&&z&&G){const F=j.touches[0],Z=F.clientX-G.x,re=F.clientY-G.y;M(ae=>({x:ae.x+Z,y:ae.y+re})),D({x:F.clientX,y:F.clientY})}else if(j.touches.length===2&&V!==null){const F=y(j.touches[0],j.touches[1]);if(F===0)return;w(Z=>X(Z*(F/V),1,4)),P(F)}},[z,G,V]),A=s.useCallback(j=>{j.touches.length<2&&P(null),j.touches.length<1&&(_(!1),D(null))},[]);s.useEffect(()=>{w(1),M({x:0,y:0})},[d]);const R=j=>{if(!j)return"a general fantasy style";const F=j.name.toLowerCase();for(const Z in Ca)if(F.includes(Z))return Ca[Z];return`a style fitting for ${j.name}`},q=s.useCallback(async()=>{var fe,me,de;if(!Ue||!n){h("Image generation service or theme is not available."),i(!1),Se(null);return}i(!0),Se("visualize"),h(null),u(null);const j=`A detailed, digital painting in ${R(n)} without ANY text on it.
    Aspect ratio 4:3.
    It is ${r??"now"}. ${o??"The air is okay"}. ${c??"Location is unimportant"}. ${t}`;let F=j;const Z=[];a.forEach(W=>{t.toLowerCase().includes(W.placeName.toLowerCase())&&(F+=` The ${W.placeName} is prominent, described as: ${W.data.description||"A notable location."}.`,Z.push(W.placeName))});const re=[];l.forEach(W=>{t.toLowerCase().includes(W.name.toLowerCase())&&(F+=` ${W.name} here, appearing as: ${W.description}.`,re.push(W.name))}),F+=" Focus on creating a faithful representation based on this description. Do not generate any text on the image.",console.log("Original Scene: ",F);let ae=F;try{const{response:W}=await $t({modelNames:[At,Pt],prompt:`Rewrite the following scene description into a safe and aestetic visual depiction suitable for highly censored image generation. Only include the elements that are definitely present in the scene and omit anything non-visual, that is mentioned only for unrelated context. Preserve all details of the landscape or environment. Mention time, weather, mood of the environment. Preserve small details. Avoid any depressing, explicit or unsafe elements. Absolutely avoid nudity or corpses.

Scene:
${F}`,systemInstruction:"Respond ONLY with the visual description of the scene.",temperature:1,label:"ImagePromptSanitizer"});ae=j+(((fe=W.text)==null?void 0:fe.trim())??F),console.log("Sanitized prompt: ",ae)}catch(W){console.warn("Prompt sanitization failed, using raw prompt.",W)}try{const W=await Ue.models.generateImages({model:"imagen-4.0-generate-001",prompt:ae,config:{aspectRatio:"4:3",imageSize:"1K",numberOfImages:1,outputMimeType:"image/jpeg"}});if(W.generatedImages&&W.generatedImages.length>0&&((me=W.generatedImages[0].image)!=null&&me.imageBytes)){const be=`data:image/jpeg;base64,${W.generatedImages[0].image.imageBytes}`;u(be),v(be,t)}else throw new Error("No image data received from API.")}catch(W){console.error("Error generating image:",W);const pe=W instanceof Error?W.message:"Unknown error during image generation.";if(Ea(W)===400)try{const x=await Ue.models.generateImages({model:"imagen-3.0-generate-002",prompt:ae,config:{numberOfImages:1,outputMimeType:"image/jpeg",aspectRatio:"4:3"}});if(x.generatedImages&&x.generatedImages.length>0&&((de=x.generatedImages[0].image)!=null&&de.imageBytes)){const ee=`data:image/jpeg;base64,${x.generatedImages[0].image.imageBytes}`;u(ee),v(ee,t)}else throw new Error("No image data received from API.")}catch(x){console.error("Fallback image generation failed:",x),h("Fallback image generation failed.")}pe.includes("quota")||pe.includes("billing")?h("Image generation quota exceeded or billing issue. Please check your Google Cloud project."):pe.includes("API key not valid")?h("Image generation failed: API key is not valid. Please check configuration."):h(`Failed to visualize scene: ${pe.substring(0,100)}`)}finally{i(!1),Se(null)}},[t,n,a,l,r,o,c,v]),H=s.useCallback(()=>{q()},[q]);return s.useEffect(()=>{p&&(g&&C===t?(u(g),i(!1),h(null)):q())},[p,g,C,t,q]),e.jsx("div",{"aria-labelledby":"visualizer-title","aria-modal":"true",className:`animated-frame ${p?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content visualizer-content-area",children:[e.jsx(k,{ariaLabel:"Close visualizer",icon:e.jsx(Y,{name:"x",size:20}),onClick:b,size:"sm",variant:"close"}),m?e.jsx("div",{className:"visualizer-spinner-container",children:e.jsx(xe,{})}):null,!m&&f?e.jsxs("div",{className:"visualizer-error-container",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-400 mb-2",id:"visualizer-title",children:"Vision Failed"}),e.jsx("p",{children:f}),e.jsx("button",{className:"mt-4 px-6 py-2 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-md shadow transition-colors",onClick:H,type:"button",children:"Retry Visualization"})]}):null,!m&&!f&&d?e.jsxs("div",{className:"visualizer-image-container",onMouseDown:U,onMouseLeave:E,onMouseMove:I,onMouseUp:E,onTouchEnd:A,onTouchMove:B,onTouchStart:S,onWheel:O,role:"presentation",children:[e.jsx("img",{alt:"Scene visualization",className:"visualizer-image",ref:J,src:d,style:{transform:`translate(${String($.x)}px, ${String($.y)}px) scale(${String(N)})`}}),e.jsx("h2",{className:"sr-only",id:"visualizer-title",children:"Scene Visualization"})]}):null,!m&&!f&&!d&&p?e.jsx("div",{className:"visualizer-spinner-container",children:e.jsx("p",{className:"mt-2 text-lg text-slate-300",id:"visualizer-title",children:"Preparing to visualize..."})}):null]})})}const St={},Al=(t,n)=>{var l;const a=(l=t.chapters)==null?void 0:l[n];if(a)return a;if(n===0){const r=t;return{heading:t.name,description:t.description,contentLength:r.contentLength??30,actualContent:r.actualContent,visibleContent:r.visibleContent}}return null},Pl=t=>t.startsWith("/9j")?"image/jpeg":(t.startsWith("iVBORw0"),"image/png"),Dl=async t=>new Promise((n,a)=>{const l=new Image;l.onload=()=>{const r=document.createElement("canvas");r.width=l.width,r.height=l.height;const o=r.getContext("2d");if(!o){a(new Error("No canvas context"));return}o.drawImage(l,0,0);const c=r.toDataURL("image/jpeg",.7).replace("data:image/jpeg;base64,","");n(c)},l.onerror=a,l.src=`data:${Pl(t)};base64,${t}`}),Na={dungeon:"a dark, gritty medieval fantasy style, dungeons and dragons concept art",cyberpunk:"a neon-drenched, futuristic cyberpunk cityscape style, Blade Runner aesthetic",eldritch:"a Lovecraftian horror style, cosmic dread, 1920s period","post-apocalyptic":"a desolate, rusty post-apocalyptic wasteland style, Mad Max aesthetic",steampunk:"a steampunk style with clockwork machines and airships, Victorian era","victorian mansion":"a haunted Victorian mansion style, gothic horror, moody and atmospheric","deep space":"a deep space sci-fi style, cosmic anomaly, advanced technology","lost world":"a prehistoric lost world style, lush jungles, dinosaurs, ancient ruins","greek hero":"a mythic Greek hero style, classical art, epic battles","wild west":"a Wild West outlaw style, dusty frontier, cinematic western"},Rl=t=>{if(!t)return"a general fantasy style";const n=t.name.toLowerCase();for(const a in Na)if(n.includes(a))return Na[a];return`a style fitting for ${t.name}`},zl=async(t,n,a)=>{var u;const l=`${t.id}-${String(a)}`,r=St[l];if(r)return r;if(!Pe()||!Ue)return console.error("generateChapterImage: API key not configured."),"";const o=Al(t,a);if(!o)return console.warn(`generateChapterImage: invalid chapter index ${String(a)}`),"";const c=`${o.description} ${o.actualContent??""}`.trim(),p=`${t.name}: ${t.description}. ${c}`.trim(),b=`A detailed, ${t.type} in ${Rl(n)} without ANY text on it.`,v=`${b} ${p}`;let g=v;try{const{response:m}=await $t({modelNames:[At,Pt],prompt:`Rewrite the following item depiction so it prioritizes the item's name and description while including any chapter details. Ensure the result is safe for a highly censored image generation system.

Description:
${v}`,systemInstruction:"Respond ONLY with the visual description.",temperature:1,label:"ImagePromptSanitizer"});g=`${b} ${((u=m.text)==null?void 0:u.trim())??p}`}catch(m){console.warn("Prompt sanitization failed, using raw prompt.",m)}const C=Ue,d=(async()=>{const i=await Ma(async f=>{var h,N,w,$,M,z;try{La(It.visualize.icon);const G=(w=(N=(h=(await C.models.generateImages({model:"imagen-4.0-generate-001",prompt:g,config:{aspectRatio:"4:3",imageSize:"1K",numberOfImages:1,outputMimeType:"image/jpeg"}})).generatedImages)==null?void 0:h[0])==null?void 0:N.image)==null?void 0:w.imageBytes;if(G)return{result:G}}catch(_){if(console.error(`generateChapterImage error (Attempt ${String(f+1)}):`,_),Ea(_)===400)try{const V=(z=(M=($=(await C.models.generateImages({model:"imagen-3.0-generate-002",prompt:g,config:{numberOfImages:1,outputMimeType:"image/jpeg",aspectRatio:"4:3"}})).generatedImages)==null?void 0:$[0])==null?void 0:M.image)==null?void 0:z.imageBytes;if(V)return{result:V}}catch(D){console.error("Fallback image generation failed:",D)}throw _}return{result:""}})??"";return i?Dl(i):""})();St[l]=d;try{return await d}finally{St[l]=void 0}},Et=(t,n)=>t.split(/(\*\*[^*]+\*\*|\*[^*]+\*)/g).map((l,r)=>{const o=`${n}-${String(r)}-${l}`;if(l.startsWith("**")&&l.endsWith("**")){const c=l.slice(2,-2);return e.jsx("strong",{children:c},`b-${o}`)}if(l.startsWith("*")&&l.endsWith("*")){const c=l.slice(1,-1);return e.jsx("em",{children:c},`i-${o}`)}return e.jsx(Tt.Fragment,{children:l},`t-${o}`)}),Gl=t=>{const n=t.replace(/\r\n/g,`
`).split(/\n/),a=[],l=[];let r=[];const o=/^(#+)\s+(.*)$/,c=()=>{if(r.length===0)return;const g=a.length,C=r.map((d,u)=>{const m=`p-${String(g)}-${String(u)}`,i=Et(d,m),f=u<r.length-1?e.jsx("br",{}):null;return e.jsxs(Tt.Fragment,{children:[i,f]},m)});a.push(e.jsx("p",{children:C},`p-${String(g)}`)),r=[]},p=()=>{const g=l.pop();if(!g)return;const{items:C,level:d}=g,u=`ul-${String(d)}-${String(a.length)}`,m=e.jsx("ul",{className:"list-disc list-inside ml-4 space-y-1",children:C},u);l.length===0?a.push(m):l[l.length-1].items.push(m)},b=g=>{for(;l.length>g+1;)p()},v=/^(\s*)\*\s+(.*)$/;return n.forEach(g=>{if(g.trim()==="--- torn ---"){c(),b(-1),a.push(e.jsx("hr",{"aria-hidden":"true",className:"torn-divider"},`torn-${String(a.length)}`));return}const C=o.exec(g);if(C){c(),b(-1);const u=C[2],m=`h-${String(a.length)}`,i=Et(u,m);a.push(e.jsx("p",{children:e.jsx("strong",{children:i})},m));return}const d=v.exec(g);if(d){c();const u=d[1].length,m=Math.floor(u/2);for(b(m);l.length<=m;)l.push({level:l.length,items:[]});const i=d[2],f=`li-${String(m)}-${String(l[m].items.length)}`,h=Et(i,f);l[m].items.push(e.jsx("li",{children:h},f))}else g.trim()===""?(c(),b(-1)):r.push(g)}),c(),b(-1),a};function Qa({item:t,currentTheme:n,currentScene:a,storytellerThoughts:l,mapData:r,allNPCs:o,currentQuest:c,isVisible:p,startIndex:b=0,onClose:v,updateItemContent:g,onInspect:C,onWriteJournal:d,canWriteJournal:u=!0,canInspectJournal:m=!0,isWritingJournal:i=!1}){var ke;const[f,h]=s.useState(null),[N,w]=s.useState(!1),[$,M]=s.useState(!1),z=N||$,[_,G]=s.useState(!1),[D,V]=s.useState(null),[P,J]=s.useState(b),X=s.useRef(!1),O=(t==null?void 0:t.type)==="book",U=(t==null?void 0:t.type)==="page",I=(t==null?void 0:t.id)===ce,E=s.useMemo(()=>{if(!t)return[];if(t.id===ce)return t.chapters??[];if(t.chapters&&t.chapters.length>0)return t.chapters;const x=t;return[{heading:t.name,description:t.description,contentLength:x.contentLength??30,actualContent:x.actualContent,visibleContent:x.visibleContent}]},[t]),y=s.useMemo(()=>{if(!t||t.type!=="book")return E.length;let x=0;for(;x<E.length&&E[x].actualContent;x+=1);return Math.min(E.length,x+1)},[E,t]),S=s.useMemo(()=>E.every(x=>!!x.actualContent),[E]),B=s.useCallback(()=>{J(x=>Math.max(0,x-1))},[]),A=s.useCallback(()=>{J(x=>Math.min(I?E.length-1:y,x+1))},[I,E.length,y]),R=s.useCallback(()=>{C==null||C()},[C]),q=s.useCallback(()=>{d==null||d()},[d]),H=s.useCallback(x=>{const L=Number(x.target.value);O&&!I?L<=y&&J(L):L<y&&J(L)},[y,O,I]),{name:j,storyGuidance:F}=n,Z=s.useCallback(()=>{G(x=>!x)},[]);s.useEffect(()=>{G(!1),J(b)},[t==null?void 0:t.id,p,b]);const re=s.useCallback(x=>{x.target===x.currentTarget&&v()},[v]),ae=s.useMemo(()=>{const x=(t==null?void 0:t.tags)??[],L=[],ee=(t==null?void 0:t.type)==="book"&&!I?P-1:P,ye=ee>=0&&ee<E.length?E[ee]:void 0,he=_&&!!(ye!=null&&ye.actualContent),Ee=!he&&x.includes("foreign");return x.includes("handwritten")?L.push(Ee?"tag-handwritten-foreign":"tag-handwritten"):x.includes("printed")?L.push(Ee?"tag-printed-foreign":"tag-printed"):x.includes("typed")?L.push(Ee?"tag-typed-foreign":"tag-typed"):x.includes("digital")&&L.push(Ee?"tag-digital-foreign":"tag-digital"),x.includes("faded")&&L.push("tag-faded"),x.includes("smudged")&&L.push("tag-smudged"),x.includes("torn")&&L.push("tag-torn"),he||(x.includes("glitching")&&L.push("tag-glitching"),x.includes("encrypted")&&L.push("tag-encrypted"),x.includes("foreign")&&L.push("tag-foreign")),x.includes("gothic")&&L.push("tag-gothic"),x.includes("runic")&&L.push("tag-runic"),x.includes("recovered")&&_&&L.push("tag-recovered"),L.join(" ")},[t,_,P,E,I]),fe=s.useMemo(()=>{const x=r.nodes.filter(L=>L.data.nodeType!=="feature"&&L.data.nodeType!=="room");return Ta(x,!0)},[r]),me=s.useMemo(()=>o.length>0?$a(o," - ",!1,!1,!1,!0):"None specifically known in this theme yet.",[o]);s.useEffect(()=>{if(!p||!t){h(null),V(null),w(!1);return}if(t.type==="book"&&!I&&P===0){h(null),w(!1);return}const x=t.type==="book"&&!I?P-1:P;if(x<0||x>=E.length){h(null),w(!1);return}const L=E[x];if(L.visibleContent){h(L.visibleContent),w(!1);return}if(t.id===ce&&L.actualContent){h(L.actualContent),w(!1);return}w(!0),Se(t.type==="book"?"book":"page"),(async()=>{const ee=L.contentLength,le=await ga(L.heading,L.description,ee,j,F,a,l,fe,me,c,"Write it exclusively in English without any foreign, encrypted, or gibberish text.",t.type==="book"&&!I&&x>0?E[x-1].actualContent??"":void 0);if(le){const ye=t.tags??[];let he=le;ye.includes("foreign")?he=await ga(L.heading,L.description,ee,j,F,a,l,fe,me,c,`Translate the following text into an artificial nonexistent language that fits the theme and context:
"""${le}"""`)??le:ye.includes("encrypted")?he=Tn(le):ye.includes("runic")&&(he=$n(le)),ye.includes("torn")&&!ye.includes("recovered")&&(he=In(he)),g(t.id,le,he,x),h(he)}w(!1),Se(null)})()},[p,t,P,E,j,F,a,l,fe,me,c,g,I]),s.useEffect(()=>{if(M(!1),!p||!t||t.type!=="picture"&&t.type!=="map"){V(null),M(!1);return}const x=P;if(x<0||x>=E.length){V(null),M(!1);return}const L=E[x];(async()=>{if(An(L.imageData)){const le=await xa(t.id,x);if(le){V(`data:image/jpeg;base64,${le}`),M(!1);return}}else if(L.imageData){await fa(t.id,x,L.imageData),g(t.id,void 0,void 0,x,wt(t.id,x)),V(`data:image/jpeg;base64,${L.imageData}`),M(!1);return}else{const le=await xa(t.id,x);if(le){g(t.id,void 0,void 0,x,wt(t.id,x)),V(`data:image/jpeg;base64,${le}`),M(!1);return}}if(X.current)return;X.current=!0,M(!0),Se(t.type==="book"?"book":"page");const ee=await zl(t,n,x);ee&&(await fa(t.id,x,ee),g(t.id,void 0,void 0,x,wt(t.id,x)),V(`data:image/jpeg;base64,${ee}`)),M(!1),Se(null),X.current=!1})()},[p,t,P,E,n,g]);const de=s.useMemo(()=>{if(!t)return f;const x=t.type==="book"&&!I?P-1:P;if(!(x>=0&&x<E.length))return f;const ee=E[x];return _&&ee.actualContent?ee.actualContent:f},[_,t,f,P,E,I]),W=s.useMemo(()=>I&&i,[I,i]);s.useEffect(()=>{if(W)return Se("journal"),()=>{Se(null)}},[W]);const pe=s.useMemo(()=>{var L;if(!t||!((L=t.tags)!=null&&L.includes("torn"))||t.tags.includes("recovered")||!de)return null;const x=de.trim();return x.startsWith("--- torn ---")?"top":x.endsWith("--- torn ---")?"bottom":null},[de,t]),be=s.useMemo(()=>t?I?m:O||U?S:!0:!1,[t,I,O,U,m,S]);return e.jsx("div",{"aria-labelledby":"page-view-title","aria-modal":"true",className:`animated-frame ${p?"open":""}`,onClick:re,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content page-view-content-area",children:[e.jsx(k,{ariaLabel:"Close page",icon:e.jsx(Y,{name:"x",size:20}),onClick:v,size:"sm",variant:"close"}),t!=null&&t.name?e.jsx("h2",{className:"text-2xl font-bold text-amber-400 mb-4 text-center",id:"page-view-title",children:t.name}):null,O||I?e.jsxs("div",{className:"flex justify-center items-center gap-2 mb-2",children:[I&&C?e.jsx(k,{ariaLabel:"Inspect",disabled:!be,label:"Inspect",onClick:R,preset:"indigo",size:"sm",variant:"compact"}):null,e.jsx(k,{ariaLabel:"Previous chapter",disabled:P===0,label:"â",onClick:B,preset:"slate",size:"lg",variant:"toolbar"}),e.jsx("select",{"aria-label":"Select chapter",className:"bg-slate-800 text-white text-md h-9 p-2",onChange:H,value:P,children:O&&!I?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:0,children:"ToC"}),E.slice(0,y).map((x,L)=>e.jsx("option",{value:L+1,children:x.heading},x.heading))]}):E.map((x,L)=>e.jsx("option",{value:L,children:x.heading},x.heading))}),e.jsx(k,{ariaLabel:"Next chapter",disabled:z||(O&&!I?P>=y||P===E.length:P>=E.length-1),label:"âº",onClick:A,preset:"slate",size:"lg",variant:"toolbar"}),I&&d?e.jsx(k,{ariaLabel:"Write entry",disabled:!u||i,label:"Write",onClick:q,preset:"blue",size:"sm",title:"Write a new journal entry",variant:"compact"}):null]}):null,(ke=t==null?void 0:t.tags)!=null&&ke.includes("recovered")?e.jsx("div",{className:"flex justify-center",children:e.jsx(k,{ariaLabel:_?"Show encoded text":"Show decoded text",label:_?"Hide":"Reveal",onClick:Z,preset:_?"sky":"slate",pressed:_,size:"sm",variant:"toggle"})}):null,W?e.jsx(xe,{}):z?e.jsx(xe,{}):(t==null?void 0:t.type)==="book"&&!I&&P===0?e.jsx("ul",{className:`p-5 mt-4 list-disc list-inside overflow-y-auto text-left ${ae}`,children:E.map((x,L)=>e.jsx("p",{children:`${String(L+1)}. ${x.heading}`},x.heading))}):de||((t==null?void 0:t.type)==="picture"||(t==null?void 0:t.type)==="map")&&D?e.jsxs("div",{className:`whitespace-pre-wrap text-lg overflow-y-auto p-5 mt-4 ${ae} ${pe?`torn-${pe}`:""}`,children:[((t==null?void 0:t.type)==="picture"||(t==null?void 0:t.type)==="map")&&D?e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx("img",{alt:t.name,className:"max-h-[24rem] object-contain mask-gradient-edges",src:D})}):null,de?Gl(de):null]}):I&&E.length===0?e.jsx("div",{className:`whitespace-pre-wrap text-lg overflow-y-auto p-5 mt-4 min-h-[20rem] tag-${n.playerJournalStyle}`}):null]})})}Qa.defaultProps={canInspectJournal:!0,canWriteJournal:!0,isWritingJournal:!1,onInspect:void 0,onWriteJournal:void 0,startIndex:0};function Fl({isVisualizerVisible:t,onCloseVisualizer:n,visualizerImageUrl:a,visualizerImageScene:l,setGeneratedImage:r,currentScene:o,currentTheme:c,mapData:p,allNPCs:b,localTime:v,localEnvironment:g,localPlace:C,isKnowledgeBaseVisible:d,onCloseKnowledgeBase:u,isMapVisible:m,onCloseMap:i,currentThemeName:f,currentMapNodeId:h,destinationNodeId:N,itemPresenceByNode:w,onSelectDestination:$,initialLayoutConfig:M,initialViewBox:z,onViewBoxChange:_,onNodesPositioned:G,onLayoutConfigChange:D,newGameFromMenuConfirmOpen:V,handleConfirmNewGameFromMenu:P,handleCancelNewGameFromMenu:J,loadGameFromMenuConfirmOpen:X,handleConfirmLoadGameFromMenu:O,handleCancelLoadGameFromMenu:U,inventory:I,playerJournal:E,lastJournalWriteTurn:y,pageItemId:S,pageStartChapterIndex:B,isPageVisible:A,onClosePage:R,storytellerThoughts:q,currentQuest:H,updateItemContent:j,updatePlayerJournalContent:F,onItemInspect:Z,canInspectJournal:re,onWriteJournal:ae,canWriteJournal:fe,isWritingJournal:me}){const de=s.useCallback((be,ke,x,L,ee)=>{S===ce?F(ke??"",L):j(be,ke,x,L,ee)},[S,j,F]),W=s.useCallback(()=>{S&&(Z(S),R())},[S,Z,R]),pe=s.useCallback(()=>{S===ce&&ae()},[S,ae]);return e.jsxs(e.Fragment,{children:[e.jsx(Il,{allNPCs:b,cachedImageScene:l,cachedImageUrl:a,currentSceneDescription:o,currentTheme:c,isVisible:t,localEnvironment:g,localPlace:C,localTime:v,mapData:p.nodes,onClose:n,setGeneratedImage:r}),e.jsx(Sl,{allNPCs:b,currentTheme:c,isVisible:d,onClose:u}),e.jsx(Qa,{allNPCs:b,canInspectJournal:re,canWriteJournal:fe,currentQuest:H,currentScene:o,currentTheme:c,isVisible:A,isWritingJournal:me,item:S===ce?{id:ce,name:"Personal Journal",type:"book",description:"Your own journal",holderId:Da,chapters:E,lastWriteTurn:y,tags:[c.playerJournalStyle]}:I.find(be=>be.id===S)??null,mapData:p,onClose:R,onInspect:S?W:void 0,onWriteJournal:S?pe:void 0,startIndex:B,storytellerThoughts:q,updateItemContent:de}),e.jsx($l,{currentMapNodeId:h,currentThemeName:f,destinationNodeId:N,initialLayoutConfig:M,initialViewBox:z,isVisible:m,itemPresenceByNode:w,mapData:p,onClose:i,onLayoutConfigChange:D,onNodesPositioned:G,onSelectDestination:$,onViewBoxChange:_}),e.jsx(Lt,{confirmPreset:"red",confirmText:"Start New Game",isOpen:V,message:"Are you sure you want to start a new game? Your current progress will be lost.",onCancel:J,onConfirm:P,title:"Confirm New Game"}),e.jsx(Lt,{confirmPreset:"blue",confirmText:"Load Game",isOpen:X,message:"Are you sure you want to load a game? Your current progress will be overwritten if you load a new game.",onCancel:U,onConfirm:O,title:"Confirm Load Game"})]})}function Ol({freeFormActionText:t,canPerformFreeAction:n,onChange:a,onSubmit:l}){const r=s.useCallback(()=>{l()},[l]);return e.jsxs("div",{className:"mt-4 p-4 bg-slate-800 border border-slate-700 rounded-lg shadow",children:[e.jsxs("label",{className:"block text-sm font-medium text-amber-300 mb-1",htmlFor:"freeFormAction",children:["Perform Custom Action (Cost:"," ",Ra," ","Score Points)"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{"aria-label":"Custom action input",className:"flex-grow p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 disabled:bg-slate-600 disabled:text-slate-300",disabled:!n,id:"freeFormAction",maxLength:ya,onChange:a,placeholder:"Type your custom action here...",type:"text",value:t}),e.jsx(k,{ariaLabel:"Submit custom action",disabled:!n||t.trim()==="",label:"Submit",onClick:r,preset:"green",type:"button",variant:"compact"})]}),!n&&e.jsx("p",{className:"text-xs text-red-400 mt-1",children:"Not enough score points."}),n?e.jsxs("p",{className:"text-xs text-slate-300 mt-1",children:["Max"," ",ya," ","characters."]}):null]})}const _l=t=>({type:"object",properties:{heading:{type:"string",description:"Short plain text heading for the journal entry."},text:{type:"string",minLength:100,description:`Approximately ${String(t)} words of the journal entry, starting with a Markup-formatted heading. Basic Markup syntax is allowed, such as **bold** and *italic*.`}},required:["heading","text"],additionalProperties:!1}),Bl=t=>{const n=Xn(t);return Qn(n,a=>!!a&&typeof a=="object"&&typeof a.heading=="string"&&typeof a.text=="string")},Vl=async(t,n,a,l,r,o,c,p,b,v,g,C)=>{if(!Pe())return console.error("generateJournalEntry: API key not configured."),null;const d=C?`Current Quest: "${C}"`:"Current Quest: Not set",u=Pn(g),m=`**Context:**
Theme Name: "${r}";
Theme Description: "${o}";
${d};

## Known Locations:
${b}
## Known NPCs:
${v}
## Previous Journal Entry:
${l}

## Last events:
${u}

## Scene Description:
${c};

------
`,i="You are the main protagonist writing a new entry in your personal journal, focusing primarily on Last events and Scene description, logically continuing from the Previous Journal Entry. Always write in-character. NEVER include any ID strings. Provide only the JSON for the new journal entry.",f=_l(t);return Ma(async h=>{var N,w,$,M;try{La(It.journal.icon);const z=Dn(1024),{response:_,systemInstructionUsed:G,jsonSchemaUsed:D,promptUsed:V}=await $t({modelNames:[Pt,At,Aa],prompt:m,systemInstruction:i,temperature:1,thinkingBudget:z,includeThoughts:!0,responseMimeType:"application/json",jsonSchema:f,label:"Journal"}),J=((($=(w=(N=_.candidates)==null?void 0:N[0])==null?void 0:w.content)==null?void 0:$.parts)??[]).filter(U=>U.thought===!0&&typeof U.text=="string").map(U=>U.text),X=((M=_.text)==null?void 0:M.trim())??"",O=X?Bl(X):null;return{result:{entry:O,debugInfo:{prompt:V,systemInstruction:G,jsonSchema:D??f,rawResponse:X,parsedPayload:O??void 0,thoughts:J}}}}catch(z){throw console.error(`generateJournalEntry error (Attempt ${String(h+1)}):`,z),z}return{result:{entry:null,debugInfo:null}}})};function Wl(){var ia,oa,ca,da;const{clearProgress:t}=ka(),n=s.useRef(null),a=()=>{if(!n.current)throw new Error("Game logic is not initialized");return n.current},{enabledThemePacks:l,setEnabledThemePacks:r,thinkingEffort:o,setThinkingEffort:c,initialSavedState:p,initialDebugStack:b,appReady:v,fileInputRef:g,handleSaveToFile:C,handleLoadFromFileClick:d,handleFileInputChange:u}=Rn({gatherGameStateStack:()=>a().gatherCurrentGameState(),gatherDebugPacketStack:()=>a().gatherDebugPacketStack(),applyLoadedGameState:T=>a().applyLoadedGameState(T),setError:T=>{a().setError(T)},setIsLoading:T=>{a().setIsLoading(T)},isLoading:(ia=n.current)==null?void 0:ia.isLoading,dialogueState:(oa=n.current)==null?void 0:oa.dialogueState,hasGameBeenInitialized:(ca=n.current)==null?void 0:ca.hasGameBeenInitialized}),{isVisualizerVisible:m,visualizerImageUrl:i,setVisualizerImageUrl:f,visualizerImageScene:h,setVisualizerImageScene:N,isKnowledgeBaseVisible:w,isSettingsVisible:$,isInfoVisible:M,isMapVisible:z,userRequestedTitleMenuOpen:_,setShouldReturnToTitleMenu:G,shouldReturnToTitleMenu:D,isDebugViewVisible:V,isCustomGameSetupVisible:P,newGameFromMenuConfirmOpen:J,loadGameFromMenuConfirmOpen:X,openVisualizer:O,closeVisualizer:U,openKnowledgeBase:I,closeKnowledgeBase:E,openMap:y,closeMap:S,openSettings:B,closeSettings:A,openInfo:R,closeInfo:q,openTitleMenu:H,closeTitleMenu:j,closeDebugView:F,setIsDebugViewVisible:Z,openCustomGameSetup:re,closeCustomGameSetup:ae,openNewGameFromMenuConfirm:fe,closeNewGameFromMenuConfirm:me,openLoadGameFromMenuConfirm:de,closeLoadGameFromMenuConfirm:W,pageItemId:pe,pageStartChapterIndex:be,isPageVisible:ke,openPageView:x,closePageView:L,isDebugLoreVisible:ee,debugLoreFacts:le,openDebugLoreModal:ye,isGenderSelectVisible:he,openGenderSelectModal:Ee,submitGenderSelectModal:Za,openCharacterSelectModal:zt,isCharacterSelectVisible:es,characterSelectData:Oe,submitCharacterSelectModal:ts,submitCharacterSelectHeroData:as,genderSelectDefault:ss,submitDebugLoreModal:ns,closeDebugLoreModal:ls}=zn(),[rs,dt]=s.useState(!1),[Ke,ut]=s.useState(null);s.useEffect(()=>{Pe()||dt(!0)},[]);const is=s.useCallback(()=>{dt(!0)},[]),os=s.useCallback(()=>{dt(!1)},[]),cs=s.useCallback((T,K)=>new Promise(Q=>{zt(T,K,Q)}),[zt]),ds=s.useCallback(T=>new Promise(K=>{Ee(T,K)}),[Ee]),De=Gn({enabledThemePacksProp:l,thinkingEffortProp:o,initialSavedStateFromApp:p,initialDebugStackFromApp:b,isAppReady:v,openDebugLoreModal:ye,openCharacterSelectModal:cs,openGenderSelectModal:ds,onActIntro:ut});n.current=De;const us=s.useCallback(T=>{c(T);const K=a().gatherCurrentGameState()[0];a().commitGameState({...K,thinkingEffort:T})},[c]),{currentTheme:se,currentScene:je,mainQuest:Ye,currentObjective:Gt,actionOptions:Ft,storyArc:mt,heroSheet:Ot,inventory:Me,itemsHere:ms,itemPresenceByNode:ps,gameLog:$e,isLoading:ue,isTurnProcessing:Le,error:_e,lastActionLog:_t,mapData:ie,currentMapNodeId:ve,mapLayoutConfig:Be,allNPCs:we,score:pt,freeFormActionText:hs,setFreeFormActionText:Bt,handleFreeFormActionSubmit:gs,objectiveAnimationType:xs,handleActionSelect:fs,executeItemInteraction:ht,handleRetry:Vt,startCustomGame:Wt,gatherCurrentGameState:bs,gatherDebugPacketStack:ys,hasGameBeenInitialized:te,localTime:gt,localEnvironment:xt,localPlace:ft,dialogueState:ne,handleDialogueOptionSelect:Ut,handleForceExitDialogue:js,isDialogueExiting:Ht,lastDebugPacket:Ie,lastTurnChanges:Ae,globalTurnNumber:Re,gameStateStack:bt,debugPacketStack:vs,handleMapLayoutConfigChange:Cs,handleUndoTurn:Ns,triggerMainQuestAchieved:Je,destinationNodeId:ze,handleSelectDestinationNode:ks,mapViewBox:Ve,handleMapViewBoxChange:ws,handleMapNodesPositionChange:yt,commitGameState:Xe,updateItemContent:Ss,addPlayerJournalEntry:Kt,updatePlayerJournalContent:Es,recordPlayerJournalInspect:Yt,playerJournal:ge,lastJournalWriteTurn:Te,lastJournalInspectTurn:Jt,handleDistillFacts:Xt,toggleDebugLore:Ms,debugLore:Qt,debugGoodFacts:qt,debugBadFacts:Zt,isVictory:jt,simulateVictory:ea,queueItemAction:Ls,queuedItemActions:ta,clearQueuedItemActions:Ts,remainingActionPoints:$s}=De,Is=Ke!==null&&(ue||Le);s.useEffect(()=>{jt&&ut(null)},[jt]),s.useEffect(()=>{Ae!=null&&Ae.mainQuestAchieved&&Je()},[Ae==null?void 0:Ae.mainQuestAchieved,Je]);const As=s.useCallback(()=>{ut(null)},[]),Ps=s.useCallback(T=>{Xe(T)},[Xe]),Ds=s.useCallback(()=>{Je()},[Je]),Rs=s.useCallback(()=>{ea()},[ea]),zs=s.useCallback(()=>{Xe({...bt[0],isVictory:!1}),H()},[Xe,bt,H]),Gs=s.useCallback(T=>{const K=new Blob([T],{type:"application/json"}),Q=URL.createObjectURL(K),oe=document.createElement("a");oe.href=Q,oe.download="DebugLoreFacts.json",document.body.appendChild(oe),oe.click(),document.body.removeChild(oe),URL.revokeObjectURL(Q)},[]),Fs=s.useCallback(()=>{De.clearDebugFacts(),Fn({debugLore:De.debugLore,debugGoodFacts:[],debugBadFacts:[]})},[De]);s.useEffect(()=>{ue||t()},[ue,t]);const aa=s.useRef($e.length),sa=s.useRef(je),na=_||v&&!te&&!ue&&!P,Ge=m||w||$||M||z||V||ke||ee||!!ne||na||J||X||P||Ke!==null;s.useEffect(()=>{const T=document.body;if(Ge){const K=window.innerWidth-document.documentElement.clientWidth;T.style.overflow="hidden",K>0&&(T.style.paddingRight=`${String(K)}px`)}else T.style.overflow="",T.style.paddingRight="";return()=>{T.style.overflow="",T.style.paddingRight=""}},[Ge]),s.useEffect(()=>{(je!==sa.current||$e.length>aa.current)&&window.scrollTo({top:0,behavior:"smooth"}),sa.current=je,aa.current=$e.length},[je,$e.length]),s.useEffect(()=>{f(null),N(null)},[je,f,N]),On({appReady:v,dependencies:[se,je,Ft,Ye,Gt,Me,$e,_t,ie,ve,Be,we,pt,gt,xt,ft,l,Qt,qt,Zt],dialogueState:ne,gatherDebugPacketStack:ys,gatherGameStateStack:bs,hasGameBeenInitialized:te,isLoading:ue,isTurnProcessing:Le,setError:T=>{a().setError(T)}});const Os=pt>=Ra&&!ue&&!Le&&te&&!ne,_s=typeof window<"u"&&window.matchMedia("(hover: none)").matches,Bs=s.useCallback((T,K)=>{f(T),N(K)},[f,N]),la=s.useCallback(()=>{Vt()},[Vt]),Vs=s.useCallback(()=>{Xt()},[Xt]),Ws=s.useCallback(T=>{var Q;const K=T.id===ce?Math.max(0,(((Q=T.chapters)==null?void 0:Q.length)??0)-1):0;x(T.id,K)},[x]),[Qe,vt]=s.useState(!1),Us=(Te===0||Re-Te>=ja)&&!Qe,Hs=ge.length>0&&(Jt===0||Re-Jt>=Ia),Ks=s.useCallback(()=>{const T=ge.length>0?ge.length-1:0;x(ce,T)},[x,ge.length]),Ys=s.useCallback(()=>{!(Te===0||Re-Te>=ja)||Qe||(vt(!0),x(ce,ge.length),(async()=>{var ma,pa;if(!se){vt(!1);return}const{name:K,storyGuidance:Q}=se,oe=ie.nodes.filter(qe=>qe.data.nodeType!=="feature"&&qe.data.nodeType!=="room"),We=Ta(oe,!0),kt=we.length>0?$a(we," - ",!1,!1,!1,!0):"None specifically known in this theme yet.",gn=((ma=ge[ge.length-1])==null?void 0:ma.actualContent)??"",ua=Math.floor(Math.random()*50)+100,Fe=await Vl(ua,"Personal Journal","Your own journal",gn,K,Q,je,((pa=Ie==null?void 0:Ie.storytellerThoughts)==null?void 0:pa.slice(-1)[0])??"",We,kt,$e.slice(-Zn),Ye);if(Fe!=null&&Fe.entry){const qe={heading:Fe.entry.heading,description:"",contentLength:ua,actualContent:Fe.entry.text};Kt(qe,Fe.debugInfo??void 0),x(ce,ge.length)}vt(!1)})())},[we,se,je,Kt,ie.nodes,Ye,x,ge,Ie,$e,Re,Te,Qe]),Js=s.useCallback(T=>{if(T===ce){const Q={id:ce,name:"Personal Journal",type:"book",description:"Your own journal",holderId:Da,chapters:ge,lastWriteTurn:Te,tags:[(se==null?void 0:se.playerJournalStyle)??"handwritten"]},oe=Yt();ht(Q,"inspect",void 0,oe);return}const K=Me.find(Q=>Q.id===T);K&&ht(K,"inspect")},[Me,ht,ge,Te,Yt,se]),Xs=s.useCallback(T=>{Bt(T.target.value)},[Bt]),Qs=s.useCallback(()=>{W(),H()},[W,H]),qs=s.useCallback(()=>{me(),H()},[me,H]),Zs=s.useCallback(T=>{r(K=>{const Q=K.includes(T)?K.filter(oe=>oe!==T):[...K,T];return Q.length===0?(a().setError("At least one theme pack must be enabled."),K):Q})},[r]),en=s.useCallback(T=>{Ut(T)},[Ut]),tn=s.useCallback(()=>{j(),te?fe():re()},[j,te,re,fe]),an=s.useCallback(()=>{me(),re()},[me,re]),sn=s.useCallback(()=>{j(),te?de():d()},[j,te,d,de]),nn=s.useCallback(()=>{W(),d()},[W,d]),ln=s.useCallback(async()=>{j(),await C()},[j,C]),rn=s.useCallback(()=>{j(),G(!0),B()},[j,G,B]),on=s.useCallback(()=>{A(),(D||!te)&&H(),G(!1)},[A,D,te,H,G]),cn=s.useCallback(()=>{j(),G(!0),R()},[j,G,R]),dn=s.useCallback(()=>{q(),(D||!te)&&H(),G(!1)},[q,D,te,H,G]),un=s.useCallback(()=>{ae(),H()},[ae,H]),mn=s.useCallback(T=>{ae(),Wt(T)},[ae,Wt]),[pn,Ct]=s.useState(Ve),ra=s.useMemo(()=>_n(ie),[ie]),hn=s.useMemo(()=>!ze||!ve||ve===ze||Bn(ie,ve,ze)?null:Vn(ie,ve,ze,ra),[ze,ve,ie,ra,Re]),Nt=s.useRef(!1);return s.useEffect(()=>{if(z&&!Nt.current){const T=Sa(ie.nodes.map(Q=>({...Q})),{padding:Be.NESTED_PADDING,anglePadding:Be.NESTED_ANGLE_PADDING});yt(T);const K=Ve.split(" ").map(parseFloat);if(K.length===4){const[,,Q,oe]=K,We=T.find(kt=>kt.id===ve);We&&!isNaN(Q)&&!isNaN(oe)?Ct(`${String(We.position.x-Q/2)} ${String(We.position.y-oe/2)} ${String(Q)} ${String(oe)}`):Ct(Ve)}else Ct(Ve)}z?Nt.current=!0:Nt.current=!1},[z,Ve,ve,ie.nodes,se==null?void 0:se.name,Be,yt]),v?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 p-4 md:p-8 flex flex-col items-center",children:[e.jsx(_a,{currentTheme:se,hasGameBeenInitialized:te}),_e&&!ue&&!ne&&te?e.jsx("div",{className:"w-full max-w-3xl my-4",children:e.jsx(Mt,{message:_e,onRetry:la})}):null,_e&&!te?e.jsx("div",{className:"w-full max-w-3xl my-4",children:e.jsx(Mt,{message:_e,onRetry:la})}):null,e.jsxs("main",{className:`w-full max-w-screen-xl grid grid-cols-1 lg:grid-cols-4 gap-3 flex-grow ${Ge?"filter blur-sm pointer-events-none":""}`,children:[e.jsxs("div",{className:"lg:col-span-2 space-y-3 flex flex-col",children:[e.jsx(il,{currentSceneExists:!!je,currentThemeName:se?se.name:null,isLoading:ue||!!ne||Le,isTurnProcessing:Le,onOpenKnowledgeBase:I,onOpenMap:y,onOpenTitleMenu:H,onOpenVisualizer:O,score:pt}),e.jsx(Oa,{}),ue&&!te?!_e&&e.jsx(xe,{}):null,te?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ga,{allNPCs:we,description:je,inventory:Me,lastActionLog:_t,localEnvironment:xt,localPlace:ft,localTime:gt,mapData:ie.nodes}),ue&&!ne&&!Ht?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-900/75 rounded-lg",children:e.jsx(xe,{})}):null]}),e.jsx(tl,{allNPCs:we,disabled:ue||Le||!!ne,inventory:Me,mapData:ie.nodes,onActionSelect:fs,onClearQueuedActions:Ts,options:Ft,queuedActions:ta}),e.jsx(Ol,{canPerformFreeAction:Os,freeFormActionText:hs,onChange:Xs,onSubmit:gs})]}):e.jsx("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg flex-grow min-h-48"})]}),e.jsx("div",{className:"lg:col-span-2 space-y-2 flex flex-col",children:te?e.jsx(rl,{allNPCs:we,currentMapNodeId:ve,currentObjective:Gt,disabled:ue||Le||Ge,enableMobileTap:_s,globalTurnNumber:Re,inventory:Me,itemsHere:ms,mapNodes:ie.nodes,objectiveAnimationType:xs,onItemInteract:Ls,onReadPage:Ws,onReadPlayerJournal:Ks,onStashToggle:De.handleStashToggle,queuedActionIds:new Set(ta.map(T=>T.id)),remainingActionPoints:$s,storyArc:mt}):e.jsx("div",{className:"hidden lg:block bg-slate-800/50 border border-slate-700 rounded-lg flex-grow min-h-48"})})]}),e.jsx(dl,{isGameBusy:Ge||ue||Le,lastTurnChanges:Ae}),e.jsx(wl,{isBlurred:Ge,isDebugViewVisible:V,setIsDebugViewVisible:Z})]}),e.jsx("input",{accept:".json,application/json","aria-hidden":"true",className:"hidden",onChange:u,ref:g,type:"file"}),e.jsx(Wa,{allNPCs:we,history:(ne==null?void 0:ne.history)??[],inventory:Me,isDialogueExiting:Ht,isLoading:ue,isVisible:!!ne,mapData:ie.nodes,onClose:js,onOptionSelect:en,options:(ne==null?void 0:ne.options)??[],participants:(ne==null?void 0:ne.participants)??[]}),e.jsx(qn,{badFacts:Zt,debugLore:Qt,debugPacket:vs[0],gameStateStack:bt,goodFacts:qt,isVisible:V,onApplyGameState:Ps,onClearFacts:Fs,onClose:F,onDistillFacts:Vs,onSaveFacts:Gs,onSimulateVictory:Rs,onToggleDebugLore:Ms,onTriggerMainQuestAchieved:Ds,onUndoTurn:Ns,travelPath:hn}),e.jsx(Va,{isGameActive:te,isVisible:na,onClose:j,onLoadGame:sn,onNewGame:tn,onOpenGeminiKeyModal:is,onOpenInfo:cn,onOpenSettings:rn,onSaveGame:te?ln:void 0}),e.jsx(Ha,{isVisible:P,onClose:un,onThemeSelected:mn}),e.jsx(ul,{enabledThemePacks:l,isVisible:$,onChangeThinkingEffort:us,onClose:on,onToggleThemePack:Zs,thinkingEffort:o}),e.jsx(fl,{isVisible:M,onClose:dn}),e.jsx(bl,{facts:le,isVisible:ee,onClose:ls,onSubmit:ns}),e.jsx(yl,{isVisible:rs,onClose:os}),e.jsx(Cl,{defaultGender:ss,isVisible:he,onSubmit:Za}),Ke?e.jsx(Nl,{act:Ke,isTurnGenerating:Is,onContinue:As}):null,jt&&Ot&&mt?e.jsx(kl,{heroSheet:Ot,onClose:zs,storyArc:mt}):null,Oe?e.jsx(vl,{heroGender:Oe.heroGender,isVisible:es,onComplete:ts,onHeroData:as,options:Oe.options,theme:Oe.theme,worldFacts:Oe.worldFacts}):null,te&&se?e.jsx(Fl,{allNPCs:we,canInspectJournal:Hs,canWriteJournal:Us,currentMapNodeId:ve,currentQuest:Ye,currentScene:je,currentTheme:se,currentThemeName:se.name,destinationNodeId:ze,handleCancelLoadGameFromMenu:Qs,handleCancelNewGameFromMenu:qs,handleConfirmLoadGameFromMenu:nn,handleConfirmNewGameFromMenu:an,initialLayoutConfig:Be,initialViewBox:pn,inventory:Me,isKnowledgeBaseVisible:w,isMapVisible:z,isPageVisible:ke,isVisualizerVisible:m,isWritingJournal:Qe,itemPresenceByNode:ps,lastJournalWriteTurn:Te,loadGameFromMenuConfirmOpen:X,localEnvironment:xt,localPlace:ft,localTime:gt,mapData:ie,newGameFromMenuConfirmOpen:J,onCloseKnowledgeBase:E,onCloseMap:S,onClosePage:L,onCloseVisualizer:U,onItemInspect:Js,onLayoutConfigChange:Cs,onNodesPositioned:yt,onSelectDestination:ks,onViewBoxChange:ws,onWriteJournal:Ys,pageItemId:pe,pageStartChapterIndex:be,playerJournal:ge,setGeneratedImage:Bs,storytellerThoughts:((da=Ie==null?void 0:Ie.storytellerThoughts)==null?void 0:da.slice(-1)[0])??"",updateItemContent:Ss,updatePlayerJournalContent:Es,visualizerImageScene:h,visualizerImageUrl:i}):null]}):e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 flex flex-col items-center justify-center p-4",children:[e.jsx(xe,{}),e.jsx("p",{className:"mt-4 text-xl text-sky-400",children:"Initializing application..."})]})}const qa=document.getElementById("root");if(!qa)throw new Error("Could not find root element to mount to");const Ul=xn.createRoot(qa);Ul.render(e.jsx(s.StrictMode,{children:e.jsx(Wl,{})}));
