import{j as e,r as l,R as bs,a as qn}from"./vendor-BcNuLXi4.js";import{u as Zn,a as qs,b as el,c as tl,d as sl,i as ze,e as Ws,T as Hs,g as al,s as nl,f as ll,h as Zs,j as rl,k as il,l as ea,D as ol,m as cl,n as dl,o as ul,p as xs,q as ml,r as hl,t as pl,v as xl,w as gl,x as fl,y as bl,z as yl,A as jl,B as Cl,C as vl,E as Nl,F as kl,G as wl,P as Sl,H as El,I as Ml,J as Ll,K as Tl,L as Il,M as Pl,N as Al,O as $l,Q as Dl,R as Fl}from"./hooks-62OcQXB5.js";import{r as ta,ay as U,az as N,aA as Gl,aB as Ct,aC as Mt,ak as sa,aD as Js,ao as vt,aq as Nt,ap as kt,O as Rl,ax as zl,am as be,aE as aa,aF as Ol,aG as _l,C as Vl,j as na,G as la,a9 as Bl,i as ra,H as Wl,N as Ee,e as wt,d as St,aH as ia,aI as Us,c as Hl,b as Jl,a5 as oa,aJ as Ul,z as Kl,aK as Ks,aa as Yl}from"./debug-D_oztM7f.js";import{c as Ql}from"./resources-B9u9Fxlu.js";import"./gemini-DfLdvowQ.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const d of r)if(d.type==="childList")for(const i of d.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const d={};return r.integrity&&(d.integrity=r.integrity),r.referrerPolicy&&(d.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?d.credentials="include":r.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function a(r){if(r.ep)return;r.ep=!0;const d=n(r);fetch(r.href,d)}})();function Ne({className:t="",showText:s=!0,size:n="lg"}){const a=Zn(),{progress:r,retryCount:d}=qs(),x=`${n==="sm"?"rounded-full h-6 w-6 border-t-2 border-b-2":"rounded-full h-16 w-16 border-t-4 border-b-4"} animate-spin border-sky-600`,f="text-sky-400",y=a?ta[a]:void 0,h=(y==null?void 0:y.text)??"Loading...",b=r?r+r.split("").reverse().join(""):"",c=d>0?`Retry ${String(d)}`:"",u=s?"flex flex-col items-center my-8":"";return e.jsxs("div",{"aria-live":"polite",className:`${u} ${t}`,role:"status",children:[e.jsx("div",{"aria-hidden":"true",className:x}),s?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:`mt-2 text-xl ${f} text-shadow-md`,children:h}),c?e.jsx("p",{className:`mt-1 text-sm ${f} text-shadow-md`,children:c}):null,b?e.jsx("div",{className:"mt-2 text-2xl text-sky-300 font-mono text-shadow-md",children:b}):null]}):null]})}Ne.defaultProps={className:"",showText:!0,size:"lg"};function ca({hasGameBeenInitialized:t,theme:s}){return e.jsxs("header",{className:"w-full max-w-screen-xl mb-6 text-center",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-sky-400 tracking-wider title-font",children:"Whispers in the Dark"}),e.jsx("p",{className:"text-slate-300 text-lg",children:"An AI-Powered Adventure"}),t?e.jsx("p",{children:s?e.jsx("span",{className:"block text-xs text-purple-400",children:s.name}):null}):null]})}function da({message:t,onRetry:s}){return e.jsxs("div",{className:"bg-red-800 border border-red-600 text-red-100 p-6 rounded-lg shadow-xl my-4 animate-pulse",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(U,{color:"red",inline:!0,marginRight:12,name:"error",size:32}),e.jsx("h3",{className:"font-bold text-2xl text-red-200",children:"A Shadow Falls!"})]}),e.jsx("p",{className:"text-red-200 mb-4",children:t}),s?e.jsx(N,{ariaLabel:"Try again after error",label:"Try Again",onClick:s,preset:"red",size:"md",variant:"compact"}):null]})}da.defaultProps={onRetry:void 0};function ys({type:t}){const n={"single-use":"text-red-400","multi-use":"text-yellow-400",equipment:"text-sky-400",container:"text-orange-400",key:"text-lime-400",weapon:"text-amber-400",ammunition:"text-cyan-400",vehicle:"text-indigo-400",immovable:"text-purple-400","status effect":"text-pink-400",page:"text-green-400",book:"text-green-400",picture:"text-fuchsia-400",map:"text-teal-400"}[t];return e.jsx("span",{className:`text-xs italic ${n}`,children:t})}const bt=()=>{};function Xl({lastTurnChanges:t,isGameBusy:s,currentTurnNumber:n}){const{itemForCardDisplay:a,currentAnimatingItem:r,isVisibleOverlay:d,isCardVisibleClass:i,explicitDisappearClass:x,activeGlowType:f,handleSkipAnimations:y,handleKeyDown:h}=el({lastTurnChanges:t,isGameBusy:s,currentTurnNumber:n}),b=p=>{var g,v;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(ys,{type:p.type}),p.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:p.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-3 italic leading-tight flex-grow",children:p.isActive&&p.activeDescription?p.activeDescription:p.description}),(g=p.tags)!=null&&g.includes("junk")?e.jsx("p",{className:"text-xs text-orange-400 mb-1 italic",children:"(Marked as junk)"}):null,e.jsxs("div",{className:"space-y-1 mt-auto",children:[(v=p.knownUses)==null?void 0:v.map(C=>e.jsx(N,{"aria-hidden":"true",ariaLabel:C.actionName,disabled:!0,label:C.actionName,onClick:bt,preset:"slate",size:"sm",title:C.description},`${p.name}-anim-ku-${C.actionName}`)),e.jsx(N,{"aria-hidden":"true",ariaLabel:"Inspect",disabled:!0,label:"Inspect",onClick:bt,preset:"slate",size:"sm"}),p.type!=="status effect"&&p.type!=="vehicle"&&e.jsx(N,{"aria-hidden":"true",ariaLabel:"Attempt to Use (Generic)",disabled:!0,label:"Attempt to Use (Generic)",onClick:bt,preset:"slate",size:"sm"}),p.type==="vehicle"&&e.jsx(N,{"aria-hidden":"true",ariaLabel:p.isActive?`Exit ${p.name}`:`Enter ${p.name}`,disabled:!0,label:p.isActive?`Exit ${p.name}`:`Enter ${p.name}`,onClick:bt,preset:"slate",size:"sm"})]})]})};if(!d||!a)return null;const c=p=>f?f==="acquire"&&p==="single"?"apply-green-glow-effect":f==="loss"&&p==="single"?"apply-red-glow-effect":f==="change-new"&&p==="new"?"apply-neutral-glow-effect":"":"",u="animating-item-card",m=i?"visible":"",o=x&&!i?x:"";return e.jsx("div",{"aria-label":"Skip item animations",className:"item-change-overlay active",onClick:y,onKeyDown:h,role:"button",tabIndex:0,children:(r==null?void 0:r.type)==="change"&&a.oldItem&&a.newItem?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`${u} ${m} ${o} ${c("old")}`,children:b(a.oldItem)}),e.jsx("div",{className:`${u} ${m} ${o} ${c("new")}`,children:b(a.newItem)})]}):a.item?e.jsx("div",{className:`${u} ${m} ${o} ${c("single")}`,children:b(a.item)}):null})}function ql({isBlurred:t,isDebugViewVisible:s,setIsDebugViewVisible:n}){const a=l.useCallback(()=>{n(r=>!r)},[n]);return e.jsx("footer",{className:`w-full max-w-screen-xl mt-12 text-center text-slate-500 text-sm ${t?"filter blur-sm pointer-events-none":""}`,children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-left",children:["Â©"," ",new Date().getFullYear(),". Developed by"," ",Gl,", Codex, and Gemini."," ",e.jsx("br",{}),"Powered by Gemini."]}),e.jsx("button",{"aria-label":s?"Hide Debug View":"Open Debug View",className:"px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs rounded shadow-md transition-colors",onClick:a,type:"button",children:"Debug"})]})})}function Zl({headerProps:t,errorBanners:s,isBlurred:n,children:a,itemAnimatorProps:r,footerProps:d,fileInputProps:i}){const x=s.filter(C=>C.isVisible),{hasGameBeenInitialized:f,theme:y}=t,{currentTurnNumber:h,isGameBusy:b,lastTurnChanges:c}=r,{isBlurred:u,isDebugViewVisible:m,setIsDebugViewVisible:o}=d,{accept:p,onChange:g,inputRef:v}=i;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 p-4 md:p-8 flex flex-col items-center",children:[e.jsx(ca,{hasGameBeenInitialized:f,theme:y}),x.map(C=>e.jsx("div",{className:"w-full max-w-3xl my-4",children:e.jsx(da,{message:C.message,onRetry:C.handleRetry})},C.id)),e.jsx("main",{className:`w-full max-w-screen-xl grid grid-cols-1 lg:grid-cols-4 gap-3 flex-grow ${n?"filter blur-sm pointer-events-none":""}`,children:a}),e.jsx(Xl,{currentTurnNumber:h,isGameBusy:b,lastTurnChanges:c}),e.jsx(ql,{isBlurred:u,isDebugViewVisible:m,setIsDebugViewVisible:o})]}),e.jsx("input",{accept:p,"aria-hidden":"true",className:"hidden",onChange:g,ref:v,type:"file"})]})}function er({score:t,isLoading:s,isTurnProcessing:n,adventureName:a,currentSceneExists:r,onOpenVisualizer:d,onOpenKnowledgeBase:i,onOpenMap:x,onOpenTitleMenu:f}){return e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{"aria-label":`Current score: ${String(t)} points`,className:"flex items-center p-2 border border-amber-500 rounded-md shadow-md",title:`Score: ${String(t)} points`,children:[e.jsx(U,{color:"amber",inline:!0,marginRight:8,name:"coin",size:20}),e.jsx("span",{className:"text-amber-400 font-semibold text-lg",children:t})]}),n?e.jsx(Ne,{showText:!1,size:"sm"}):null]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(N,{ariaLabel:"Visualize Scene",disabled:s||n||!a||!r,icon:e.jsx(U,{inline:!0,name:"visualize",size:20}),onClick:d,preset:"blue",size:"md",title:"Visualize Scene",variant:"toolbar"}),e.jsx(N,{ariaLabel:"Open Knowledge Base",disabled:s||n||!a,icon:e.jsx(U,{inline:!0,name:"bookOpen",size:20}),onClick:i,preset:"blue",size:"md",title:"Open Knowledge Base",variant:"toolbar"}),e.jsx(N,{ariaLabel:"Open Map",disabled:s||n||!a,icon:e.jsx(U,{inline:!0,name:"map",size:20}),onClick:x,preset:"blue",size:"md",title:"Open Map",variant:"toolbar"}),e.jsx(N,{ariaLabel:"Open Title Menu",disabled:s||n,icon:e.jsx(U,{inline:!0,name:"menu",size:20}),onClick:f,preset:"gray",size:"md",title:"Open Title Menu",variant:"toolbar"})]})]})}const tr="w-4 h-4 rounded",sr=t=>t<.1?"bg-green-500":t<.2?"bg-lime-500":t<.3?"bg-yellow-500":t<.4?"bg-orange-500":t<.5?"bg-amber-500":"bg-red-500";function ua(){const t=tl();return e.jsxs("div",{"aria-label":"Model usage last minute",className:"flex space-x-1 items-center my-2",children:[Object.values(t).map(s=>{const n=s.count/s.limit,a=`${s.model}: ${String(s.count)}/${String(s.limit)} calls last minute`;return e.jsx("div",{"aria-label":a,className:`${tr} ${sr(n)}`,title:a},s.model)}),e.jsx("div",{className:"flex-grow border-t border-slate-600 ml-2"})]})}function ma({tag:t="h2",children:s,icon:n,preset:a="amber",font:r="2xl"}){const d=t,i={slate:"text-slate-300",gray:"text-gray-400",zinc:"text-zinc-400",neutral:"text-neutral-400",stone:"text-stone-400",red:"text-red-400",orange:"text-orange-400",amber:"text-amber-400",yellow:"text-yellow-400",lime:"text-lime-400",green:"text-green-400",emerald:"text-emerald-400",teal:"text-teal-400",cyan:"text-cyan-400",sky:"text-sky-400",blue:"text-blue-400",indigo:"text-indigo-400",violet:"text-violet-400",purple:"text-purple-400",fuchsia:"text-fuchsia-400",pink:"text-pink-400",rose:"text-rose-400"},x={sm:"text-sm font-semibold",base:"text-base font-semibold",lg:"text-lg font-semibold",xl:"text-xl font-semibold","2xl":"text-2xl font-semibold","3xl":"text-3xl font-semibold","4xl":"text-4xl font-semibold"},f=n?e.jsx("span",{className:"mr-2 inline-flex",children:n}):null;return l.createElement(d,{className:`${x[r]} ${i[a]}`},f,s)}ma.defaultProps={children:void 0,font:"2xl",icon:void 0,preset:"amber",tag:"h2"};function Me({header:t,headerIcon:s,children:n,text:a,highlightEntities:r,enableMobileTap:d=!1,containerClassName:i="p-3",headerTag:x="h2",borderColorClass:f="border-amber-700",backgroundColorClass:y="",borderWidthClass:h="border-b",headerFont:b="2xl",headerPreset:c="amber",headerWrapperClassName:u="",contentFontClass:m="",contentColorClass:o="text-slate-200"}){const p=a?a.split(`
`).map(g=>e.jsx("p",{className:"mb-3 last:mb-0",children:r?Ct(g,r,d):g},g)):n;return e.jsxs("section",{className:`${i} ${y} ${h} ${f}`,children:[t?e.jsx("div",{className:` ${u} `,children:e.jsx(ma,{font:b,icon:s,preset:c,tag:x,children:t})}):null,e.jsx("div",{className:`${m} ${o}`,children:p})]})}Me.defaultProps={backgroundColorClass:"",borderColorClass:"border-amber-700",borderWidthClass:"border-b",children:void 0,containerClassName:"p-3",contentColorClass:"text-slate-200",contentFontClass:"",enableMobileTap:!1,header:void 0,headerFont:"2xl",headerIcon:void 0,headerPreset:"amber",headerTag:"h2",headerWrapperClassName:"",highlightEntities:void 0,text:void 0};function ar({description:t,lastActionLog:s,inventory:n,mapData:a,allNPCs:r,localTime:d,localEnvironment:i,localPlace:x}){const f=l.useMemo(()=>Mt(n,a,r),[n,a,r]),y=typeof window<"u"&&window.matchMedia("(hover: none)").matches,h=e.jsx(Me,{backgroundColorClass:"bg-slate-800",borderColorClass:"border-slate-600",borderWidthClass:"rounded-lg border",contentFontClass:"leading-relaxed text-lg",enableMobileTap:y,highlightEntities:f,text:t}),b=s?e.jsx(Me,{backgroundColorClass:"bg-slate-800",borderColorClass:"border-slate-600",borderWidthClass:"rounded-lg border",contentColorClass:"text-yellow-200",contentFontClass:"leading-relaxed text-lg",enableMobileTap:y,highlightEntities:f,text:s}):null,c=e.jsx(Me,{borderColorClass:"border-slate-600",borderWidthClass:"border-t",contentColorClass:"text-slate-300",contentFontClass:"text-lg",text:`Time: ${d}. Environment: ${i}. Location: ${x}`});return e.jsxs("div",{className:"space-y-3",children:[b,h,c]})}function nr({options:t,onActionSelect:s,disabled:n,inventory:a,mapData:r,allNPCs:d,queuedActions:i,onClearQueuedActions:x}){const f=l.useMemo(()=>Mt(a,r,d),[a,r,d]),y=i.map(u=>u.displayText).join(", "),h=i.map(u=>`  - ${u.promptText}`).join(`
`),b=l.useCallback(u=>{i.forEach(m=>{var o;return(o=m.effect)==null?void 0:o.call(m)}),s(h),x(),u.currentTarget.blur()},[i,s,x,h]),c=l.useCallback(u=>m=>{const o=h?`${h}
  - ${u}`:`  - ${u}`;i.forEach(p=>{var g;return(g=p.effect)==null?void 0:g.call(p)}),s(o),x(),m.currentTarget.blur()},[i,s,x,h]);return e.jsxs("div",{className:"mt-6",children:[i.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-3",children:e.jsx(N,{ariaLabel:y,disabled:n,label:e.jsx(e.Fragment,{children:Ct(y,f)}),onClick:b,preset:"teal",size:"lg",variant:"standard"})}),e.jsxs("div",{className:"mb-3 flex items-center",role:"separator",children:[e.jsx("span",{className:"flex-grow border-b border-slate-500"}),e.jsx("span",{className:"px-2 text-slate-300",children:"AND"}),e.jsx("span",{className:"flex-grow border-b border-slate-500"})]})]}):null,e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:t.map(u=>e.jsx(N,{ariaLabel:u,disabled:n||u==="...",label:e.jsx(e.Fragment,{children:Ct(u,f)}),onClick:c(u),preset:"sky",size:"lg",variant:"standard"},u))})]})}function lr({freeFormActionText:t,canPerformFreeAction:s,onChange:n,onSubmit:a}){const r=l.useCallback(()=>{a()},[a]);return e.jsxs("div",{className:"mt-4 p-4 bg-slate-800 border border-slate-700 rounded-lg shadow",children:[e.jsxs("label",{className:"block text-sm font-medium text-amber-300 mb-1",htmlFor:"freeFormAction",children:["Perform Custom Action (Cost:"," ",sa," ","Score Points)"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{"aria-label":"Custom action input",className:"flex-grow p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 disabled:bg-slate-600 disabled:text-slate-300",disabled:!s,id:"freeFormAction",maxLength:Js,onChange:n,placeholder:"Type your custom action here...",type:"text",value:t}),e.jsx(N,{ariaLabel:"Submit custom action",disabled:!s||t.trim()==="",label:"Submit",onClick:r,preset:"green",type:"button",variant:"compact"})]}),!s&&e.jsx("p",{className:"text-xs text-red-400 mt-1",children:"Not enough score points."}),s?e.jsxs("p",{className:"text-xs text-slate-300 mt-1",children:["Max"," ",Js," ","characters."]}):null]})}function rr({items:t,onItemInteract:s,disabled:n,currentNodeId:a,mapNodes:r,queuedActionIds:d,remainingActionPoints:i}){const x=l.useCallback(c=>{const u=c.currentTarget.dataset.itemId;if(!u)return;const m=t.find(o=>o.id===u);m&&(s(m,"take"),c.currentTarget.blur())},[t,s]),f=l.useCallback(c=>{const u=c.currentTarget.dataset.itemId;if(!u)return;const m=t.find(o=>o.id===u);m&&(s(m,"inspect"),c.currentTarget.blur())},[t,s]),y=l.useCallback(c=>{const u=c.currentTarget.dataset.itemId;if(!u)return;const m=t.find(o=>o.id===u);m&&(s(m,"generic"),c.currentTarget.blur())},[t,s]),h=l.useCallback(c=>{const{itemId:u,actionName:m,promptEffect:o}=c.currentTarget.dataset;if(!u||!m||!o)return;const p=t.find(v=>v.id===u);if(!p)return;s(p,"specific",{actionName:m,promptEffect:o,description:m}),c.currentTarget.blur()},[t,s]),b=l.useCallback(c=>c.knownUses?c.knownUses.filter(u=>{const m=!!c.isActive;return u.appliesWhenActive!==void 0&&u.appliesWhenInactive!==void 0?u.appliesWhenActive&&m||u.appliesWhenInactive&&!m||!u.appliesWhenActive&&!u.appliesWhenInactive:u.appliesWhenActive!==void 0?u.appliesWhenActive===m:u.appliesWhenInactive!==void 0?u.appliesWhenInactive===!m:!0}):[],[]);return t.length===0?null:e.jsxs("div",{className:"bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-amber-400 mb-2 border-b-2 border-amber-700 pb-2 flex items-center",children:[e.jsx(U,{color:"amber",inline:!0,marginRight:8,name:"inventory",size:20})," ","Items Here"]}),e.jsx("ul",{className:"flex flex-wrap justify-center gap-4 list-none p-0",children:t.map(c=>{var p;const u=c.isActive&&c.activeDescription?c.activeDescription:c.description,m=c.holderId===a,o=m?null:(p=r.find(g=>g.id===c.holderId))==null?void 0:p.placeName;return e.jsxs("li",{className:"w-[270px] text-slate-300 bg-slate-700/60 p-4 rounded-md shadow border border-slate-600 flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(ys,{type:c.type}),c.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:c.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-1 italic leading-tight flex-grow",children:u}),!m&&o?e.jsxs("p",{className:"text-xs text-slate-300 mb-2",children:["Reachable at ",o]}):null,e.jsx("div",{className:"mt-auto space-y-2",children:c.type==="immovable"?e.jsxs(e.Fragment,{children:[b(c).map(g=>{const v=d.has(`${c.id}-specific-${g.actionName}`);return e.jsx(N,{ariaLabel:`${g.actionName}${g.description?": "+g.description:""}`,cost:vt,"data-action-name":g.actionName,"data-item-id":c.id,"data-prompt-effect":g.promptEffect,disabled:n||!v&&vt>i,label:g.actionName,onClick:h,preset:"teal",pressed:v,size:"sm",title:g.description,variant:"toggleFull"},`${c.id}-ku-${g.actionName}`)}),(()=>{const g=d.has(`${c.id}-inspect`);return e.jsx(N,{ariaLabel:`Inspect ${c.name}`,cost:Nt,"data-item-id":c.id,disabled:n||!g&&Nt>i,label:"Inspect",onClick:f,preset:"indigo",pressed:g,size:"sm",variant:"toggleFull"})})(),(()=>{const g=d.has(`${c.id}-generic`);return e.jsx(N,{ariaLabel:`Attempt to use ${c.name}`,cost:kt,"data-item-id":c.id,disabled:n||!g&&kt>i,label:"Attempt to Use (Generic)",onClick:y,preset:"sky",pressed:g,size:"sm",variant:"toggleFull"})})()]}):e.jsx(N,{ariaLabel:c.type==="vehicle"?`Enter ${c.name}`:`Take ${c.name}`,"data-item-id":c.id,disabled:n,label:c.type==="vehicle"?"Enter Vehicle":"Take",onClick:x,preset:"green",size:"sm"})})]},c.id)})})]})}function ha({item:t,isNew:s,isStashing:n,applicableUses:a,disabled:r,currentTurn:d,onSpecificUse:i,onInspect:x,onGenericUse:f,onVehicleToggle:y,onDrop:h,onDiscard:b,onRead:c,onStashToggle:u,filterMode:m,registerRef:o,queuedActionIds:p,remainingActionPoints:g}){var R,B,G,j,M,L,S,Y;const v=t.isActive&&t.activeDescription?t.activeDescription:t.description,C=Rl.includes(t.type),k=zl.includes(t.type),T=t.type!=="status effect"&&t.type!=="vehicle",w=!((R=t.tags)!=null&&R.includes("junk"))&&t.type!=="vehicle"&&t.type!=="status effect",_=m==="stashed"&&(t.stashed===!0||n),$=w&&(!C||_),I=[],[W,V]=l.useState(!1),K=l.useCallback(D=>{V(!0),D.currentTarget.blur()},[]),Q=l.useCallback(D=>{b(D),V(!1)},[b]),z=l.useCallback(D=>{V(!1),D.currentTarget.blur()},[]);a.forEach(D=>{const ee=p.has(`${t.id}-specific-${D.actionName}`);I.push(e.jsx(N,{ariaLabel:`${D.actionName}${D.description?": "+D.description:""}`,cost:vt,"data-action-name":D.actionName,"data-item-id":t.id,"data-prompt-effect":D.promptEffect,disabled:r||!ee&&vt>g,label:D.actionName,onClick:i,preset:"teal",pressed:ee,size:"sm",title:D.description,variant:"toggleFull"},`${t.id}-knownuse-${D.actionName}`))});const A=r||(C?t.id===be?(((B=t.chapters)==null?void 0:B.length)??0)===0:((G=t.chapters)==null?void 0:G.some(D=>!D.actualContent))??!0:k?((j=t.chapters)==null?void 0:j.some(D=>!D.imageData))??!0:!1)||t.lastInspectTurn!==void 0&&d-t.lastInspectTurn<aa,H=p.has(`${t.id}-inspect`);if(I.push(e.jsx(N,{ariaLabel:`Inspect ${t.name}`,cost:Nt,"data-item-id":t.id,disabled:A||!H&&Nt>g,label:"Inspect",onClick:x,preset:"indigo",pressed:H,size:"sm",variant:"toggleFull"},`${t.id}-inspect`)),C&&I.push(e.jsx(N,{ariaLabel:`Read ${t.name}`,"data-item-id":t.id,disabled:r||t.id===be&&(((M=t.chapters)==null?void 0:M.length)??0)===0,label:"Read",onClick:c,preset:"teal",size:"sm"},`${t.id}-read`)),T){const D=p.has(`${t.id}-generic`);I.push(e.jsx(N,{ariaLabel:`Attempt to use ${t.name} (generic action)`,cost:kt,"data-item-id":t.id,disabled:r||!D&&kt>g,label:"Attempt to Use (Generic)",onClick:f,preset:"sky",pressed:D,size:"sm",variant:"toggleFull"},`${t.id}-generic-use`))}return t.type==="vehicle"&&I.push(e.jsx(N,{ariaLabel:t.isActive?`Exit ${t.name}`:`Enter ${t.name}`,"data-item-id":t.id,disabled:r,label:t.isActive?`Exit ${t.name}`:`Enter ${t.name}`,onClick:y,preset:"sky",pressed:p.has(`${t.id}-specific-${t.isActive?`Exit ${t.name}`:`Enter ${t.name}`}`),size:"sm",variant:"toggleFull"},`${t.id}-vehicle-action`)),(L=t.tags)!=null&&L.includes("junk")&&(W?I.push(e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[e.jsx(N,{ariaLabel:`Confirm discard of ${t.name}`,"data-item-id":t.id,disabled:r,label:t.type==="vehicle"&&!t.isActive?"Confirm Park":"Confirm Discard",onClick:Q,preset:"red",size:"sm"},`${t.id}-confirm-discard`),e.jsx(N,{ariaLabel:"Cancel discard",disabled:r,label:"Cancel",onClick:z,preset:"slate",size:"sm"},`${t.id}-cancel-discard`)]},`${t.id}-confirm-group`)):I.push(e.jsx(N,{ariaLabel:`Discard ${t.name}`,"data-item-id":t.id,disabled:r,icon:e.jsx(U,{color:"white",inline:!0,marginRight:4,name:"trash",size:16}),label:"Discard",onClick:K,preset:"orange",size:"sm"},`${t.id}-discard`))),C&&I.push(e.jsx(N,{ariaLabel:m==="stashed"?`Retrieve ${t.name}`:`Stash ${t.name}`,"data-item-id":t.id,disabled:r,label:m==="stashed"?"Retrieve":"Stash",onClick:u,preset:"sky",size:"sm"},`${t.id}-stash`)),w&&C&&$&&I.push(e.jsx(N,{ariaLabel:`Drop ${t.name}`,"data-item-id":t.id,disabled:r,label:"Drop",onClick:h,preset:"sky",size:"sm"},`${t.id}-drop`)),w&&!C&&$&&I.push(e.jsx(N,{ariaLabel:`Drop ${t.name}`,"data-item-id":t.id,disabled:r,label:"Drop",onClick:h,preset:"sky",size:"sm"},`${t.id}-drop`)),!((S=t.tags)!=null&&S.includes("junk"))&&t.type==="vehicle"&&!t.isActive&&I.push(e.jsx(N,{ariaLabel:`Park ${t.name} here`,"data-item-id":t.id,disabled:r,label:"Park Here",onClick:h,preset:"sky",size:"sm"},`${t.id}-drop`)),e.jsxs("li",{className:`w-[270px] text-slate-300 bg-slate-700/60 p-4 rounded-md shadow border border-slate-600 ${s?"animate-new-item-pulse":""} ${n?"animate-archive-fade-out":""} flex flex-col`,"data-item-id":t.id,ref:o,children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(ys,{type:t.type}),t.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:t.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-3 italic leading-tight flex-grow",children:v}),(Y=t.tags)!=null&&Y.includes("junk")?e.jsx("p",{className:"text-xs text-orange-400 mb-1 italic",children:"(Marked as junk)"}):null,e.jsx("div",{className:"space-y-2 mt-auto",children:I})]},t.id)}ha.defaultProps={registerRef:void 0};function ir({sortOrder:t,disabled:s,onSortByName:n,onSortByType:a}){return e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[e.jsx(N,{ariaLabel:"Sort by Name",disabled:s,label:"Sort by Name",onClick:n,preset:t==="name"?"sky":"slate",pressed:t==="name",size:"sm",variant:"toggle"}),e.jsx(N,{ariaLabel:"Sort by Type",disabled:s,label:"Sort by Type",onClick:a,preset:t==="type"?"sky":"slate",pressed:t==="type",size:"sm",variant:"toggle"})]})}function or({filterMode:t,disabled:s,onFilterAll:n,onFilterStashed:a}){return e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[e.jsx(N,{ariaLabel:"Show All",disabled:s,label:"All",onClick:n,preset:t==="all"?"sky":"slate",pressed:t==="all",size:"sm",variant:"toggle"}),e.jsx(N,{ariaLabel:"Show Stashed",disabled:s,label:"Stashed",onClick:a,preset:t==="stashed"?"sky":"slate",pressed:t==="stashed",size:"sm",variant:"toggle"})]})}function cr({items:t,onItemInteract:s,onStashToggle:n,onReadPage:a,currentTurn:r,disabled:d,queuedActionIds:i,remainingActionPoints:x}){const{displayedItems:f,newlyAddedItemIds:y,stashingItemIds:h,sortOrder:b,handleSortByName:c,handleSortByType:u,filterMode:m,handleFilterAll:o,handleFilterStashed:p,handleSpecificUse:g,handleInspect:v,handleGenericUse:C,handleDrop:k,handleDiscard:T,handleVehicleToggle:w,handleStashToggleInternal:_,handleRead:$,getApplicableKnownUses:I}=sl({items:t,onItemInteract:s,onStashToggle:n,onReadPage:a}),W=l.useRef(new Map),V=l.useRef(new Map),K=l.useRef(d),Q=l.useCallback(z=>{if(!z)return;const A=z.dataset.itemId;A&&W.current.set(A,z)},[]);return l.useLayoutEffect(()=>{const z=new Map;if(W.current.forEach((A,H)=>{if(!A.isConnected){W.current.delete(H),V.current.delete(H);return}const R=A.getBoundingClientRect();z.set(H,new DOMRect(R.left+window.scrollX,R.top+window.scrollY,R.width,R.height))}),K.current!==d){K.current=d,V.current=z;return}d||V.current.forEach((A,H)=>{const R=z.get(H),B=W.current.get(H);if(!R||!B)return;const G=Math.round(A.left-R.left),j=Math.round(A.top-R.top);(G!==0||j!==0)&&(B.style.transition="none",B.style.transform=`translate(${String(G)}px, ${String(j)}px)`,requestAnimationFrame(()=>{B.style.transition="transform 0.2s",B.style.transform=""}),setTimeout(()=>{B.style.transition=""},200))}),V.current=z},[f,d]),e.jsxs("div",{className:"bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700 h-full",children:[e.jsxs("h3",{className:"text-xl font-bold text-amber-400 mb-2 border-b-2 border-amber-700 pb-2 flex items-center",children:[e.jsx(U,{color:"amber",inline:!0,marginRight:8,name:"inventory",size:20})," ","Inventory"]}),e.jsx(ir,{disabled:d,onSortByName:c,onSortByType:u,sortOrder:b}),e.jsx(or,{disabled:d,filterMode:m,onFilterAll:o,onFilterStashed:p}),f.length===0?e.jsx("p",{className:"text-slate-300 italic",children:"Your pockets are empty."}):e.jsx("ul",{className:"flex flex-wrap justify-center gap-4 list-none p-0",children:f.map(z=>{const A=I(z),H=y.has(z.id),R=h.has(z.id);return e.jsx(ha,{applicableUses:A,currentTurn:r,disabled:d,filterMode:m,isNew:H,isStashing:R,item:z,onDiscard:T,onDrop:k,onGenericUse:C,onInspect:v,onRead:$,onSpecificUse:g,onStashToggle:_,onVehicleToggle:w,queuedActionIds:i,registerRef:Q,remainingActionPoints:x},z.id)})})]})}function dr({allNPCs:t,currentMapNodeId:s,currentObjective:n,enableMobileTap:a,inventory:r,itemsHere:d,storyArc:i,mapNodes:x,objectiveAnimationType:f,onStashToggle:y,onItemInteract:h,onReadPage:b,onReadPlayerJournal:c,globalTurnNumber:u,disabled:m,queuedActionIds:o,remainingActionPoints:p}){const g=l.useMemo(()=>Mt(r,x,t),[r,x,t]),v=i==null?void 0:i.acts[i.currentAct-1],C=(v==null?void 0:v.mainObjective)??null,k=v?`Act ${String(i.currentAct)}: ${v.title}`:"";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-start gap-4 mb-2",children:e.jsx(N,{ariaLabel:"Open journal",disabled:m,icon:e.jsx(U,{name:"journalPen",size:24}),onClick:c,preset:"blue",size:"lg",title:"Open Journal",variant:"toolbarLarge"})}),C?e.jsx(Me,{backgroundColorClass:"bg-purple-800/50",borderColorClass:"border-purple-600",borderWidthClass:"border rounded-lg",containerClassName:"p-3",contentColorClass:"text-purple-200",contentFontClass:"text-lg",enableMobileTap:a,header:k,headerFont:"lg",headerPreset:"purple",highlightEntities:g,text:C}):null,n?e.jsx(Me,{backgroundColorClass:"bg-amber-800/50",borderColorClass:"border-amber-600",borderWidthClass:"border rounded-lg",containerClassName:`p-3 ${f==="success"?"animate-objective-success":f==="neutral"?"animate-objective-neutral":""}`,contentColorClass:"text-amber-200",contentFontClass:"text-lg",enableMobileTap:a,header:"Current Objective",headerFont:"lg",headerPreset:"amber",highlightEntities:g,text:n}):null,e.jsx(rr,{currentNodeId:s,disabled:m,items:d,mapNodes:x,onItemInteract:h,queuedActionIds:o,remainingActionPoints:p}),e.jsx(cr,{currentTurn:u,disabled:m,items:r,onItemInteract:h,onReadPage:b,onStashToggle:y,queuedActionIds:o,remainingActionPoints:p})]})}function ur({hasGameBeenInitialized:t,showInitialLoadingSpinner:s,showSceneLoadingOverlay:n,mainToolbarProps:a,sceneDisplayProps:r,actionOptionsProps:d,freeActionInputProps:i,sidebarProps:x}){const{adventureName:f,currentSceneExists:y,isLoading:h,isTurnProcessing:b,onOpenKnowledgeBase:c,onOpenMap:u,onOpenTitleMenu:m,onOpenVisualizer:o,score:p}=a,{allNPCs:g,description:v,inventory:C,lastActionLog:k,localEnvironment:T,localPlace:w,localTime:_,mapData:$}=r,{allNPCs:I,disabled:W,inventory:V,mapData:K,onActionSelect:Q,onClearQueuedActions:z,options:A,queuedActions:H}=d,{canPerformFreeAction:R,freeFormActionText:B,onChange:G,onSubmit:j}=i,{allNPCs:M,currentMapNodeId:L,currentObjective:S,disabled:Y,enableMobileTap:D,globalTurnNumber:ee,inventory:le,itemsHere:re,mapNodes:pe,objectiveAnimationType:E,onItemInteract:F,onReadPage:X,onReadPlayerJournal:oe,onStashToggle:se,queuedActionIds:O,remainingActionPoints:J,storyArc:ye}=x;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"lg:col-span-2 space-y-3 flex flex-col",children:[e.jsx(er,{adventureName:f,currentSceneExists:y,isLoading:h,isTurnProcessing:b,onOpenKnowledgeBase:c,onOpenMap:u,onOpenTitleMenu:m,onOpenVisualizer:o,score:p}),e.jsx(ua,{}),s?e.jsx(Ne,{}):null,t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(ar,{allNPCs:g,description:v,inventory:C,lastActionLog:k,localEnvironment:T,localPlace:w,localTime:_,mapData:$}),n?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-900/75 rounded-lg",children:e.jsx(Ne,{})}):null]}),e.jsx(nr,{allNPCs:I,disabled:W,inventory:V,mapData:K,onActionSelect:Q,onClearQueuedActions:z,options:A,queuedActions:H}),e.jsx(lr,{canPerformFreeAction:R,freeFormActionText:B,onChange:G,onSubmit:j})]}):e.jsx("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg flex-grow min-h-48"})]}),e.jsx("div",{className:"lg:col-span-2 space-y-2 flex flex-col",children:t?e.jsx(dr,{allNPCs:M,currentMapNodeId:L,currentObjective:S,disabled:Y,enableMobileTap:D,globalTurnNumber:ee,inventory:le,itemsHere:re,mapNodes:pe,objectiveAnimationType:E,onItemInteract:F,onReadPage:X,onReadPlayerJournal:oe,onStashToggle:se,queuedActionIds:O,remainingActionPoints:J,storyArc:ye}):e.jsx("div",{className:"hidden lg:block bg-slate-800/50 border border-slate-700 rounded-lg flex-grow min-h-48"})})]})}function pa({isVisible:t,onClose:s,history:n,options:a,onOptionSelect:r,participants:d,isLoading:i,isDialogueExiting:x,inventory:f,mapData:y,allNPCs:h,heroShortName:b}){const c=l.useRef(null),u=l.useRef(null);l.useEffect(()=>{t&&u.current&&u.current.scrollIntoView({behavior:"smooth",block:"end"})},[n,t]),l.useEffect(()=>{if(!t)return;const C=c.current;C&&i&&(x===!0||a.length===0)&&C.scrollTo({top:C.scrollHeight,behavior:"smooth"})},[i,x,a.length,t,n.length]);const m=l.useMemo(()=>Mt(f,y,h),[f,y,h]),o=d.join(", "),p=i||x,g=l.useCallback(C=>{const k=C.currentTarget.dataset.option;k&&(r(k),C.currentTarget.blur())},[r]);if(!t)return null;const v=()=>{if(x||i)return e.jsx(Ne,{});if(a.length>0)return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:a.map(C=>e.jsx(N,{ariaLabel:C,"data-option":C,disabled:p,enableHighlightTap:!0,highlightEntities:m,label:C,onClick:g,preset:"sky",size:"md",variant:"standard"},C))})};return e.jsx("div",{"aria-labelledby":"dialogue-title","aria-modal":"true",className:"dialogue-frame open",ref:c,role:"dialog",children:e.jsxs("div",{className:"dialogue-frame-content",children:[e.jsx(N,{ariaLabel:"End Conversation",disabled:i||x,icon:e.jsx(U,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}),e.jsxs("h1",{className:"text-2xl font-bold text-sky-300 mb-4 text-center",id:"dialogue-title",children:["Conversation with:"," ",o]}),e.jsx("div",{className:"dialogue-log-area flex-grow mb-4 pr-2 min-h-[200px] overflow-y-auto",children:n.map((C,k)=>{const T=C.speaker.toLowerCase()==="player",w=T?b??"Player":C.speaker;return e.jsxs("div",{className:`mb-3 p-3 rounded-lg animate-dialogue-new-entry ${T?"bg-slate-700 ml-auto w-11/12 text-right":"bg-slate-600 mr-auto w-11/12"}`,ref:k===n.length-1?u:null,children:[e.jsxs("strong",{className:T?"text-amber-400":"text-emerald-400",children:[w,":"]}),e.jsx("span",{className:"text-slate-100 ml-2",children:Ct(C.line,m)})]},C.line)})}),e.jsxs("div",{className:"dialogue-options-area mt-auto pt-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(ua,{}),e.jsx("div",{className:"flex-grow border-t border-slate-600 ml-2"})]}),v()]})]})})}pa.defaultProps={heroShortName:void 0,isDialogueExiting:!1};function xa({version:t,sourceInfo:s}){return e.jsxs("p",{className:"text-sm text-slate-300 absolute bottom-4 right-4",children:[e.jsx("span",{children:"Version: "+t}),e.jsx("br",{}),e.jsx("span",{children:s??null})]})}xa.defaultProps={sourceInfo:void 0};function ga({isVisible:t,onClose:s,onNewGame:n,onSaveGame:a,onLoadGame:r,onOpenSettings:d,onOpenInfo:i,onOpenGeminiKeyModal:x,isGameActive:f}){const y=l.useCallback(()=>{a&&a()},[a]);return e.jsx("div",{"aria-labelledby":"title-menu-heading","aria-modal":"true",className:`animated-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content relative",children:[" ",f?e.jsx(N,{ariaLabel:"Close Title Menu",icon:e.jsx(U,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}):null,e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full p-4 text-center",children:[e.jsx(ca,{hasGameBeenInitialized:f,theme:null}),e.jsxs("div",{className:"space-y-3 sm:space-y-3 w-full max-w-xs sm:max-w-sm",children:[!ze()&&x?e.jsx(N,{ariaLabel:"Set Gemini API key",label:"Set Gemini Key",onClick:x,preset:"indigo",size:"lg"}):null,ze()&&!Ws()&&x?e.jsx(N,{ariaLabel:"Change the Gemini API key",label:"Change Gemini Key",onClick:x,preset:"indigo",size:"lg"}):null,e.jsx(N,{ariaLabel:f?"Start a New Game (Progress will be lost)":"Start a New Game",disabled:!ze(),label:"New Game",onClick:n,preset:"red",size:"lg"}),f&&a?e.jsx(N,{ariaLabel:"Save Current Game to File",label:"Save Game",onClick:y,preset:"green",size:"lg"}):null,e.jsx(N,{ariaLabel:f?"Load Game from File (Current progress will be lost)":"Load Game from File",disabled:!ze(),label:"Load Game",onClick:r,preset:"blue",size:"lg"}),e.jsx(N,{ariaLabel:"Open Settings",label:"Settings",onClick:d,preset:"gray",size:"lg"}),e.jsx(N,{ariaLabel:"About & Game Guide",label:"About",onClick:i,preset:"cyan",size:"lg"}),f?e.jsx(N,{ariaLabel:"Return to Game",label:"Return to Game",onClick:s,preset:"sky",size:"lg"}):null]})]}),e.jsx(xa,{sourceInfo:Ws()?"Using System Gemini Key":void 0,version:Ol})]})})}ga.defaultProps={onOpenGeminiKeyModal:void 0,onSaveGame:void 0};function fa({theme:t,onSelect:s,disabled:n=!1}){const a=l.useCallback(()=>{s()},[s]);return e.jsx(N,{ariaLabel:`Start a new game in the theme: ${t.name}${n?" (Current theme, cannot select)":""}`,disabled:n,label:e.jsxs("div",{className:"flex flex-col items-start text-left w-full",style:{minHeight:"180px"},children:[e.jsx("h3",{className:"text-xl font-semibold text-amber-400 mb-2",children:t.name}),e.jsx("p",{className:"text-sm text-slate-300 leading-snug line-clamp-8",children:t.storyGuidance}),n?e.jsx("p",{className:"text-xs text-orange-300 mt-1 italic",children:"(Currently active theme)"}):null]}),onClick:a,preset:"slate",variant:"standard"})}fa.defaultProps={disabled:!1};function ba({isVisible:t,onClose:s,onThemeSelected:n,disabledThemeName:a=null,titleText:r=void 0,descriptionText:d=void 0}){const i=l.useCallback(h=>()=>{n(h)},[n]);if(!t)return null;const x=Object.keys(Hs).reduce((h,b)=>{const c=b;return h[c]=Hs[c],h},{}),f=r??"Choose Your Adventure Theme",y=d??"Select a theme to start your adventure. The story will remain in this setting until you begin a new game.";return e.jsx("div",{"aria-labelledby":"custom-game-setup-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(N,{ariaLabel:"Close theme selection",icon:e.jsx(U,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}),e.jsxs("div",{className:"flex flex-col items-center w-full h-full p-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-4 text-center",id:"custom-game-setup-title",children:f}),e.jsx("p",{className:"text-slate-300 mb-6 text-center text-sm max-w-2xl",children:y}),Object.keys(x).length===0?e.jsx("p",{className:"text-slate-300 italic",children:"No themes available. Please check configuration."}):e.jsx("div",{className:"overflow-y-auto flex-grow w-full max-w-5xl px-6",children:Object.entries(x).map(([h,b])=>b.length>0&&e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-purple-400 mb-3 pb-1 border-b border-purple-600",children:h}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4",children:b.map(c=>{const u=c.name===a;return e.jsx(fa,{disabled:u,onSelect:i(c.name),theme:c},c.name)})})]},h))})]})]})})}ba.defaultProps={descriptionText:void 0,disabledThemeName:null,titleText:void 0};function ya({options:t,selected:s,onToggle:n,errorText:a}){const r=l.useCallback(d=>{n(d.currentTarget.value)},[n]);return e.jsxs("div",{className:"space-y-3",children:[t.map(d=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-2 bg-slate-700/50 rounded-md hover:bg-slate-600/50 transition-colors",children:[e.jsx("input",{"aria-labelledby":`${d}-label`,checked:s.includes(d),className:"form-checkbox h-5 w-5 text-sky-500 bg-slate-600 border-slate-500 rounded focus:ring-sky-400 focus:ring-offset-slate-800",onChange:r,type:"checkbox",value:d}),e.jsx("span",{className:"text-slate-200 text-lg",id:`${d}-label`,children:d})]},d)),a?e.jsx("p",{className:"text-red-400 mt-2 text-sm",children:a}):null]})}ya.defaultProps={errorText:void 0};function js({name:t,options:s,value:n,onChange:a,addCustom:r=!1,placeholder:d=""}){const i=s.includes(n),x=i||!r||n==="Not Specified"?"":n,[f,y]=l.useState(x);l.useEffect(()=>{const o=s.includes(n);y(o||!r||n==="Not Specified"?"":n)},[n,s,r]);const h=l.useCallback(o=>{a(o==="Custom"?f.trim()||"Not Specified":o)},[f,a]),b=l.useCallback(o=>{h(o.currentTarget.value)},[h]),c=l.useCallback(o=>{const p=o.target.value;y(p),s.includes(n)||a(p.trim()||"Not Specified")},[a,s,n]),u=i?n:"Custom",m=r?[...s,"Custom"]:s;return e.jsxs("div",{className:"space-y-3",children:[m.map(o=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-2 bg-slate-700/50 rounded-md hover:bg-slate-600/50 transition-colors",children:[e.jsx("input",{"aria-labelledby":`${t}-${o}`,checked:u===o,className:"form-radio h-5 w-5 text-sky-500 bg-slate-600 border-slate-500 focus:ring-sky-400 focus:ring-offset-slate-800",name:t,onChange:b,type:"radio",value:o}),e.jsx("span",{className:"text-slate-200 text-lg",id:`${t}-${o}`,children:o})]},o)),r&&u==="Custom"?e.jsx("input",{"aria-label":"Custom input",className:"w-full p-2 mt-2 bg-slate-600 text-slate-100 border border-slate-500 rounded-md focus:ring-sky-500 focus:border-sky-500",onChange:c,placeholder:d,type:"text",value:f}):null]})}js.defaultProps={addCustom:!1,placeholder:""};function mr({enabledThemePacks:t,isVisible:s,onChangeThinkingEffort:n,onChangePreferredPlayerName:a,onClose:r,onToggleThemePack:d,preferredPlayerName:i,thinkingEffort:x}){const f=l.useCallback(c=>{d(c)},[d]),y=l.useCallback(c=>{f(c)},[f]),h=l.useCallback(c=>{n(c)},[n]),b=l.useCallback(c=>{const m=c.target.value.replace(/[^a-zA-Z0-9\s\-"']/g,"");a(m)},[a]);return e.jsx("div",{"aria-labelledby":"settings-title","aria-modal":"true",className:`animated-frame ${s?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(N,{ariaLabel:"Close settings",icon:e.jsx(U,{name:"x",size:20}),onClick:r,size:"sm",variant:"close"}),e.jsxs("div",{className:"settings-content-area",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-8 text-center",id:"settings-title",children:"Game Settings"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Preferred Player Name"}),e.jsx("p",{className:"settings-explanation mb-3",children:"Optional: if set, this name appears as the first option when choosing your character. Disallowed characters are removed automatically."}),e.jsx("input",{"aria-label":"Preferred player name",className:"w-full p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500",onChange:b,placeholder:"e.g., Morgan",type:"text",value:i})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Thinking Effort"}),e.jsx("p",{className:"settings-explanation mb-3",children:"Select how much reasoning the AI uses. Higher levels may improve quality at the cost of time, but will not affect API usage quotas."}),e.jsx(js,{name:"thinking-effort",onChange:h,options:["Low","Medium","High"],value:x})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Theme Pack Preferences"}),e.jsx("p",{className:"settings-explanation mb-3",children:"Select which genre packs to include when choosing a starting theme. At least one pack must be enabled. You can change this setting at any time."}),e.jsx(ya,{errorText:t.length===0?"At least one theme pack must be enabled. Please select a pack to continue.":void 0,onToggle:y,options:_l,selected:t})]})]})]})})}function hr({title:t,items:s}){return e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-medium text-sky-400 mb-2",children:t}),e.jsx("ul",{className:"list-disc list-inside ml-4 space-y-1",children:s.map(n=>e.jsx("li",{children:n},n))})]})}const Et=Ql;function pr(t){return t.replace(/\{\{CURRENT_SAVE_GAME_VERSION\}\}/g,Vl).replace(/\{\{GEMINI_MODEL_NAME\}\}/g,na).replace(/\{\{GEMINI_LITE_MODEL_NAME\}\}/g,la).replace(/\{\{GEMINI_PRO_MODEL_NAME\}\}/g,Bl).replace(/\{\{MINIMAL_MODEL_NAME\}\}/g,ra)}const xr=Et.sections.map(t=>e.jsx(Me,{contentFontClass:"leading-relaxed space-y-3",header:t.header,text:t.text.map(s=>pr(s)).join(`
`)},t.header)),gr=Et.changelog.map(t=>e.jsx(hr,{items:t.items,title:t.title},t.title));function fr({isVisible:t,onClose:s}){return e.jsx("div",{"aria-labelledby":"info-title","aria-modal":"true",className:`animated-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(N,{ariaLabel:"Close game information",icon:e.jsx(U,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}),e.jsxs("div",{className:"info-content-area",children:[e.jsx(Me,{borderColorClass:"border-sky-700",borderWidthClass:"border-b-2",containerClassName:"mb-6",header:Et.title,headerFont:"3xl",headerPreset:"sky",headerTag:"h1",headerWrapperClassName:"text-center"}),xr,e.jsx(Me,{contentFontClass:"leading-relaxed space-y-4",header:"Changelog",children:gr}),e.jsx(Me,{containerClassName:"mt-8",contentColorClass:"text-slate-500",contentFontClass:"text-sm text-center",text:Et.footer})]})]})})}const br=bs.memo(fr);function yr({isVisible:t,facts:s,onSubmit:n,onClose:a}){const[r,d]=l.useState({});l.useEffect(()=>{t&&d({})},[s,t]);const i=l.useCallback((u,m)=>{d(o=>({...o,[u]:o[u]===m?void 0:m}))},[]),x=l.useCallback(()=>{const u=[],m=[];s.forEach((o,p)=>{r[p]==="good"&&u.push(o),r[p]==="bad"&&m.push(o)}),n(u,m,!0)},[s,r,n]),f=l.useCallback(()=>{n([],[],!1)},[n]),y=l.useCallback(u=>{i(u,"good")},[i]),h=l.useCallback(u=>{i(u,"bad")},[i]),b=l.useMemo(()=>s.map((u,m)=>()=>{y(m)}),[s,y]),c=l.useMemo(()=>s.map((u,m)=>()=>{h(m)}),[s,h]);return e.jsx("div",{"aria-labelledby":"debug-lore-title","aria-modal":"true",className:`animated-frame debug-lore-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(N,{ariaLabel:"Close debug lore",icon:e.jsx(U,{name:"x",size:20}),onClick:a,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-2xl font-bold text-amber-400 mb-3 text-center",id:"debug-lore-title",children:"Evaluate Extracted Facts"}),e.jsx("ul",{className:"mb-4 space-y-2",children:s.map((u,m)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"flex-grow text-slate-300",children:u}),e.jsx(N,{ariaLabel:"Mark good",label:"Good",onClick:b[m],preset:"green",pressed:r[m]==="good",size:"sm",variant:"toggle"}),e.jsx(N,{ariaLabel:"Mark bad",label:"Bad",onClick:c[m],preset:"red",pressed:r[m]==="bad",size:"sm",variant:"toggle"})]},u))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(N,{ariaLabel:"Skip",label:"Skip",onClick:f,preset:"stone",size:"sm"}),e.jsx(N,{ariaLabel:"OK",label:"OK",onClick:x,preset:"sky",size:"sm"})]})]})})}function jr({isVisible:t,onClose:s}){const[n,a]=l.useState("");l.useEffect(()=>{t&&a(al()??"")},[t]);const r=l.useCallback(i=>{a(i.target.value)},[]),d=l.useCallback(()=>{nl(n.trim()),s()},[n,s]);return t?e.jsx("div",{"aria-labelledby":"gemini-key-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex flex-col items-center",children:[e.jsx(N,{ariaLabel:"Close Gemini key setup",icon:e.jsx(U,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-2xl font-bold text-sky-300 mb-4",id:"gemini-key-title",children:"Configure Gemini API Key"}),e.jsxs("div",{className:"mb-4 text-slate-200 text-center",children:["Visit"," ",e.jsx("a",{className:"text-sky-400 underline hover:text-sky-300",href:"https://aistudio.google.com",rel:"noopener noreferrer",target:"_blank",children:"https://aistudio.google.com"})," ","to generate a free API key. Paste it below."]}),e.jsxs("div",{className:"flex w-full max-w-md space-x-2",children:[e.jsx("input",{"aria-label":"Gemini API key",className:"flex-grow p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500",onChange:r,placeholder:"Enter API key",type:"password",value:n}),e.jsx(N,{ariaLabel:"Save API key",disabled:n.trim()==="",label:"Save",onClick:d,preset:"green",variant:"compact"})]}),e.jsx("div",{className:"mb-4 text-amber-400 text-center",children:"The game runs entirely in your browser. The key never leaves your device and will be stored in the Browser's Local Storage."})]})}):null}function Cr({isVisible:t,defaultGender:s,onSubmit:n}){const[a,r]=l.useState(s),d=l.useCallback(()=>{n(a.trim()||"Not Specified")},[a,n]);return t?e.jsx("div",{"aria-labelledby":"gender-select-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex flex-col items-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-sky-300 mb-4",id:"gender-select-title",children:"Choose Your Character's Gender"}),e.jsx("div",{className:"mb-6 w-full max-w-xs",children:e.jsx(js,{addCustom:!0,name:"heroGender",onChange:r,options:["Male","Female"],placeholder:"Enter custom gender",value:a})}),e.jsx(N,{ariaLabel:"Confirm gender",icon:e.jsx(U,{name:"bookOpen",size:20}),label:"Continue",onClick:d,preset:"green",size:"lg"})]})}):null}function vr({act:t,isTurnGenerating:s,onContinue:n}){return e.jsx("div",{"aria-labelledby":"act-intro-heading","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h2",{className:"mb-4 text-center text-3xl font-bold text-amber-400",id:"act-intro-heading",children:`Act ${String(t.actNumber)}: ${t.title}`}),e.jsx("div",{className:"mt-4 w-4/5 flex-1 max-h-[60vh] overflow-y-auto rounded p-4 text-left text-slate-300 space-y-6",children:e.jsx("section",{className:"space-y-2 text-lg",children:e.jsx("p",{className:"whitespace-pre-line text-center",children:t.description})})}),e.jsxs("div",{className:"mt-8 flex items-center space-x-4 self-center",children:[e.jsx(N,{ariaLabel:"Continue",label:"Continue",onClick:n,preset:"blue",size:"lg"}),s?e.jsx(Ne,{showText:!1,size:"sm"}):null]})]})})}function Nr({heroSheet:t,storyArc:s,onClose:n}){return e.jsx("div",{"aria-labelledby":"victory-heading","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold",id:"victory-heading",children:"Victory!"}),e.jsx("p",{className:"mt-4",children:`You guided ${t.name}, ${t.occupation}, through ${s.title}.`}),e.jsx("div",{className:"mt-8 w-4/5 max-h-[60vh] flex-1 overflow-y-auto rounded p-4 text-left",children:e.jsx("ul",{className:"space-y-6",children:s.acts.map(a=>e.jsxs("li",{children:[e.jsx("p",{className:"font-semibold text-center",children:`Act ${String(a.actNumber)}: ${a.title}`}),e.jsx("p",{className:"mt-2",children:a.description})]},a.actNumber))})}),e.jsx("div",{className:"mt-8 self-center",children:e.jsx(N,{ariaLabel:"Return to Title Menu",label:"Return to Title",onClick:n,preset:"blue",size:"lg"})})]})})}function kr({label:t,text:s}){return e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:t}),": ",s]})}function ja({option:t,onSelect:s,disabled:n=!1}){const a=l.useCallback(()=>{s(t)},[s,t]);return e.jsx(N,{ariaLabel:`Select character ${t.name}${n?" (selected)":""}`,disabled:n,label:e.jsxs("div",{className:"flex flex-col items-start text-left w-full",style:{minHeight:"120px"},children:[e.jsx("h3",{className:"text-xl font-semibold text-amber-400 mb-2",children:t.name}),e.jsx("p",{className:"text-sm text-slate-300 leading-snug line-clamp-8",children:t.description}),n?e.jsx("p",{className:"text-xs text-orange-300 mt-1 italic",children:"(Selected)"}):null]}),onClick:a,preset:"slate",variant:"standard"})}ja.defaultProps={disabled:!1};function wr({isVisible:t,theme:s,heroGender:n,WorldSheet:a,options:r,onHeroData:d,onComplete:i}){const[x,f]=l.useState(null),[y,h]=l.useState(null),[b,c]=l.useState(null),[u,m]=l.useState(!1),[o,p]=l.useState(!1),g=l.useCallback(k=>{f(k.name),m(!0),(async()=>{const T=await ll(s,n,a,k.name,k.description),w={name:k.name,heroSheet:(T==null?void 0:T.heroSheet)??null,heroBackstory:(T==null?void 0:T.heroBackstory)??null,storyArc:(T==null?void 0:T.storyArc)??null};h(w.heroSheet),c(w.heroBackstory),m(!1),p(!0),d(w).finally(()=>{p(!1)})})()},[s,n,a,d]),v=l.useCallback(()=>{x&&i()},[x,i]),C=l.useCallback(k=>e.jsx(ja,{disabled:x===k.name,onSelect:g,option:k},k.name),[x,g]);return t?e.jsx("div",{"aria-labelledby":"character-select-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content character-select-content-area flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h1",{className:"mb-4 text-center text-3xl font-bold text-sky-300",id:"character-select-title",children:"Choose Your Character"}),e.jsxs("p",{className:"mb-6 max-w-2xl text-center text-sm text-slate-300",children:["Explore the world of"," ",e.jsx("span",{className:"font-semibold",children:s.name}),". ","Select a character to begin your adventure."]}),u?e.jsx(Ne,{}):y&&b?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-4 w-4/5 flex-1 max-h-[60vh] overflow-y-auto rounded p-4 text-left text-slate-300 space-y-8",children:[e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h2",{className:"text-center font-semibold text-amber-400",children:y.name}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Occupation:"})," ",y.occupation]}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Traits:"})," ",y.traits.join(", ")]}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Starting Items:"})," ",y.startingItems.join(", ")]})]}),e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h3",{className:"text-center font-semibold text-sky-300",children:"Backstory"}),e.jsx("div",{className:"space-y-2 whitespace-pre-line",children:[{label:"5 years ago",text:b.fiveYearsAgo},{label:"1 year ago",text:b.oneYearAgo},{label:"6 months ago",text:b.sixMonthsAgo},{label:"1 month ago",text:b.oneMonthAgo},{label:"1 week ago",text:b.oneWeekAgo},{label:"Yesterday",text:b.yesterday},{label:"Now",text:b.now}].map(({label:k,text:T})=>e.jsx(kr,{label:k,text:T},k))})]}),e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h3",{className:"text-center font-semibold text-sky-300",children:"World Information"}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Geography:"})," ",a.geography]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Climate:"})," ",a.climate]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Technology Level:"})," ",a.technologyLevel]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Supernatural Elements:"})," ",a.supernaturalElements]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Major Factions:"})," ",a.majorFactions.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Key Resources:"})," ",a.keyResources.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Cultural Notes:"})," ",a.culturalNotes.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Notable Locations:"})," ",a.notableLocations.join(`
`)]})]})]}),e.jsxs("div",{className:"mt-8 flex items-center justify-center space-x-4",children:[e.jsx(N,{ariaLabel:"Begin the adventure",icon:e.jsx(U,{name:"bookOpen",size:20}),label:"Begin the Journey",onClick:v,preset:"green",size:"lg"}),o?e.jsx(Ne,{showText:!1,size:"sm"}):null]})]}):e.jsx("div",{className:"mt-4 w-4/5 flex-1 grid grid-cols-1 gap-4 overflow-y-auto p-4 md:grid-cols-2",children:r.map(C)})]})}):null}function Sr({allNPCs:t,theme:s,isVisible:n,onClose:a}){const r=l.useMemo(()=>[...t].sort((i,x)=>i.name.localeCompare(x.name)),[t]),d=l.useCallback(i=>{var y;const x=i.lastKnownLocation,f=typeof x=="string"&&x!=="Unknown";if(s&&Wl.includes(i.presenceStatus)){const h=i.presenceStatus==="companion",b=h?"companion":"nearbyNpc",c=h?"text-green-300":"text-sky-300",u=h?"(Companion)":"(Nearby)",m=(y=i.preciseLocation)==null?void 0:y.trim();return e.jsxs("p",{className:"text-sm text-slate-300 flex items-center",children:[e.jsx(U,{color:h?"green":"sky",inline:!0,marginRight:4,name:b,size:16}),e.jsx("span",{className:`ml-1 ${c} italic`,children:m&&m.length>0?e.jsxs(e.Fragment,{children:[m," ",u]}):u})]})}return f?e.jsx("p",{className:"text-sm text-slate-300 flex items-center",children:e.jsxs("span",{className:"ml-1 italic",children:[x," ","(",i.presenceStatus,")"]})}):e.jsx("p",{className:"text-sm text-slate-500 flex items-center",children:e.jsxs("span",{className:"ml-1 italic",children:["(",i.presenceStatus,")"]})})},[s]);return e.jsx("div",{"aria-labelledby":"knowledge-base-title","aria-modal":"true",className:`animated-frame ${n?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(N,{ariaLabel:"Close knowledge base",icon:e.jsx(U,{name:"x",size:20}),onClick:a,size:"sm",variant:"close"}),e.jsxs("div",{className:"knowledge-base-content-area",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-6 text-center",id:"knowledge-base-title",children:"Knowledge Base"}),r.length===0&&n?e.jsx("p",{className:"text-slate-300 italic text-center",children:"No knowledge has been recorded yet."}):null,n?e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"kb-group-title",children:"NPCs"}),r.length>0&&e.jsx("div",{className:"kb-card-grid",children:r.map(i=>e.jsxs("div",{className:"kb-card",children:[e.jsx("div",{className:"kb-card-name-header",children:i.name}),i.aliases&&i.aliases.length>0?e.jsx("p",{className:"kb-card-aliases",children:i.aliases.join(", ")}):null,e.jsx("p",{className:"kb-card-description",children:i.description}),e.jsx("div",{className:"mt-2 pt-2 border-t border-slate-600",children:d(i)}),i.knowsPlayerAs.length>0?e.jsxs("p",{className:"text-sm text-slate-400",children:["Knows you as:"," ",i.knowsPlayerAs.join(", ")]}):e.jsx("p",{className:"text-sm text-slate-500 italic",children:"Does not know your name."})]},i.name))})]}):null]})]})})}const Er=new Set(["feature","room","interior"]),jt=t=>{if(t.visualRadius)return t.visualRadius;switch(t.type){case"region":return Ee*2.4;case"location":return Ee*2;case"settlement":return Ee*1.8;case"district":return Ee*1.6;case"exterior":return Ee*1.4;case"interior":return Ee*1.2;case"room":return Ee*.8;case"feature":return Ee*.6;default:return Ee*.6}},Ca=(t,s,n)=>{if(!t)return[];const a=t.split(" "),r=[];let d="";for(const i of a){if(r.length===n)break;if(d.length===0)d=i;else if(d.length+i.length+1<=s)d+=` ${i}`;else{if(r.push(d),r.length===n){if(i){const x=r[n-1];x.length>3?r[n-1]=x.slice(0,-3)+"...":r[n-1]=".."}d="";break}d=i}}if(d&&r.length<n?r.push(d):d&&r.length===n&&r[n-1]&&!r[n-1].endsWith("...")&&(r[n-1].length>3?r[n-1]=r[n-1].slice(0,-3)+"...":r[n-1]=".."),r.length===n&&t.split(" ").length>a.indexOf(d.split(" ")[0])+d.split(" ").length){const i=r[n-1];i&&i.length>3&&!i.endsWith("...")?r[n-1]=i.slice(0,Math.max(0,i.length-3))+"...":i&&!i.endsWith("...")&&(r[n-1]="..")}return r},lt=t=>!!t&&Er.has(t),va=t=>t==="feature",Mr=(t,s)=>{const n=new Map(t.map(o=>[o.id,o])),a=new Map;t.forEach(o=>{if(o.parentNodeId){const p=a.get(o.parentNodeId)??[];p.push(o),a.set(o.parentNodeId,p)}});const r=new Map,d=o=>{if(!o)return 0;const p=r.get(o.id);if(p!==void 0)return p;const g=o.parentNodeId?n.get(o.parentNodeId):void 0,v=g?d(g)+1:0;return r.set(o.id,v),v};t.forEach(o=>d(o));const i=o=>a.has(o.id),x=o=>lt(o.type)?7:12,f={},y=o=>{const p=f[o.id];if(p)return p;const g=lt(o.type)||!i(o)?20:25,v=Ca(o.placeName,g,ia);return f[o.id]=v,v},h=o=>y(o).length*x(o)*St,b=o=>Math.max(...y(o).map(p=>p.length*x(o)*.6)),c=(o,p)=>{const g=b(o),v=h(o);if(va(o.type))return{x:o.position.x-g/2,y:o.position.y-v/2,width:g,height:v*2};const C=jt(o)+wt+p;return{x:o.position.x-g/2,y:o.position.y+C,width:g,height:v}},u={};t.forEach(o=>{u[o.id]=0});const m=(o,p)=>o.x<p.x+p.width&&o.x+o.width>p.x&&o.y<p.y+p.height&&o.y+o.height>p.y;return a.forEach(o=>{const p=[...o].sort((g,v)=>g.position.x-v.position.x);for(let g=1;g<p.length;g++){const v=p[g-1],C=p[g];let k=c(v,u[v.id]),T=c(C,u[C.id]);if(m(k,T)){const w=k.y+k.height-T.y+s;C.type!=="feature"?(u[C.id]+=w,T=c(C,u[C.id])):v.type!=="feature"&&(u[v.id]+=w,k=c(v,u[v.id]))}}}),t.forEach(o=>{if(o.type==="feature")return;const p=t.filter(g=>g.type==="feature"&&Zs(g,o,n));for(const g of p){const v=c(o,u[o.id]),C=c(g,u[g.id]);if(m(v,C)){const k=C.y+C.height-v.y+s;u[o.id]+=k}}}),u},Ys=(t,s)=>{const n=t.position.x,a=t.position.y,r=s.position.x,d=s.position.y,i=r-n,x=d-a,f=Math.sqrt(i*i+x*x)||1,y=(n+r)/2,h=(a+d)/2,b=f*.3,c=-x/f,u=i/f,m=y+c*b,o=h+u*b;return`M ${String(n)} ${String(a)} Q ${String(m)} ${String(o)} ${String(r)} ${String(d)}`},Lr={};function Tr({nodes:t,edges:s,currentMapNodeId:n,destinationNodeId:a,itemPresenceByNode:r=Lr,onSelectDestination:d,labelOverlapMarginPx:i,itemIconScale:x,initialViewBox:f,onViewBoxChange:y,isInteractive:h}){const b=rl(f,y),{svgRef:c,viewBox:u,handleMouseDown:m,handleMouseMove:o,handleMouseUp:p,handleMouseLeave:g,handleWheel:v,handleTouchStart:C,handleTouchMove:k,handleTouchEnd:T}=b,{tooltip:w,tooltipScreenPosition:_,isTooltipLocked:$,handleMouseLeaveGeneral:I,handleSvgClick:W,handleEdgeMouseEnterById:V,handleNodeMouseEnterById:K,handleNodeClickById:Q,handleDestinationClick:z}=il({nodes:t,edges:s,svgRef:c,viewBox:u,destinationNodeId:a,onSelectDestination:d}),A=l.useMemo(()=>new Map(t.map(j=>[j.id,j])),[t]),H=l.useMemo(()=>Mr(t,i),[t,i]),R=l.useMemo(()=>{const j=new Map,M=L=>{if(!L)return 0;const S=j.get(L.id);if(S!==void 0)return S;const Y=L.parentNodeId?A.get(L.parentNodeId):void 0,D=Y?M(Y)+1:0;return j.set(L.id,D),D};return t.forEach(L=>M(L)),j},[t,A]),B=l.useMemo(()=>[...t].sort((j,M)=>(R.get(j.id)??0)-(R.get(M.id)??0)),[t,R]),G=l.useMemo(()=>{if(!a)return null;const j=A.get(a)??null,M=n?A.get(n)??null:null;return!j||M&&(M.id===j.id||Zs(M,j,A))?null:e.jsx("polygon",{className:"map-destination-marker",pointerEvents:"none",points:"0,-14 10,0 0,14 -10,0",transform:`translate(${String(j.position.x)}, ${String(j.position.y)})`})},[a,A,n]);return t.length===0?e.jsx("div",{className:"map-content-area",children:e.jsx("p",{className:"text-slate-500 italic",children:"No map data available."})}):e.jsxs("div",{className:"map-content-area",children:[e.jsx("svg",{className:"map-svg-container",onClick:h?W:void 0,onMouseDown:h?m:void 0,onMouseLeave:h?g:void 0,onMouseMove:h?o:void 0,onMouseUp:h?p:void 0,onTouchEnd:h?T:void 0,onTouchMove:h?k:void 0,onTouchStart:h?C:void 0,onWheel:h?v:void 0,preserveAspectRatio:"xMidYMid meet",ref:c,style:{pointerEvents:h?"auto":"none",touchAction:h?void 0:"none"},viewBox:u,children:e.jsxs("g",{children:[s.map(j=>{const M=A.get(j.sourceNodeId),L=A.get(j.targetNodeId);if(!M||!L)return null;let S="map-edge";return S+=` ${j.type.replace(/\s+/g,"_").toLowerCase()}`,S+=` ${j.status.replace(/\s+/g,"_").toLowerCase()}`,e.jsx("g",{className:"map-edge-group","data-edge-id":j.id,onMouseEnter:h?V:void 0,onMouseLeave:h?I:void 0,children:j.type==="shortcut"?e.jsxs(e.Fragment,{children:[e.jsx("path",{d:Ys(M,L),fill:"none",stroke:"transparent",strokeWidth:Us}),e.jsx("path",{className:S,d:Ys(M,L)})]}):e.jsxs(e.Fragment,{children:[e.jsx("line",{stroke:"transparent",strokeWidth:Us,x1:M.position.x,x2:L.position.x,y1:M.position.y,y2:L.position.y}),e.jsx("line",{className:S,x1:M.position.x,x2:L.position.x,y1:M.position.y,y2:L.position.y})]})},j.id)}),B.map(j=>{let M="map-node-circle";M+=` ${j.type}`,j.id===n&&(M+=" current");const L=j.status.replace(/\s+/g,"_").toLowerCase();M+=` ${L}`;const S=jt(j);return e.jsxs("g",{className:"map-node","data-node-id":j.id,onClick:h?Q:void 0,onMouseLeave:h?I:void 0,transform:`translate(${String(j.position.x)}, ${String(j.position.y)})`,children:[e.jsx("circle",{className:M,"data-node-id":j.id,onMouseEnter:j.type==="feature"?K:void 0,onMouseLeave:j.type==="feature"?I:void 0,pointerEvents:j.type==="feature"?"visible":"none",r:S}),e.jsx("circle",{className:"map-node-hover-ring","data-node-id":j.id,fill:"none",onMouseEnter:h?K:void 0,onMouseLeave:h?I:void 0,pointerEvents:h?"stroke":"none",r:S,stroke:"transparent",strokeWidth:8})]},j.id)}),G,B.map(j=>{const M=r[j.id]??{hasUseful:!1,hasVehicle:!1};if(!M.hasUseful&&!M.hasVehicle)return null;const S=jt(j)+wt*1.5,Y=Ee*2*x,D=j.position.x+S*Math.sin(20*Math.PI/180)-Y/2,ee=j.position.y-S*Math.cos(20*Math.PI/180)-Y/2,le=j.position.x+S*Math.sin(340*Math.PI/180)-Y/2,re=j.position.y-S*Math.cos(340*Math.PI/180)-Y/2;return e.jsxs("g",{children:[M.hasUseful?e.jsx("g",{pointerEvents:"none",transform:`translate(${String(D)}, ${String(ee)})`,children:e.jsx(U,{color:"green",name:"mapItemBox",size:Y,wrapper:"g"})}):null,M.hasVehicle?e.jsx("g",{pointerEvents:"none",transform:`translate(${String(le)}, ${String(re)})`,children:e.jsx(U,{color:"green",name:"mapWheel",size:Y,wrapper:"g"})}):null]},`${j.id}-icons`)}),B.map(j=>{const M=lt(j.type)?20:25,L=Ca(j.placeName,M,ia),S=jt(j),Y=lt(j.type)?7:12,D=S+wt+(H[j.id]??0),ee=va(j.type)?-(L.length-1)*.5*St+.3:D/Y;return e.jsx("text",{className:`map-node-label${lt(j.type)?j.type==="feature"?" feature-label":j.type==="room"?" room-label":" interior-label":""}`,"data-node-id":j.id,onMouseEnter:K,onMouseLeave:I,pointerEvents:"visible",transform:`translate(${String(j.position.x)}, ${String(j.position.y)})`,children:L.map((le,re)=>e.jsx("tspan",{dy:re===0?`${String(ee)}em`:`${String(St)}em`,x:"0",children:le},`${j.id}-${le}`))},`label-${j.id}`)})]})}),w&&_?e.jsxs("div",{className:`map-tooltip anchor-${w.anchor}`,style:{top:_.y,left:_.x,pointerEvents:$?"auto":"none"},children:[$&&w.nodeId?e.jsx("div",{className:"mb-1",children:e.jsx(N,{ariaLabel:w.nodeId===a?"Remove Destination":"Set Destination","data-node-id":w.nodeId,label:w.nodeId===a?"Remove Destination":"Set Destination",onClick:z,preset:"amber",size:"sm",variant:"standard"})}):null,w.content.split(`
`).map((j,M)=>e.jsxs(l.Fragment,{children:[M===0?e.jsx("strong",{children:j}):j,M<w.content.split(`
`).length-1&&e.jsx("br",{})]},`${String(w.nodeId)}-${j}`))]}):null]})}function yt({label:t,id:s,value:n,onChange:a,min:r,max:d,step:i,explanation:x=""}){const f=l.useCallback(y=>{a(parseFloat(y.target.value))},[a]);return e.jsxs("div",{className:"map-control-group",children:[e.jsxs("label",{className:"map-control-label",htmlFor:s,children:[t,": ",n.toFixed(i<1?2:0)]}),e.jsx("input",{className:"map-control-input",id:s,max:d,min:r,onChange:f,step:i,type:"range",value:n}),x?e.jsx("p",{className:"map-control-explanation",children:x}):null]})}function Ir(t){const[s,n]=l.useState(!1),a=l.useCallback(()=>{n(m=>!m)},[]),{padding:r,setPadding:d,anglePadding:i,setAnglePadding:x,overlapMargin:f,setOverlapMargin:y,itemIconScale:h,setItemIconScale:b,onReset:c,onRefreshLayout:u}=t;return e.jsxs("div",{className:`map-controls-container ${s?"controls-expanded":""}`,children:[s?e.jsxs("div",{className:"map-layout-sliders-wrapper",children:[e.jsx(yt,{explanation:"Distance between parent and child levels",id:"layoutPadding",label:"Padding",max:60,min:5,onChange:d,step:1,value:r}),e.jsx(yt,{explanation:"Extra spacing between siblings",id:"layoutAnglePadding",label:"Angle Padding",max:.5,min:0,onChange:x,step:.01,value:i}),e.jsx(yt,{explanation:"Extra spacing when labels overlap",id:"overlapMargin",label:"Overlap Margin",max:10,min:0,onChange:y,step:1,value:f}),e.jsx(yt,{explanation:"Relative size of item markers",id:"itemIconScale",label:"Icon Size",max:1,min:.2,onChange:b,step:.1,value:h}),e.jsx("div",{className:"mt-2",children:e.jsx(N,{ariaLabel:"Reset to Defaults",label:"Reset to Defaults",onClick:c,preset:"orange",variant:"standard"})})]}):null,e.jsxs("div",{className:"map-action-buttons-row",children:[e.jsx(N,{ariaLabel:"Toggle Layout Controls",label:`${s?"Hide":"Show"} Layout Controls`,onClick:a,preset:"blue",size:"sm",variant:"compact"}),e.jsx(N,{ariaLabel:"Refresh Layout",label:"Refresh Layout",onClick:u,preset:"blue",size:"sm",variant:"compact"})]})]})}function Pr({adventureName:t,currentMapNodeId:s,destinationNodeId:n,initialLayoutConfig:a,initialViewBox:r,isVisible:d,itemPresenceByNode:i,mapData:x,onClose:f,onLayoutConfigChange:y,onNodesPositioned:h,onSelectDestination:b,onTransitionEnd:c,onViewBoxChange:u}){const[m,o]=l.useState([]),[p,g]=l.useState(a.IDEAL_EDGE_LENGTH),[v,C]=l.useState(a.NESTED_PADDING),[k,T]=l.useState(a.NESTED_ANGLE_PADDING),w=wt,_=St,[$,I]=l.useState(a.LABEL_OVERLAP_MARGIN_PX),[W,V]=l.useState(a.ITEM_ICON_SCALE);l.useEffect(()=>{const B=a.IDEAL_EDGE_LENGTH,G=a.NESTED_PADDING,j=a.NESTED_ANGLE_PADDING,M=a.LABEL_OVERLAP_MARGIN_PX,L=a.ITEM_ICON_SCALE;g(S=>S===B?S:B),C(S=>S===G?S:G),T(S=>S===j?S:j),I(S=>S===M?S:M),V(S=>S===L?S:L)},[a]);const K=l.useMemo(()=>({IDEAL_EDGE_LENGTH:p,NESTED_PADDING:v,NESTED_ANGLE_PADDING:k,LABEL_MARGIN_PX:w,LABEL_LINE_HEIGHT_EM:_,LABEL_OVERLAP_MARGIN_PX:$,ITEM_ICON_SCALE:W}),[p,v,k,w,_,$,W]);l.useEffect(()=>{const B=setTimeout(()=>{y(K)},500);return()=>{clearTimeout(B)}},[K,y]);const Q=l.useMemo(()=>x.nodes,[x.nodes]),z=l.useMemo(()=>x.edges,[x.edges]),A=l.useCallback(()=>{const B=[...Q],G=ea(B,{padding:v,anglePadding:k});o(G),h(G)},[Q,v,k,h]);l.useEffect(()=>{d&&A()},[d,A]);const H=l.useCallback(()=>{A()},[A]),R=l.useCallback(()=>{g(ol),C(cl),T(dl),I(Hl),V(Jl)},[]);return e.jsx("div",{"aria-hidden":!d,"aria-labelledby":"map-display-title","aria-modal":"true",className:`animated-frame ${d?"open":""}`,onTransitionEnd:c,role:"dialog",style:{pointerEvents:d?"auto":"none"},children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(N,{ariaLabel:"Close map view",icon:e.jsx(U,{name:"x",size:20}),onClick:f,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-xl font-bold text-teal-400 mb-2 text-center",id:"map-display-title",children:t?`Map: ${t}`:"Map"}),e.jsx("p",{className:"text-center text-xs text-slate-300 mb-1",children:"Pan by dragging, zoom with the mouse wheel or pinch. Hover for details."}),e.jsx(Tr,{currentMapNodeId:s,destinationNodeId:n,edges:z,initialViewBox:r,isInteractive:d,itemIconScale:W,itemPresenceByNode:i,labelOverlapMarginPx:$,nodes:m,onSelectDestination:b,onViewBoxChange:u}),e.jsx(Ir,{anglePadding:k,itemIconScale:W,onRefreshLayout:H,onReset:R,overlapMargin:$,padding:v,setAnglePadding:T,setItemIconScale:V,setOverlapMargin:I,setPadding:C})]})})}function fs({isOpen:t,title:s,message:n,onConfirm:a,onCancel:r,confirmText:d="Confirm",cancelText:i="Cancel",confirmPreset:x="sky"}){const f=l.useCallback(h=>{h.stopPropagation()},[]);if(!t)return null;const y=n;return e.jsxs("div",{"aria-labelledby":"confirmation-dialog-title","aria-modal":"true",className:"fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center z-[100] p-4 backdrop-blur-sm",onClick:r,role:"dialog",children:[e.jsxs("div",{className:"bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-lg transform transition-all duration-300 ease-out scale-95 opacity-0 animate-dialog-enter",onClick:f,style:{animationFillMode:"forwards"},children:[e.jsx("h2",{className:"text-2xl font-bold text-sky-300 mb-5",id:"confirmation-dialog-title",children:s}),e.jsx("div",{className:"text-slate-300 mb-8 text-base leading-relaxed",children:y}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(N,{ariaLabel:i,label:i,onClick:r,preset:"slate",size:"md",variant:"compact"}),e.jsx(N,{ariaLabel:d,label:d,onClick:a,preset:x,size:"md",variant:"compact"})]})]}),e.jsx("style",{children:`
        @keyframes dialog-enter {
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        .animate-dialog-enter {
          animation: dialog-enter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
      `})]})}fs.defaultProps={cancelText:"Cancel",confirmPreset:"sky",confirmText:"Confirm"};const Qs=t=>t.map(s=>`${s.id}|${s.placeName}|${s.description}`).sort().join("||"),Xs=t=>t.map(s=>`${s.id}|${s.name}|${s.description}`).sort().join("||");ze()||console.error("Gemini API key is not set. Image visualization will not work.");function Ar({currentSceneDescription:t,theme:s,mapData:n,allNPCs:a,localTime:r,localEnvironment:d,localPlace:i,isVisible:x,onClose:f,setGeneratedImage:y,cachedImageUrl:h,cachedImageScene:b}){const[c,u]=l.useState(null),[m,o]=l.useState(!1),[p,g]=l.useState(null),[v,C]=l.useState(1),[k,T]=l.useState({x:0,y:0}),[w,_]=l.useState(!1),[$,I]=l.useState(null),[W,V]=l.useState(null),K=l.useRef(null),Q=l.useRef(n),z=l.useRef(a),[A,H]=l.useState(()=>Qs(n)),[R,B]=l.useState(()=>Xs(a));l.useEffect(()=>{Q.current=n,H(E=>{const F=Qs(n);return F===E?E:F})},[n]),l.useEffect(()=>{z.current=a,B(E=>{const F=Xs(a);return F===E?E:F})},[a]);const G=(E,F,X)=>Math.min(X,Math.max(F,E)),j=l.useCallback(E=>{E.cancelable&&E.preventDefault();const F=E.deltaY<0?1.1:.9;C(X=>G(X*F,1,4))},[]),M=l.useCallback(E=>{_(!0),I({x:E.clientX,y:E.clientY})},[]),L=l.useCallback(E=>{if(!w||!$)return;const F=E.clientX-$.x,X=E.clientY-$.y;T(oe=>({x:oe.x+F,y:oe.y+X})),I({x:E.clientX,y:E.clientY})},[w,$]),S=l.useCallback(()=>{_(!1),I(null)},[]),Y=(E,F)=>Math.sqrt((E.clientX-F.clientX)**2+(E.clientY-F.clientY)**2),D=l.useCallback(E=>{E.cancelable&&E.preventDefault(),E.touches.length===1?(_(!0),I({x:E.touches[0].clientX,y:E.touches[0].clientY}),V(null)):E.touches.length===2&&(_(!1),I(null),V(Y(E.touches[0],E.touches[1])))},[]),ee=l.useCallback(E=>{if(E.cancelable&&E.preventDefault(),E.touches.length===1&&w&&$){const F=E.touches[0],X=F.clientX-$.x,oe=F.clientY-$.y;T(se=>({x:se.x+X,y:se.y+oe})),I({x:F.clientX,y:F.clientY})}else if(E.touches.length===2&&W!==null){const F=Y(E.touches[0],E.touches[1]);if(F===0)return;C(X=>G(X*(F/W),1,4)),V(F)}},[w,$,W]),le=l.useCallback(E=>{E.touches.length<2&&V(null),E.touches.length<1&&(_(!1),I(null))},[]);l.useEffect(()=>{C(1),T({x:0,y:0})},[c]);const re=l.useCallback(async()=>{if(!ul||!s){g("Image generation service or theme is not available."),o(!1),xs(null);return}o(!0),xs("visualize_scene"),g(null);const E=`A detailed, digital painting in ${ml(s)} without ANY text on it.
    Aspect ratio 4:3.
    It is ${r}. ${d}. ${i}. ${t}`;let F=E;const X=[];Q.current.forEach(O=>{t.toLowerCase().includes(O.placeName.toLowerCase())&&(F+=` The ${O.placeName} is prominent, described as: ${O.description||"A notable location."}.`,X.push(O.placeName))});const oe=[];z.current.forEach(O=>{t.toLowerCase().includes(O.name.toLowerCase())&&(F+=` ${O.name} here, appearing as: ${O.description}.`,oe.push(O.name))}),F+=" Focus on creating a faithful representation based on this description. Do not generate any text on the image.";const se=await hl(`Rewrite the following scene description into a safe and aestetic visual depiction suitable for highly censored image generation. Only include the elements that are definitely present in the scene and omit anything non-visual, that is mentioned only for unrelated context. Preserve all details of the landscape or environment. Mention time, weather, mood of the environment. Preserve small details. Avoid any depressing, explicit or unsafe elements. Absolutely avoid nudity or corpses.

Scene:
${F}`,E,"Respond ONLY with the visual description of the scene.","ImagePromptSanitizer");try{const O=await pl(se,"4:3");if(O){const J=`data:image/jpeg;base64,${O}`;u(J),y(J,t)}else throw new Error("No image data received from API.")}catch(O){console.error("Error generating image:",O);const J=O instanceof Error?O.message:"Unknown error during image generation.";xl(O)===400&&g("Fallback image generation failed."),J.includes("quota")||J.includes("billing")?g("Image generation quota exceeded or billing issue. Please check your Google Cloud project."):J.includes("API key not valid")?g("Image generation failed: API key is not valid. Please check configuration."):g(`Failed to visualize scene: ${J.substring(0,100)}`)}finally{o(!1),xs(null)}},[t,s,r,d,i,y]),pe=l.useCallback(()=>{re()},[re]);return l.useEffect(()=>{x&&(h&&b===t?(u(h),o(!1),g(null)):re())},[x,h,b,t,A,R,re]),e.jsx("div",{"aria-labelledby":"visualizer-title","aria-modal":"true",className:`animated-frame ${x?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content visualizer-content-area",children:[e.jsx(N,{ariaLabel:"Close visualizer",icon:e.jsx(U,{name:"x",size:20}),onClick:f,size:"sm",variant:"close"}),m?e.jsx("div",{className:"visualizer-spinner-container",children:e.jsx(Ne,{})}):null,!m&&p?e.jsxs("div",{className:"visualizer-error-container",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-400 mb-2",id:"visualizer-title",children:"Vision Failed"}),e.jsx("p",{children:p}),e.jsx("button",{className:"mt-4 px-6 py-2 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-md shadow transition-colors",onClick:pe,type:"button",children:"Retry Visualization"})]}):null,!m&&!p&&c?e.jsxs("div",{className:"visualizer-image-container",onMouseDown:M,onMouseLeave:S,onMouseMove:L,onMouseUp:S,onTouchEnd:le,onTouchMove:ee,onTouchStart:D,onWheel:j,role:"presentation",children:[e.jsx("img",{alt:"Scene visualization",className:"visualizer-image",ref:K,src:c,style:{transform:`translate(${String(k.x)}px, ${String(k.y)}px) scale(${String(v)})`}}),e.jsx("h2",{className:"sr-only",id:"visualizer-title",children:"Scene Visualization"})]}):null,!m&&!p&&!c&&x?e.jsx("div",{className:"visualizer-spinner-container",children:e.jsx("p",{className:"mt-2 text-lg text-slate-300",id:"visualizer-title",children:"Preparing to visualize..."})}):null]})})}function Na({isBook:t,isJournal:s,chapters:n,chapterIndex:a,unlockedChapterCount:r,isLoading:d,canInspectItem:i,canInspectJournal:x,canWriteJournal:f,isWritingJournal:y,onInspect:h,onWriteJournal:b,onPrev:c,onNext:u,onSelectChapter:m}){const o=l.useCallback(g=>{m(Number(g.target.value))},[m]);if(!t&&!s)return null;const p=d||(t&&!s?a>=r||a===n.length:a>=n.length-1);return e.jsxs("div",{className:"flex justify-center items-center gap-2 mb-2",children:[s&&h?e.jsx(N,{ariaLabel:"Inspect",disabled:!i||!x,label:"Inspect",onClick:h,preset:"indigo",size:"sm",variant:"compact"}):null,e.jsx(N,{ariaLabel:"Previous chapter",disabled:a===0,label:"â",onClick:c,preset:"slate",size:"lg",variant:"toolbar"}),e.jsx("select",{"aria-label":"Select chapter",className:"bg-slate-800 text-white text-md h-9 p-2",onChange:o,value:a,children:t&&!s?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:0,children:"ToC"}),n.slice(0,r).map((g,v)=>e.jsx("option",{value:v+1,children:g.heading},g.heading))]}):n.map((g,v)=>e.jsx("option",{value:v,children:g.heading},g.heading))}),e.jsx(N,{ariaLabel:"Next chapter",disabled:p,label:"âº",onClick:u,preset:"slate",size:"lg",variant:"toolbar"}),s&&b?e.jsx(N,{ariaLabel:"Write entry",disabled:!f||y,label:"Write",onClick:b,preset:"blue",size:"sm",title:"Write a new journal entry",variant:"compact"}):null]})}Na.defaultProps={onInspect:void 0,onWriteJournal:void 0};const gs=(t,s)=>t.split(/(\*\*[^*]+\*\*|\*[^*]+\*)/g).map((a,r)=>{const d=`${s}-${String(r)}-${a}`;if(a.startsWith("**")&&a.endsWith("**")){const i=a.slice(2,-2);return e.jsx("strong",{children:i},`b-${d}`)}if(a.startsWith("*")&&a.endsWith("*")){const i=a.slice(1,-1);return e.jsx("em",{children:i},`i-${d}`)}return e.jsx(bs.Fragment,{children:a},`t-${d}`)}),$r=t=>{const s=t.replace(/\r\n/g,`
`).split(/\n/),n=[],a=[];let r=[];const d=/^(#+)\s+(.*)$/,i=()=>{if(r.length===0)return;const h=n.length,b=r.map((c,u)=>{const m=`p-${String(h)}-${String(u)}`,o=gs(c,m),p=u<r.length-1?e.jsx("br",{}):null;return e.jsxs(bs.Fragment,{children:[o,p]},m)});n.push(e.jsx("p",{children:b},`p-${String(h)}`)),r=[]},x=()=>{const h=a.pop();if(!h)return;const{items:b,level:c}=h,u=`ul-${String(c)}-${String(n.length)}`,m=e.jsx("ul",{className:"list-disc list-inside ml-4 space-y-1",children:b},u);a.length===0?n.push(m):a[a.length-1].items.push(m)},f=h=>{for(;a.length>h+1;)x()},y=/^(\s*)\*\s+(.*)$/;return s.forEach(h=>{if(h.trim()==="--- torn ---"){i(),f(-1),n.push(e.jsx("hr",{"aria-hidden":"true",className:"torn-divider"},`torn-${String(n.length)}`));return}const b=d.exec(h);if(b){i(),f(-1);const u=b[2],m=`h-${String(n.length)}`,o=gs(u,m);n.push(e.jsx("p",{children:e.jsx("strong",{children:o})},m));return}const c=y.exec(h);if(c){i();const u=c[1].length,m=Math.floor(u/2);for(f(m);a.length<=m;)a.push({level:a.length,items:[]});const o=c[2],p=`li-${String(m)}-${String(a[m].items.length)}`,g=gs(o,p);a[m].items.push(e.jsx("li",{children:g},p))}else h.trim()===""?(i(),f(-1)):r.push(h)}),i(),f(-1),n};function Dr({pendingWrite:t,isLoading:s,isBook:n,isJournal:a,chapterIndex:r,chapters:d,textClassNames:i,displayedText:x,isImageItem:f,imageUrl:y,tearOrientation:h,theme:b,itemName:c}){return t||s?e.jsx(Ne,{}):n&&!a&&r===0?e.jsx("ul",{className:`p-5 mt-4 list-disc list-inside overflow-y-auto text-left ${i}`,children:d.map((u,m)=>e.jsx("p",{children:`${String(m+1)}. ${u.heading}`},u.heading))}):x||f&&y?e.jsxs("div",{className:`whitespace-pre-wrap text-lg overflow-y-auto p-5 mt-4 ${i} ${h?`torn-${h}`:""}`,children:[f&&y?e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx("img",{alt:c??"Item image",className:"max-h-[24rem] object-contain mask-gradient-edges",src:y})}):null,x?$r(x):null]}):a&&d.length===0?e.jsx("div",{className:`whitespace-pre-wrap text-lg overflow-y-auto p-5 mt-4 min-h-[20rem] tag-${b.playerJournalStyle}`}):null}function ka({item:t,theme:s,currentScene:n,storytellerThoughts:a,mapData:r,allNPCs:d,currentQuest:i,isVisible:x,startIndex:f=0,onClose:y,updateItemContent:h,onInspect:b,onWriteJournal:c,canWriteJournal:u=!0,canInspectJournal:m=!0,isWritingJournal:o=!1}){var j;const{chapters:p,chapterIndex:g,isBook:v,isJournal:C,isImageItem:k,unlockedChapterCount:T,showDecoded:w,textClassNames:_,tearOrientation:$,imageUrl:I,isLoading:W,pendingWrite:V,canInspectItem:K,handlePrevChapter:Q,handleNextChapter:z,handleSelectChapter:A,toggleDecoded:H,displayedText:R}=gl({item:t,theme:s,currentScene:n,storytellerThoughts:a,mapData:r,allNPCs:d,currentQuest:i,isVisible:x,startIndex:f,isWritingJournal:o,updateItemContent:h}),B=l.useCallback(M=>{M.target===M.currentTarget&&y()},[y]),G=!!((j=t==null?void 0:t.tags)!=null&&j.includes("recovered"));return e.jsx("div",{"aria-labelledby":"page-view-title","aria-modal":"true",className:`animated-frame ${x?"open":""}`,onClick:B,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content page-view-content-area",children:[e.jsx(N,{ariaLabel:"Close page",icon:e.jsx(U,{name:"x",size:20}),onClick:y,size:"sm",variant:"close"}),t!=null&&t.name?e.jsx("h2",{className:"text-2xl font-bold text-amber-400 mb-4 text-center",id:"page-view-title",children:t.name}):null,e.jsx(Na,{canInspectItem:K,canInspectJournal:m,canWriteJournal:u,chapterIndex:g,chapters:p,isBook:v,isJournal:C,isLoading:W,isWritingJournal:o,onInspect:b,onNext:z,onPrev:Q,onSelectChapter:A,onWriteJournal:c,unlockedChapterCount:T}),G?e.jsx("div",{className:"flex justify-center",children:e.jsx(N,{ariaLabel:w?"Show encoded text":"Show decoded text",label:w?"Hide":"Reveal",onClick:H,preset:w?"sky":"slate",pressed:w,size:"sm",variant:"toggle"})}):null,e.jsx(Dr,{chapterIndex:g,chapters:p,displayedText:R,imageUrl:I,isBook:v,isImageItem:k,isJournal:C,isLoading:W,itemName:(t==null?void 0:t.name)??null,pendingWrite:V,tearOrientation:$,textClassNames:_,theme:s})]})})}ka.defaultProps={canInspectJournal:!0,canWriteJournal:!0,isWritingJournal:!1,onInspect:void 0,onWriteJournal:void 0,startIndex:0};function Fr({isVisualizerVisible:t,onCloseVisualizer:s,visualizerImageUrl:n,visualizerImageScene:a,setGeneratedImage:r,currentScene:d,theme:i,mapData:x,allNPCs:f,localTime:y,localEnvironment:h,localPlace:b,isKnowledgeBaseVisible:c,onCloseKnowledgeBase:u,isMapVisible:m,onCloseMap:o,adventureName:p,currentMapNodeId:g,destinationNodeId:v,itemPresenceByNode:C,onSelectDestination:k,initialLayoutConfig:T,initialViewBox:w,onViewBoxChange:_,onNodesPositioned:$,onLayoutConfigChange:I,newGameFromMenuConfirmOpen:W,handleConfirmNewGameFromMenu:V,handleCancelNewGameFromMenu:K,loadGameFromMenuConfirmOpen:Q,handleConfirmLoadGameFromMenu:z,handleCancelLoadGameFromMenu:A,inventory:H,playerJournal:R,lastJournalWriteTurn:B,pageItemId:G,pageStartChapterIndex:j,isPageVisible:M,onClosePage:L,storytellerThoughts:S,currentQuest:Y,updateItemContent:D,updatePlayerJournalContent:ee,onItemInspect:le,canInspectJournal:re,onWriteJournal:pe,canWriteJournal:E,isWritingJournal:F}){const[X,oe]=l.useState(m),[se,O]=l.useState(m),J=l.useRef(null);l.useEffect(()=>{if(m){if(oe(!0),J.current!==null&&(clearTimeout(J.current),J.current=null),O(!1),typeof window<"u"){let ae=null,xe=null;return ae=window.requestAnimationFrame(()=>{xe=window.requestAnimationFrame(()=>{O(!0)})}),()=>{ae&&window.cancelAnimationFrame(ae),xe&&window.cancelAnimationFrame(xe)}}O(!0);return}O(!1)},[m]),l.useEffect(()=>{if(se){J.current!==null&&(clearTimeout(J.current),J.current=null);return}if(!X)return;const xe=(typeof window<"u"?window.setTimeout.bind(window):setTimeout)(()=>{oe(!1),J.current=null,O(!1)},400);return J.current=xe,()=>{clearTimeout(J.current??xe),J.current=null}},[se,X]),l.useEffect(()=>()=>{J.current!==null&&(clearTimeout(J.current),J.current=null)},[]);const ye=l.useCallback(ae=>{ae.target===ae.currentTarget&&(se||(oe(!1),J.current!==null&&(clearTimeout(J.current),J.current=null)))},[se]),Oe=l.useMemo(()=>X?e.jsx(Pr,{adventureName:p,currentMapNodeId:g,destinationNodeId:v,initialLayoutConfig:T,initialViewBox:w,isVisible:se,itemPresenceByNode:C,mapData:x,onClose:o,onLayoutConfigChange:I,onNodesPositioned:$,onSelectDestination:k,onTransitionEnd:ye,onViewBoxChange:_}):null,[p,g,v,T,w,se,C,x,ye,o,I,$,k,_,X]),Ae=l.useCallback((ae,xe,Ye,_e,Qe)=>{G===be?ee(xe??"",_e):D(ae,xe,Ye,_e,Qe)},[G,D,ee]),Ke=l.useCallback(()=>{G&&(le(G),L())},[G,le,L]),$e=l.useCallback(()=>{G===be&&pe()},[G,pe]);return e.jsxs(e.Fragment,{children:[e.jsx(Ar,{allNPCs:f,cachedImageScene:a,cachedImageUrl:n,currentSceneDescription:d,isVisible:t,localEnvironment:h,localPlace:b,localTime:y,mapData:x.nodes,onClose:s,setGeneratedImage:r,theme:i}),e.jsx(Sr,{allNPCs:f,isVisible:c,onClose:u,theme:i}),e.jsx(ka,{allNPCs:f,canInspectJournal:re,canWriteJournal:E,currentQuest:Y,currentScene:d,isVisible:M,isWritingJournal:F,item:G===be?{id:be,name:"Personal Journal",type:"book",description:"Your own journal",holderId:oa,chapters:R,lastWriteTurn:B,tags:[i.playerJournalStyle]}:H.find(ae=>ae.id===G)??null,mapData:x,onClose:L,onInspect:G?Ke:void 0,onWriteJournal:G?$e:void 0,startIndex:j,storytellerThoughts:S,theme:i,updateItemContent:Ae}),Oe,e.jsx(fs,{confirmPreset:"red",confirmText:"Start New Game",isOpen:W,message:"Are you sure you want to start a new game? Your current progress will be lost.",onCancel:K,onConfirm:V,title:"Confirm New Game"}),e.jsx(fs,{confirmPreset:"blue",confirmText:"Load Game",isOpen:Q,message:"Are you sure you want to load a game? Your current progress will be overwritten if you load a new game.",onCancel:A,onConfirm:z,title:"Confirm Load Game"})]})}function Gr({shouldLockBodyScroll:t,dialogueDisplayProps:s,debugViewProps:n,titleMenuProps:a,gameSetupProps:r,settingsDisplayProps:d,infoDisplayProps:i,debugLoreModalProps:x,geminiKeyModalProps:f,genderSelectModalProps:y,actIntroModalProps:h,victoryScreenProps:b,characterSelectModalProps:c,appModalsProps:u,mapLayoutConfig:m,mapViewBox:o,currentMapNodeId:p,mapData:g,onMapNodesPositioned:v}){const[C,k]=l.useState(o),T=l.useRef(!1);l.useEffect(()=>{if(typeof window>"u")return;const Z=document.body;if(t){const fe=window.innerWidth-document.documentElement.clientWidth;Z.style.overflow="hidden",fe>0&&(Z.style.paddingRight=`${String(fe)}px`)}else Z.style.overflow="",Z.style.paddingRight="";return()=>{Z.style.overflow="",Z.style.paddingRight=""}},[t]),l.useEffect(()=>{if(!u)return;const{isMapVisible:Z}=u;if(Z&&!T.current){const fe=ea(g.nodes.map(de=>({...de})),{padding:m.NESTED_PADDING,anglePadding:m.NESTED_ANGLE_PADDING});v(fe);const We=o.split(" ").map(parseFloat);if(We.length===4){const[,,de,Te]=We,ge=fe.find(Fe=>Fe.id===p);ge&&!Number.isNaN(de)&&!Number.isNaN(Te)?k(`${String(ge.position.x-de/2)} ${String(ge.position.y-Te/2)} ${String(de)} ${String(Te)}`):k(o)}else k(o)}T.current=Z,Z||(T.current=!1)},[u,p,g.nodes,m,o,v]);const w=l.useMemo(()=>u?{...u,initialLayoutConfig:m,initialViewBox:C,onNodesPositioned:v}:null,[u,m,C,v]),{allNPCs:_,heroShortName:$,history:I,inventory:W,isDialogueExiting:V,isLoading:K,isVisible:Q,mapData:z,onClose:A,onOptionSelect:H,options:R,participants:B}=s,{badFacts:G,debugLore:j,debugPacket:M,gameStateStack:L,goodFacts:S,isVisible:Y,onApplyGameState:D,onClearFacts:ee,onClose:le,onDistillFacts:re,onSaveFacts:pe,onSimulateVictory:E,onSpawnBook:F,onSpawnMap:X,onSpawnNpcAtLocation:oe,onSpawnPage:se,onSpawnPicture:O,onSpawnVehicle:J,onToggleDebugLore:ye,onTriggerMainQuestAchieved:Oe,onUndoTurn:Ae,travelPath:Ke}=n,{isGameActive:$e,isVisible:ae,onClose:xe,onLoadGame:Ye,onNewGame:_e,onOpenGeminiKeyModal:Qe,onOpenInfo:Lt,onOpenSettings:Xe,onSaveGame:qe}=a,{isVisible:Tt,onClose:It,onThemeSelected:rt}=r,{enabledThemePacks:Ve,isVisible:Pt,onChangePreferredPlayerName:At,onChangeThinkingEffort:$t,onClose:Dt,onToggleThemePack:Ft,preferredPlayerName:Gt,thinkingEffort:Rt}=d,{isVisible:zt,onClose:Ot}=i,{facts:_t,isVisible:Vt,onClose:Bt,onSubmit:Wt}=x,{isVisible:ie,onClose:ke}=f,{defaultGender:Be,isVisible:q,onSubmit:je}=y;let me=null;if(h){const Z=h.onContinue;me=e.jsx(vr,{act:h.act,isTurnGenerating:h.isTurnGenerating,onContinue:Z})}let De=null;if(b){const Z=b.onClose;De=e.jsx(Nr,{heroSheet:b.heroSheet,onClose:Z,storyArc:b.storyArc})}let Ze=null;if(c){const Z=c.onComplete,fe=c.onHeroData;Ze=e.jsx(wr,{WorldSheet:c.WorldSheet,heroGender:c.heroGender,isVisible:c.isVisible,onComplete:Z,onHeroData:fe,options:c.options,theme:c.theme})}let et=null;if(w){const{adventureName:Z,allNPCs:fe,canInspectJournal:We,canWriteJournal:de,currentMapNodeId:Te,currentQuest:ge,currentScene:Fe,destinationNodeId:Le,handleCancelLoadGameFromMenu:tt,handleCancelNewGameFromMenu:st,handleConfirmLoadGameFromMenu:at,handleConfirmNewGameFromMenu:Ge,initialLayoutConfig:Ht,initialViewBox:He,inventory:it,isKnowledgeBaseVisible:ce,isMapVisible:Ce,isPageVisible:Ie,isVisualizerVisible:ot,isWritingJournal:Jt,itemPresenceByNode:Ut,lastJournalWriteTurn:Kt,loadGameFromMenuConfirmOpen:Yt,localEnvironment:Qt,localPlace:Xt,localTime:qt,mapData:we,newGameFromMenuConfirmOpen:Zt,onCloseKnowledgeBase:es,onCloseMap:ts,onClosePage:nt,onCloseVisualizer:ss,onItemInspect:as,onLayoutConfigChange:ct,onNodesPositioned:ns,onSelectDestination:ls,onViewBoxChange:rs,onWriteJournal:he,pageItemId:Se,pageStartChapterIndex:dt,playerJournal:is,setGeneratedImage:ut,storytellerThoughts:os,theme:mt,updateItemContent:ht,updatePlayerJournalContent:ne,visualizerImageScene:cs,visualizerImageUrl:ds}=w;et=e.jsx(Fr,{adventureName:Z,allNPCs:fe,canInspectJournal:We,canWriteJournal:de,currentMapNodeId:Te,currentQuest:ge,currentScene:Fe,destinationNodeId:Le,handleCancelLoadGameFromMenu:tt,handleCancelNewGameFromMenu:st,handleConfirmLoadGameFromMenu:at,handleConfirmNewGameFromMenu:Ge,initialLayoutConfig:Ht,initialViewBox:He,inventory:it,isKnowledgeBaseVisible:ce,isMapVisible:Ce,isPageVisible:Ie,isVisualizerVisible:ot,isWritingJournal:Jt,itemPresenceByNode:Ut,lastJournalWriteTurn:Kt,loadGameFromMenuConfirmOpen:Yt,localEnvironment:Qt,localPlace:Xt,localTime:qt,mapData:we,newGameFromMenuConfirmOpen:Zt,onCloseKnowledgeBase:es,onCloseMap:ts,onClosePage:nt,onCloseVisualizer:ss,onItemInspect:as,onLayoutConfigChange:ct,onNodesPositioned:ns,onSelectDestination:ls,onViewBoxChange:rs,onWriteJournal:he,pageItemId:Se,pageStartChapterIndex:dt,playerJournal:is,setGeneratedImage:ut,storytellerThoughts:os,theme:mt,updateItemContent:ht,updatePlayerJournalContent:ne,visualizerImageScene:cs,visualizerImageUrl:ds})}return e.jsxs(e.Fragment,{children:[e.jsx(pa,{allNPCs:_,heroShortName:$,history:I,inventory:W,isDialogueExiting:V,isLoading:K,isVisible:Q,mapData:z,onClose:A,onOptionSelect:H,options:R,participants:B}),e.jsx(Ul,{badFacts:G,debugLore:j,debugPacket:M,gameStateStack:L,goodFacts:S,isVisible:Y,onApplyGameState:D,onClearFacts:ee,onClose:le,onDistillFacts:re,onSaveFacts:pe,onSimulateVictory:E,onSpawnBook:F,onSpawnMap:X,onSpawnNpcAtLocation:oe,onSpawnPage:se,onSpawnPicture:O,onSpawnVehicle:J,onToggleDebugLore:ye,onTriggerMainQuestAchieved:Oe,onUndoTurn:Ae,travelPath:Ke}),e.jsx(ga,{isGameActive:$e,isVisible:ae,onClose:xe,onLoadGame:Ye,onNewGame:_e,onOpenGeminiKeyModal:Qe,onOpenInfo:Lt,onOpenSettings:Xe,onSaveGame:qe}),e.jsx(ba,{isVisible:Tt,onClose:It,onThemeSelected:rt}),e.jsx(mr,{enabledThemePacks:Ve,isVisible:Pt,onChangePreferredPlayerName:At,onChangeThinkingEffort:$t,onClose:Dt,onToggleThemePack:Ft,preferredPlayerName:Gt,thinkingEffort:Rt}),e.jsx(br,{isVisible:zt,onClose:Ot}),e.jsx(yr,{facts:_t,isVisible:Vt,onClose:Bt,onSubmit:Wt}),e.jsx(jr,{isVisible:ie,onClose:ke}),e.jsx(Cr,{defaultGender:Be,isVisible:q,onSubmit:je}),me,De,Ze,et]})}const Rr=`<ID: {id}> - {name}
`,zr=t=>({type:"object",properties:{heading:{type:"string",description:"Short plain text heading for the journal entry."},text:{type:"string",minLength:100,description:`Approximately ${String(t)} words of the journal entry, starting with a Markup-formatted heading. Basic Markup syntax is allowed, such as **bold** and *italic*.`}},required:["heading","text"],additionalProperties:!1}),Or=t=>Kl(t,s=>!!s&&typeof s=="object"&&typeof s.heading=="string"&&typeof s.text=="string"),_r=async(t,s,n,a,r,d,i,x,f,y,h,b)=>{if(!ze())return console.error("generateJournalEntry: API key not configured."),null;const c=b?`Current Quest: "${b}"`:"Current Quest: Not set",u=fl(h),m=bl(f,!0),o=yl(y,Rr,`## Known NPCs:
`,`
`),p=`**Context:**
Theme Name: "${r}";
Theme Description: "${d}";
${c};

## Known Locations:
${m}
${o}
## Previous Journal Entry:
${a}

## Last events:
${u}

## Scene Description:
${i};

------
`,g="You are the main protagonist writing a new entry in your personal journal, focusing primarily on Last events and Scene description, logically continuing from the Previous Journal Entry. Always write in-character. NEVER include any ID strings. Provide only the JSON for the new journal entry.",v=zr(t);return jl(async C=>{var k,T,w,_;try{Cl(ta.write_journal.icon);const $=vl(1024),{response:I,systemInstructionUsed:W,jsonSchemaUsed:V,promptUsed:K}=await Nl({modelNames:[la,ra,na],prompt:p,systemInstruction:g,temperature:1,thinkingBudget:$,includeThoughts:!0,responseMimeType:"application/json",jsonSchema:v,label:"Journal"}),z=(((w=(T=(k=I.candidates)==null?void 0:k[0])==null?void 0:T.content)==null?void 0:w.parts)??[]).filter(R=>R.thought===!0&&typeof R.text=="string").map(R=>R.text),A=((_=I.text)==null?void 0:_.trim())??"",H=A?Or(A):null;return{result:{entry:H,debugInfo:{prompt:K,systemInstruction:W,jsonSchema:V??v,rawResponse:A,parsedPayload:H??void 0,thoughts:z}}}}catch($){throw console.error(`generateJournalEntry error (Attempt ${String(C+1)}):`,$),$}return{result:{entry:null,debugInfo:null}}})};function Vr({saveLoadState:t,appModals:s,pendingAct:n,setPendingAct:a}){var Os;const{clearProgress:r}=qs(),{enabledThemePacks:d,setEnabledThemePacks:i,thinkingEffort:x,setThinkingEffort:f,preferredPlayerName:y,setPreferredPlayerName:h,appReady:b}=t,{isVisualizerVisible:c,visualizerImageUrl:u,setVisualizerImageUrl:m,visualizerImageScene:o,setVisualizerImageScene:p,isKnowledgeBaseVisible:g,isSettingsVisible:v,isInfoVisible:C,isMapVisible:k,userRequestedTitleMenuOpen:T,setShouldReturnToTitleMenu:w,shouldReturnToTitleMenu:_,isDebugViewVisible:$,isCustomGameSetupVisible:I,newGameFromMenuConfirmOpen:W,loadGameFromMenuConfirmOpen:V,openVisualizer:K,closeVisualizer:Q,openKnowledgeBase:z,closeKnowledgeBase:A,openMap:H,closeMap:R,openSettings:B,closeSettings:G,openInfo:j,closeInfo:M,openTitleMenu:L,closeTitleMenu:S,closeDebugView:Y,setIsDebugViewVisible:D,openCustomGameSetup:ee,closeCustomGameSetup:le,openNewGameFromMenuConfirm:re,closeNewGameFromMenuConfirm:pe,openLoadGameFromMenuConfirm:E,closeLoadGameFromMenuConfirm:F,pageItemId:X,pageStartChapterIndex:oe,isPageVisible:se,openPageView:O,closePageView:J,isDebugLoreVisible:ye,debugLoreFacts:Oe,isGenderSelectVisible:Ae,submitGenderSelectModal:Ke,isCharacterSelectVisible:$e,characterSelectData:ae,submitCharacterSelectModal:xe,submitCharacterSelectHeroData:Ye,genderSelectDefault:_e,submitDebugLoreModal:Qe,closeDebugLoreModal:Lt}=s,[Xe,qe]=l.useState(!1),Tt=kl(),{fileInputRef:It,handleSaveToFile:rt,handleLoadFromFileClick:Ve,handleFileInputChange:Pt}=wl({enabledThemePacks:d,thinkingEffort:x});l.useEffect(()=>{ze()||qe(!0)},[]);const At=l.useCallback(()=>{qe(!0)},[]),$t=l.useCallback(()=>{qe(!1)},[]),{status:Dt,story:Ft,map:Gt,inventory:Rt,journal:zt,dialogue:Ot,actions:_t,debug:Vt,system:Bt,npcs:Wt}=Tt,{isLoading:ie,isTurnProcessing:ke,error:Be,hasGameBeenInitialized:q}=Dt,{theme:je,currentScene:me,mainQuest:De,currentObjective:Ze,actionOptions:et,storyArc:Z,heroSheet:fe,objectiveAnimationType:We,gameLog:de,lastActionLog:Te,lastTurnChanges:ge,score:Fe,globalTurnNumber:Le,localTime:tt,localEnvironment:st,localPlace:at,isVictory:Ge,handlers:Ht}=Ft,{triggerMainQuestAchieved:He,simulateVictory:it}=Ht,{data:ce,currentNodeId:Ce,destinationNodeId:Ie,layoutConfig:ot,viewBox:Jt,itemPresenceByNode:Ut,handlers:Kt}=Gt,{setLayoutConfig:Yt,setViewBox:Qt,setNodePositions:Xt,selectDestination:qt}=Kt,{items:we,itemsHere:Zt,handlers:es,queue:ts}=Rt,{executeItemInteraction:nt,handleStashToggle:ss,updateItemContent:as}=es,{actions:ct,enqueue:ns,clear:ls,remainingActionPoints:rs}=ts,{playerJournal:he,lastWriteTurn:Se,lastInspectTurn:dt,handlers:is}=zt,{addPlayerEntry:ut,updatePlayerEntryContent:os,recordInspect:mt,distillLore:ht}=is,{state:ne,isExiting:cs,handlers:ds}=Ot,{selectOption:Cs,forceExit:Sa}=ds,{freeFormActionText:Ea,setFreeFormActionText:vs,handleFreeFormActionSubmit:Ma,handleActionSelect:La,handleUndoTurn:Ta,handleRetry:Ns,startCustomGame:ks}=_t,{lastDebugPacket:Re,gameStateStack:us,debugPacketStack:Ia,toggleDebugLore:Pa,clearDebugFacts:ws,debugLore:pt,debugGoodFacts:Ss,debugBadFacts:Es,gatherCurrentGameState:ms,gatherDebugPacketStack:Aa,spawnBookForPlayer:Ms,spawnMapForPlayer:Ls,spawnPictureForPlayer:Ts,spawnPageForPlayer:Is,spawnVehicleForPlayer:Ps,spawnNpcAtPlayerLocation:As}=Vt,{commitGameState:Je,setError:hs}=Bt,{all:Pe}=Wt,$a=l.useCallback(P=>{f(P);const te=ms()[0];Je({...te,thinkingEffort:P})},[Je,ms,f]),Da=l.useCallback(P=>{h(P)},[h]),xt=je.name===Sl.name,$s=xt?null:je.name,Fa=n!==null&&(ie||ke);l.useEffect(()=>{Ge&&a(null)},[Ge,a]),l.useEffect(()=>{ge!=null&&ge.mainQuestAchieved&&He().catch(P=>{console.error("Failed to finalize main quest achievement after a turn.",P)})},[ge==null?void 0:ge.mainQuestAchieved,He]);const Ga=l.useCallback(()=>{a(null)},[a]),Ra=l.useCallback(P=>{Je(P)},[Je]),za=l.useCallback(()=>{He().catch(P=>{console.error("Failed to trigger main quest achievement via debug action.",P)})},[He]),Oa=l.useCallback(()=>{it().catch(P=>{console.error("Failed to simulate victory via debug action.",P)})},[it]),_a=l.useCallback(()=>{As()},[As]),Va=l.useCallback(()=>{Ms()},[Ms]),Ba=l.useCallback(()=>{Ls()},[Ls]),Wa=l.useCallback(()=>{Ts()},[Ts]),Ha=l.useCallback(()=>{Is()},[Is]),Ja=l.useCallback(()=>{Ps()},[Ps]),Ua=l.useCallback(()=>{Je({...us[0],isVictory:!1}),L()},[Je,us,L]),Ka=l.useCallback(P=>{const te=new Blob([P],{type:"application/json"}),ue=URL.createObjectURL(te),ve=document.createElement("a");ve.href=ue,ve.download="DebugLoreFacts.json",document.body.appendChild(ve),ve.click(),document.body.removeChild(ve),URL.revokeObjectURL(ue)},[]),Ya=l.useCallback(()=>{ws(),El({debugLore:pt,debugGoodFacts:[],debugBadFacts:[]})},[ws,pt]);l.useEffect(()=>{ie||r()},[ie,r]);const Ds=l.useRef(de.length),Fs=l.useRef(me),Qa=l.useMemo(()=>{const P=T||b&&!q&&!ie&&!I,te=Ge;return{effectiveIsTitleMenuOpen:P,isVictoryModalVisible:te,isAnyModalActive:c||g||v||C||k||$||se||ye||P||W||V||I||Xe||Ae||$e||te||n!==null}},[b,Xe,q,$e,I,ye,$,C,g,ie,k,se,v,c,Ge,Ae,V,W,n,T]),{effectiveIsTitleMenuOpen:Xa,isAnyModalActive:Gs}=Qa,gt=Gs||!!ne;l.useEffect(()=>{(me!==Fs.current||de.length>Ds.current)&&window.scrollTo({top:0,behavior:"smooth"}),Fs.current=me,Ds.current=de.length},[me,de.length]),l.useEffect(()=>{m(null),p(null)},[me,m,p]),Ml({appReady:b,dependencies:[je,me,et,De,Ze,we,de,Te,ce,Ce,ot,Pe,Fe,tt,st,at,d,pt,Ss,Es],dialogueState:ne,gatherDebugPacketStack:Aa,gatherGameStateStack:ms,hasGameBeenInitialized:q,isLoading:ie,isTurnProcessing:ke,setError:P=>{hs(P)}});const qa=Fe>=sa&&!ie&&!ke&&q&&!ne,Za=typeof window<"u"&&window.matchMedia("(hover: none)").matches,en=l.useCallback((P,te)=>{m(P),p(te)},[m,p]),Rs=l.useCallback(()=>{Ns()},[Ns]),tn=l.useCallback(()=>{ht()},[ht]),sn=l.useCallback(P=>{var ue;const te=P.id===be?Math.max(0,(((ue=P.chapters)==null?void 0:ue.length)??0)-1):0;O(P.id,te)},[O]),[ft,ps]=l.useState(!1),an=(Se===0||Le-Se>=Ks)&&!ft,nn=he.length>0&&(dt===0||Le-dt>=aa),ln=l.useCallback(()=>{const P=he.length>0?he.length-1:0;O(be,P)},[O,he.length]),rn=l.useCallback(()=>{!(Se===0||Le-Se>=Ks)||ft||(ps(!0),O(be,he.length),(async()=>{var Vs,Bs;if(xt){ps(!1);return}const{name:te,storyGuidance:ue}=je,ve=((Vs=he[he.length-1])==null?void 0:Vs.actualContent)??"",_s=Math.floor(Math.random()*50)+100,Ue=await _r(_s,"Personal Journal","Your own journal",ve,te,ue,me,((Bs=Re==null?void 0:Re.storytellerThoughts)==null?void 0:Bs.slice(-1)[0])??"",ce.nodes,Pe,de.slice(-Yl),De);if(Ue!=null&&Ue.entry){const Xn={heading:Ll(Ue.entry.heading)||"Journal Entry",description:"",contentLength:_s,actualContent:Ue.entry.text};ut(Xn,Ue.debugInfo??void 0),O(be,he.length)}ps(!1)})())},[Pe,je,me,ut,ce.nodes,De,O,he,Re,de,Le,Se,ft,xt]),on=l.useCallback(P=>{if(P===be){const ue={id:be,name:"Personal Journal",type:"book",description:"Your own journal",holderId:oa,chapters:he,lastWriteTurn:Se,tags:[je.playerJournalStyle]},ve=mt();nt(ue,"inspect",void 0,ve);return}const te=we.find(ue=>ue.id===P);te&&nt(te,"inspect")},[we,nt,he,Se,mt,je]),cn=l.useCallback(P=>{vs(P.target.value)},[vs]),dn=l.useCallback(()=>{F(),L()},[F,L]),un=l.useCallback(()=>{pe(),L()},[pe,L]),mn=l.useCallback(P=>{i(te=>{const ue=te.includes(P)?te.filter(ve=>ve!==P):[...te,P];return ue.length===0?(hs("At least one theme pack must be enabled."),te):ue})},[i,hs]),hn=l.useCallback(P=>{Cs(P)},[Cs]),pn=l.useCallback(()=>{S(),q?re():ee()},[S,q,ee,re]),xn=l.useCallback(()=>{pe(),ee()},[pe,ee]),gn=l.useCallback(()=>{S(),q?E():Ve()},[S,q,Ve,E]),fn=l.useCallback(()=>{F(),Ve()},[F,Ve]),bn=l.useCallback(async()=>{S(),await rt()},[S,rt]),yn=l.useCallback(()=>{S(),w(!0),B()},[S,w,B]),jn=l.useCallback(()=>{G(),(_||!q)&&L(),w(!1)},[G,_,q,L,w]),Cn=l.useCallback(()=>{S(),w(!0),j()},[S,w,j]),vn=l.useCallback(()=>{M(),(_||!q)&&L(),w(!1)},[M,_,q,L,w]),Nn=l.useCallback(()=>{le(),L()},[le,L]),kn=l.useCallback(P=>{le(),ks(P)},[le,ks]),zs=l.useMemo(()=>Tl(ce),[ce]),wn=l.useMemo(()=>!Ie||!Ce||Ce===Ie||Il(ce,Ce,Ie)?null:Pl(ce,Ce,Ie,zs),[Ie,Ce,ce,zs,Le]),Sn=ie&&!q&&!Be,En=ie&&!ne,Mn=new Set(ct.map(P=>P.id)),Ln={adventureName:$s,currentSceneExists:!!me,isLoading:ie||!!ne||ke,isTurnProcessing:ke,onOpenKnowledgeBase:z,onOpenMap:H,onOpenTitleMenu:L,onOpenVisualizer:K,score:Fe},Tn={allNPCs:Pe,description:me,inventory:we,lastActionLog:Te,localEnvironment:st,localPlace:at,localTime:tt,mapData:ce.nodes},In={allNPCs:Pe,disabled:ie||ke||!!ne,inventory:we,mapData:ce.nodes,onActionSelect:La,onClearQueuedActions:ls,options:et,queuedActions:ct},Pn={canPerformFreeAction:qa,freeFormActionText:Ea,onChange:cn,onSubmit:Ma},An={allNPCs:Pe,currentMapNodeId:Ce,currentObjective:Ze,disabled:ie||ke||gt,enableMobileTap:Za,globalTurnNumber:Le,inventory:we,itemsHere:Zt,mapNodes:ce.nodes,objectiveAnimationType:We,onItemInteract:ns,onReadPage:sn,onReadPlayerJournal:ln,onStashToggle:ss,queuedActionIds:Mn,remainingActionPoints:rs,storyArc:Z},$n=Be?[{id:"active-game-error",isVisible:!ie&&!ne&&q,message:Be,handleRetry:Rs},{id:"pre-game-error",isVisible:!q,message:Be,handleRetry:Rs}]:[],Dn={currentTurnNumber:Le,isGameBusy:ie||ke||Gs,lastTurnChanges:ge},Fn={isBlurred:gt,isDebugViewVisible:$,setIsDebugViewVisible:D},Gn={accept:".json,application/json",onChange:Pt,inputRef:It},Rn={allNPCs:Pe,heroShortName:fe.heroShortName,history:(ne==null?void 0:ne.history)??[],inventory:we,isDialogueExiting:cs,isLoading:ie,isVisible:!!ne,mapData:ce.nodes,onClose:Sa,onOptionSelect:hn,options:(ne==null?void 0:ne.options)??[],participants:(ne==null?void 0:ne.participants)??[]},zn={badFacts:Es,debugLore:pt,debugPacket:Ia[0],gameStateStack:us,goodFacts:Ss,isVisible:$,onApplyGameState:Ra,onClearFacts:Ya,onClose:Y,onDistillFacts:tn,onSaveFacts:Ka,onSimulateVictory:Oa,onSpawnBook:Va,onSpawnMap:Ba,onSpawnNpcAtLocation:_a,onSpawnPage:Ha,onSpawnPicture:Wa,onSpawnVehicle:Ja,onToggleDebugLore:Pa,onTriggerMainQuestAchieved:za,onUndoTurn:Ta,travelPath:wn},On={isGameActive:q,isVisible:Xa,onClose:S,onLoadGame:gn,onNewGame:pn,onOpenGeminiKeyModal:At,onOpenInfo:Cn,onOpenSettings:yn,onSaveGame:q?bn:void 0},_n={isVisible:I,onClose:Nn,onThemeSelected:kn},Vn={enabledThemePacks:d,isVisible:v,onChangePreferredPlayerName:Da,onChangeThinkingEffort:$a,onClose:jn,onToggleThemePack:mn,preferredPlayerName:y,thinkingEffort:x},Bn={isVisible:C,onClose:vn},Wn={facts:Oe,isVisible:ye,onClose:Lt,onSubmit:Qe},Hn={isVisible:Xe,onClose:$t},Jn={defaultGender:_e,isVisible:Ae,onSubmit:Ke},Un=n?{act:n,isTurnGenerating:Fa,onContinue:Ga}:null,Kn=Ge?{heroSheet:fe,onClose:Ua,storyArc:Z}:null,Yn=ae?{WorldSheet:ae.WorldSheet,heroGender:ae.heroGender,isVisible:$e,onComplete:xe,onHeroData:Ye,options:ae.options,theme:ae.theme}:null,Qn=q&&!xt?{adventureName:$s,allNPCs:Pe,canInspectJournal:nn,canWriteJournal:an,currentMapNodeId:Ce,currentQuest:De,currentScene:me,destinationNodeId:Ie,handleCancelLoadGameFromMenu:dn,handleCancelNewGameFromMenu:un,handleConfirmLoadGameFromMenu:fn,handleConfirmNewGameFromMenu:xn,inventory:we,isKnowledgeBaseVisible:g,isMapVisible:k,isPageVisible:se,isVisualizerVisible:c,isWritingJournal:ft,itemPresenceByNode:Ut,lastJournalWriteTurn:Se,loadGameFromMenuConfirmOpen:V,localEnvironment:st,localPlace:at,localTime:tt,mapData:ce,newGameFromMenuConfirmOpen:W,onCloseKnowledgeBase:A,onCloseMap:R,onClosePage:J,onCloseVisualizer:Q,onItemInspect:on,onLayoutConfigChange:Yt,onSelectDestination:qt,onViewBoxChange:Qt,onWriteJournal:rn,pageItemId:X,pageStartChapterIndex:oe,playerJournal:he,setGeneratedImage:en,storytellerThoughts:((Os=Re==null?void 0:Re.storytellerThoughts)==null?void 0:Os.slice(-1)[0])??"",theme:je,updateItemContent:as,updatePlayerJournalContent:os,visualizerImageScene:o,visualizerImageUrl:u}:null;return b?e.jsxs(e.Fragment,{children:[e.jsx(Zl,{errorBanners:$n,fileInputProps:Gn,footerProps:Fn,headerProps:{hasGameBeenInitialized:q,theme:je},isBlurred:gt,itemAnimatorProps:Dn,children:e.jsx(ur,{actionOptionsProps:In,freeActionInputProps:Pn,hasGameBeenInitialized:q,mainToolbarProps:Ln,sceneDisplayProps:Tn,showInitialLoadingSpinner:Sn,showSceneLoadingOverlay:En,sidebarProps:An})}),e.jsx(Gr,{actIntroModalProps:Un,appModalsProps:Qn,characterSelectModalProps:Yn,currentMapNodeId:Ce,debugLoreModalProps:Wn,debugViewProps:zn,dialogueDisplayProps:Rn,gameSetupProps:_n,geminiKeyModalProps:Hn,genderSelectModalProps:Jn,infoDisplayProps:Bn,mapData:ce,mapLayoutConfig:ot,mapViewBox:Jt,onMapNodesPositioned:Xt,settingsDisplayProps:Vn,shouldLockBodyScroll:gt,titleMenuProps:On,victoryScreenProps:Kn})]}):e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 flex flex-col items-center justify-center p-4",children:[e.jsx(Ne,{}),e.jsx("p",{className:"mt-4 text-xl text-sky-400",children:"Initializing application..."})]})}function Br(){const t=Al(),s=$l(),{openCharacterSelectModal:n,openGenderSelectModal:a,openDebugLoreModal:r}=s,[d,i]=l.useState(null),x=l.useCallback((h,b)=>new Promise(c=>{n(h,b,c)}),[n]),f=l.useCallback(h=>new Promise(b=>{a(h,b)}),[a]),y=Dl({enabledThemePacksProp:t.enabledThemePacks,thinkingEffortProp:t.thinkingEffort,preferredPlayerNameProp:t.preferredPlayerName,initialSavedStateFromApp:t.initialSavedState,initialDebugStackFromApp:t.initialDebugStack,isAppReady:t.appReady,openDebugLoreModal:r,openCharacterSelectModal:x,openGenderSelectModal:f,onActIntro:i});return e.jsx(Fl,{value:y,children:e.jsx(Vr,{appModals:s,pendingAct:d,saveLoadState:t,setPendingAct:i})})}const wa=document.getElementById("root");if(!wa)throw new Error("Could not find root element to mount to");const Wr=qn.createRoot(wa);Wr.render(e.jsx(l.StrictMode,{children:e.jsx(Br,{})}));
