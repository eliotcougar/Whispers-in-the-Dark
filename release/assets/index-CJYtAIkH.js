import{j as e,r as l,R as fs,a as Xn}from"./vendor-BcNuLXi4.js";import{u as qn,a as Xs,b as Zn,c as el,d as tl,i as We,e as sl,T as Ws,g as al,s as nl,f as ll,h as qs,j as il,k as rl,l as Zs,D as ol,m as cl,n as dl,o as ul,p as xs,q as ml,r as hl,t as pl,v as xl,w as gl,x as bl,y as fl,z as yl,A as jl,B as Cl,C as Nl,E as vl,F as kl,G as Sl,P as wl,H as El,I as Ml,J as Ll,K as Il,L as Tl,M as Pl,N as $l,O as Al,Q as Dl,R as Gl}from"./hooks-eSO5fFfV.js";import{r as ea,ay as J,az as v,aA as Fl,aB as gt,aC as vt,ak as ta,aD as Hs,ao as bt,aq as ft,ap as yt,O as zl,ax as Ol,am as ge,aE as sa,aF as Rl,aG as _l,C as Vl,j as aa,G as na,a9 as Bl,i as la,H as Wl,N as Se,e as jt,d as Ct,aH as ia,aI as Js,c as Hl,b as Jl,a5 as ra,aJ as Ul,z as Kl,aK as Us,aa as Yl}from"./debug-D_oztM7f.js";import{c as Ql}from"./resources-B9u9Fxlu.js";import"./gemini-DfLdvowQ.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const d of i)if(d.type==="childList")for(const r of d.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function a(i){const d={};return i.integrity&&(d.integrity=i.integrity),i.referrerPolicy&&(d.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?d.credentials="include":i.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function n(i){if(i.ep)return;i.ep=!0;const d=a(i);fetch(i.href,d)}})();function je({className:t="",showText:s=!0,size:a="lg"}){const n=qn(),{progress:i,retryCount:d}=Xs(),p=`${a==="sm"?"rounded-full h-6 w-6 border-t-2 border-b-2":"rounded-full h-16 w-16 border-t-4 border-b-4"} animate-spin border-sky-600`,b="text-sky-400",j=n?ea[n]:void 0,x=(j==null?void 0:j.text)??"Loading...",f=i?i+i.split("").reverse().join(""):"",c=d>0?`Retry ${String(d)}`:"",u=s?"flex flex-col items-center my-8":"";return e.jsxs("div",{"aria-live":"polite",className:`${u} ${t}`,role:"status",children:[e.jsx("div",{"aria-hidden":"true",className:p}),s?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:`mt-2 text-xl ${b} text-shadow-md`,children:x}),c?e.jsx("p",{className:`mt-1 text-sm ${b} text-shadow-md`,children:c}):null,f?e.jsx("div",{className:"mt-2 text-2xl text-sky-300 font-mono text-shadow-md",children:f}):null]}):null]})}je.defaultProps={className:"",showText:!0,size:"lg"};function oa({hasGameBeenInitialized:t,theme:s}){return e.jsxs("header",{className:"w-full max-w-screen-xl mb-6 text-center",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-sky-400 tracking-wider title-font",children:"Whispers in the Dark"}),e.jsx("p",{className:"text-slate-300 text-lg",children:"An AI-Powered Adventure"}),t?e.jsx("p",{children:s?e.jsx("span",{className:"block text-xs text-purple-400",children:s.name}):null}):null]})}function ca({message:t,onRetry:s}){return e.jsxs("div",{className:"bg-red-800 border border-red-600 text-red-100 p-6 rounded-lg shadow-xl my-4 animate-pulse",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(J,{color:"red",inline:!0,marginRight:12,name:"error",size:32}),e.jsx("h3",{className:"font-bold text-2xl text-red-200",children:"A Shadow Falls!"})]}),e.jsx("p",{className:"text-red-200 mb-4",children:t}),s?e.jsx(v,{ariaLabel:"Try again after error",label:"Try Again",onClick:s,preset:"red",size:"md",variant:"compact"}):null]})}ca.defaultProps={onRetry:void 0};function ys({type:t}){const a={"single-use":"text-red-400","multi-use":"text-yellow-400",equipment:"text-sky-400",container:"text-orange-400",key:"text-lime-400",weapon:"text-amber-400",ammunition:"text-cyan-400",vehicle:"text-indigo-400",immovable:"text-purple-400","status effect":"text-pink-400",page:"text-green-400",book:"text-green-400",picture:"text-fuchsia-400",map:"text-teal-400"}[t];return e.jsx("span",{className:`text-xs italic ${a}`,children:t})}const ht=()=>{};function Xl({lastTurnChanges:t,isGameBusy:s,currentTurnNumber:a}){const{itemForCardDisplay:n,currentAnimatingItem:i,isVisibleOverlay:d,isCardVisibleClass:r,explicitDisappearClass:p,activeGlowType:b,handleSkipAnimations:j,handleKeyDown:x}=Zn({lastTurnChanges:t,isGameBusy:s,currentTurnNumber:a}),f=h=>{var g,N;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(ys,{type:h.type}),h.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:h.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-3 italic leading-tight flex-grow",children:h.isActive&&h.activeDescription?h.activeDescription:h.description}),(g=h.tags)!=null&&g.includes("junk")?e.jsx("p",{className:"text-xs text-orange-400 mb-1 italic",children:"(Marked as junk)"}):null,e.jsxs("div",{className:"space-y-1 mt-auto",children:[(N=h.knownUses)==null?void 0:N.map(C=>e.jsx(v,{"aria-hidden":"true",ariaLabel:C.actionName,disabled:!0,label:C.actionName,onClick:ht,preset:"slate",size:"sm",title:C.description},`${h.name}-anim-ku-${C.actionName}`)),e.jsx(v,{"aria-hidden":"true",ariaLabel:"Inspect",disabled:!0,label:"Inspect",onClick:ht,preset:"slate",size:"sm"}),h.type!=="status effect"&&h.type!=="vehicle"&&e.jsx(v,{"aria-hidden":"true",ariaLabel:"Attempt to Use (Generic)",disabled:!0,label:"Attempt to Use (Generic)",onClick:ht,preset:"slate",size:"sm"}),h.type==="vehicle"&&e.jsx(v,{"aria-hidden":"true",ariaLabel:h.isActive?`Exit ${h.name}`:`Enter ${h.name}`,disabled:!0,label:h.isActive?`Exit ${h.name}`:`Enter ${h.name}`,onClick:ht,preset:"slate",size:"sm"})]})]})};if(!d||!n)return null;const c=h=>b?b==="acquire"&&h==="single"?"apply-green-glow-effect":b==="loss"&&h==="single"?"apply-red-glow-effect":b==="change-new"&&h==="new"?"apply-neutral-glow-effect":"":"",u="animating-item-card",m=r?"visible":"",o=p&&!r?p:"";return e.jsx("div",{"aria-label":"Skip item animations",className:"item-change-overlay active",onClick:j,onKeyDown:x,role:"button",tabIndex:0,children:(i==null?void 0:i.type)==="change"&&n.oldItem&&n.newItem?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`${u} ${m} ${o} ${c("old")}`,children:f(n.oldItem)}),e.jsx("div",{className:`${u} ${m} ${o} ${c("new")}`,children:f(n.newItem)})]}):n.item?e.jsx("div",{className:`${u} ${m} ${o} ${c("single")}`,children:f(n.item)}):null})}function ql({isBlurred:t,isDebugViewVisible:s,setIsDebugViewVisible:a}){const n=l.useCallback(()=>{a(i=>!i)},[a]);return e.jsx("footer",{className:`w-full max-w-screen-xl mt-12 text-center text-slate-500 text-sm ${t?"filter blur-sm pointer-events-none":""}`,children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-left",children:["Â©"," ",new Date().getFullYear(),". Developed by"," ",Fl,", Codex, and Gemini."," ",e.jsx("br",{}),"Powered by Gemini."]}),e.jsx("button",{"aria-label":s?"Hide Debug View":"Open Debug View",className:"px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs rounded shadow-md transition-colors",onClick:n,type:"button",children:"Debug"})]})})}function Zl({headerProps:t,errorBanners:s,isBlurred:a,children:n,itemAnimatorProps:i,footerProps:d,fileInputProps:r}){const p=s.filter(C=>C.isVisible),{hasGameBeenInitialized:b,theme:j}=t,{currentTurnNumber:x,isGameBusy:f,lastTurnChanges:c}=i,{isBlurred:u,isDebugViewVisible:m,setIsDebugViewVisible:o}=d,{accept:h,onChange:g,inputRef:N}=r;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 p-4 md:p-8 flex flex-col items-center",children:[e.jsx(oa,{hasGameBeenInitialized:b,theme:j}),p.map(C=>e.jsx("div",{className:"w-full max-w-3xl my-4",children:e.jsx(ca,{message:C.message,onRetry:C.handleRetry})},C.id)),e.jsx("main",{className:`w-full max-w-screen-xl grid grid-cols-1 lg:grid-cols-4 gap-3 flex-grow ${a?"filter blur-sm pointer-events-none":""}`,children:n}),e.jsx(Xl,{currentTurnNumber:x,isGameBusy:f,lastTurnChanges:c}),e.jsx(ql,{isBlurred:u,isDebugViewVisible:m,setIsDebugViewVisible:o})]}),e.jsx("input",{accept:h,"aria-hidden":"true",className:"hidden",onChange:g,ref:N,type:"file"})]})}function ei({score:t,isLoading:s,isTurnProcessing:a,adventureName:n,currentSceneExists:i,onOpenVisualizer:d,onOpenKnowledgeBase:r,onOpenMap:p,onOpenTitleMenu:b}){return e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{"aria-label":`Current score: ${String(t)} points`,className:"flex items-center p-2 border border-amber-500 rounded-md shadow-md",title:`Score: ${String(t)} points`,children:[e.jsx(J,{color:"amber",inline:!0,marginRight:8,name:"coin",size:20}),e.jsx("span",{className:"text-amber-400 font-semibold text-lg",children:t})]}),a?e.jsx(je,{showText:!1,size:"sm"}):null]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(v,{ariaLabel:"Visualize Scene",disabled:s||a||!n||!i,icon:e.jsx(J,{inline:!0,name:"visualize",size:20}),onClick:d,preset:"blue",size:"md",title:"Visualize Scene",variant:"toolbar"}),e.jsx(v,{ariaLabel:"Open Knowledge Base",disabled:s||a||!n,icon:e.jsx(J,{inline:!0,name:"bookOpen",size:20}),onClick:r,preset:"blue",size:"md",title:"Open Knowledge Base",variant:"toolbar"}),e.jsx(v,{ariaLabel:"Open Map",disabled:s||a||!n,icon:e.jsx(J,{inline:!0,name:"map",size:20}),onClick:p,preset:"blue",size:"md",title:"Open Map",variant:"toolbar"}),e.jsx(v,{ariaLabel:"Open Title Menu",disabled:s||a,icon:e.jsx(J,{inline:!0,name:"menu",size:20}),onClick:b,preset:"gray",size:"md",title:"Open Title Menu",variant:"toolbar"})]})]})}const ti="w-4 h-4 rounded",si=t=>t<.1?"bg-green-500":t<.2?"bg-lime-500":t<.3?"bg-yellow-500":t<.4?"bg-orange-500":t<.5?"bg-amber-500":"bg-red-500";function da(){const t=el();return e.jsxs("div",{"aria-label":"Model usage last minute",className:"flex space-x-1 items-center my-2",children:[Object.values(t).map(s=>{const a=s.count/s.limit,n=`${s.model}: ${String(s.count)}/${String(s.limit)} calls last minute`;return e.jsx("div",{"aria-label":n,className:`${ti} ${si(a)}`,title:n},s.model)}),e.jsx("div",{className:"flex-grow border-t border-slate-600 ml-2"})]})}function ua({tag:t="h2",children:s,icon:a,preset:n="amber",font:i="2xl"}){const d=t,r={slate:"text-slate-300",gray:"text-gray-400",zinc:"text-zinc-400",neutral:"text-neutral-400",stone:"text-stone-400",red:"text-red-400",orange:"text-orange-400",amber:"text-amber-400",yellow:"text-yellow-400",lime:"text-lime-400",green:"text-green-400",emerald:"text-emerald-400",teal:"text-teal-400",cyan:"text-cyan-400",sky:"text-sky-400",blue:"text-blue-400",indigo:"text-indigo-400",violet:"text-violet-400",purple:"text-purple-400",fuchsia:"text-fuchsia-400",pink:"text-pink-400",rose:"text-rose-400"},p={sm:"text-sm font-semibold",base:"text-base font-semibold",lg:"text-lg font-semibold",xl:"text-xl font-semibold","2xl":"text-2xl font-semibold","3xl":"text-3xl font-semibold","4xl":"text-4xl font-semibold"},b=a?e.jsx("span",{className:"mr-2 inline-flex",children:a}):null;return l.createElement(d,{className:`${p[i]} ${r[n]}`},b,s)}ua.defaultProps={children:void 0,font:"2xl",icon:void 0,preset:"amber",tag:"h2"};function we({header:t,headerIcon:s,children:a,text:n,highlightEntities:i,enableMobileTap:d=!1,containerClassName:r="p-3",headerTag:p="h2",borderColorClass:b="border-amber-700",backgroundColorClass:j="",borderWidthClass:x="border-b",headerFont:f="2xl",headerPreset:c="amber",headerWrapperClassName:u="",contentFontClass:m="",contentColorClass:o="text-slate-200"}){const h=n?n.split(`
`).map(g=>e.jsx("p",{className:"mb-3 last:mb-0",children:i?gt(g,i,d):g},g)):a;return e.jsxs("section",{className:`${r} ${j} ${x} ${b}`,children:[t?e.jsx("div",{className:` ${u} `,children:e.jsx(ua,{font:f,icon:s,preset:c,tag:p,children:t})}):null,e.jsx("div",{className:`${m} ${o}`,children:h})]})}we.defaultProps={backgroundColorClass:"",borderColorClass:"border-amber-700",borderWidthClass:"border-b",children:void 0,containerClassName:"p-3",contentColorClass:"text-slate-200",contentFontClass:"",enableMobileTap:!1,header:void 0,headerFont:"2xl",headerIcon:void 0,headerPreset:"amber",headerTag:"h2",headerWrapperClassName:"",highlightEntities:void 0,text:void 0};function ai({description:t,lastActionLog:s,inventory:a,mapData:n,allNPCs:i,localTime:d,localEnvironment:r,localPlace:p}){const b=l.useMemo(()=>vt(a,n,i),[a,n,i]),j=typeof window<"u"&&window.matchMedia("(hover: none)").matches,x=e.jsx(we,{backgroundColorClass:"bg-slate-800",borderColorClass:"border-slate-600",borderWidthClass:"rounded-lg border",contentFontClass:"leading-relaxed text-lg",enableMobileTap:j,highlightEntities:b,text:t}),f=s?e.jsx(we,{backgroundColorClass:"bg-slate-800",borderColorClass:"border-slate-600",borderWidthClass:"rounded-lg border",contentColorClass:"text-yellow-200",contentFontClass:"leading-relaxed text-lg",enableMobileTap:j,highlightEntities:b,text:s}):null,c=e.jsx(we,{borderColorClass:"border-slate-600",borderWidthClass:"border-t",contentColorClass:"text-slate-300",contentFontClass:"text-lg",text:`Time: ${d}. Environment: ${r}. Location: ${p}`});return e.jsxs("div",{className:"space-y-3",children:[f,x,c]})}function ni({options:t,onActionSelect:s,disabled:a,inventory:n,mapData:i,allNPCs:d,queuedActions:r,onClearQueuedActions:p}){const b=l.useMemo(()=>vt(n,i,d),[n,i,d]),j=r.map(u=>u.displayText).join(", "),x=r.map(u=>`  - ${u.promptText}`).join(`
`),f=l.useCallback(u=>{r.forEach(m=>{var o;return(o=m.effect)==null?void 0:o.call(m)}),s(x),p(),u.currentTarget.blur()},[r,s,p,x]),c=l.useCallback(u=>m=>{const o=x?`${x}
  - ${u}`:`  - ${u}`;r.forEach(h=>{var g;return(g=h.effect)==null?void 0:g.call(h)}),s(o),p(),m.currentTarget.blur()},[r,s,p,x]);return e.jsxs("div",{className:"mt-6",children:[r.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-3",children:e.jsx(v,{ariaLabel:j,disabled:a,label:e.jsx(e.Fragment,{children:gt(j,b)}),onClick:f,preset:"teal",size:"lg",variant:"standard"})}),e.jsxs("div",{className:"mb-3 flex items-center",role:"separator",children:[e.jsx("span",{className:"flex-grow border-b border-slate-500"}),e.jsx("span",{className:"px-2 text-slate-300",children:"AND"}),e.jsx("span",{className:"flex-grow border-b border-slate-500"})]})]}):null,e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:t.map(u=>e.jsx(v,{ariaLabel:u,disabled:a||u==="...",label:e.jsx(e.Fragment,{children:gt(u,b)}),onClick:c(u),preset:"sky",size:"lg",variant:"standard"},u))})]})}function li({freeFormActionText:t,canPerformFreeAction:s,onChange:a,onSubmit:n}){const i=l.useCallback(()=>{n()},[n]);return e.jsxs("div",{className:"mt-4 p-4 bg-slate-800 border border-slate-700 rounded-lg shadow",children:[e.jsxs("label",{className:"block text-sm font-medium text-amber-300 mb-1",htmlFor:"freeFormAction",children:["Perform Custom Action (Cost:"," ",ta," ","Score Points)"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{"aria-label":"Custom action input",className:"flex-grow p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 disabled:bg-slate-600 disabled:text-slate-300",disabled:!s,id:"freeFormAction",maxLength:Hs,onChange:a,placeholder:"Type your custom action here...",type:"text",value:t}),e.jsx(v,{ariaLabel:"Submit custom action",disabled:!s||t.trim()==="",label:"Submit",onClick:i,preset:"green",type:"button",variant:"compact"})]}),!s&&e.jsx("p",{className:"text-xs text-red-400 mt-1",children:"Not enough score points."}),s?e.jsxs("p",{className:"text-xs text-slate-300 mt-1",children:["Max"," ",Hs," ","characters."]}):null]})}function ii({items:t,onItemInteract:s,disabled:a,currentNodeId:n,mapNodes:i,queuedActionIds:d,remainingActionPoints:r}){const p=l.useCallback(c=>{const u=c.currentTarget.dataset.itemId;if(!u)return;const m=t.find(o=>o.id===u);m&&(s(m,"take"),c.currentTarget.blur())},[t,s]),b=l.useCallback(c=>{const u=c.currentTarget.dataset.itemId;if(!u)return;const m=t.find(o=>o.id===u);m&&(s(m,"inspect"),c.currentTarget.blur())},[t,s]),j=l.useCallback(c=>{const u=c.currentTarget.dataset.itemId;if(!u)return;const m=t.find(o=>o.id===u);m&&(s(m,"generic"),c.currentTarget.blur())},[t,s]),x=l.useCallback(c=>{const{itemId:u,actionName:m,promptEffect:o}=c.currentTarget.dataset;if(!u||!m||!o)return;const h=t.find(N=>N.id===u);if(!h)return;s(h,"specific",{actionName:m,promptEffect:o,description:m}),c.currentTarget.blur()},[t,s]),f=l.useCallback(c=>c.knownUses?c.knownUses.filter(u=>{const m=!!c.isActive;return u.appliesWhenActive!==void 0&&u.appliesWhenInactive!==void 0?u.appliesWhenActive&&m||u.appliesWhenInactive&&!m||!u.appliesWhenActive&&!u.appliesWhenInactive:u.appliesWhenActive!==void 0?u.appliesWhenActive===m:u.appliesWhenInactive!==void 0?u.appliesWhenInactive===!m:!0}):[],[]);return t.length===0?null:e.jsxs("div",{className:"bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-amber-400 mb-2 border-b-2 border-amber-700 pb-2 flex items-center",children:[e.jsx(J,{color:"amber",inline:!0,marginRight:8,name:"inventory",size:20})," ","Items Here"]}),e.jsx("ul",{className:"flex flex-wrap justify-center gap-4 list-none p-0",children:t.map(c=>{var h;const u=c.isActive&&c.activeDescription?c.activeDescription:c.description,m=c.holderId===n,o=m?null:(h=i.find(g=>g.id===c.holderId))==null?void 0:h.placeName;return e.jsxs("li",{className:"w-[270px] text-slate-300 bg-slate-700/60 p-4 rounded-md shadow border border-slate-600 flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(ys,{type:c.type}),c.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:c.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-1 italic leading-tight flex-grow",children:u}),!m&&o?e.jsxs("p",{className:"text-xs text-slate-300 mb-2",children:["Reachable at ",o]}):null,e.jsx("div",{className:"mt-auto space-y-2",children:c.type==="immovable"?e.jsxs(e.Fragment,{children:[f(c).map(g=>{const N=d.has(`${c.id}-specific-${g.actionName}`);return e.jsx(v,{ariaLabel:`${g.actionName}${g.description?": "+g.description:""}`,cost:bt,"data-action-name":g.actionName,"data-item-id":c.id,"data-prompt-effect":g.promptEffect,disabled:a||!N&&bt>r,label:g.actionName,onClick:x,preset:"teal",pressed:N,size:"sm",title:g.description,variant:"toggleFull"},`${c.id}-ku-${g.actionName}`)}),(()=>{const g=d.has(`${c.id}-inspect`);return e.jsx(v,{ariaLabel:`Inspect ${c.name}`,cost:ft,"data-item-id":c.id,disabled:a||!g&&ft>r,label:"Inspect",onClick:b,preset:"indigo",pressed:g,size:"sm",variant:"toggleFull"})})(),(()=>{const g=d.has(`${c.id}-generic`);return e.jsx(v,{ariaLabel:`Attempt to use ${c.name}`,cost:yt,"data-item-id":c.id,disabled:a||!g&&yt>r,label:"Attempt to Use (Generic)",onClick:j,preset:"sky",pressed:g,size:"sm",variant:"toggleFull"})})()]}):e.jsx(v,{ariaLabel:c.type==="vehicle"?`Enter ${c.name}`:`Take ${c.name}`,"data-item-id":c.id,disabled:a,label:c.type==="vehicle"?"Enter Vehicle":"Take",onClick:p,preset:"green",size:"sm"})})]},c.id)})})]})}function ma({item:t,isNew:s,isStashing:a,applicableUses:n,disabled:i,currentTurn:d,onSpecificUse:r,onInspect:p,onGenericUse:b,onVehicleToggle:j,onDrop:x,onDiscard:f,onRead:c,onStashToggle:u,filterMode:m,registerRef:o,queuedActionIds:h,remainingActionPoints:g}){var A,H,y,E,D,k,z,q;const N=t.isActive&&t.activeDescription?t.activeDescription:t.description,C=zl.includes(t.type),S=Ol.includes(t.type),w=t.type!=="status effect"&&t.type!=="vehicle",L=!((A=t.tags)!=null&&A.includes("junk"))&&t.type!=="vehicle"&&t.type!=="status effect",R=m==="stashed"&&(t.stashed===!0||a),$=L&&(!C||R),I=[],[W,O]=l.useState(!1),U=l.useCallback(F=>{O(!0),F.currentTarget.blur()},[]),Y=l.useCallback(F=>{f(F),O(!1)},[f]),T=l.useCallback(F=>{O(!1),F.currentTarget.blur()},[]);n.forEach(F=>{const Q=h.has(`${t.id}-specific-${F.actionName}`);I.push(e.jsx(v,{ariaLabel:`${F.actionName}${F.description?": "+F.description:""}`,cost:bt,"data-action-name":F.actionName,"data-item-id":t.id,"data-prompt-effect":F.promptEffect,disabled:i||!Q&&bt>g,label:F.actionName,onClick:r,preset:"teal",pressed:Q,size:"sm",title:F.description,variant:"toggleFull"},`${t.id}-knownuse-${F.actionName}`))});const V=i||(C?t.id===ge?(((H=t.chapters)==null?void 0:H.length)??0)===0:((y=t.chapters)==null?void 0:y.some(F=>!F.actualContent))??!0:S?((E=t.chapters)==null?void 0:E.some(F=>!F.imageData))??!0:!1)||t.lastInspectTurn!==void 0&&d-t.lastInspectTurn<sa,B=h.has(`${t.id}-inspect`);if(I.push(e.jsx(v,{ariaLabel:`Inspect ${t.name}`,cost:ft,"data-item-id":t.id,disabled:V||!B&&ft>g,label:"Inspect",onClick:p,preset:"indigo",pressed:B,size:"sm",variant:"toggleFull"},`${t.id}-inspect`)),C&&I.push(e.jsx(v,{ariaLabel:`Read ${t.name}`,"data-item-id":t.id,disabled:i||t.id===ge&&(((D=t.chapters)==null?void 0:D.length)??0)===0,label:"Read",onClick:c,preset:"teal",size:"sm"},`${t.id}-read`)),w){const F=h.has(`${t.id}-generic`);I.push(e.jsx(v,{ariaLabel:`Attempt to use ${t.name} (generic action)`,cost:yt,"data-item-id":t.id,disabled:i||!F&&yt>g,label:"Attempt to Use (Generic)",onClick:b,preset:"sky",pressed:F,size:"sm",variant:"toggleFull"},`${t.id}-generic-use`))}return t.type==="vehicle"&&I.push(e.jsx(v,{ariaLabel:t.isActive?`Exit ${t.name}`:`Enter ${t.name}`,"data-item-id":t.id,disabled:i,label:t.isActive?`Exit ${t.name}`:`Enter ${t.name}`,onClick:j,preset:"sky",pressed:h.has(`${t.id}-specific-${t.isActive?`Exit ${t.name}`:`Enter ${t.name}`}`),size:"sm",variant:"toggleFull"},`${t.id}-vehicle-action`)),(k=t.tags)!=null&&k.includes("junk")&&(W?I.push(e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[e.jsx(v,{ariaLabel:`Confirm discard of ${t.name}`,"data-item-id":t.id,disabled:i,label:t.type==="vehicle"&&!t.isActive?"Confirm Park":"Confirm Discard",onClick:Y,preset:"red",size:"sm"},`${t.id}-confirm-discard`),e.jsx(v,{ariaLabel:"Cancel discard",disabled:i,label:"Cancel",onClick:T,preset:"slate",size:"sm"},`${t.id}-cancel-discard`)]},`${t.id}-confirm-group`)):I.push(e.jsx(v,{ariaLabel:`Discard ${t.name}`,"data-item-id":t.id,disabled:i,icon:e.jsx(J,{color:"white",inline:!0,marginRight:4,name:"trash",size:16}),label:"Discard",onClick:U,preset:"orange",size:"sm"},`${t.id}-discard`))),C&&I.push(e.jsx(v,{ariaLabel:m==="stashed"?`Retrieve ${t.name}`:`Stash ${t.name}`,"data-item-id":t.id,disabled:i,label:m==="stashed"?"Retrieve":"Stash",onClick:u,preset:"sky",size:"sm"},`${t.id}-stash`)),L&&C&&$&&I.push(e.jsx(v,{ariaLabel:`Drop ${t.name}`,"data-item-id":t.id,disabled:i,label:"Drop",onClick:x,preset:"sky",size:"sm"},`${t.id}-drop`)),L&&!C&&$&&I.push(e.jsx(v,{ariaLabel:`Drop ${t.name}`,"data-item-id":t.id,disabled:i,label:"Drop",onClick:x,preset:"sky",size:"sm"},`${t.id}-drop`)),!((z=t.tags)!=null&&z.includes("junk"))&&t.type==="vehicle"&&!t.isActive&&I.push(e.jsx(v,{ariaLabel:`Park ${t.name} here`,"data-item-id":t.id,disabled:i,label:"Park Here",onClick:x,preset:"sky",size:"sm"},`${t.id}-drop`)),e.jsxs("li",{className:`w-[270px] text-slate-300 bg-slate-700/60 p-4 rounded-md shadow border border-slate-600 ${s?"animate-new-item-pulse":""} ${a?"animate-archive-fade-out":""} flex flex-col`,"data-item-id":t.id,ref:o,children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 text-xs",children:[e.jsx(ys,{type:t.type}),t.isActive?e.jsx("span",{className:"text-green-400 font-semibold",children:"Active"}):null]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-lg text-slate-100",children:t.name})}),e.jsx("p",{className:"text-sm text-slate-300 mb-3 italic leading-tight flex-grow",children:N}),(q=t.tags)!=null&&q.includes("junk")?e.jsx("p",{className:"text-xs text-orange-400 mb-1 italic",children:"(Marked as junk)"}):null,e.jsx("div",{className:"space-y-2 mt-auto",children:I})]},t.id)}ma.defaultProps={registerRef:void 0};function ri({sortOrder:t,disabled:s,onSortByName:a,onSortByType:n}){return e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[e.jsx(v,{ariaLabel:"Sort by Name",disabled:s,label:"Sort by Name",onClick:a,preset:t==="name"?"sky":"slate",pressed:t==="name",size:"sm",variant:"toggle"}),e.jsx(v,{ariaLabel:"Sort by Type",disabled:s,label:"Sort by Type",onClick:n,preset:t==="type"?"sky":"slate",pressed:t==="type",size:"sm",variant:"toggle"})]})}function oi({filterMode:t,disabled:s,onFilterAll:a,onFilterStashed:n}){return e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[e.jsx(v,{ariaLabel:"Show All",disabled:s,label:"All",onClick:a,preset:t==="all"?"sky":"slate",pressed:t==="all",size:"sm",variant:"toggle"}),e.jsx(v,{ariaLabel:"Show Stashed",disabled:s,label:"Stashed",onClick:n,preset:t==="stashed"?"sky":"slate",pressed:t==="stashed",size:"sm",variant:"toggle"})]})}function ci({items:t,onItemInteract:s,onStashToggle:a,onReadPage:n,currentTurn:i,disabled:d,queuedActionIds:r,remainingActionPoints:p}){const{displayedItems:b,newlyAddedItemIds:j,stashingItemIds:x,sortOrder:f,handleSortByName:c,handleSortByType:u,filterMode:m,handleFilterAll:o,handleFilterStashed:h,handleSpecificUse:g,handleInspect:N,handleGenericUse:C,handleDrop:S,handleDiscard:w,handleVehicleToggle:L,handleStashToggleInternal:R,handleRead:$,getApplicableKnownUses:I}=tl({items:t,onItemInteract:s,onStashToggle:a,onReadPage:n}),W=l.useRef(new Map),O=l.useRef(new Map),U=l.useRef(d),Y=l.useCallback(T=>{if(!T)return;const V=T.dataset.itemId;V&&W.current.set(V,T)},[]);return l.useLayoutEffect(()=>{const T=new Map;if(W.current.forEach((V,B)=>{if(!V.isConnected){W.current.delete(B),O.current.delete(B);return}const A=V.getBoundingClientRect();T.set(B,new DOMRect(A.left+window.scrollX,A.top+window.scrollY,A.width,A.height))}),U.current!==d){U.current=d,O.current=T;return}d||O.current.forEach((V,B)=>{const A=T.get(B),H=W.current.get(B);if(!A||!H)return;const y=Math.round(V.left-A.left),E=Math.round(V.top-A.top);(y!==0||E!==0)&&(H.style.transition="none",H.style.transform=`translate(${String(y)}px, ${String(E)}px)`,requestAnimationFrame(()=>{H.style.transition="transform 0.2s",H.style.transform=""}),setTimeout(()=>{H.style.transition=""},200))}),O.current=T},[b,d]),e.jsxs("div",{className:"bg-slate-800 p-6 rounded-lg shadow-lg border border-slate-700 h-full",children:[e.jsxs("h3",{className:"text-xl font-bold text-amber-400 mb-2 border-b-2 border-amber-700 pb-2 flex items-center",children:[e.jsx(J,{color:"amber",inline:!0,marginRight:8,name:"inventory",size:20})," ","Inventory"]}),e.jsx(ri,{disabled:d,onSortByName:c,onSortByType:u,sortOrder:f}),e.jsx(oi,{disabled:d,filterMode:m,onFilterAll:o,onFilterStashed:h}),b.length===0?e.jsx("p",{className:"text-slate-300 italic",children:"Your pockets are empty."}):e.jsx("ul",{className:"flex flex-wrap justify-center gap-4 list-none p-0",children:b.map(T=>{const V=I(T),B=j.has(T.id),A=x.has(T.id);return e.jsx(ma,{applicableUses:V,currentTurn:i,disabled:d,filterMode:m,isNew:B,isStashing:A,item:T,onDiscard:w,onDrop:S,onGenericUse:C,onInspect:N,onRead:$,onSpecificUse:g,onStashToggle:R,onVehicleToggle:L,queuedActionIds:r,registerRef:Y,remainingActionPoints:p},T.id)})})]})}function di({allNPCs:t,currentMapNodeId:s,currentObjective:a,enableMobileTap:n,inventory:i,itemsHere:d,storyArc:r,mapNodes:p,objectiveAnimationType:b,onStashToggle:j,onItemInteract:x,onReadPage:f,onReadPlayerJournal:c,globalTurnNumber:u,disabled:m,queuedActionIds:o,remainingActionPoints:h}){const g=l.useMemo(()=>vt(i,p,t),[i,p,t]),N=r==null?void 0:r.acts[r.currentAct-1],C=(N==null?void 0:N.mainObjective)??null,S=N?`Act ${String(r.currentAct)}: ${N.title}`:"";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-start gap-4 mb-2",children:e.jsx(v,{ariaLabel:"Open journal",disabled:m,icon:e.jsx(J,{name:"journalPen",size:24}),onClick:c,preset:"blue",size:"lg",title:"Open Journal",variant:"toolbarLarge"})}),C?e.jsx(we,{backgroundColorClass:"bg-purple-800/50",borderColorClass:"border-purple-600",borderWidthClass:"border rounded-lg",containerClassName:"p-3",contentColorClass:"text-purple-200",contentFontClass:"text-lg",enableMobileTap:n,header:S,headerFont:"lg",headerPreset:"purple",highlightEntities:g,text:C}):null,a?e.jsx(we,{backgroundColorClass:"bg-amber-800/50",borderColorClass:"border-amber-600",borderWidthClass:"border rounded-lg",containerClassName:`p-3 ${b==="success"?"animate-objective-success":b==="neutral"?"animate-objective-neutral":""}`,contentColorClass:"text-amber-200",contentFontClass:"text-lg",enableMobileTap:n,header:"Current Objective",headerFont:"lg",headerPreset:"amber",highlightEntities:g,text:a}):null,e.jsx(ii,{currentNodeId:s,disabled:m,items:d,mapNodes:p,onItemInteract:x,queuedActionIds:o,remainingActionPoints:h}),e.jsx(ci,{currentTurn:u,disabled:m,items:i,onItemInteract:x,onReadPage:f,onStashToggle:j,queuedActionIds:o,remainingActionPoints:h})]})}function ui({hasGameBeenInitialized:t,showInitialLoadingSpinner:s,showSceneLoadingOverlay:a,mainToolbarProps:n,sceneDisplayProps:i,actionOptionsProps:d,freeActionInputProps:r,sidebarProps:p}){const{adventureName:b,currentSceneExists:j,isLoading:x,isTurnProcessing:f,onOpenKnowledgeBase:c,onOpenMap:u,onOpenTitleMenu:m,onOpenVisualizer:o,score:h}=n,{allNPCs:g,description:N,inventory:C,lastActionLog:S,localEnvironment:w,localPlace:L,localTime:R,mapData:$}=i,{allNPCs:I,disabled:W,inventory:O,mapData:U,onActionSelect:Y,onClearQueuedActions:T,options:V,queuedActions:B}=d,{canPerformFreeAction:A,freeFormActionText:H,onChange:y,onSubmit:E}=r,{allNPCs:D,currentMapNodeId:k,currentObjective:z,disabled:q,enableMobileTap:F,globalTurnNumber:Q,inventory:se,itemsHere:me,mapNodes:he,objectiveAnimationType:M,onItemInteract:G,onReadPage:ee,onReadPlayerJournal:oe,onStashToggle:ce,queuedActionIds:_,remainingActionPoints:ne,storyArc:Ce}=p;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"lg:col-span-2 space-y-3 flex flex-col",children:[e.jsx(ei,{adventureName:b,currentSceneExists:j,isLoading:x,isTurnProcessing:f,onOpenKnowledgeBase:c,onOpenMap:u,onOpenTitleMenu:m,onOpenVisualizer:o,score:h}),e.jsx(da,{}),s?e.jsx(je,{}):null,t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(ai,{allNPCs:g,description:N,inventory:C,lastActionLog:S,localEnvironment:w,localPlace:L,localTime:R,mapData:$}),a?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-900/75 rounded-lg",children:e.jsx(je,{})}):null]}),e.jsx(ni,{allNPCs:I,disabled:W,inventory:O,mapData:U,onActionSelect:Y,onClearQueuedActions:T,options:V,queuedActions:B}),e.jsx(li,{canPerformFreeAction:A,freeFormActionText:H,onChange:y,onSubmit:E})]}):e.jsx("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg flex-grow min-h-48"})]}),e.jsx("div",{className:"lg:col-span-2 space-y-2 flex flex-col",children:t?e.jsx(di,{allNPCs:D,currentMapNodeId:k,currentObjective:z,disabled:q,enableMobileTap:F,globalTurnNumber:Q,inventory:se,itemsHere:me,mapNodes:he,objectiveAnimationType:M,onItemInteract:G,onReadPage:ee,onReadPlayerJournal:oe,onStashToggle:ce,queuedActionIds:_,remainingActionPoints:ne,storyArc:Ce}):e.jsx("div",{className:"hidden lg:block bg-slate-800/50 border border-slate-700 rounded-lg flex-grow min-h-48"})})]})}function ha({isVisible:t,onClose:s,history:a,options:n,onOptionSelect:i,participants:d,isLoading:r,isDialogueExiting:p,inventory:b,mapData:j,allNPCs:x,heroShortName:f}){const c=l.useRef(null),u=l.useRef(null);l.useEffect(()=>{t&&u.current&&u.current.scrollIntoView({behavior:"smooth",block:"end"})},[a,t]),l.useEffect(()=>{if(!t)return;const C=c.current;C&&r&&(p===!0||n.length===0)&&C.scrollTo({top:C.scrollHeight,behavior:"smooth"})},[r,p,n.length,t,a.length]);const m=l.useMemo(()=>vt(b,j,x),[b,j,x]),o=d.join(", "),h=r||p,g=l.useCallback(C=>{const S=C.currentTarget.dataset.option;S&&(i(S),C.currentTarget.blur())},[i]);if(!t)return null;const N=()=>{if(p||r)return e.jsx(je,{});if(n.length>0)return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:n.map(C=>e.jsx(v,{ariaLabel:C,"data-option":C,disabled:h,enableHighlightTap:!0,highlightEntities:m,label:C,onClick:g,preset:"sky",size:"md",variant:"standard"},C))})};return e.jsx("div",{"aria-labelledby":"dialogue-title","aria-modal":"true",className:"dialogue-frame open",ref:c,role:"dialog",children:e.jsxs("div",{className:"dialogue-frame-content",children:[e.jsx(v,{ariaLabel:"End Conversation",disabled:r||p,icon:e.jsx(J,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}),e.jsxs("h1",{className:"text-2xl font-bold text-sky-300 mb-4 text-center",id:"dialogue-title",children:["Conversation with:"," ",o]}),e.jsx("div",{className:"dialogue-log-area flex-grow mb-4 pr-2 min-h-[200px] overflow-y-auto",children:a.map((C,S)=>{const w=C.speaker.toLowerCase()==="player",L=w?f??"Player":C.speaker;return e.jsxs("div",{className:`mb-3 p-3 rounded-lg animate-dialogue-new-entry ${w?"bg-slate-700 ml-auto w-11/12 text-right":"bg-slate-600 mr-auto w-11/12"}`,ref:S===a.length-1?u:null,children:[e.jsxs("strong",{className:w?"text-amber-400":"text-emerald-400",children:[L,":"]}),e.jsx("span",{className:"text-slate-100 ml-2",children:gt(C.line,m)})]},C.line)})}),e.jsxs("div",{className:"dialogue-options-area mt-auto pt-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(da,{}),e.jsx("div",{className:"flex-grow border-t border-slate-600 ml-2"})]}),N()]})]})})}ha.defaultProps={heroShortName:void 0,isDialogueExiting:!1};function pa({version:t,sourceInfo:s}){return e.jsxs("p",{className:"text-sm text-slate-300 absolute bottom-4 right-4",children:[e.jsx("span",{children:"Version: "+t}),e.jsx("br",{}),e.jsx("span",{children:s??null})]})}pa.defaultProps={sourceInfo:void 0};function xa({isVisible:t,onClose:s,onNewGame:a,onSaveGame:n,onLoadGame:i,onOpenSettings:d,onOpenInfo:r,onOpenGeminiKeyModal:p,isGameActive:b}){const j=l.useCallback(()=>{n&&n()},[n]);return e.jsx("div",{"aria-labelledby":"title-menu-heading","aria-modal":"true",className:`animated-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content relative",children:[" ",b?e.jsx(v,{ariaLabel:"Close Title Menu",icon:e.jsx(J,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}):null,e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full p-4 text-center",children:[e.jsx(oa,{hasGameBeenInitialized:b,theme:null}),e.jsxs("div",{className:"space-y-3 sm:space-y-3 w-full max-w-xs sm:max-w-sm",children:[!We()&&p?e.jsx(v,{ariaLabel:"Set Gemini API key",label:"Set Gemini Key",onClick:p,preset:"indigo",size:"lg"}):null,e.jsx(v,{ariaLabel:b?"Start a New Game (Progress will be lost)":"Start a New Game",disabled:!We(),label:"New Game",onClick:a,preset:"red",size:"lg"}),b&&n?e.jsx(v,{ariaLabel:"Save Current Game to File",label:"Save Game",onClick:j,preset:"green",size:"lg"}):null,e.jsx(v,{ariaLabel:b?"Load Game from File (Current progress will be lost)":"Load Game from File",disabled:!We(),label:"Load Game",onClick:i,preset:"blue",size:"lg"}),e.jsx(v,{ariaLabel:"Open Settings",label:"Settings",onClick:d,preset:"gray",size:"lg"}),e.jsx(v,{ariaLabel:"About & Game Guide",label:"About",onClick:r,preset:"cyan",size:"lg"}),b?e.jsx(v,{ariaLabel:"Return to Game",label:"Return to Game",onClick:s,preset:"sky",size:"lg"}):null]})]}),e.jsx(pa,{sourceInfo:sl()?"Using System Gemini Key":void 0,version:Rl})]})})}xa.defaultProps={onOpenGeminiKeyModal:void 0,onSaveGame:void 0};function ga({theme:t,onSelect:s,disabled:a=!1}){const n=l.useCallback(()=>{s()},[s]);return e.jsx(v,{ariaLabel:`Start a new game in the theme: ${t.name}${a?" (Current theme, cannot select)":""}`,disabled:a,label:e.jsxs("div",{className:"flex flex-col items-start text-left w-full",style:{minHeight:"180px"},children:[e.jsx("h3",{className:"text-xl font-semibold text-amber-400 mb-2",children:t.name}),e.jsx("p",{className:"text-sm text-slate-300 leading-snug line-clamp-8",children:t.storyGuidance}),a?e.jsx("p",{className:"text-xs text-orange-300 mt-1 italic",children:"(Currently active theme)"}):null]}),onClick:n,preset:"slate",variant:"standard"})}ga.defaultProps={disabled:!1};function ba({isVisible:t,onClose:s,onThemeSelected:a,disabledThemeName:n=null,titleText:i=void 0,descriptionText:d=void 0}){const r=l.useCallback(x=>()=>{a(x)},[a]);if(!t)return null;const p=Object.keys(Ws).reduce((x,f)=>{const c=f;return x[c]=Ws[c],x},{}),b=i??"Choose Your Adventure Theme",j=d??"Select a theme to start your adventure. The story will remain in this setting until you begin a new game.";return e.jsx("div",{"aria-labelledby":"custom-game-setup-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(v,{ariaLabel:"Close theme selection",icon:e.jsx(J,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}),e.jsxs("div",{className:"flex flex-col items-center w-full h-full p-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-4 text-center",id:"custom-game-setup-title",children:b}),e.jsx("p",{className:"text-slate-300 mb-6 text-center text-sm max-w-2xl",children:j}),Object.keys(p).length===0?e.jsx("p",{className:"text-slate-300 italic",children:"No themes available. Please check configuration."}):e.jsx("div",{className:"overflow-y-auto flex-grow w-full max-w-5xl px-6",children:Object.entries(p).map(([x,f])=>f.length>0&&e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold text-purple-400 mb-3 pb-1 border-b border-purple-600",children:x}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4",children:f.map(c=>{const u=c.name===n;return e.jsx(ga,{disabled:u,onSelect:r(c.name),theme:c},c.name)})})]},x))})]})]})})}ba.defaultProps={descriptionText:void 0,disabledThemeName:null,titleText:void 0};function fa({options:t,selected:s,onToggle:a,errorText:n}){const i=l.useCallback(d=>{a(d.currentTarget.value)},[a]);return e.jsxs("div",{className:"space-y-3",children:[t.map(d=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-2 bg-slate-700/50 rounded-md hover:bg-slate-600/50 transition-colors",children:[e.jsx("input",{"aria-labelledby":`${d}-label`,checked:s.includes(d),className:"form-checkbox h-5 w-5 text-sky-500 bg-slate-600 border-slate-500 rounded focus:ring-sky-400 focus:ring-offset-slate-800",onChange:i,type:"checkbox",value:d}),e.jsx("span",{className:"text-slate-200 text-lg",id:`${d}-label`,children:d})]},d)),n?e.jsx("p",{className:"text-red-400 mt-2 text-sm",children:n}):null]})}fa.defaultProps={errorText:void 0};function js({name:t,options:s,value:a,onChange:n,addCustom:i=!1,placeholder:d=""}){const r=s.includes(a),p=r||!i||a==="Not Specified"?"":a,[b,j]=l.useState(p);l.useEffect(()=>{const o=s.includes(a);j(o||!i||a==="Not Specified"?"":a)},[a,s,i]);const x=l.useCallback(o=>{n(o==="Custom"?b.trim()||"Not Specified":o)},[b,n]),f=l.useCallback(o=>{x(o.currentTarget.value)},[x]),c=l.useCallback(o=>{const h=o.target.value;j(h),s.includes(a)||n(h.trim()||"Not Specified")},[n,s,a]),u=r?a:"Custom",m=i?[...s,"Custom"]:s;return e.jsxs("div",{className:"space-y-3",children:[m.map(o=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-2 bg-slate-700/50 rounded-md hover:bg-slate-600/50 transition-colors",children:[e.jsx("input",{"aria-labelledby":`${t}-${o}`,checked:u===o,className:"form-radio h-5 w-5 text-sky-500 bg-slate-600 border-slate-500 focus:ring-sky-400 focus:ring-offset-slate-800",name:t,onChange:f,type:"radio",value:o}),e.jsx("span",{className:"text-slate-200 text-lg",id:`${t}-${o}`,children:o})]},o)),i&&u==="Custom"?e.jsx("input",{"aria-label":"Custom input",className:"w-full p-2 mt-2 bg-slate-600 text-slate-100 border border-slate-500 rounded-md focus:ring-sky-500 focus:border-sky-500",onChange:c,placeholder:d,type:"text",value:b}):null]})}js.defaultProps={addCustom:!1,placeholder:""};function mi({enabledThemePacks:t,isVisible:s,onChangeThinkingEffort:a,onChangePreferredPlayerName:n,onClose:i,onToggleThemePack:d,preferredPlayerName:r,thinkingEffort:p}){const b=l.useCallback(c=>{d(c)},[d]),j=l.useCallback(c=>{b(c)},[b]),x=l.useCallback(c=>{a(c)},[a]),f=l.useCallback(c=>{const m=c.target.value.replace(/[^a-zA-Z0-9\s\-"']/g,"");n(m)},[n]);return e.jsx("div",{"aria-labelledby":"settings-title","aria-modal":"true",className:`animated-frame ${s?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(v,{ariaLabel:"Close settings",icon:e.jsx(J,{name:"x",size:20}),onClick:i,size:"sm",variant:"close"}),e.jsxs("div",{className:"settings-content-area",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-8 text-center",id:"settings-title",children:"Game Settings"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Preferred Player Name"}),e.jsx("p",{className:"settings-explanation mb-3",children:"Optional: if set, this name appears as the first option when choosing your character. Disallowed characters are removed automatically."}),e.jsx("input",{"aria-label":"Preferred player name",className:"w-full p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500",onChange:f,placeholder:"e.g., Morgan",type:"text",value:r})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Thinking Effort"}),e.jsx("p",{className:"settings-explanation mb-3",children:"Select how much reasoning the AI uses. Higher levels may improve quality at the cost of time, but will not affect API usage quotas."}),e.jsx(js,{name:"thinking-effort",onChange:x,options:["Low","Medium","High"],value:p})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-amber-400 mb-3 pb-1 border-b border-amber-600",children:"Theme Pack Preferences"}),e.jsx("p",{className:"settings-explanation mb-3",children:"Select which genre packs to include when choosing a starting theme. At least one pack must be enabled. You can change this setting at any time."}),e.jsx(fa,{errorText:t.length===0?"At least one theme pack must be enabled. Please select a pack to continue.":void 0,onToggle:j,options:_l,selected:t})]})]})]})})}function hi({title:t,items:s}){return e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-medium text-sky-400 mb-2",children:t}),e.jsx("ul",{className:"list-disc list-inside ml-4 space-y-1",children:s.map(a=>e.jsx("li",{children:a},a))})]})}const Nt=Ql;function pi(t){return t.replace(/\{\{CURRENT_SAVE_GAME_VERSION\}\}/g,Vl).replace(/\{\{GEMINI_MODEL_NAME\}\}/g,aa).replace(/\{\{GEMINI_LITE_MODEL_NAME\}\}/g,na).replace(/\{\{GEMINI_PRO_MODEL_NAME\}\}/g,Bl).replace(/\{\{MINIMAL_MODEL_NAME\}\}/g,la)}const xi=Nt.sections.map(t=>e.jsx(we,{contentFontClass:"leading-relaxed space-y-3",header:t.header,text:t.text.map(s=>pi(s)).join(`
`)},t.header)),gi=Nt.changelog.map(t=>e.jsx(hi,{items:t.items,title:t.title},t.title));function bi({isVisible:t,onClose:s}){return e.jsx("div",{"aria-labelledby":"info-title","aria-modal":"true",className:`animated-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(v,{ariaLabel:"Close game information",icon:e.jsx(J,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}),e.jsxs("div",{className:"info-content-area",children:[e.jsx(we,{borderColorClass:"border-sky-700",borderWidthClass:"border-b-2",containerClassName:"mb-6",header:Nt.title,headerFont:"3xl",headerPreset:"sky",headerTag:"h1",headerWrapperClassName:"text-center"}),xi,e.jsx(we,{contentFontClass:"leading-relaxed space-y-4",header:"Changelog",children:gi}),e.jsx(we,{containerClassName:"mt-8",contentColorClass:"text-slate-500",contentFontClass:"text-sm text-center",text:Nt.footer})]})]})})}const fi=fs.memo(bi);function yi({isVisible:t,facts:s,onSubmit:a,onClose:n}){const[i,d]=l.useState({});l.useEffect(()=>{t&&d({})},[s,t]);const r=l.useCallback((u,m)=>{d(o=>({...o,[u]:o[u]===m?void 0:m}))},[]),p=l.useCallback(()=>{const u=[],m=[];s.forEach((o,h)=>{i[h]==="good"&&u.push(o),i[h]==="bad"&&m.push(o)}),a(u,m,!0)},[s,i,a]),b=l.useCallback(()=>{a([],[],!1)},[a]),j=l.useCallback(u=>{r(u,"good")},[r]),x=l.useCallback(u=>{r(u,"bad")},[r]),f=l.useMemo(()=>s.map((u,m)=>()=>{j(m)}),[s,j]),c=l.useMemo(()=>s.map((u,m)=>()=>{x(m)}),[s,x]);return e.jsx("div",{"aria-labelledby":"debug-lore-title","aria-modal":"true",className:`animated-frame debug-lore-frame ${t?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(v,{ariaLabel:"Close debug lore",icon:e.jsx(J,{name:"x",size:20}),onClick:n,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-2xl font-bold text-amber-400 mb-3 text-center",id:"debug-lore-title",children:"Evaluate Extracted Facts"}),e.jsx("ul",{className:"mb-4 space-y-2",children:s.map((u,m)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"flex-grow text-slate-300",children:u}),e.jsx(v,{ariaLabel:"Mark good",label:"Good",onClick:f[m],preset:"green",pressed:i[m]==="good",size:"sm",variant:"toggle"}),e.jsx(v,{ariaLabel:"Mark bad",label:"Bad",onClick:c[m],preset:"red",pressed:i[m]==="bad",size:"sm",variant:"toggle"})]},u))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(v,{ariaLabel:"Skip",label:"Skip",onClick:b,preset:"stone",size:"sm"}),e.jsx(v,{ariaLabel:"OK",label:"OK",onClick:p,preset:"sky",size:"sm"})]})]})})}function ji({isVisible:t,onClose:s}){const[a,n]=l.useState("");l.useEffect(()=>{t&&n(al()??"")},[t]);const i=l.useCallback(r=>{n(r.target.value)},[]),d=l.useCallback(()=>{nl(a.trim()),s()},[a,s]);return t?e.jsx("div",{"aria-labelledby":"gemini-key-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex flex-col items-center",children:[e.jsx(v,{ariaLabel:"Close Gemini key setup",icon:e.jsx(J,{name:"x",size:20}),onClick:s,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-2xl font-bold text-sky-300 mb-4",id:"gemini-key-title",children:"Configure Gemini API Key"}),e.jsxs("div",{className:"mb-4 text-slate-200 text-center",children:["Visit"," ",e.jsx("a",{className:"text-sky-400 underline hover:text-sky-300",href:"https://aistudio.google.com",rel:"noopener noreferrer",target:"_blank",children:"https://aistudio.google.com"})," ","to generate a free API key. Paste it below."]}),e.jsxs("div",{className:"flex w-full max-w-md space-x-2",children:[e.jsx("input",{"aria-label":"Gemini API key",className:"flex-grow p-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500",onChange:i,placeholder:"Enter API key",type:"password",value:a}),e.jsx(v,{ariaLabel:"Save API key",disabled:a.trim()==="",label:"Save",onClick:d,preset:"green",variant:"compact"})]}),e.jsx("div",{className:"mb-4 text-amber-400 text-center",children:"The game runs entirely in your browser. The key never leaves your device and will be stored in the Browser's Local Storage."})]})}):null}function Ci({isVisible:t,defaultGender:s,onSubmit:a}){const[n,i]=l.useState(s),d=l.useCallback(()=>{a(n.trim()||"Not Specified")},[n,a]);return t?e.jsx("div",{"aria-labelledby":"gender-select-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex flex-col items-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-sky-300 mb-4",id:"gender-select-title",children:"Choose Your Character's Gender"}),e.jsx("div",{className:"mb-6 w-full max-w-xs",children:e.jsx(js,{addCustom:!0,name:"heroGender",onChange:i,options:["Male","Female"],placeholder:"Enter custom gender",value:n})}),e.jsx(v,{ariaLabel:"Confirm gender",icon:e.jsx(J,{name:"bookOpen",size:20}),label:"Continue",onClick:d,preset:"green",size:"lg"})]})}):null}function Ni({act:t,isTurnGenerating:s,onContinue:a}){return e.jsx("div",{"aria-labelledby":"act-intro-heading","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h2",{className:"mb-4 text-center text-3xl font-bold text-amber-400",id:"act-intro-heading",children:`Act ${String(t.actNumber)}: ${t.title}`}),e.jsx("div",{className:"mt-4 w-4/5 flex-1 max-h-[60vh] overflow-y-auto rounded p-4 text-left text-slate-300 space-y-6",children:e.jsx("section",{className:"space-y-2 text-lg",children:e.jsx("p",{className:"whitespace-pre-line text-center",children:t.description})})}),e.jsxs("div",{className:"mt-8 flex items-center space-x-4 self-center",children:[e.jsx(v,{ariaLabel:"Continue",label:"Continue",onClick:a,preset:"blue",size:"lg"}),s?e.jsx(je,{showText:!1,size:"sm"}):null]})]})})}function vi({heroSheet:t,storyArc:s,onClose:a}){return e.jsx("div",{"aria-labelledby":"victory-heading","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold",id:"victory-heading",children:"Victory!"}),e.jsx("p",{className:"mt-4",children:`You guided ${t.name}, ${t.occupation}, through ${s.title}.`}),e.jsx("div",{className:"mt-8 w-4/5 max-h-[60vh] flex-1 overflow-y-auto rounded p-4 text-left",children:e.jsx("ul",{className:"space-y-6",children:s.acts.map(n=>e.jsxs("li",{children:[e.jsx("p",{className:"font-semibold text-center",children:`Act ${String(n.actNumber)}: ${n.title}`}),e.jsx("p",{className:"mt-2",children:n.description})]},n.actNumber))})}),e.jsx("div",{className:"mt-8 self-center",children:e.jsx(v,{ariaLabel:"Return to Title Menu",label:"Return to Title",onClick:a,preset:"blue",size:"lg"})})]})})}function ki({label:t,text:s}){return e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:t}),": ",s]})}function ya({option:t,onSelect:s,disabled:a=!1}){const n=l.useCallback(()=>{s(t)},[s,t]);return e.jsx(v,{ariaLabel:`Select character ${t.name}${a?" (selected)":""}`,disabled:a,label:e.jsxs("div",{className:"flex flex-col items-start text-left w-full",style:{minHeight:"120px"},children:[e.jsx("h3",{className:"text-xl font-semibold text-amber-400 mb-2",children:t.name}),e.jsx("p",{className:"text-sm text-slate-300 leading-snug line-clamp-8",children:t.description}),a?e.jsx("p",{className:"text-xs text-orange-300 mt-1 italic",children:"(Selected)"}):null]}),onClick:n,preset:"slate",variant:"standard"})}ya.defaultProps={disabled:!1};function Si({isVisible:t,theme:s,heroGender:a,WorldSheet:n,options:i,onHeroData:d,onComplete:r}){const[p,b]=l.useState(null),[j,x]=l.useState(null),[f,c]=l.useState(null),[u,m]=l.useState(!1),[o,h]=l.useState(!1),g=l.useCallback(S=>{b(S.name),m(!0),(async()=>{const w=await ll(s,a,n,S.name,S.description),L={name:S.name,heroSheet:(w==null?void 0:w.heroSheet)??null,heroBackstory:(w==null?void 0:w.heroBackstory)??null,storyArc:(w==null?void 0:w.storyArc)??null};x(L.heroSheet),c(L.heroBackstory),m(!1),h(!0),d(L).finally(()=>{h(!1)})})()},[s,a,n,d]),N=l.useCallback(()=>{p&&r()},[p,r]),C=l.useCallback(S=>e.jsx(ya,{disabled:p===S.name,onSelect:g,option:S},S.name),[p,g]);return t?e.jsx("div",{"aria-labelledby":"character-select-title","aria-modal":"true",className:"animated-frame open",role:"dialog",children:e.jsxs("div",{className:"animated-frame-content character-select-content-area flex max-h-[80vh] w-full flex-col items-center p-8 text-center",children:[e.jsx("h1",{className:"mb-4 text-center text-3xl font-bold text-sky-300",id:"character-select-title",children:"Choose Your Character"}),e.jsxs("p",{className:"mb-6 max-w-2xl text-center text-sm text-slate-300",children:["Explore the world of"," ",e.jsx("span",{className:"font-semibold",children:s.name}),". ","Select a character to begin your adventure."]}),u?e.jsx(je,{}):j&&f?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-4 w-4/5 flex-1 max-h-[60vh] overflow-y-auto rounded p-4 text-left text-slate-300 space-y-8",children:[e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h2",{className:"text-center font-semibold text-amber-400",children:j.name}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Occupation:"})," ",j.occupation]}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Traits:"})," ",j.traits.join(", ")]}),e.jsxs("p",{className:"text-center",children:[e.jsx("span",{className:"font-semibold text-amber-300",children:"Starting Items:"})," ",j.startingItems.join(", ")]})]}),e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h3",{className:"text-center font-semibold text-sky-300",children:"Backstory"}),e.jsx("div",{className:"space-y-2 whitespace-pre-line",children:[{label:"5 years ago",text:f.fiveYearsAgo},{label:"1 year ago",text:f.oneYearAgo},{label:"6 months ago",text:f.sixMonthsAgo},{label:"1 month ago",text:f.oneMonthAgo},{label:"1 week ago",text:f.oneWeekAgo},{label:"Yesterday",text:f.yesterday},{label:"Now",text:f.now}].map(({label:S,text:w})=>e.jsx(ki,{label:S,text:w},S))})]}),e.jsxs("section",{className:"space-y-2 text-lg",children:[e.jsx("h3",{className:"text-center font-semibold text-sky-300",children:"World Information"}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Geography:"})," ",n.geography]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Climate:"})," ",n.climate]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Technology Level:"})," ",n.technologyLevel]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Supernatural Elements:"})," ",n.supernaturalElements]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Major Factions:"})," ",n.majorFactions.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Key Resources:"})," ",n.keyResources.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Cultural Notes:"})," ",n.culturalNotes.join(`
`)]}),e.jsxs("p",{className:"whitespace-pre-line",children:[e.jsx("span",{className:"font-semibold text-sky-300",children:"Notable Locations:"})," ",n.notableLocations.join(`
`)]})]})]}),e.jsxs("div",{className:"mt-8 flex items-center justify-center space-x-4",children:[e.jsx(v,{ariaLabel:"Begin the adventure",icon:e.jsx(J,{name:"bookOpen",size:20}),label:"Begin the Journey",onClick:N,preset:"green",size:"lg"}),o?e.jsx(je,{showText:!1,size:"sm"}):null]})]}):e.jsx("div",{className:"mt-4 w-4/5 flex-1 grid grid-cols-1 gap-4 overflow-y-auto p-4 md:grid-cols-2",children:i.map(C)})]})}):null}function wi({allNPCs:t,theme:s,isVisible:a,onClose:n}){const i=l.useMemo(()=>[...t].sort((r,p)=>r.name.localeCompare(p.name)),[t]),d=l.useCallback(r=>{var j;const p=r.lastKnownLocation,b=typeof p=="string"&&p!=="Unknown";if(s&&Wl.includes(r.presenceStatus)){const x=r.presenceStatus==="companion",f=x?"companion":"nearbyNpc",c=x?"text-green-300":"text-sky-300",u=x?"(Companion)":"(Nearby)",m=(j=r.preciseLocation)==null?void 0:j.trim();return e.jsxs("p",{className:"text-sm text-slate-300 flex items-center",children:[e.jsx(J,{color:x?"green":"sky",inline:!0,marginRight:4,name:f,size:16}),e.jsx("span",{className:`ml-1 ${c} italic`,children:m&&m.length>0?e.jsxs(e.Fragment,{children:[m," ",u]}):u})]})}return b?e.jsx("p",{className:"text-sm text-slate-300 flex items-center",children:e.jsxs("span",{className:"ml-1 italic",children:[p," ","(",r.presenceStatus,")"]})}):e.jsx("p",{className:"text-sm text-slate-500 flex items-center",children:e.jsxs("span",{className:"ml-1 italic",children:["(",r.presenceStatus,")"]})})},[s]);return e.jsx("div",{"aria-labelledby":"knowledge-base-title","aria-modal":"true",className:`animated-frame ${a?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(v,{ariaLabel:"Close knowledge base",icon:e.jsx(J,{name:"x",size:20}),onClick:n,size:"sm",variant:"close"}),e.jsxs("div",{className:"knowledge-base-content-area",children:[e.jsx("h1",{className:"text-3xl font-bold text-sky-300 mb-6 text-center",id:"knowledge-base-title",children:"Knowledge Base"}),i.length===0&&a?e.jsx("p",{className:"text-slate-300 italic text-center",children:"No knowledge has been recorded yet."}):null,a?e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"kb-group-title",children:"NPCs"}),i.length>0&&e.jsx("div",{className:"kb-card-grid",children:i.map(r=>e.jsxs("div",{className:"kb-card",children:[e.jsx("div",{className:"kb-card-name-header",children:r.name}),r.aliases&&r.aliases.length>0?e.jsx("p",{className:"kb-card-aliases",children:r.aliases.join(", ")}):null,e.jsx("p",{className:"kb-card-description",children:r.description}),e.jsx("div",{className:"mt-2 pt-2 border-t border-slate-600",children:d(r)}),r.knowsPlayerAs.length>0?e.jsxs("p",{className:"text-sm text-slate-400",children:["Knows you as:"," ",r.knowsPlayerAs.join(", ")]}):e.jsx("p",{className:"text-sm text-slate-500 italic",children:"Does not know your name."})]},r.name))})]}):null]})]})})}const Ei=new Set(["feature","room","interior"]),xt=t=>{if(t.visualRadius)return t.visualRadius;switch(t.type){case"region":return Se*2.4;case"location":return Se*2;case"settlement":return Se*1.8;case"district":return Se*1.6;case"exterior":return Se*1.4;case"interior":return Se*1.2;case"room":return Se*.8;case"feature":return Se*.6;default:return Se*.6}},ja=(t,s,a)=>{if(!t)return[];const n=t.split(" "),i=[];let d="";for(const r of n){if(i.length===a)break;if(d.length===0)d=r;else if(d.length+r.length+1<=s)d+=` ${r}`;else{if(i.push(d),i.length===a){if(r){const p=i[a-1];p.length>3?i[a-1]=p.slice(0,-3)+"...":i[a-1]=".."}d="";break}d=r}}if(d&&i.length<a?i.push(d):d&&i.length===a&&i[a-1]&&!i[a-1].endsWith("...")&&(i[a-1].length>3?i[a-1]=i[a-1].slice(0,-3)+"...":i[a-1]=".."),i.length===a&&t.split(" ").length>n.indexOf(d.split(" ")[0])+d.split(" ").length){const r=i[a-1];r&&r.length>3&&!r.endsWith("...")?i[a-1]=r.slice(0,Math.max(0,r.length-3))+"...":r&&!r.endsWith("...")&&(i[a-1]="..")}return i},et=t=>!!t&&Ei.has(t),Ca=t=>t==="feature",Mi=(t,s)=>{const a=new Map(t.map(o=>[o.id,o])),n=new Map;t.forEach(o=>{if(o.parentNodeId){const h=n.get(o.parentNodeId)??[];h.push(o),n.set(o.parentNodeId,h)}});const i=new Map,d=o=>{if(!o)return 0;const h=i.get(o.id);if(h!==void 0)return h;const g=o.parentNodeId?a.get(o.parentNodeId):void 0,N=g?d(g)+1:0;return i.set(o.id,N),N};t.forEach(o=>d(o));const r=o=>n.has(o.id),p=o=>et(o.type)?7:12,b={},j=o=>{const h=b[o.id];if(h)return h;const g=et(o.type)||!r(o)?20:25,N=ja(o.placeName,g,ia);return b[o.id]=N,N},x=o=>j(o).length*p(o)*Ct,f=o=>Math.max(...j(o).map(h=>h.length*p(o)*.6)),c=(o,h)=>{const g=f(o),N=x(o);if(Ca(o.type))return{x:o.position.x-g/2,y:o.position.y-N/2,width:g,height:N*2};const C=xt(o)+jt+h;return{x:o.position.x-g/2,y:o.position.y+C,width:g,height:N}},u={};t.forEach(o=>{u[o.id]=0});const m=(o,h)=>o.x<h.x+h.width&&o.x+o.width>h.x&&o.y<h.y+h.height&&o.y+o.height>h.y;return n.forEach(o=>{const h=[...o].sort((g,N)=>g.position.x-N.position.x);for(let g=1;g<h.length;g++){const N=h[g-1],C=h[g];let S=c(N,u[N.id]),w=c(C,u[C.id]);if(m(S,w)){const L=S.y+S.height-w.y+s;C.type!=="feature"?(u[C.id]+=L,w=c(C,u[C.id])):N.type!=="feature"&&(u[N.id]+=L,S=c(N,u[N.id]))}}}),t.forEach(o=>{if(o.type==="feature")return;const h=t.filter(g=>g.type==="feature"&&qs(g,o,a));for(const g of h){const N=c(o,u[o.id]),C=c(g,u[g.id]);if(m(N,C)){const S=C.y+C.height-N.y+s;u[o.id]+=S}}}),u},Ks=(t,s)=>{const a=t.position.x,n=t.position.y,i=s.position.x,d=s.position.y,r=i-a,p=d-n,b=Math.sqrt(r*r+p*p)||1,j=(a+i)/2,x=(n+d)/2,f=b*.3,c=-p/b,u=r/b,m=j+c*f,o=x+u*f;return`M ${String(a)} ${String(n)} Q ${String(m)} ${String(o)} ${String(i)} ${String(d)}`},Li={};function Ii({nodes:t,edges:s,currentMapNodeId:a,destinationNodeId:n,itemPresenceByNode:i=Li,onSelectDestination:d,labelOverlapMarginPx:r,itemIconScale:p,initialViewBox:b,onViewBoxChange:j}){const x=il(b,j),{svgRef:f,viewBox:c,handleMouseDown:u,handleMouseMove:m,handleMouseUp:o,handleMouseLeave:h,handleWheel:g,handleTouchStart:N,handleTouchMove:C,handleTouchEnd:S}=x,{tooltip:w,tooltipScreenPosition:L,isTooltipLocked:R,handleMouseLeaveGeneral:$,handleSvgClick:I,handleEdgeMouseEnterById:W,handleNodeMouseEnterById:O,handleNodeClickById:U,handleDestinationClick:Y}=rl({nodes:t,edges:s,svgRef:f,viewBox:c,destinationNodeId:n,onSelectDestination:d}),T=l.useMemo(()=>new Map(t.map(y=>[y.id,y])),[t]),V=l.useMemo(()=>Mi(t,r),[t,r]),B=l.useMemo(()=>{const y=new Map,E=D=>{if(!D)return 0;const k=y.get(D.id);if(k!==void 0)return k;const z=D.parentNodeId?T.get(D.parentNodeId):void 0,q=z?E(z)+1:0;return y.set(D.id,q),q};return t.forEach(D=>E(D)),y},[t,T]),A=l.useMemo(()=>[...t].sort((y,E)=>(B.get(y.id)??0)-(B.get(E.id)??0)),[t,B]),H=l.useMemo(()=>{if(!n)return null;const y=T.get(n)??null,E=a?T.get(a)??null:null;return!y||E&&(E.id===y.id||qs(E,y,T))?null:e.jsx("polygon",{className:"map-destination-marker",pointerEvents:"none",points:"0,-14 10,0 0,14 -10,0",transform:`translate(${String(y.position.x)}, ${String(y.position.y)})`})},[n,T,a]);return t.length===0?e.jsx("div",{className:"map-content-area",children:e.jsx("p",{className:"text-slate-500 italic",children:"No map data available."})}):e.jsxs("div",{className:"map-content-area",children:[e.jsx("svg",{className:"map-svg-container",onClick:I,onMouseDown:u,onMouseLeave:h,onMouseMove:m,onMouseUp:o,onTouchEnd:S,onTouchMove:C,onTouchStart:N,onWheel:g,preserveAspectRatio:"xMidYMid meet",ref:f,viewBox:c,children:e.jsxs("g",{children:[s.map(y=>{const E=T.get(y.sourceNodeId),D=T.get(y.targetNodeId);if(!E||!D)return null;let k="map-edge";return k+=` ${y.type.replace(/\s+/g,"_").toLowerCase()}`,k+=` ${y.status.replace(/\s+/g,"_").toLowerCase()}`,e.jsx("g",{className:"map-edge-group","data-edge-id":y.id,onMouseEnter:W,onMouseLeave:$,children:y.type==="shortcut"?e.jsxs(e.Fragment,{children:[e.jsx("path",{d:Ks(E,D),fill:"none",stroke:"transparent",strokeWidth:Js}),e.jsx("path",{className:k,d:Ks(E,D)})]}):e.jsxs(e.Fragment,{children:[e.jsx("line",{stroke:"transparent",strokeWidth:Js,x1:E.position.x,x2:D.position.x,y1:E.position.y,y2:D.position.y}),e.jsx("line",{className:k,x1:E.position.x,x2:D.position.x,y1:E.position.y,y2:D.position.y})]})},y.id)}),A.map(y=>{let E="map-node-circle";E+=` ${y.type}`,y.id===a&&(E+=" current");const D=y.status.replace(/\s+/g,"_").toLowerCase();E+=` ${D}`;const k=xt(y);return e.jsxs("g",{className:"map-node","data-node-id":y.id,onClick:U,onMouseLeave:$,transform:`translate(${String(y.position.x)}, ${String(y.position.y)})`,children:[e.jsx("circle",{className:E,"data-node-id":y.id,onMouseEnter:y.type==="feature"?O:void 0,onMouseLeave:y.type==="feature"?$:void 0,pointerEvents:y.type==="feature"?"visible":"none",r:k}),e.jsx("circle",{className:"map-node-hover-ring","data-node-id":y.id,fill:"none",onMouseEnter:O,onMouseLeave:$,pointerEvents:"stroke",r:k,stroke:"transparent",strokeWidth:8})]},y.id)}),H,A.map(y=>{const E=i[y.id]??{hasUseful:!1,hasVehicle:!1};if(!E.hasUseful&&!E.hasVehicle)return null;const k=xt(y)+jt*1.5,z=Se*2*p,q=y.position.x+k*Math.sin(20*Math.PI/180)-z/2,F=y.position.y-k*Math.cos(20*Math.PI/180)-z/2,Q=y.position.x+k*Math.sin(340*Math.PI/180)-z/2,se=y.position.y-k*Math.cos(340*Math.PI/180)-z/2;return e.jsxs("g",{children:[E.hasUseful?e.jsx("g",{pointerEvents:"none",transform:`translate(${String(q)}, ${String(F)})`,children:e.jsx(J,{color:"green",name:"mapItemBox",size:z,wrapper:"g"})}):null,E.hasVehicle?e.jsx("g",{pointerEvents:"none",transform:`translate(${String(Q)}, ${String(se)})`,children:e.jsx(J,{color:"green",name:"mapWheel",size:z,wrapper:"g"})}):null]},`${y.id}-icons`)}),A.map(y=>{const E=et(y.type)?20:25,D=ja(y.placeName,E,ia),k=xt(y),z=et(y.type)?7:12,q=k+jt+(V[y.id]??0),F=Ca(y.type)?-(D.length-1)*.5*Ct+.3:q/z;return e.jsx("text",{className:`map-node-label${et(y.type)?y.type==="feature"?" feature-label":y.type==="room"?" room-label":" interior-label":""}`,"data-node-id":y.id,onMouseEnter:O,onMouseLeave:$,pointerEvents:"visible",transform:`translate(${String(y.position.x)}, ${String(y.position.y)})`,children:D.map((Q,se)=>e.jsx("tspan",{dy:se===0?`${String(F)}em`:`${String(Ct)}em`,x:"0",children:Q},`${y.id}-${Q}`))},`label-${y.id}`)})]})}),w&&L?e.jsxs("div",{className:`map-tooltip anchor-${w.anchor}`,style:{top:L.y,left:L.x,pointerEvents:R?"auto":"none"},children:[R&&w.nodeId?e.jsx("div",{className:"mb-1",children:e.jsx(v,{ariaLabel:w.nodeId===n?"Remove Destination":"Set Destination","data-node-id":w.nodeId,label:w.nodeId===n?"Remove Destination":"Set Destination",onClick:Y,preset:"amber",size:"sm",variant:"standard"})}):null,w.content.split(`
`).map((y,E)=>e.jsxs(l.Fragment,{children:[E===0?e.jsx("strong",{children:y}):y,E<w.content.split(`
`).length-1&&e.jsx("br",{})]},`${String(w.nodeId)}-${y}`))]}):null]})}function pt({label:t,id:s,value:a,onChange:n,min:i,max:d,step:r,explanation:p=""}){const b=l.useCallback(j=>{n(parseFloat(j.target.value))},[n]);return e.jsxs("div",{className:"map-control-group",children:[e.jsxs("label",{className:"map-control-label",htmlFor:s,children:[t,": ",a.toFixed(r<1?2:0)]}),e.jsx("input",{className:"map-control-input",id:s,max:d,min:i,onChange:b,step:r,type:"range",value:a}),p?e.jsx("p",{className:"map-control-explanation",children:p}):null]})}function Ti(t){const[s,a]=l.useState(!1),n=l.useCallback(()=>{a(m=>!m)},[]),{padding:i,setPadding:d,anglePadding:r,setAnglePadding:p,overlapMargin:b,setOverlapMargin:j,itemIconScale:x,setItemIconScale:f,onReset:c,onRefreshLayout:u}=t;return e.jsxs("div",{className:`map-controls-container ${s?"controls-expanded":""}`,children:[s?e.jsxs("div",{className:"map-layout-sliders-wrapper",children:[e.jsx(pt,{explanation:"Distance between parent and child levels",id:"layoutPadding",label:"Padding",max:60,min:5,onChange:d,step:1,value:i}),e.jsx(pt,{explanation:"Extra spacing between siblings",id:"layoutAnglePadding",label:"Angle Padding",max:.5,min:0,onChange:p,step:.01,value:r}),e.jsx(pt,{explanation:"Extra spacing when labels overlap",id:"overlapMargin",label:"Overlap Margin",max:10,min:0,onChange:j,step:1,value:b}),e.jsx(pt,{explanation:"Relative size of item markers",id:"itemIconScale",label:"Icon Size",max:1,min:.2,onChange:f,step:.1,value:x}),e.jsx("div",{className:"mt-2",children:e.jsx(v,{ariaLabel:"Reset to Defaults",label:"Reset to Defaults",onClick:c,preset:"orange",variant:"standard"})})]}):null,e.jsxs("div",{className:"map-action-buttons-row",children:[e.jsx(v,{ariaLabel:"Toggle Layout Controls",label:`${s?"Hide":"Show"} Layout Controls`,onClick:n,preset:"blue",size:"sm",variant:"compact"}),e.jsx(v,{ariaLabel:"Refresh Layout",label:"Refresh Layout",onClick:u,preset:"blue",size:"sm",variant:"compact"})]})]})}function Pi({mapData:t,adventureName:s,currentMapNodeId:a,destinationNodeId:n,itemPresenceByNode:i,onSelectDestination:d,initialLayoutConfig:r,initialViewBox:p,onViewBoxChange:b,onNodesPositioned:j,onLayoutConfigChange:x,isVisible:f,onClose:c}){const[u,m]=l.useState([]),[o,h]=l.useState(r.IDEAL_EDGE_LENGTH),[g,N]=l.useState(r.NESTED_PADDING),[C,S]=l.useState(r.NESTED_ANGLE_PADDING),w=jt,L=Ct,[R,$]=l.useState(r.LABEL_OVERLAP_MARGIN_PX),[I,W]=l.useState(r.ITEM_ICON_SCALE);l.useEffect(()=>{const A=r.IDEAL_EDGE_LENGTH,H=r.NESTED_PADDING,y=r.NESTED_ANGLE_PADDING,E=r.LABEL_OVERLAP_MARGIN_PX,D=r.ITEM_ICON_SCALE;h(k=>k===A?k:A),N(k=>k===H?k:H),S(k=>k===y?k:y),$(k=>k===E?k:E),W(k=>k===D?k:D)},[r]);const O=l.useMemo(()=>({IDEAL_EDGE_LENGTH:o,NESTED_PADDING:g,NESTED_ANGLE_PADDING:C,LABEL_MARGIN_PX:w,LABEL_LINE_HEIGHT_EM:L,LABEL_OVERLAP_MARGIN_PX:R,ITEM_ICON_SCALE:I}),[o,g,C,w,L,R,I]);l.useEffect(()=>{const A=setTimeout(()=>{x(O)},500);return()=>{clearTimeout(A)}},[O,x]);const U=l.useMemo(()=>t.nodes,[t.nodes]),Y=l.useMemo(()=>t.edges,[t.edges]),T=l.useCallback(()=>{const A=[...U],H=Zs(A,{padding:g,anglePadding:C});m(H),j(H)},[U,g,C,j]);l.useEffect(()=>{f&&T()},[f,T]);const V=l.useCallback(()=>{T()},[T]),B=l.useCallback(()=>{h(ol),N(cl),S(dl),$(Hl),W(Jl)},[]);return e.jsx("div",{"aria-hidden":!f,"aria-labelledby":"map-display-title","aria-modal":"true",className:`animated-frame ${f?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content",children:[e.jsx(v,{ariaLabel:"Close map view",icon:e.jsx(J,{name:"x",size:20}),onClick:c,size:"sm",variant:"close"}),e.jsx("h1",{className:"text-xl font-bold text-teal-400 mb-2 text-center",id:"map-display-title",children:s?`Map: ${s}`:"Map"}),e.jsx("p",{className:"text-center text-xs text-slate-300 mb-1",children:"Pan by dragging, zoom with the mouse wheel or pinch. Hover for details."}),e.jsx(Ii,{currentMapNodeId:a,destinationNodeId:n,edges:Y,initialViewBox:p,itemIconScale:I,itemPresenceByNode:i,labelOverlapMarginPx:R,nodes:u,onSelectDestination:d,onViewBoxChange:b}),e.jsx(Ti,{anglePadding:C,itemIconScale:I,onRefreshLayout:V,onReset:B,overlapMargin:R,padding:g,setAnglePadding:S,setItemIconScale:W,setOverlapMargin:$,setPadding:N})]})})}function bs({isOpen:t,title:s,message:a,onConfirm:n,onCancel:i,confirmText:d="Confirm",cancelText:r="Cancel",confirmPreset:p="sky"}){const b=l.useCallback(x=>{x.stopPropagation()},[]);if(!t)return null;const j=a;return e.jsxs("div",{"aria-labelledby":"confirmation-dialog-title","aria-modal":"true",className:"fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center z-[100] p-4 backdrop-blur-sm",onClick:i,role:"dialog",children:[e.jsxs("div",{className:"bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-lg transform transition-all duration-300 ease-out scale-95 opacity-0 animate-dialog-enter",onClick:b,style:{animationFillMode:"forwards"},children:[e.jsx("h2",{className:"text-2xl font-bold text-sky-300 mb-5",id:"confirmation-dialog-title",children:s}),e.jsx("div",{className:"text-slate-300 mb-8 text-base leading-relaxed",children:j}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(v,{ariaLabel:r,label:r,onClick:i,preset:"slate",size:"md",variant:"compact"}),e.jsx(v,{ariaLabel:d,label:d,onClick:n,preset:p,size:"md",variant:"compact"})]})]}),e.jsx("style",{children:`
        @keyframes dialog-enter {
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        .animate-dialog-enter {
          animation: dialog-enter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
      `})]})}bs.defaultProps={cancelText:"Cancel",confirmPreset:"sky",confirmText:"Confirm"};const Ys=t=>t.map(s=>`${s.id}|${s.placeName}|${s.description}`).sort().join("||"),Qs=t=>t.map(s=>`${s.id}|${s.name}|${s.description}`).sort().join("||");We()||console.error("Gemini API key is not set. Image visualization will not work.");function $i({currentSceneDescription:t,theme:s,mapData:a,allNPCs:n,localTime:i,localEnvironment:d,localPlace:r,isVisible:p,onClose:b,setGeneratedImage:j,cachedImageUrl:x,cachedImageScene:f}){const[c,u]=l.useState(null),[m,o]=l.useState(!1),[h,g]=l.useState(null),[N,C]=l.useState(1),[S,w]=l.useState({x:0,y:0}),[L,R]=l.useState(!1),[$,I]=l.useState(null),[W,O]=l.useState(null),U=l.useRef(null),Y=l.useRef(a),T=l.useRef(n),[V,B]=l.useState(()=>Ys(a)),[A,H]=l.useState(()=>Qs(n));l.useEffect(()=>{Y.current=a,B(M=>{const G=Ys(a);return G===M?M:G})},[a]),l.useEffect(()=>{T.current=n,H(M=>{const G=Qs(n);return G===M?M:G})},[n]);const y=(M,G,ee)=>Math.min(ee,Math.max(G,M)),E=l.useCallback(M=>{M.cancelable&&M.preventDefault();const G=M.deltaY<0?1.1:.9;C(ee=>y(ee*G,1,4))},[]),D=l.useCallback(M=>{R(!0),I({x:M.clientX,y:M.clientY})},[]),k=l.useCallback(M=>{if(!L||!$)return;const G=M.clientX-$.x,ee=M.clientY-$.y;w(oe=>({x:oe.x+G,y:oe.y+ee})),I({x:M.clientX,y:M.clientY})},[L,$]),z=l.useCallback(()=>{R(!1),I(null)},[]),q=(M,G)=>Math.sqrt((M.clientX-G.clientX)**2+(M.clientY-G.clientY)**2),F=l.useCallback(M=>{M.cancelable&&M.preventDefault(),M.touches.length===1?(R(!0),I({x:M.touches[0].clientX,y:M.touches[0].clientY}),O(null)):M.touches.length===2&&(R(!1),I(null),O(q(M.touches[0],M.touches[1])))},[]),Q=l.useCallback(M=>{if(M.cancelable&&M.preventDefault(),M.touches.length===1&&L&&$){const G=M.touches[0],ee=G.clientX-$.x,oe=G.clientY-$.y;w(ce=>({x:ce.x+ee,y:ce.y+oe})),I({x:G.clientX,y:G.clientY})}else if(M.touches.length===2&&W!==null){const G=q(M.touches[0],M.touches[1]);if(G===0)return;C(ee=>y(ee*(G/W),1,4)),O(G)}},[L,$,W]),se=l.useCallback(M=>{M.touches.length<2&&O(null),M.touches.length<1&&(R(!1),I(null))},[]);l.useEffect(()=>{C(1),w({x:0,y:0})},[c]);const me=l.useCallback(async()=>{if(!ul||!s){g("Image generation service or theme is not available."),o(!1),xs(null);return}o(!0),xs("visualize_scene"),g(null);const M=`A detailed, digital painting in ${ml(s)} without ANY text on it.
    Aspect ratio 4:3.
    It is ${i}. ${d}. ${r}. ${t}`;let G=M;const ee=[];Y.current.forEach(_=>{t.toLowerCase().includes(_.placeName.toLowerCase())&&(G+=` The ${_.placeName} is prominent, described as: ${_.description||"A notable location."}.`,ee.push(_.placeName))});const oe=[];T.current.forEach(_=>{t.toLowerCase().includes(_.name.toLowerCase())&&(G+=` ${_.name} here, appearing as: ${_.description}.`,oe.push(_.name))}),G+=" Focus on creating a faithful representation based on this description. Do not generate any text on the image.";const ce=await hl(`Rewrite the following scene description into a safe and aestetic visual depiction suitable for highly censored image generation. Only include the elements that are definitely present in the scene and omit anything non-visual, that is mentioned only for unrelated context. Preserve all details of the landscape or environment. Mention time, weather, mood of the environment. Preserve small details. Avoid any depressing, explicit or unsafe elements. Absolutely avoid nudity or corpses.

Scene:
${G}`,M,"Respond ONLY with the visual description of the scene.","ImagePromptSanitizer");try{const _=await pl(ce,"4:3");if(_){const ne=`data:image/jpeg;base64,${_}`;u(ne),j(ne,t)}else throw new Error("No image data received from API.")}catch(_){console.error("Error generating image:",_);const ne=_ instanceof Error?_.message:"Unknown error during image generation.";xl(_)===400&&g("Fallback image generation failed."),ne.includes("quota")||ne.includes("billing")?g("Image generation quota exceeded or billing issue. Please check your Google Cloud project."):ne.includes("API key not valid")?g("Image generation failed: API key is not valid. Please check configuration."):g(`Failed to visualize scene: ${ne.substring(0,100)}`)}finally{o(!1),xs(null)}},[t,s,i,d,r,j]),he=l.useCallback(()=>{me()},[me]);return l.useEffect(()=>{p&&(x&&f===t?(u(x),o(!1),g(null)):me())},[p,x,f,t,V,A,me]),e.jsx("div",{"aria-labelledby":"visualizer-title","aria-modal":"true",className:`animated-frame ${p?"open":""}`,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content visualizer-content-area",children:[e.jsx(v,{ariaLabel:"Close visualizer",icon:e.jsx(J,{name:"x",size:20}),onClick:b,size:"sm",variant:"close"}),m?e.jsx("div",{className:"visualizer-spinner-container",children:e.jsx(je,{})}):null,!m&&h?e.jsxs("div",{className:"visualizer-error-container",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-400 mb-2",id:"visualizer-title",children:"Vision Failed"}),e.jsx("p",{children:h}),e.jsx("button",{className:"mt-4 px-6 py-2 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-md shadow transition-colors",onClick:he,type:"button",children:"Retry Visualization"})]}):null,!m&&!h&&c?e.jsxs("div",{className:"visualizer-image-container",onMouseDown:D,onMouseLeave:z,onMouseMove:k,onMouseUp:z,onTouchEnd:se,onTouchMove:Q,onTouchStart:F,onWheel:E,role:"presentation",children:[e.jsx("img",{alt:"Scene visualization",className:"visualizer-image",ref:U,src:c,style:{transform:`translate(${String(S.x)}px, ${String(S.y)}px) scale(${String(N)})`}}),e.jsx("h2",{className:"sr-only",id:"visualizer-title",children:"Scene Visualization"})]}):null,!m&&!h&&!c&&p?e.jsx("div",{className:"visualizer-spinner-container",children:e.jsx("p",{className:"mt-2 text-lg text-slate-300",id:"visualizer-title",children:"Preparing to visualize..."})}):null]})})}function Na({isBook:t,isJournal:s,chapters:a,chapterIndex:n,unlockedChapterCount:i,isLoading:d,canInspectItem:r,canInspectJournal:p,canWriteJournal:b,isWritingJournal:j,onInspect:x,onWriteJournal:f,onPrev:c,onNext:u,onSelectChapter:m}){const o=l.useCallback(g=>{m(Number(g.target.value))},[m]);if(!t&&!s)return null;const h=d||(t&&!s?n>=i||n===a.length:n>=a.length-1);return e.jsxs("div",{className:"flex justify-center items-center gap-2 mb-2",children:[s&&x?e.jsx(v,{ariaLabel:"Inspect",disabled:!r||!p,label:"Inspect",onClick:x,preset:"indigo",size:"sm",variant:"compact"}):null,e.jsx(v,{ariaLabel:"Previous chapter",disabled:n===0,label:"â",onClick:c,preset:"slate",size:"lg",variant:"toolbar"}),e.jsx("select",{"aria-label":"Select chapter",className:"bg-slate-800 text-white text-md h-9 p-2",onChange:o,value:n,children:t&&!s?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:0,children:"ToC"}),a.slice(0,i).map((g,N)=>e.jsx("option",{value:N+1,children:g.heading},g.heading))]}):a.map((g,N)=>e.jsx("option",{value:N,children:g.heading},g.heading))}),e.jsx(v,{ariaLabel:"Next chapter",disabled:h,label:"âº",onClick:u,preset:"slate",size:"lg",variant:"toolbar"}),s&&f?e.jsx(v,{ariaLabel:"Write entry",disabled:!b||j,label:"Write",onClick:f,preset:"blue",size:"sm",title:"Write a new journal entry",variant:"compact"}):null]})}Na.defaultProps={onInspect:void 0,onWriteJournal:void 0};const gs=(t,s)=>t.split(/(\*\*[^*]+\*\*|\*[^*]+\*)/g).map((n,i)=>{const d=`${s}-${String(i)}-${n}`;if(n.startsWith("**")&&n.endsWith("**")){const r=n.slice(2,-2);return e.jsx("strong",{children:r},`b-${d}`)}if(n.startsWith("*")&&n.endsWith("*")){const r=n.slice(1,-1);return e.jsx("em",{children:r},`i-${d}`)}return e.jsx(fs.Fragment,{children:n},`t-${d}`)}),Ai=t=>{const s=t.replace(/\r\n/g,`
`).split(/\n/),a=[],n=[];let i=[];const d=/^(#+)\s+(.*)$/,r=()=>{if(i.length===0)return;const x=a.length,f=i.map((c,u)=>{const m=`p-${String(x)}-${String(u)}`,o=gs(c,m),h=u<i.length-1?e.jsx("br",{}):null;return e.jsxs(fs.Fragment,{children:[o,h]},m)});a.push(e.jsx("p",{children:f},`p-${String(x)}`)),i=[]},p=()=>{const x=n.pop();if(!x)return;const{items:f,level:c}=x,u=`ul-${String(c)}-${String(a.length)}`,m=e.jsx("ul",{className:"list-disc list-inside ml-4 space-y-1",children:f},u);n.length===0?a.push(m):n[n.length-1].items.push(m)},b=x=>{for(;n.length>x+1;)p()},j=/^(\s*)\*\s+(.*)$/;return s.forEach(x=>{if(x.trim()==="--- torn ---"){r(),b(-1),a.push(e.jsx("hr",{"aria-hidden":"true",className:"torn-divider"},`torn-${String(a.length)}`));return}const f=d.exec(x);if(f){r(),b(-1);const u=f[2],m=`h-${String(a.length)}`,o=gs(u,m);a.push(e.jsx("p",{children:e.jsx("strong",{children:o})},m));return}const c=j.exec(x);if(c){r();const u=c[1].length,m=Math.floor(u/2);for(b(m);n.length<=m;)n.push({level:n.length,items:[]});const o=c[2],h=`li-${String(m)}-${String(n[m].items.length)}`,g=gs(o,h);n[m].items.push(e.jsx("li",{children:g},h))}else x.trim()===""?(r(),b(-1)):i.push(x)}),r(),b(-1),a};function Di({pendingWrite:t,isLoading:s,isBook:a,isJournal:n,chapterIndex:i,chapters:d,textClassNames:r,displayedText:p,isImageItem:b,imageUrl:j,tearOrientation:x,theme:f,itemName:c}){return t||s?e.jsx(je,{}):a&&!n&&i===0?e.jsx("ul",{className:`p-5 mt-4 list-disc list-inside overflow-y-auto text-left ${r}`,children:d.map((u,m)=>e.jsx("p",{children:`${String(m+1)}. ${u.heading}`},u.heading))}):p||b&&j?e.jsxs("div",{className:`whitespace-pre-wrap text-lg overflow-y-auto p-5 mt-4 ${r} ${x?`torn-${x}`:""}`,children:[b&&j?e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx("img",{alt:c??"Item image",className:"max-h-[24rem] object-contain mask-gradient-edges",src:j})}):null,p?Ai(p):null]}):n&&d.length===0?e.jsx("div",{className:`whitespace-pre-wrap text-lg overflow-y-auto p-5 mt-4 min-h-[20rem] tag-${f.playerJournalStyle}`}):null}function va({item:t,theme:s,currentScene:a,storytellerThoughts:n,mapData:i,allNPCs:d,currentQuest:r,isVisible:p,startIndex:b=0,onClose:j,updateItemContent:x,onInspect:f,onWriteJournal:c,canWriteJournal:u=!0,canInspectJournal:m=!0,isWritingJournal:o=!1}){var E;const{chapters:h,chapterIndex:g,isBook:N,isJournal:C,isImageItem:S,unlockedChapterCount:w,showDecoded:L,textClassNames:R,tearOrientation:$,imageUrl:I,isLoading:W,pendingWrite:O,canInspectItem:U,handlePrevChapter:Y,handleNextChapter:T,handleSelectChapter:V,toggleDecoded:B,displayedText:A}=gl({item:t,theme:s,currentScene:a,storytellerThoughts:n,mapData:i,allNPCs:d,currentQuest:r,isVisible:p,startIndex:b,isWritingJournal:o,updateItemContent:x}),H=l.useCallback(D=>{D.target===D.currentTarget&&j()},[j]),y=!!((E=t==null?void 0:t.tags)!=null&&E.includes("recovered"));return e.jsx("div",{"aria-labelledby":"page-view-title","aria-modal":"true",className:`animated-frame ${p?"open":""}`,onClick:H,role:"dialog",children:e.jsxs("div",{className:"animated-frame-content page-view-content-area",children:[e.jsx(v,{ariaLabel:"Close page",icon:e.jsx(J,{name:"x",size:20}),onClick:j,size:"sm",variant:"close"}),t!=null&&t.name?e.jsx("h2",{className:"text-2xl font-bold text-amber-400 mb-4 text-center",id:"page-view-title",children:t.name}):null,e.jsx(Na,{canInspectItem:U,canInspectJournal:m,canWriteJournal:u,chapterIndex:g,chapters:h,isBook:N,isJournal:C,isLoading:W,isWritingJournal:o,onInspect:f,onNext:T,onPrev:Y,onSelectChapter:V,onWriteJournal:c,unlockedChapterCount:w}),y?e.jsx("div",{className:"flex justify-center",children:e.jsx(v,{ariaLabel:L?"Show encoded text":"Show decoded text",label:L?"Hide":"Reveal",onClick:B,preset:L?"sky":"slate",pressed:L,size:"sm",variant:"toggle"})}):null,e.jsx(Di,{chapterIndex:g,chapters:h,displayedText:A,imageUrl:I,isBook:N,isImageItem:S,isJournal:C,isLoading:W,itemName:(t==null?void 0:t.name)??null,pendingWrite:O,tearOrientation:$,textClassNames:R,theme:s})]})})}va.defaultProps={canInspectJournal:!0,canWriteJournal:!0,isWritingJournal:!1,onInspect:void 0,onWriteJournal:void 0,startIndex:0};function Gi({isVisualizerVisible:t,onCloseVisualizer:s,visualizerImageUrl:a,visualizerImageScene:n,setGeneratedImage:i,currentScene:d,theme:r,mapData:p,allNPCs:b,localTime:j,localEnvironment:x,localPlace:f,isKnowledgeBaseVisible:c,onCloseKnowledgeBase:u,isMapVisible:m,onCloseMap:o,adventureName:h,currentMapNodeId:g,destinationNodeId:N,itemPresenceByNode:C,onSelectDestination:S,initialLayoutConfig:w,initialViewBox:L,onViewBoxChange:R,onNodesPositioned:$,onLayoutConfigChange:I,newGameFromMenuConfirmOpen:W,handleConfirmNewGameFromMenu:O,handleCancelNewGameFromMenu:U,loadGameFromMenuConfirmOpen:Y,handleConfirmLoadGameFromMenu:T,handleCancelLoadGameFromMenu:V,inventory:B,playerJournal:A,lastJournalWriteTurn:H,pageItemId:y,pageStartChapterIndex:E,isPageVisible:D,onClosePage:k,storytellerThoughts:z,currentQuest:q,updateItemContent:F,updatePlayerJournalContent:Q,onItemInspect:se,canInspectJournal:me,onWriteJournal:he,canWriteJournal:M,isWritingJournal:G}){const ee=l.useCallback((_,ne,Ce,Te,Pe)=>{y===ge?Q(ne??"",Te):F(_,ne,Ce,Te,Pe)},[y,F,Q]),oe=l.useCallback(()=>{y&&(se(y),k())},[y,se,k]),ce=l.useCallback(()=>{y===ge&&he()},[y,he]);return e.jsxs(e.Fragment,{children:[e.jsx($i,{allNPCs:b,cachedImageScene:n,cachedImageUrl:a,currentSceneDescription:d,isVisible:t,localEnvironment:x,localPlace:f,localTime:j,mapData:p.nodes,onClose:s,setGeneratedImage:i,theme:r}),e.jsx(wi,{allNPCs:b,isVisible:c,onClose:u,theme:r}),e.jsx(va,{allNPCs:b,canInspectJournal:me,canWriteJournal:M,currentQuest:q,currentScene:d,isVisible:D,isWritingJournal:G,item:y===ge?{id:ge,name:"Personal Journal",type:"book",description:"Your own journal",holderId:ra,chapters:A,lastWriteTurn:H,tags:[r.playerJournalStyle]}:B.find(_=>_.id===y)??null,mapData:p,onClose:k,onInspect:y?oe:void 0,onWriteJournal:y?ce:void 0,startIndex:E,storytellerThoughts:z,theme:r,updateItemContent:ee}),e.jsx(Pi,{adventureName:h,currentMapNodeId:g,destinationNodeId:N,initialLayoutConfig:w,initialViewBox:L,isVisible:m,itemPresenceByNode:C,mapData:p,onClose:o,onLayoutConfigChange:I,onNodesPositioned:$,onSelectDestination:S,onViewBoxChange:R}),e.jsx(bs,{confirmPreset:"red",confirmText:"Start New Game",isOpen:W,message:"Are you sure you want to start a new game? Your current progress will be lost.",onCancel:U,onConfirm:O,title:"Confirm New Game"}),e.jsx(bs,{confirmPreset:"blue",confirmText:"Load Game",isOpen:Y,message:"Are you sure you want to load a game? Your current progress will be overwritten if you load a new game.",onCancel:V,onConfirm:T,title:"Confirm Load Game"})]})}function Fi({shouldLockBodyScroll:t,dialogueDisplayProps:s,debugViewProps:a,titleMenuProps:n,gameSetupProps:i,settingsDisplayProps:d,infoDisplayProps:r,debugLoreModalProps:p,geminiKeyModalProps:b,genderSelectModalProps:j,actIntroModalProps:x,victoryScreenProps:f,characterSelectModalProps:c,appModalsProps:u,mapLayoutConfig:m,mapViewBox:o,currentMapNodeId:h,mapData:g,onMapNodesPositioned:N}){const[C,S]=l.useState(o),w=l.useRef(!1);l.useEffect(()=>{if(typeof window>"u")return;const X=document.body;if(t){const xe=window.innerWidth-document.documentElement.clientWidth;X.style.overflow="hidden",xe>0&&(X.style.paddingRight=`${String(xe)}px`)}else X.style.overflow="",X.style.paddingRight="";return()=>{X.style.overflow="",X.style.paddingRight=""}},[t]),l.useEffect(()=>{if(!u)return;const{isMapVisible:X}=u;if(X&&!w.current){const xe=Zs(g.nodes.map(ie=>({...ie})),{padding:m.NESTED_PADDING,anglePadding:m.NESTED_ANGLE_PADDING});N(xe);const Re=o.split(" ").map(parseFloat);if(Re.length===4){const[,,ie,Me]=Re,pe=xe.find(De=>De.id===h);pe&&!Number.isNaN(ie)&&!Number.isNaN(Me)?S(`${String(pe.position.x-ie/2)} ${String(pe.position.y-Me/2)} ${String(ie)} ${String(Me)}`):S(o)}else S(o)}w.current=X,X||(w.current=!1)},[u,h,g.nodes,m,o,N]);const L=l.useMemo(()=>u?{...u,initialLayoutConfig:m,initialViewBox:C,onNodesPositioned:N}:null,[u,m,C,N]),{allNPCs:R,heroShortName:$,history:I,inventory:W,isDialogueExiting:O,isLoading:U,isVisible:Y,mapData:T,onClose:V,onOptionSelect:B,options:A,participants:H}=s,{badFacts:y,debugLore:E,debugPacket:D,gameStateStack:k,goodFacts:z,isVisible:q,onApplyGameState:F,onClearFacts:Q,onClose:se,onDistillFacts:me,onSaveFacts:he,onSimulateVictory:M,onSpawnBook:G,onSpawnMap:ee,onSpawnNpcAtLocation:oe,onSpawnPage:ce,onSpawnPicture:_,onSpawnVehicle:ne,onToggleDebugLore:Ce,onTriggerMainQuestAchieved:Te,onUndoTurn:Pe,travelPath:kt}=a,{isGameActive:He,isVisible:$e,onClose:St,onLoadGame:wt,onNewGame:Et,onOpenGeminiKeyModal:Mt,onOpenInfo:Lt,onOpenSettings:Je,onSaveGame:Ue}=n,{isVisible:It,onClose:Tt,onThemeSelected:tt}=i,{enabledThemePacks:ze,isVisible:Pt,onChangePreferredPlayerName:$t,onChangeThinkingEffort:At,onClose:Dt,onToggleThemePack:Gt,preferredPlayerName:Ft,thinkingEffort:zt}=d,{isVisible:Ot,onClose:Rt}=r,{facts:_t,isVisible:Vt,onClose:Bt,onSubmit:Wt}=p,{isVisible:ae,onClose:Ne}=b,{defaultGender:Oe,isVisible:K,onSubmit:be}=j;let de=null;if(x){const X=x.onContinue;de=e.jsx(Ni,{act:x.act,isTurnGenerating:x.isTurnGenerating,onContinue:X})}let Ae=null;if(f){const X=f.onClose;Ae=e.jsx(vi,{heroSheet:f.heroSheet,onClose:X,storyArc:f.storyArc})}let Ke=null;if(c){const X=c.onComplete,xe=c.onHeroData;Ke=e.jsx(Si,{WorldSheet:c.WorldSheet,heroGender:c.heroGender,isVisible:c.isVisible,onComplete:X,onHeroData:xe,options:c.options,theme:c.theme})}let Ye=null;if(L){const{adventureName:X,allNPCs:xe,canInspectJournal:Re,canWriteJournal:ie,currentMapNodeId:Me,currentQuest:pe,currentScene:De,destinationNodeId:Ee,handleCancelLoadGameFromMenu:Qe,handleCancelNewGameFromMenu:Xe,handleConfirmLoadGameFromMenu:qe,handleConfirmNewGameFromMenu:Ge,initialLayoutConfig:Ht,initialViewBox:_e,inventory:st,isKnowledgeBaseVisible:le,isMapVisible:fe,isPageVisible:Le,isVisualizerVisible:at,isWritingJournal:Jt,itemPresenceByNode:Ut,lastJournalWriteTurn:Kt,loadGameFromMenuConfirmOpen:Yt,localEnvironment:Qt,localPlace:Xt,localTime:qt,mapData:ve,newGameFromMenuConfirmOpen:Zt,onCloseKnowledgeBase:es,onCloseMap:ts,onClosePage:Ze,onCloseVisualizer:ss,onItemInspect:as,onLayoutConfigChange:nt,onNodesPositioned:ns,onSelectDestination:ls,onViewBoxChange:is,onWriteJournal:ue,pageItemId:ke,pageStartChapterIndex:lt,playerJournal:rs,setGeneratedImage:it,storytellerThoughts:os,theme:rt,updateItemContent:ot,updatePlayerJournalContent:te,visualizerImageScene:cs,visualizerImageUrl:ds}=L;Ye=e.jsx(Gi,{adventureName:X,allNPCs:xe,canInspectJournal:Re,canWriteJournal:ie,currentMapNodeId:Me,currentQuest:pe,currentScene:De,destinationNodeId:Ee,handleCancelLoadGameFromMenu:Qe,handleCancelNewGameFromMenu:Xe,handleConfirmLoadGameFromMenu:qe,handleConfirmNewGameFromMenu:Ge,initialLayoutConfig:Ht,initialViewBox:_e,inventory:st,isKnowledgeBaseVisible:le,isMapVisible:fe,isPageVisible:Le,isVisualizerVisible:at,isWritingJournal:Jt,itemPresenceByNode:Ut,lastJournalWriteTurn:Kt,loadGameFromMenuConfirmOpen:Yt,localEnvironment:Qt,localPlace:Xt,localTime:qt,mapData:ve,newGameFromMenuConfirmOpen:Zt,onCloseKnowledgeBase:es,onCloseMap:ts,onClosePage:Ze,onCloseVisualizer:ss,onItemInspect:as,onLayoutConfigChange:nt,onNodesPositioned:ns,onSelectDestination:ls,onViewBoxChange:is,onWriteJournal:ue,pageItemId:ke,pageStartChapterIndex:lt,playerJournal:rs,setGeneratedImage:it,storytellerThoughts:os,theme:rt,updateItemContent:ot,updatePlayerJournalContent:te,visualizerImageScene:cs,visualizerImageUrl:ds})}return e.jsxs(e.Fragment,{children:[e.jsx(ha,{allNPCs:R,heroShortName:$,history:I,inventory:W,isDialogueExiting:O,isLoading:U,isVisible:Y,mapData:T,onClose:V,onOptionSelect:B,options:A,participants:H}),e.jsx(Ul,{badFacts:y,debugLore:E,debugPacket:D,gameStateStack:k,goodFacts:z,isVisible:q,onApplyGameState:F,onClearFacts:Q,onClose:se,onDistillFacts:me,onSaveFacts:he,onSimulateVictory:M,onSpawnBook:G,onSpawnMap:ee,onSpawnNpcAtLocation:oe,onSpawnPage:ce,onSpawnPicture:_,onSpawnVehicle:ne,onToggleDebugLore:Ce,onTriggerMainQuestAchieved:Te,onUndoTurn:Pe,travelPath:kt}),e.jsx(xa,{isGameActive:He,isVisible:$e,onClose:St,onLoadGame:wt,onNewGame:Et,onOpenGeminiKeyModal:Mt,onOpenInfo:Lt,onOpenSettings:Je,onSaveGame:Ue}),e.jsx(ba,{isVisible:It,onClose:Tt,onThemeSelected:tt}),e.jsx(mi,{enabledThemePacks:ze,isVisible:Pt,onChangePreferredPlayerName:$t,onChangeThinkingEffort:At,onClose:Dt,onToggleThemePack:Gt,preferredPlayerName:Ft,thinkingEffort:zt}),e.jsx(fi,{isVisible:Ot,onClose:Rt}),e.jsx(yi,{facts:_t,isVisible:Vt,onClose:Bt,onSubmit:Wt}),e.jsx(ji,{isVisible:ae,onClose:Ne}),e.jsx(Ci,{defaultGender:Oe,isVisible:K,onSubmit:be}),de,Ae,Ke,Ye]})}const zi=`<ID: {id}> - {name}
`,Oi=t=>({type:"object",properties:{heading:{type:"string",description:"Short plain text heading for the journal entry."},text:{type:"string",minLength:100,description:`Approximately ${String(t)} words of the journal entry, starting with a Markup-formatted heading. Basic Markup syntax is allowed, such as **bold** and *italic*.`}},required:["heading","text"],additionalProperties:!1}),Ri=t=>Kl(t,s=>!!s&&typeof s=="object"&&typeof s.heading=="string"&&typeof s.text=="string"),_i=async(t,s,a,n,i,d,r,p,b,j,x,f)=>{if(!We())return console.error("generateJournalEntry: API key not configured."),null;const c=f?`Current Quest: "${f}"`:"Current Quest: Not set",u=bl(x),m=fl(b,!0),o=yl(j,zi,`## Known NPCs:
`,`
`),h=`**Context:**
Theme Name: "${i}";
Theme Description: "${d}";
${c};

## Known Locations:
${m}
${o}
## Previous Journal Entry:
${n}

## Last events:
${u}

## Scene Description:
${r};

------
`,g="You are the main protagonist writing a new entry in your personal journal, focusing primarily on Last events and Scene description, logically continuing from the Previous Journal Entry. Always write in-character. NEVER include any ID strings. Provide only the JSON for the new journal entry.",N=Oi(t);return jl(async C=>{var S,w,L,R;try{Cl(ea.write_journal.icon);const $=Nl(1024),{response:I,systemInstructionUsed:W,jsonSchemaUsed:O,promptUsed:U}=await vl({modelNames:[na,la,aa],prompt:h,systemInstruction:g,temperature:1,thinkingBudget:$,includeThoughts:!0,responseMimeType:"application/json",jsonSchema:N,label:"Journal"}),T=(((L=(w=(S=I.candidates)==null?void 0:S[0])==null?void 0:w.content)==null?void 0:L.parts)??[]).filter(A=>A.thought===!0&&typeof A.text=="string").map(A=>A.text),V=((R=I.text)==null?void 0:R.trim())??"",B=V?Ri(V):null;return{result:{entry:B,debugInfo:{prompt:U,systemInstruction:W,jsonSchema:O??N,rawResponse:V,parsedPayload:B??void 0,thoughts:T}}}}catch($){throw console.error(`generateJournalEntry error (Attempt ${String(C+1)}):`,$),$}return{result:{entry:null,debugInfo:null}}})};function Vi({saveLoadState:t,appModals:s,pendingAct:a,setPendingAct:n}){var Rs;const{clearProgress:i}=Xs(),{enabledThemePacks:d,setEnabledThemePacks:r,thinkingEffort:p,setThinkingEffort:b,preferredPlayerName:j,setPreferredPlayerName:x,appReady:f}=t,{isVisualizerVisible:c,visualizerImageUrl:u,setVisualizerImageUrl:m,visualizerImageScene:o,setVisualizerImageScene:h,isKnowledgeBaseVisible:g,isSettingsVisible:N,isInfoVisible:C,isMapVisible:S,userRequestedTitleMenuOpen:w,setShouldReturnToTitleMenu:L,shouldReturnToTitleMenu:R,isDebugViewVisible:$,isCustomGameSetupVisible:I,newGameFromMenuConfirmOpen:W,loadGameFromMenuConfirmOpen:O,openVisualizer:U,closeVisualizer:Y,openKnowledgeBase:T,closeKnowledgeBase:V,openMap:B,closeMap:A,openSettings:H,closeSettings:y,openInfo:E,closeInfo:D,openTitleMenu:k,closeTitleMenu:z,closeDebugView:q,setIsDebugViewVisible:F,openCustomGameSetup:Q,closeCustomGameSetup:se,openNewGameFromMenuConfirm:me,closeNewGameFromMenuConfirm:he,openLoadGameFromMenuConfirm:M,closeLoadGameFromMenuConfirm:G,pageItemId:ee,pageStartChapterIndex:oe,isPageVisible:ce,openPageView:_,closePageView:ne,isDebugLoreVisible:Ce,debugLoreFacts:Te,isGenderSelectVisible:Pe,submitGenderSelectModal:kt,isCharacterSelectVisible:He,characterSelectData:$e,submitCharacterSelectModal:St,submitCharacterSelectHeroData:wt,genderSelectDefault:Et,submitDebugLoreModal:Mt,closeDebugLoreModal:Lt}=s,[Je,Ue]=l.useState(!1),It=kl(),{fileInputRef:Tt,handleSaveToFile:tt,handleLoadFromFileClick:ze,handleFileInputChange:Pt}=Sl({enabledThemePacks:d,thinkingEffort:p});l.useEffect(()=>{We()||Ue(!0)},[]);const $t=l.useCallback(()=>{Ue(!0)},[]),At=l.useCallback(()=>{Ue(!1)},[]),{status:Dt,story:Gt,map:Ft,inventory:zt,journal:Ot,dialogue:Rt,actions:_t,debug:Vt,system:Bt,npcs:Wt}=It,{isLoading:ae,isTurnProcessing:Ne,error:Oe,hasGameBeenInitialized:K}=Dt,{theme:be,currentScene:de,mainQuest:Ae,currentObjective:Ke,actionOptions:Ye,storyArc:X,heroSheet:xe,objectiveAnimationType:Re,gameLog:ie,lastActionLog:Me,lastTurnChanges:pe,score:De,globalTurnNumber:Ee,localTime:Qe,localEnvironment:Xe,localPlace:qe,isVictory:Ge,handlers:Ht}=Gt,{triggerMainQuestAchieved:_e,simulateVictory:st}=Ht,{data:le,currentNodeId:fe,destinationNodeId:Le,layoutConfig:at,viewBox:Jt,itemPresenceByNode:Ut,handlers:Kt}=Ft,{setLayoutConfig:Yt,setViewBox:Qt,setNodePositions:Xt,selectDestination:qt}=Kt,{items:ve,itemsHere:Zt,handlers:es,queue:ts}=zt,{executeItemInteraction:Ze,handleStashToggle:ss,updateItemContent:as}=es,{actions:nt,enqueue:ns,clear:ls,remainingActionPoints:is}=ts,{playerJournal:ue,lastWriteTurn:ke,lastInspectTurn:lt,handlers:rs}=Ot,{addPlayerEntry:it,updatePlayerEntryContent:os,recordInspect:rt,distillLore:ot}=rs,{state:te,isExiting:cs,handlers:ds}=Rt,{selectOption:Cs,forceExit:Sa}=ds,{freeFormActionText:wa,setFreeFormActionText:Ns,handleFreeFormActionSubmit:Ea,handleActionSelect:Ma,handleUndoTurn:La,handleRetry:vs,startCustomGame:ks}=_t,{lastDebugPacket:Fe,gameStateStack:us,debugPacketStack:Ia,toggleDebugLore:Ta,clearDebugFacts:Ss,debugLore:ct,debugGoodFacts:ws,debugBadFacts:Es,gatherCurrentGameState:ms,gatherDebugPacketStack:Pa,spawnBookForPlayer:Ms,spawnMapForPlayer:Ls,spawnPictureForPlayer:Is,spawnPageForPlayer:Ts,spawnVehicleForPlayer:Ps,spawnNpcAtPlayerLocation:$s}=Vt,{commitGameState:Ve,setError:hs}=Bt,{all:Ie}=Wt,$a=l.useCallback(P=>{b(P);const Z=ms()[0];Ve({...Z,thinkingEffort:P})},[Ve,ms,b]),Aa=l.useCallback(P=>{x(P)},[x]),dt=be.name===wl.name,As=dt?null:be.name,Da=a!==null&&(ae||Ne);l.useEffect(()=>{Ge&&n(null)},[Ge,n]),l.useEffect(()=>{pe!=null&&pe.mainQuestAchieved&&_e().catch(P=>{console.error("Failed to finalize main quest achievement after a turn.",P)})},[pe==null?void 0:pe.mainQuestAchieved,_e]);const Ga=l.useCallback(()=>{n(null)},[n]),Fa=l.useCallback(P=>{Ve(P)},[Ve]),za=l.useCallback(()=>{_e().catch(P=>{console.error("Failed to trigger main quest achievement via debug action.",P)})},[_e]),Oa=l.useCallback(()=>{st().catch(P=>{console.error("Failed to simulate victory via debug action.",P)})},[st]),Ra=l.useCallback(()=>{$s()},[$s]),_a=l.useCallback(()=>{Ms()},[Ms]),Va=l.useCallback(()=>{Ls()},[Ls]),Ba=l.useCallback(()=>{Is()},[Is]),Wa=l.useCallback(()=>{Ts()},[Ts]),Ha=l.useCallback(()=>{Ps()},[Ps]),Ja=l.useCallback(()=>{Ve({...us[0],isVictory:!1}),k()},[Ve,us,k]),Ua=l.useCallback(P=>{const Z=new Blob([P],{type:"application/json"}),re=URL.createObjectURL(Z),ye=document.createElement("a");ye.href=re,ye.download="DebugLoreFacts.json",document.body.appendChild(ye),ye.click(),document.body.removeChild(ye),URL.revokeObjectURL(re)},[]),Ka=l.useCallback(()=>{Ss(),El({debugLore:ct,debugGoodFacts:[],debugBadFacts:[]})},[Ss,ct]);l.useEffect(()=>{ae||i()},[ae,i]);const Ds=l.useRef(ie.length),Gs=l.useRef(de),Ya=l.useMemo(()=>{const P=w||f&&!K&&!ae&&!I,Z=Ge;return{effectiveIsTitleMenuOpen:P,isVictoryModalVisible:Z,isAnyModalActive:c||g||N||C||S||$||ce||Ce||P||W||O||I||Je||Pe||He||Z||a!==null}},[f,Je,K,He,I,Ce,$,C,g,ae,S,ce,N,c,Ge,Pe,O,W,a,w]),{effectiveIsTitleMenuOpen:Qa,isAnyModalActive:Fs}=Ya,ut=Fs||!!te;l.useEffect(()=>{(de!==Gs.current||ie.length>Ds.current)&&window.scrollTo({top:0,behavior:"smooth"}),Gs.current=de,Ds.current=ie.length},[de,ie.length]),l.useEffect(()=>{m(null),h(null)},[de,m,h]),Ml({appReady:f,dependencies:[be,de,Ye,Ae,Ke,ve,ie,Me,le,fe,at,Ie,De,Qe,Xe,qe,d,ct,ws,Es],dialogueState:te,gatherDebugPacketStack:Pa,gatherGameStateStack:ms,hasGameBeenInitialized:K,isLoading:ae,isTurnProcessing:Ne,setError:P=>{hs(P)}});const Xa=De>=ta&&!ae&&!Ne&&K&&!te,qa=typeof window<"u"&&window.matchMedia("(hover: none)").matches,Za=l.useCallback((P,Z)=>{m(P),h(Z)},[m,h]),zs=l.useCallback(()=>{vs()},[vs]),en=l.useCallback(()=>{ot()},[ot]),tn=l.useCallback(P=>{var re;const Z=P.id===ge?Math.max(0,(((re=P.chapters)==null?void 0:re.length)??0)-1):0;_(P.id,Z)},[_]),[mt,ps]=l.useState(!1),sn=(ke===0||Ee-ke>=Us)&&!mt,an=ue.length>0&&(lt===0||Ee-lt>=sa),nn=l.useCallback(()=>{const P=ue.length>0?ue.length-1:0;_(ge,P)},[_,ue.length]),ln=l.useCallback(()=>{!(ke===0||Ee-ke>=Us)||mt||(ps(!0),_(ge,ue.length),(async()=>{var Vs,Bs;if(dt){ps(!1);return}const{name:Z,storyGuidance:re}=be,ye=((Vs=ue[ue.length-1])==null?void 0:Vs.actualContent)??"",_s=Math.floor(Math.random()*50)+100,Be=await _i(_s,"Personal Journal","Your own journal",ye,Z,re,de,((Bs=Fe==null?void 0:Fe.storytellerThoughts)==null?void 0:Bs.slice(-1)[0])??"",le.nodes,Ie,ie.slice(-Yl),Ae);if(Be!=null&&Be.entry){const Qn={heading:Ll(Be.entry.heading)||"Journal Entry",description:"",contentLength:_s,actualContent:Be.entry.text};it(Qn,Be.debugInfo??void 0),_(ge,ue.length)}ps(!1)})())},[Ie,be,de,it,le.nodes,Ae,_,ue,Fe,ie,Ee,ke,mt,dt]),rn=l.useCallback(P=>{if(P===ge){const re={id:ge,name:"Personal Journal",type:"book",description:"Your own journal",holderId:ra,chapters:ue,lastWriteTurn:ke,tags:[be.playerJournalStyle]},ye=rt();Ze(re,"inspect",void 0,ye);return}const Z=ve.find(re=>re.id===P);Z&&Ze(Z,"inspect")},[ve,Ze,ue,ke,rt,be]),on=l.useCallback(P=>{Ns(P.target.value)},[Ns]),cn=l.useCallback(()=>{G(),k()},[G,k]),dn=l.useCallback(()=>{he(),k()},[he,k]),un=l.useCallback(P=>{r(Z=>{const re=Z.includes(P)?Z.filter(ye=>ye!==P):[...Z,P];return re.length===0?(hs("At least one theme pack must be enabled."),Z):re})},[r,hs]),mn=l.useCallback(P=>{Cs(P)},[Cs]),hn=l.useCallback(()=>{z(),K?me():Q()},[z,K,Q,me]),pn=l.useCallback(()=>{he(),Q()},[he,Q]),xn=l.useCallback(()=>{z(),K?M():ze()},[z,K,ze,M]),gn=l.useCallback(()=>{G(),ze()},[G,ze]),bn=l.useCallback(async()=>{z(),await tt()},[z,tt]),fn=l.useCallback(()=>{z(),L(!0),H()},[z,L,H]),yn=l.useCallback(()=>{y(),(R||!K)&&k(),L(!1)},[y,R,K,k,L]),jn=l.useCallback(()=>{z(),L(!0),E()},[z,L,E]),Cn=l.useCallback(()=>{D(),(R||!K)&&k(),L(!1)},[D,R,K,k,L]),Nn=l.useCallback(()=>{se(),k()},[se,k]),vn=l.useCallback(P=>{se(),ks(P)},[se,ks]),Os=l.useMemo(()=>Il(le),[le]),kn=l.useMemo(()=>!Le||!fe||fe===Le||Tl(le,fe,Le)?null:Pl(le,fe,Le,Os),[Le,fe,le,Os,Ee]),Sn=ae&&!K&&!Oe,wn=ae&&!te,En=new Set(nt.map(P=>P.id)),Mn={adventureName:As,currentSceneExists:!!de,isLoading:ae||!!te||Ne,isTurnProcessing:Ne,onOpenKnowledgeBase:T,onOpenMap:B,onOpenTitleMenu:k,onOpenVisualizer:U,score:De},Ln={allNPCs:Ie,description:de,inventory:ve,lastActionLog:Me,localEnvironment:Xe,localPlace:qe,localTime:Qe,mapData:le.nodes},In={allNPCs:Ie,disabled:ae||Ne||!!te,inventory:ve,mapData:le.nodes,onActionSelect:Ma,onClearQueuedActions:ls,options:Ye,queuedActions:nt},Tn={canPerformFreeAction:Xa,freeFormActionText:wa,onChange:on,onSubmit:Ea},Pn={allNPCs:Ie,currentMapNodeId:fe,currentObjective:Ke,disabled:ae||Ne||ut,enableMobileTap:qa,globalTurnNumber:Ee,inventory:ve,itemsHere:Zt,mapNodes:le.nodes,objectiveAnimationType:Re,onItemInteract:ns,onReadPage:tn,onReadPlayerJournal:nn,onStashToggle:ss,queuedActionIds:En,remainingActionPoints:is,storyArc:X},$n=Oe?[{id:"active-game-error",isVisible:!ae&&!te&&K,message:Oe,handleRetry:zs},{id:"pre-game-error",isVisible:!K,message:Oe,handleRetry:zs}]:[],An={currentTurnNumber:Ee,isGameBusy:ae||Ne||Fs,lastTurnChanges:pe},Dn={isBlurred:ut,isDebugViewVisible:$,setIsDebugViewVisible:F},Gn={accept:".json,application/json",onChange:Pt,inputRef:Tt},Fn={allNPCs:Ie,heroShortName:xe.heroShortName,history:(te==null?void 0:te.history)??[],inventory:ve,isDialogueExiting:cs,isLoading:ae,isVisible:!!te,mapData:le.nodes,onClose:Sa,onOptionSelect:mn,options:(te==null?void 0:te.options)??[],participants:(te==null?void 0:te.participants)??[]},zn={badFacts:Es,debugLore:ct,debugPacket:Ia[0],gameStateStack:us,goodFacts:ws,isVisible:$,onApplyGameState:Fa,onClearFacts:Ka,onClose:q,onDistillFacts:en,onSaveFacts:Ua,onSimulateVictory:Oa,onSpawnBook:_a,onSpawnMap:Va,onSpawnNpcAtLocation:Ra,onSpawnPage:Wa,onSpawnPicture:Ba,onSpawnVehicle:Ha,onToggleDebugLore:Ta,onTriggerMainQuestAchieved:za,onUndoTurn:La,travelPath:kn},On={isGameActive:K,isVisible:Qa,onClose:z,onLoadGame:xn,onNewGame:hn,onOpenGeminiKeyModal:$t,onOpenInfo:jn,onOpenSettings:fn,onSaveGame:K?bn:void 0},Rn={isVisible:I,onClose:Nn,onThemeSelected:vn},_n={enabledThemePacks:d,isVisible:N,onChangePreferredPlayerName:Aa,onChangeThinkingEffort:$a,onClose:yn,onToggleThemePack:un,preferredPlayerName:j,thinkingEffort:p},Vn={isVisible:C,onClose:Cn},Bn={facts:Te,isVisible:Ce,onClose:Lt,onSubmit:Mt},Wn={isVisible:Je,onClose:At},Hn={defaultGender:Et,isVisible:Pe,onSubmit:kt},Jn=a?{act:a,isTurnGenerating:Da,onContinue:Ga}:null,Un=Ge?{heroSheet:xe,onClose:Ja,storyArc:X}:null,Kn=$e?{WorldSheet:$e.WorldSheet,heroGender:$e.heroGender,isVisible:He,onComplete:St,onHeroData:wt,options:$e.options,theme:$e.theme}:null,Yn=K&&!dt?{adventureName:As,allNPCs:Ie,canInspectJournal:an,canWriteJournal:sn,currentMapNodeId:fe,currentQuest:Ae,currentScene:de,destinationNodeId:Le,handleCancelLoadGameFromMenu:cn,handleCancelNewGameFromMenu:dn,handleConfirmLoadGameFromMenu:gn,handleConfirmNewGameFromMenu:pn,inventory:ve,isKnowledgeBaseVisible:g,isMapVisible:S,isPageVisible:ce,isVisualizerVisible:c,isWritingJournal:mt,itemPresenceByNode:Ut,lastJournalWriteTurn:ke,loadGameFromMenuConfirmOpen:O,localEnvironment:Xe,localPlace:qe,localTime:Qe,mapData:le,newGameFromMenuConfirmOpen:W,onCloseKnowledgeBase:V,onCloseMap:A,onClosePage:ne,onCloseVisualizer:Y,onItemInspect:rn,onLayoutConfigChange:Yt,onSelectDestination:qt,onViewBoxChange:Qt,onWriteJournal:ln,pageItemId:ee,pageStartChapterIndex:oe,playerJournal:ue,setGeneratedImage:Za,storytellerThoughts:((Rs=Fe==null?void 0:Fe.storytellerThoughts)==null?void 0:Rs.slice(-1)[0])??"",theme:be,updateItemContent:as,updatePlayerJournalContent:os,visualizerImageScene:o,visualizerImageUrl:u}:null;return f?e.jsxs(e.Fragment,{children:[e.jsx(Zl,{errorBanners:$n,fileInputProps:Gn,footerProps:Dn,headerProps:{hasGameBeenInitialized:K,theme:be},isBlurred:ut,itemAnimatorProps:An,children:e.jsx(ui,{actionOptionsProps:In,freeActionInputProps:Tn,hasGameBeenInitialized:K,mainToolbarProps:Mn,sceneDisplayProps:Ln,showInitialLoadingSpinner:Sn,showSceneLoadingOverlay:wn,sidebarProps:Pn})}),e.jsx(Fi,{actIntroModalProps:Jn,appModalsProps:Yn,characterSelectModalProps:Kn,currentMapNodeId:fe,debugLoreModalProps:Bn,debugViewProps:zn,dialogueDisplayProps:Fn,gameSetupProps:Rn,geminiKeyModalProps:Wn,genderSelectModalProps:Hn,infoDisplayProps:Vn,mapData:le,mapLayoutConfig:at,mapViewBox:Jt,onMapNodesPositioned:Xt,settingsDisplayProps:_n,shouldLockBodyScroll:ut,titleMenuProps:On,victoryScreenProps:Un})]}):e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 flex flex-col items-center justify-center p-4",children:[e.jsx(je,{}),e.jsx("p",{className:"mt-4 text-xl text-sky-400",children:"Initializing application..."})]})}function Bi(){const t=$l(),s=Al(),{openCharacterSelectModal:a,openGenderSelectModal:n,openDebugLoreModal:i}=s,[d,r]=l.useState(null),p=l.useCallback((x,f)=>new Promise(c=>{a(x,f,c)}),[a]),b=l.useCallback(x=>new Promise(f=>{n(x,f)}),[n]),j=Dl({enabledThemePacksProp:t.enabledThemePacks,thinkingEffortProp:t.thinkingEffort,preferredPlayerNameProp:t.preferredPlayerName,initialSavedStateFromApp:t.initialSavedState,initialDebugStackFromApp:t.initialDebugStack,isAppReady:t.appReady,openDebugLoreModal:i,openCharacterSelectModal:p,openGenderSelectModal:b,onActIntro:r});return e.jsx(Gl,{value:j,children:e.jsx(Vi,{appModals:s,pendingAct:d,saveLoadState:t,setPendingAct:r})})}const ka=document.getElementById("root");if(!ka)throw new Error("Could not find root element to mount to");const Wi=Xn.createRoot(ka);Wi.render(e.jsx(l.StrictMode,{children:e.jsx(Bi,{})}));
